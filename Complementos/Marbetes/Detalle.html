<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edición de Marbete - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --brand-green-dark: #064e3b;
            --brand-green-mid: #059669;
            --marbete-red: #7f1d1d;
            --alert-red: #ef4444;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #ffffff; 
            color: #1e293b; 
            padding: 0; margin: 0; 
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        
        .sticky-top-section { position: sticky; top: 0; z-index: 50; background: white; flex-shrink: 0; transition: border-color 0.3s ease; }
        .header-baja-active { border-bottom: 4px solid var(--alert-red) !important; }

        /* Diseño del Marbete Vertical */
        .marbete-vertical {
            width: 50px; height: 70px; border-radius: 6px 6px 12px 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.15); flex-shrink: 0; margin-right: 15px;
            transition: all 0.3s ease;
        }
        .marbete-hook { width: 12px; height: 12px; background: rgba(0,0,0,0.1); border-radius: 50%; position: absolute; top: 6px; }
        .marbete-digits { display: grid; grid-template-columns: repeat(2, 1fr); gap: 2px; margin-top: 10px; }
        .digit { font-size: 16px; font-weight: 900; text-align: center; }

        .bg-green-gradient { background: linear-gradient(135deg, var(--brand-green-dark) 0%, var(--brand-green-mid) 100%); }
        
        .date-ribbon { 
            background: #f1f5f9; 
            padding: 6px 20px; 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            border-bottom: 1px solid #e2e8f0; 
        }
        
        .date-item { display: flex; align-items: center; gap: 5px; }
        .date-item span:first-child { font-size: 8px; font-weight: 900; text-transform: uppercase; color: #94a3b8; }
        .date-item span:last-child { font-size: 9px; font-weight: 700; color: #64748b; }

        #baja-banner { display: none; background: #fef2f2; color: var(--alert-red); font-size: 11px; font-weight: 900; text-transform: uppercase; text-align: center; padding: 4px 0; letter-spacing: 0.3em; }

        .sync-status-bar {
            height: 32px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f8fafc;
            color: #94a3b8;
            border-bottom: 1px solid #f1f5f9;
        }

        .sync-saving { background: #1e293b; color: #60a5fa; }
        .sync-done { background: #10b981; color: white; }
        .sync-error { background: #ef4444; color: white; }

        .dot-pulse {
            width: 7px; height: 7px; background: currentColor; border-radius: 50%;
            animation: pulse-dot 1s infinite;
        }
        @keyframes pulse-dot { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.6); } 100% { opacity: 1; transform: scale(1); } }

        .form-group { margin-bottom: 0.75rem; }
        .detail-label { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #94a3b8; display: block; margin-bottom: 2px; }
        .form-input { width: 100%; background-color: #f8fafc; border: 1px solid #f1f5f9; border-radius: 10px; padding: 8px 12px; font-size: 13px; font-weight: 600; color: #334155; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--brand-green-mid); background-color: #fff; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }

        .action-btn { transition: all 0.2s ease; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; font-weight: 800; font-size: 8px; text-transform: uppercase; padding: 10px 4px; width: 100%; border: 1px solid transparent; text-decoration: none; }
        
        .section-block { padding: 1.25rem; border-radius: 16px; border: 1px solid #f1f5f9; background: #fff; margin-bottom: 1rem; }
        .main-scroll-area { flex: 1; overflow-y: auto; padding: 1.25rem; }
        
        .save-footer { 
            background: white; padding: 1rem 1.5rem; border-top: 1px solid #f1f5f9; 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }

        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }

        #assign-modal { position: fixed; inset: 0; background: rgba(6, 78, 59, 0.4); backdrop-filter: blur(8px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 24px; }
        .modal-card { background: white; width: 100%; max-width: 320px; border-radius: 24px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: modalPop 0.3s ease; }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #empty-state { display: flex; height: 100%; flex-direction: column; align-items: center; justify-content: center; text-align: center;}
        #detail-content { display: none; height: 100%; flex-direction: column; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="w-10 h-10 border-4 border-emerald-100 border-t-emerald-600 rounded-full animate-spin"></div>
        <p id="loading-text" class="text-[10px] font-black uppercase mt-4 tracking-widest text-emerald-900">Procesando...</p>
    </div>

    <!-- Modal de Asignación -->
    <div id="assign-modal">
        <div class="modal-card space-y-4 text-center">
            <h3 class="text-sm font-black uppercase tracking-tight text-emerald-900">Asignar Folio</h3>
            <p class="text-[10px] text-slate-400 font-bold uppercase">Ingrese el número de marbete</p>
            <input type="text" id="modal-folio-input" class="form-input text-center text-xl font-black text-emerald-700" placeholder="0000" autofocus>
            <div class="flex gap-2 pt-2">
                <button onclick="closeAssignModal()" class="flex-1 py-3 text-[10px] font-black uppercase text-slate-400">Cancelar</button>
                <button onclick="confirmFolioAssignment()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl text-[10px] font-black uppercase shadow-lg shadow-emerald-600/20">Asignar</button>
            </div>
        </div>
    </div>

    <!-- Pantalla Vacía -->
    <div id="empty-state">
        <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 border border-slate-100">
            <i class="fa-solid fa-file-invoice text-emerald-200 text-2xl"></i>
        </div>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest px-10">Seleccione un registro de la tabla para visualizar detalles</p>
    </div>

    <div id="detail-content">
        <div id="sticky-header-container" class="sticky-top-section shadow-sm">
            <div class="bg-green-gradient px-5 py-3 text-white flex items-center overflow-hidden">
                <!-- Visualización Marbete -->
                <div id="visual-marbete" class="marbete-vertical bg-white text-slate-900">
                    <div class="marbete-hook"></div>
                    <div id="marbete-num-display" class="marbete-digits">
                        <div class="digit">-</div><div class="digit">-</div>
                        <div class="digit">-</div><div class="digit">-</div>
                    </div>
                </div>
                <div class="flex-1 pr-4">
                    <span class="text-[7px] font-black uppercase tracking-[0.2em] opacity-50 block">Expediente de Usuario</span>
                    <h1 id="header-nombre" class="text-lg font-black tracking-tight uppercase truncate">---</h1>
                </div>
                <!-- BOTÓN DE CIERRE EN ENCABEZADO -->
                <button onclick="closePanel()" class="w-8 h-8 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-xl transition-all active:scale-95" title="Cerrar Panel">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>

            <div class="date-ribbon">
                <div class="date-item"><span>Solicitud:</span><span id="tag-fecha-solicitud">---</span></div>
                <div class="date-item"><span>Asignación:</span><span id="tag-fecha-asignacion">---</span></div>
            </div>

            <!-- Barra de Estado -->
            <div id="sync-status-bar" class="sync-status-bar">
                <div id="sync-dot" class="hidden dot-pulse"></div>
                <span id="sync-text">Conectado a Cloud</span>
            </div>

            <div id="baja-banner">BAJA - REGISTRO INACTIVO</div>

            <div class="px-5 py-2">
                <div class="grid grid-cols-4 gap-2 bg-slate-50 p-1.5 rounded-xl border border-slate-100">
                    <a id="btn-call" href="#" class="action-btn bg-white text-slate-500 border-slate-100 hover:text-emerald-600 shadow-sm">
                        <i class="fa-solid fa-phone"></i>
                        Llamar
                    </a>
                    <a id="btn-whatsapp" href="#" class="action-btn bg-white text-slate-500 border-slate-100 hover:text-emerald-600 shadow-sm">
                        <i class="fa-brands fa-whatsapp"></i>
                        W.App
                    </a>
                    <a id="btn-email" href="#" class="action-btn bg-white text-slate-500 border-slate-100 hover:text-emerald-600 shadow-sm">
                        <i class="fa-solid fa-envelope"></i>
                        E-Mail
                    </a>
                    <a id="btn-teams" href="#" target="_blank" class="action-btn bg-white text-slate-500 border-slate-100 hover:text-emerald-600 shadow-sm">
                        <i class="fa-solid fa-users"></i>
                        Teams
                    </a>
                </div>
            </div>
        </div>

        <div class="main-scroll-area custom-scroll">
            <form id="main-form" oninput="handleFormChange()">
                <!-- SECCIÓN 1: FOLIO -->
                <div class="section-block space-y-3">
                    <h2 class="text-[9px] font-black uppercase text-emerald-600 tracking-[0.2em] border-b border-emerald-50 pb-2">Control de Folio</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group"><label class="detail-label">No. Folio</label><input type="text" id="field-Folio" class="form-input font-bold text-emerald-700" oninput="syncHeader()"></div>
                        <div class="form-group">
                            <label class="detail-label">Estatus Actual</label>
                            <select id="field-Estatus" class="form-input" onchange="syncHeader()">
                                <option value="Sin folio">Sin folio</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Entregado">Entregado</option>
                                <option value="Baja">Baja</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" id="btn-assign-folio" onclick="handleAssignFolio()" class="hidden w-full py-2.5 bg-emerald-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-md hover:brightness-110">Asignar y Entregar Marbete</button>
                </div>

                <!-- SECCIÓN 2: PROPIETARIO -->
                <div class="section-block space-y-3">
                    <h2 class="text-[9px] font-black uppercase text-emerald-600 tracking-[0.2em] border-b border-emerald-50 pb-2">Datos del Propietario</h2>
                    <div class="form-group"><label class="detail-label">Nombre Completo</label><input type="text" id="field-Nombre" class="form-input uppercase" oninput="syncHeader()"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group"><label class="detail-label">No. Socio</label><input type="text" id="field-No de socio" class="form-input"></div>
                        <div class="form-group"><label class="detail-label">Teléfono</label><input type="text" id="field-Teléfono" class="form-input"></div>
                    </div>
                    <div class="form-group"><label class="detail-label">Correo</label><input type="email" id="field-Correo" class="form-input lowercase"></div>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="form-group"><label class="detail-label">Puesto</label><input type="text" id="field-Puesto" class="form-input text-[11px]"></div>
                        <div class="form-group"><label class="detail-label">Área</label><input type="text" id="field-Area" class="form-input text-[11px]"></div>
                        <div class="form-group"><label class="detail-label">Negocio</label><input type="text" id="field-Negocio" class="form-input text-[11px]"></div>
                    </div>
                </div>

                <!-- SECCIÓN 3: VEHÍCULO -->
                <div class="section-block space-y-3">
                    <h2 class="text-[9px] font-black uppercase text-emerald-600 tracking-[0.2em] border-b border-emerald-50 pb-2">Detalles del Vehículo</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-group"><label class="detail-label">Placas</label><input type="text" id="field-Placas" class="form-input font-mono uppercase"></div>
                        <div class="form-group"><label class="detail-label">Color</label><input type="text" id="field-Color" class="form-input uppercase"></div>
                        <div class="form-group"><label class="detail-label">Marca</label><input type="text" id="field-Marca" class="form-input uppercase"></div>
                        <div class="form-group"><label class="detail-label">Modelo</label><input type="text" id="field-Modelo" class="form-input uppercase"></div>
                        <div class="form-group"><label class="detail-label">Motor</label><input type="text" id="field-Tipo de motor" class="form-input"></div>
                        <div class="form-group"><label class="detail-label">Trámite</label><input type="text" id="field-Tipo" class="form-input"></div>
                    </div>
                </div>

                <div class="form-group px-1 pb-4">
                    <label class="detail-label">Observaciones</label>
                    <textarea id="field-Comentario" class="form-input min-h-[60px] resize-none text-xs" placeholder="Notas adicionales..."></textarea>
                </div>
            </form>

            <input type="hidden" id="field-IDFila">
            <input type="hidden" id="field-PartId">
        </div>

        <!-- FOOTER: Botones de Sincro y Cierre -->
        <div class="save-footer">
            <button onclick="closePanel()" class="bg-slate-100 text-slate-600 font-black uppercase tracking-widest text-[9px] py-4 rounded-2xl border border-slate-200 hover:bg-slate-200 transition-all active:scale-[0.98]">Cerrar Detalle</button>
            <button onclick="handleExcelSave()" id="btn-save-excel" class="bg-slate-900 text-white font-black uppercase tracking-widest text-[9px] py-4 rounded-2xl shadow-lg hover:bg-emerald-800 transition-all active:scale-[0.98]">Subir a Excel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const API_EXCEL = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ef2d2f799b76471f9d826c4da323c548/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Dm2VAKxKYse9NcZL_qdi6DbOAPEBmdTZKaslmg67mVE";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            messagingSenderId: "248659087868",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';

        let currentItem = null;
        let autoSaveTimer = null;
        let currentUser = null;

        /**
         * Convierte serie de Excel a String DD/MM/YYYY ajustado a Mexico City (UTC-6)
         */
        function processExcelDate(val) {
            if (!val || isNaN(val) || typeof val === 'string') return val || '---';
            try {
                const date = new Date(Math.round((val - 25569) * 86400 * 1000));
                return new Intl.DateTimeFormat('es-MX', {
                    timeZone: 'America/Mexico_City',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }).format(date);
            } catch (e) { 
                return val; 
            }
        }

        window.closePanel = () => {
            window.parent.postMessage({ action: 'closeRightPanel' }, '*');
        };

        window.syncHeader = () => {
            const folio = String(document.getElementById('field-Folio').value || "");
            const nombre = document.getElementById('field-Nombre').value;
            const estatus = String(document.getElementById('field-Estatus').value || "").toLowerCase();
            
            document.getElementById('header-nombre').innerText = String(nombre || '').toUpperCase() || 'SIN NOMBRE';
            
            const headerContainer = document.getElementById('sticky-header-container');
            const bajaBanner = document.getElementById('baja-banner');
            
            if (estatus === 'baja') {
                headerContainer.classList.add('header-baja-active');
                bajaBanner.style.display = 'block';
            } else {
                headerContainer.classList.remove('header-baja-active');
                bajaBanner.style.display = 'none';
            }

            const visual = document.getElementById('visual-marbete');
            const display = document.getElementById('marbete-num-display');
            let digits = folio.length >= 5 ? folio.slice(-4) : folio.padStart(4, '0');
            
            if (folio.length >= 5) {
                visual.style.backgroundColor = "var(--marbete-red)";
                visual.style.color = "white";
            } else {
                visual.style.backgroundColor = "white";
                visual.style.color = "black";
            }

            display.innerHTML = Array.from(digits).map(d => `<div class="digit">${d}</div>`).join('');
            
            const btnAssign = document.getElementById('btn-assign-folio');
            if (estatus === "sin folio" || estatus === "pendiente") btnAssign.classList.remove('hidden');
            else btnAssign.classList.add('hidden');
        };

        window.handleFormChange = () => {
            const statusBar = document.getElementById('sync-status-bar');
            const statusText = document.getElementById('sync-text');
            const statusDot = document.getElementById('sync-dot');
            
            statusBar.className = "sync-status-bar sync-saving";
            statusText.innerText = "Guardando cambios...";
            statusDot.classList.remove('hidden');
            
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(saveToFirebase, 800); 
        };

        async function saveToFirebase() {
            const statusBar = document.getElementById('sync-status-bar');
            const statusText = document.getElementById('sync-text');
            const statusDot = document.getElementById('sync-dot');
            
            const partId = document.getElementById('field-PartId').value;
            const idFila = document.getElementById('field-IDFila').value;

            if (!partId || !idFila || !currentUser) return;

            const payload = collectFormData();

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'Marbetes', partId);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    let items = snap.data().items;
                    const idx = items.findIndex(i => i.IDFila == idFila);
                    
                    if (idx !== -1) {
                        items[idx] = { ...items[idx], ...payload, excel_sync: false };
                        await updateDoc(docRef, { items: items });
                        
                        statusText.innerText = "Sincronizado con Cloud";
                        statusBar.className = "sync-status-bar sync-done";
                        statusDot.classList.add('hidden');
                        
                        setTimeout(() => {
                            if (statusBar.classList.contains('sync-done')) {
                                statusBar.className = "sync-status-bar";
                                statusText.innerText = "Conectado a Cloud";
                            }
                        }, 2000);
                    }
                }
            } catch (err) {
                console.error(err);
                statusText.innerText = "Error de Guardado";
                statusBar.className = "sync-status-bar sync-error";
                statusDot.classList.add('hidden');
            }
        }

        function collectFormData() {
            return {
                "Folio": document.getElementById('field-Folio').value,
                "Estatus": document.getElementById('field-Estatus').value,
                "Nombre": document.getElementById('field-Nombre').value,
                "No de socio": document.getElementById('field-No de socio').value,
                "Teléfono": document.getElementById('field-Teléfono').value,
                "Correo": document.getElementById('field-Correo').value,
                "Marca": document.getElementById('field-Marca').value,
                "Modelo": document.getElementById('field-Modelo').value,
                "Placas": document.getElementById('field-Placas').value,
                "Color": document.getElementById('field-Color').value,
                "Puesto": document.getElementById('field-Puesto').value,
                "Area": document.getElementById('field-Area').value,
                "Negocio": document.getElementById('field-Negocio').value,
                "Tipo de motor": document.getElementById('field-Tipo de motor').value,
                "Tipo": document.getElementById('field-Tipo').value,
                "Comentario": document.getElementById('field-Comentario').value,
                "IDFila": document.getElementById('field-IDFila').value
            };
        }

        window.handleExcelSave = async () => {
            const loader = document.getElementById('loading-overlay');
            const btn = document.getElementById('btn-save-excel');
            const payload = collectFormData();
            const partId = document.getElementById('field-PartId').value;

            if (!partId) return;

            loader.style.display = 'flex';
            btn.disabled = true;

            try {
                const response = await fetch(API_EXCEL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'Marbetes', partId);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) {
                        let items = snap.data().items;
                        const idx = items.findIndex(i => i.IDFila == payload.IDFila);
                        if (idx !== -1) {
                            items[idx].excel_sync = true;
                            await updateDoc(docRef, { items: items });
                        }
                    }
                    alert("Excel Maestro Actualizado");
                } else {
                    throw new Error("Error en servidor de Excel");
                }
            } catch (err) {
                alert(`Error Excel: ${err.message}`);
            } finally {
                loader.style.display = 'none';
                btn.disabled = false;
            }
        };

        window.handleAssignFolio = () => {
            document.getElementById('assign-modal').style.display = 'flex';
            document.getElementById('modal-folio-input').value = '';
            document.getElementById('modal-folio-input').focus();
        };

        window.closeAssignModal = () => document.getElementById('assign-modal').style.display = 'none';

        window.confirmFolioAssignment = () => {
            const newF = document.getElementById('modal-folio-input').value;
            if (newF && newF.trim() !== "") {
                document.getElementById('field-Folio').value = newF.trim();
                document.getElementById('field-Estatus').value = "Entregado";
                window.syncHeader();
                window.closeAssignModal();
                window.handleFormChange();
            }
        };

        function loadForm(item) {
            if (!item) return;
            currentItem = item;

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('detail-content').style.display = 'flex';

            const fields = ["Folio", "Estatus", "Marca", "Modelo", "Color", "Placas", "Tipo de motor", "Tipo", "Nombre", "No de socio", "Teléfono", "Correo", "Puesto", "Area", "Negocio", "Comentario", "IDFila"];
            fields.forEach(f => {
                const input = document.getElementById(`field-${f}`);
                if (input) input.value = item[f] || '';
            });

            document.getElementById('field-PartId').value = item.__docId || '';
            document.getElementById('tag-fecha-solicitud').innerText = processExcelDate(item["Fecha de solicitud"]);
            document.getElementById('tag-fecha-asignacion').innerText = processExcelDate(item["Fecha de asignación"]);

            window.syncHeader();

            const rawTel = String(item.Teléfono || "");
            const cleanT = rawTel.replace(/\D/g, '');
            const email = item.Correo || "";
            const formattedT = cleanT.length === 10 ? '52' + cleanT : cleanT;

            document.getElementById('btn-call').href = cleanT ? `tel:${cleanT}` : '#';
            document.getElementById('btn-whatsapp').href = cleanT ? `whatsapp://send?phone=${formattedT}` : '#';
            document.getElementById('btn-email').href = email ? `mailto:${email}` : '#';
            document.getElementById('btn-teams').href = email ? `https://teams.microsoft.com/l/chat/0/0?users=${email}` : '#';
        }

        const immediateData = window.__CURRENT_MARBETE || (window.parent && window.parent.__CURRENT_MARBETE);
        if (immediateData) {
            loadForm(immediateData);
        }

        window.addEventListener('message', e => {
            if (e.data.type === 'LOAD_DATA') loadForm(e.data.data);
        });

        onAuthStateChanged(auth, u => { 
            currentUser = u; 
            if (!u) {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) signInWithCustomToken(auth, __initial_auth_token);
                else signInAnonymously(auth);
            }
        });
    </script>
</body>
</html>