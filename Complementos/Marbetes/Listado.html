<div class="flex flex-col h-full w-full bg-white overflow-hidden relative">

    <!-- Pantalla de carga inicial -->
    <div id="loading-state" class="absolute inset-0 bg-white z-[1000] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative flex items-center justify-center">
            <div class="w-12 h-12 border-4 border-emerald-50 border-t-emerald-600 rounded-full animate-spin"></div>
            <div class="absolute w-4 h-4 bg-emerald-600 rounded-full animate-pulse"></div>
        </div>
        <span class="text-[10px] font-black text-emerald-900 uppercase mt-4 tracking-widest text-center px-4">Sincronizando Base de Datos...</span>
    </div>

    <!-- Modal de Confirmación -->
    <div id="delete-modal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-trash-can text-2xl"></i>
                </div>
                <h3 class="text-lg font-black text-slate-900 uppercase">¿Eliminar Registro?</h3>
                <p class="text-[11px] text-slate-500 font-medium mt-2">Esta acción es irreversible. Escriba <span class="text-rose-600 font-black">ELIMINAR</span>:</p>
                <input type="text" id="delete-confirm-input" class="w-full mt-4 h-10 bg-slate-50 border-2 border-slate-100 rounded-xl px-4 text-center text-xs font-black uppercase outline-none transition-all focus:border-rose-500">
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="closeDeleteModal()" class="h-10 rounded-xl bg-slate-100 text-slate-600 text-[10px] font-black uppercase hover:bg-slate-200 transition-all">Cancelar</button>
                    <button id="btn-execute-delete" disabled onclick="executeDelete()" class="h-10 rounded-xl bg-rose-500 text-white text-[10px] font-black uppercase disabled:opacity-30 transition-all">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HEADER: KPIs y Filtros -->
    <div class="flex-shrink-0 z-[100] bg-white border-b border-emerald-200 shadow-sm">
        <div class="flex items-center p-2 gap-3 overflow-x-auto no-scrollbar border-b border-slate-100">
            
            <div id="bg-task-indicator" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-50 border border-emerald-100 min-w-fit">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                <span id="bg-task-text" class="text-[9px] font-black text-emerald-700 uppercase tracking-tighter">Iniciando Motor</span>
            </div>

            <div class="flex gap-2 flex-shrink-0 border-r border-slate-100 pr-3">
                <div onclick="setKpiFilter('Todos')" id="kpi-all" class="kpi-chip active">
                    <span id="count-all" class="text-xs font-black">0</span>
                    <span class="text-[8px] font-bold uppercase opacity-80">Total</span>
                </div>
                <div onclick="setKpiFilter('Sin folio')" id="kpi-nofolio" class="kpi-chip">
                    <span id="count-nofolio" class="text-xs font-black">0</span>
                    <span class="text-[8px] font-bold uppercase opacity-80">Sin Folio</span>
                </div>
                <div onclick="setKpiFilter('Pendiente')" id="kpi-pendiente" class="kpi-chip">
                    <span id="count-pending" class="text-xs font-black">0</span>
                    <span class="text-[8px] font-bold uppercase opacity-80">Pendientes</span>
                </div>
                <div onclick="setKpiFilter('Entregado')" id="kpi-entregado" class="kpi-chip">
                    <span id="count-delivered" class="text-xs font-black">0</span>
                    <span class="text-[8px] font-bold uppercase opacity-80">Entregados</span>
                </div>
                <div onclick="setKpiFilter('Baja')" id="kpi-baja" class="kpi-chip">
                    <span id="count-bajas" class="text-xs font-black">0</span>
                    <span class="text-[8px] font-bold uppercase opacity-80">Bajas</span>
                </div>
            </div>

            <div class="flex items-center gap-2 bg-slate-50 p-1 rounded-xl border border-slate-100 flex-shrink-0">
                <select id="date-type" class="bg-white border border-slate-200 rounded-lg text-[9px] font-black uppercase px-2 py-1 outline-none text-emerald-800" onchange="applyFilters()">
                    <option value="Fecha de solicitud">Solicitud</option>
                    <option value="Fecha de asignación">Asignación</option>
                </select>
                <input type="date" id="date-start" class="bg-transparent border-none text-[10px] font-bold text-slate-600 outline-none" onchange="applyFilters()">
                <span class="text-slate-300 text-xs">/</span>
                <input type="date" id="date-end" class="bg-transparent border-none text-[10px] font-bold text-slate-600 outline-none" onchange="applyFilters()">
            </div>

            <div class="flex items-center gap-2 border-l border-slate-100 pl-3">
                <button onclick="setFilterToday()" class="px-3 py-1.5 rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-700 hover:bg-emerald-600 hover:text-white transition-all text-[10px] font-black uppercase tracking-tighter">Hoy</button>
                <button onclick="clearAllFilters()" class="px-3 py-1.5 rounded-xl bg-slate-50 border border-slate-200 text-slate-600 hover:bg-rose-50 hover:text-rose-600 transition-all text-[10px] font-black uppercase tracking-tighter">Limpiar</button>
            </div>
        </div>

        <div class="p-2 bg-white flex items-center">
            <div class="relative w-full">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                <input type="text" id="search-input" class="w-full h-10 bg-slate-50 rounded-xl pl-10 pr-4 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500 uppercase placeholder-slate-400" placeholder="FOLIO, SOCIO, NOMBRE O PLACAS..." oninput="applyFilters()">
            </div>
        </div>

        <div class="flex metallic-header bg-gradient-to-r from-emerald-900 via-emerald-700 to-emerald-500">
            <div class="p-3 text-[9px] font-black uppercase text-white tracking-widest w-[8%]">Folio</div>
            <div class="p-3 text-[9px] font-black uppercase text-white tracking-widest w-[8%]">Socio</div>
            <div class="p-3 text-[9px] font-black uppercase text-white tracking-widest w-[22%]">Nombre del Titular</div>
            <div class="p-3 text-[9px] font-black uppercase text-white tracking-widest w-[20%]">Vehículo</div>
            <div class="p-3 text-[9px] font-black uppercase text-white tracking-widest w-[22%]">Puesto / Negocio</div>
            <div class="p-3 text-[9px] font-black uppercase text-white tracking-widest w-[12%] text-right">Teléfono</div>
            <div class="p-3 text-[9px] font-black uppercase text-white tracking-widest w-[8%] text-center">Acción</div>
        </div>
    </div>

    <!-- VIEWPORT: Virtual Scroll -->
    <div id="viewport" class="flex-1 overflow-y-auto relative bg-white scroll-smooth">
        <div id="v-spacer" style="width: 100%; pointer-events: none;"></div>
        <div id="v-content" class="absolute top-0 left-0 w-full"></div>
    </div>

</div>

<style>
    .kpi-chip { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 85px; padding: 4px; border-radius: 12px; background: white; border: 1.5px solid #e2e8f0; cursor: pointer; transition: all 0.2s; }
    .kpi-chip:hover { border-color: #10b981; transform: translateY(-1px); }
    .kpi-chip.active { background: #065f46; color: white; border-color: #064e3b; box-shadow: 0 4px 10px rgba(5, 150, 105, 0.2); }
    .data-row { position: absolute; width: 100%; display: flex; align-items: center; border-bottom: 1px solid #f1f5f9; cursor: pointer; height: 52px; transition: background 0.1s; }
    .data-row:hover { background-color: #f0fdf4; }
    .cell-content { padding: 0 16px; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    mark { background-color: #fef08a; color: #1e293b; font-weight: 800; border-radius: 2px; padding: 0 2px; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
</style>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, deleteField, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    import { firebaseConfig } from '../../script.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';
    const PA_API_URL = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/fe7a46f4aa314e7a993bc66528b0d03b/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=mTepaYfQc_U2RF4I-tX0PNhrniM2OgcErzU9gDtA0fw";

    const ROW_HEIGHT = 52;
    let allData = []; 
    let filteredData = [];
    let currentKpiFilter = "Todos";
    let isProcessing = false;
    let itemToDelete = null;

    const dom = {
        viewport: document.getElementById('viewport'),
        vSpacer: document.getElementById('v-spacer'),
        vContent: document.getElementById('v-content'),
        bgText: document.getElementById('bg-task-text'),
        loader: document.getElementById('loading-state'),
        searchInput: document.getElementById('search-input'),
        deleteInput: document.getElementById('delete-confirm-input'),
        btnExecuteDelete: document.getElementById('btn-execute-delete')
    };

    function processExcelDate(val) {
        if (!val || isNaN(val) || typeof val === 'string') return val || '';
        try {
            const date = new Date(Math.round((val - 25569) * 86400 * 1000));
            return new Intl.DateTimeFormat('es-MX', {
                timeZone: 'America/Mexico_City', day: '2-digit', month: '2-digit', year: 'numeric'
            }).format(date);
        } catch (e) { return val; }
    }

    function normalizeMarbete(item, docId = null) {
        const normalized = { ...item };
        if (docId) normalized.__docId = docId;
        normalized["Fecha de solicitud"] = processExcelDate(normalized["Fecha de solicitud"]);
        normalized["Fecha de asignación"] = processExcelDate(normalized["Fecha de asignación"]);
        return normalized;
    }

    // --- MOTOR LOCAL (INDEXED DB) ---
    const initDB = () => new Promise(res => {
        const req = indexedDB.open("CIC_Marbetes_Local", 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore("cache");
        req.onsuccess = e => res(e.target.result);
    });

    const saveLocal = async (data) => {
        const idb = await initDB();
        return new Promise(resolve => {
            const tx = idb.transaction("cache", "readwrite");
            tx.objectStore("cache").put(data, "master");
            tx.oncomplete = resolve;
        });
    };

    const getLocal = async () => {
        const idb = await initDB();
        return new Promise(res => {
            const req = idb.transaction("cache", "readonly").objectStore("cache").get("master");
            req.onsuccess = () => res(req.result || []);
            req.onerror = () => res([]);
        });
    };

    // --- LÓGICA DE DATOS ---
    async function startDataEngine() {
        updateBgStatus("Consultando Nube...");
        
        try {
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Marbetes'));
            if (!snap.empty) {
                let cloudDataMap = new Map();
                snap.forEach(d => {
                    (d.data().items || []).forEach(i => {
                        const normalized = normalizeMarbete(i, d.id);
                        cloudDataMap.set(normalized.IDFila, normalized);
                    });
                });
                allData = Array.from(cloudDataMap.values());
                updateBgStatus("Nube Lista");
                finishInitialLoad();
                return;
            }
        } catch (e) { console.warn("Firebase falló:", e); }

        updateBgStatus("Buscando en Local...");
        const cached = await getLocal();
        if (cached && cached.length > 0) {
            allData = cached; 
            updateBgStatus("Usando Caché Local");
            finishInitialLoad();
            // RE-SINCRONIZACIÓN INMEDIATA: Si cargamos local, buscamos Excel para ver si cambió algo.
            backgroundWorker(); 
            return;
        }

        await fetchExcelMaster();
        finishInitialLoad();
    }

    async function fetchExcelMaster() {
        updateBgStatus("Conectando Excel API...");
        try {
            const res = await fetch(PA_API_URL, { method: 'POST' });
            const data = await res.json();
            let excelMap = new Map();
            (data.result || []).forEach(i => {
                const normalized = normalizeMarbete(i);
                excelMap.set(normalized.IDFila, normalized);
            });
            
            if (excelMap.size > 0) {
                allData = Array.from(excelMap.values());
                updateBgStatus("Excel Sincronizado");
                // SUBIR A FIREBASE (Aseguramos la nube)
                await uploadToFirebase(allData);
                await saveLocal(allData);
            }
        } catch (e) {
            updateBgStatus("Sin conexión");
        }
    }

    function finishInitialLoad() {
        dom.loader.classList.add('opacity-0');
        setTimeout(() => dom.loader.style.display = 'none', 500);
        updateKPIs();
        applyFilters();
    }

    // --- BACKGROUND WORKER ---
    async function backgroundWorker() {
        if (isProcessing) return;
        isProcessing = true;
        updateBgStatus("Sincronizando Excel...");

        try {
            const res = await fetch(PA_API_URL, { method: 'POST' });
            const data = await res.json();
            const latestExcel = (data.result || []).map(i => normalizeMarbete(i));
            
            let hasChanges = false;
            const currentMap = new Map(allData.map(i => [i.IDFila, i]));

            latestExcel.forEach(excelItem => {
                const existing = currentMap.get(excelItem.IDFila);
                if (!existing || JSON.stringify(existing) !== JSON.stringify(excelItem)) {
                    currentMap.set(excelItem.IDFila, excelItem);
                    hasChanges = true;
                }
            });

            if (hasChanges) {
                updateBgStatus("Actualizando Repositorio...");
                allData = Array.from(currentMap.values());
                // Aseguramos que la Nube y el Local reciban los nuevos datos
                await uploadToFirebase(allData);
                await saveLocal(allData);
                applyFilters();
                updateKPIs();
                updateBgStatus("Sistema al día");
            } else {
                updateBgStatus("Listo");
            }
        } catch (e) {
            console.error("Worker error:", e);
            updateBgStatus("Error de Sincro");
        } finally {
            isProcessing = false;
        }
    }

    async function uploadToFirebase(items) {
        if (!items || items.length === 0) return;
        updateBgStatus("Escribiendo en Nube...");
        const chunkSize = 1000;
        const totalItems = items.length;
        
        const promises = [];
        for (let i = 0; i < totalItems; i += chunkSize) {
            const part = Math.floor(i / chunkSize) + 1;
            const chunk = items.slice(i, i + chunkSize);
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'Marbetes', `Part${part}`);
            promises.push(setDoc(docRef, { items: chunk, lastUpdate: new Date().toISOString() }));
        }
        
        try {
            await Promise.all(promises);
            updateBgStatus("Nube Actualizada");
        } catch (err) {
            console.error("Error subiendo a Firebase:", err);
            updateBgStatus("Fallo en Nube");
        }
    }

    function updateBgStatus(text) {
        dom.bgText.textContent = text;
    }

    // --- FILTROS Y VIRTUALIZACIÓN ---
    window.applyFilters = () => {
        const query = dom.searchInput.value.toLowerCase().trim();
        const queryParts = query.split(' ').filter(p => p.length > 0);
        const kpi = currentKpiFilter;
        
        const dateType = document.getElementById('date-type').value;
        const startVal = document.getElementById('date-start').value;
        const endVal = document.getElementById('date-end').value;
        const startLimit = startVal ? new Date(startVal + "T00:00:00") : null;
        const endLimit = endVal ? new Date(endVal + "T23:59:59") : null;

        filteredData = allData.filter(item => {
            if (kpi !== "Todos" && (item.Estatus || '').toLowerCase() !== kpi.toLowerCase()) return false;
            if (startLimit || endLimit) {
                const val = item[dateType]; 
                if (!val || typeof val !== 'string' || !val.includes('/')) return false;
                const [d, m, y] = val.split('/').map(Number);
                const itemDate = new Date(y, m - 1, d);
                if (startLimit && itemDate < startLimit) return false;
                if (endLimit && itemDate > endLimit) return false;
            }
            if (queryParts.length === 0) return true;
            const pool = `${item.Folio} ${item.Nombre} ${item.Titular} ${item.Placas} ${item["No de socio"]} ${item.Puesto} ${item.Negocio}`.toLowerCase();
            return queryParts.every(p => pool.includes(p));
        });

        filteredData.sort((a,b) => (b.IDFila || 0) - (a.IDFila || 0));
        dom.vSpacer.style.height = `${filteredData.length * ROW_HEIGHT}px`;
        renderVirtual();
    };

    function renderVirtual() {
        const scrollTop = dom.viewport.scrollTop;
        const viewportHeight = dom.viewport.clientHeight;
        let startIdx = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - 2);
        let endIdx = Math.min(startIdx + Math.ceil(viewportHeight / ROW_HEIGHT) + 8, filteredData.length);
        
        dom.vContent.style.transform = `translateY(${startIdx * ROW_HEIGHT}px)`;
        const slice = filteredData.slice(startIdx, endIdx);
        const queryParts = dom.searchInput.value.toLowerCase().trim().split(' ').filter(p => p.length > 0);
        
        dom.vContent.innerHTML = slice.map((item, idx) => {
            const socio = item["No de socio"] || item.Socio || '---';
            return `
                <div class="data-row" style="top: ${idx * ROW_HEIGHT}px;" onclick="handleItemClick(${startIdx + idx})">
                    <div class="cell-content font-mono font-black text-emerald-800 w-[8%]">${item.Folio || '---'}</div>
                    <div class="cell-content font-black text-slate-400 w-[8%]">${socio}</div>
                    <div class="cell-content font-bold text-slate-800 uppercase w-[22%]">${highlightText(item.Nombre || item.Titular || '---', queryParts)}</div>
                    <div class="cell-content text-slate-500 italic w-[20%]">${item.Marca || ''} ${item.Modelo || ''} (${item.Placas || '---'})</div>
                    <div class="cell-content text-[10px] text-slate-600 font-semibold w-[22%]">${item.Puesto || '---'}</div>
                    <div class="cell-content text-right font-mono text-slate-400 font-bold w-[12%]">${item.Teléfono || '---'}</div>
                    <div class="cell-content w-[8%] text-center">
                         <button onclick="event.stopPropagation(); requestDelete(${startIdx + idx})" class="text-rose-400 hover:text-rose-600 transition-colors p-2"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }

    const highlightText = (text, queryParts) => {
        if (!queryParts.length || !text) return text;
        const regex = new RegExp(`(${queryParts.join('|')})`, 'gi');
        return String(text).replace(regex, '<mark>$1</mark>');
    };

    function updateKPIs() {
        const getLen = (s) => allData.filter(d => (d.Estatus || '').toLowerCase() === s).length;
        document.getElementById('count-all').innerText = allData.length;
        document.getElementById('count-nofolio').innerText = getLen('sin folio');
        document.getElementById('count-pending').innerText = getLen('pendiente');
        document.getElementById('count-delivered').innerText = getLen('entregado');
        document.getElementById('count-bajas').innerText = getLen('baja');
    }

    window.setKpiFilter = (s) => {
        currentKpiFilter = s;
        document.querySelectorAll('.kpi-chip').forEach(c => c.classList.remove('active'));
        const ids = { "Todos": "kpi-all", "Sin folio": "kpi-nofolio", "Pendiente": "kpi-pendiente", "Entregado": "kpi-entregado", "Baja": "kpi-baja" };
        document.getElementById(ids[s])?.classList.add('active');
        applyFilters();
    };

    window.setFilterToday = () => {
        const mexDate = new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Mexico_City' });
        document.getElementById('date-start').value = mexDate;
        document.getElementById('date-end').value = mexDate;
        document.getElementById('date-type').value = "Fecha de solicitud";
        applyFilters();
    };

    window.clearAllFilters = () => {
        dom.searchInput.value = "";
        document.getElementById('date-start').value = "";
        document.getElementById('date-end').value = "";
        setKpiFilter('Todos');
    };

    window.requestDelete = (index) => {
        itemToDelete = filteredData[index];
        if (!itemToDelete) return;
        document.getElementById('delete-modal').classList.remove('hidden');
        dom.deleteInput.value = "";
        dom.btnExecuteDelete.disabled = true;
    };

    window.closeDeleteModal = () => { document.getElementById('delete-modal').classList.add('hidden'); itemToDelete = null; };

    dom.deleteInput.oninput = (e) => {
        dom.btnExecuteDelete.disabled = (e.target.value.trim().toUpperCase() !== "ELIMINAR");
    };

    window.executeDelete = async () => {
        if (!itemToDelete) return;
        updateBgStatus("Eliminando...");
        try {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'Marbetes', itemToDelete.__docId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const updatedItems = docSnap.data().items.filter(i => i.IDFila !== itemToDelete.IDFila);
                await updateDoc(docRef, { items: updatedItems });
                allData = allData.filter(d => d.IDFila !== itemToDelete.IDFila);
                await saveLocal(allData);
                updateKPIs();
                applyFilters();
            }
        } catch (e) { console.error(e); } 
        finally { closeDeleteModal(); updateBgStatus("Listo"); }
    };

    window.handleItemClick = (index) => { 
        const item = filteredData[index];
        if (item) {
            window.parent.__CURRENT_MARBETE = item;
            window.parent.postMessage({ action: 'openRightPanel', content: `<iframe src="../Complementos/Marbetes/Detalle.html?id=${item.IDFila}" class="w-full h-full border-none"></iframe>` }, '*');
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            await startDataEngine();
            setInterval(backgroundWorker, 5 * 60 * 1000);
        } else {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
        }
    });

    dom.viewport.onscroll = renderVirtual;
</script>