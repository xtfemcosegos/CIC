<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Diario - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Librería para captura de pantalla -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --metal-fuchsia-dark: #1a031c;
            --metal-fuchsia-mid: #4a044e;
            --metal-fuchsia-light: #701a75;
            --md-primary: var(--metal-fuchsia-mid);
            --md-surface: #f8fafc;
            --md-outline: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--md-surface);
            color: #1e293b;
            padding: 12px;
            margin: 0;
            box-sizing: border-box;
        }

        #report-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 10px 25px rgba(30, 27, 75, 0.05);
            overflow: hidden;
            border: 1px solid var(--md-outline);
        }

        .report-header {
            background: linear-gradient(135deg, var(--metal-fuchsia-dark) 0%, var(--metal-fuchsia-mid) 100%);
            color: white;
            padding: 32px;
            position: relative;
            overflow: hidden;
        }
        
        .report-header::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 11px);
        }

        .shift-divider {
            background: #0f172a;
            color: white;
            padding: 12px 24px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-divider.absences { background: #be185d; }

        .table-container { background: white; overflow: hidden; }
        .table-responsive { width: 100%; overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 950px; }
        th { 
            background: #f8fafc; padding: 12px 8px; text-align: left; 
            font-size: 10px; font-weight: 900; text-transform: uppercase; 
            color: #64748b; border-bottom: 2px solid #f1f5f9; letter-spacing: 0.05em;
        }
        td { padding: 12px 8px; font-size: 13px; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle; }

        .col-id { width: 80px; }
        .col-nombre { width: 280px; } 
        .col-estado { width: auto; }
        .col-tiempo { width: 90px; }
        .col-comentario { width: 200px; }
        .col-accion { width: 50px; text-align: center; }

        .badge {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 4px 10px; border-radius: 6px; font-size: 9px; font-weight: 800;
            text-transform: uppercase; white-space: nowrap; line-height: 1;
        }
        .bg-in-turn { background: #fdf2f8; color: #701a75; border: 1px solid #fbcfe8; }
        .bg-finished { background: #f1f5f9; color: #64748b; }
        .bg-late { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .bg-special { background: #ede9fe; color: #4c1d95; }
        .bg-holiday { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
        
        /* Estilos específicos de ausentismo */
        .badge-vacaciones { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-falta { background: #fef08a; color: #b91c1c; border: 1px solid #fde047; }
        .badge-suspension { background: #ffedd5; color: #9a3412; border: 2px solid #ef4444; }
        .badge-permiso { background: #fff7ed; color: #c2410c; border: 2px solid #22c55e; }
        .badge-default-abs { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }

        .input-date {
            background: white; border: 2px solid var(--md-outline);
            border-radius: 12px; padding: 8px 16px; font-size: 12px;
            font-weight: 800; color: var(--metal-fuchsia-dark); outline: none;
        }
        .mode-btn {
            padding: 8px 16px; font-size: 10px; font-weight: 800;
            text-transform: uppercase; border-radius: 9px; transition: all 0.2s; color: #64748b;
        }
        .mode-btn.active { background: white; color: var(--metal-fuchsia-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .detail-btn {
            width: 28px; height: 28px; border-radius: 8px; background: #f1f5f9;
            display: flex; align-items: center; justify-content: center; color: #64748b;
            transition: all 0.2s; border: 1px solid #e2e8f0;
        }
        .detail-btn:hover { background: #d946ef; color: white; border-color: #d946ef; }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(26, 3, 28, 0.4); backdrop-filter: blur(8px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content { background: white; border-radius: 24px; width: 90%; max-width: 420px; padding: 32px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Modal de Envío de Correo -->
    <div id="email-modal" class="modal-overlay">
        <div class="modal-content space-y-6">
            <div class="text-center">
                <div class="w-12 h-12 bg-fuchsia-100 text-fuchsia-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </div>
                <h3 class="text-lg font-black uppercase text-indigo-950 tracking-tight">Enviar Reporte</h3>
                <p class="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Sincronización Automática</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="setEmailPreset('prueba')" class="flex-1 py-2 px-3 bg-slate-100 hover:bg-slate-200 rounded-xl text-[10px] font-black uppercase text-slate-600 transition-all">Prueba</button>
                <button onclick="setEmailPreset('default')" class="flex-1 py-2 px-3 bg-fuchsia-50 hover:bg-fuchsia-100 rounded-xl text-[10px] font-black uppercase text-fuchsia-900 transition-all">Oficial</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">Destinatarios:</label>
                    <input type="text" id="email-to" class="w-full bg-slate-50 border-2 border-slate-100 focus:border-fuchsia-600 rounded-xl px-4 py-3 text-[13px] font-semibold outline-none transition-all" placeholder="correo@ejemplo.com">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">CC (Copia):</label>
                    <input type="text" id="email-cc" class="w-full bg-slate-50 border-2 border-slate-100 focus:border-fuchsia-600 rounded-xl px-4 py-3 text-[13px] font-semibold outline-none transition-all" placeholder="Copia a...">
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="closeEmailModal()" class="flex-1 py-3 text-[11px] font-black uppercase text-slate-400 hover:text-slate-600">Cerrar</button>
                <button id="btn-confirm-send" onclick="prepareAndSend()" class="flex-[2] bg-indigo-950 text-white rounded-xl py-3 text-[11px] font-black uppercase shadow-lg active:scale-95 transition-all">Confirmar Envío</button>
            </div>
        </div>
    </div>

    <div class="max-w-full mx-auto space-y-6">
        
        <!-- Controles Superiores -->
        <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm flex flex-col lg:flex-row items-center justify-between gap-6">
            <div class="flex flex-wrap items-center gap-8">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Filtro Operativo</label>
                    <div class="flex bg-slate-100 p-1 rounded-xl gap-1">
                        <button id="btn-diurno" onclick="setMode('diurno')" class="mode-btn active">Diurno (Hoy)</button>
                        <button id="btn-nocturno" onclick="setMode('nocturno')" class="mode-btn">Nocturno (N-1/Hoy)</button>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Fecha de Corte</label>
                    <input type="date" id="report-date" onchange="loadData()" class="input-date">
                </div>
            </div>

            <button onclick="openEmailModal()" class="py-3 px-8 bg-fuchsia-900 text-white rounded-2xl text-[11px] font-black uppercase shadow-lg hover:bg-fuchsia-800 transition-all flex items-center gap-3">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                Enviar Reporte
            </button>
        </div>

        <!-- El Reporte Visual -->
        <div id="report-content">
            <header class="report-header">
                <h1 class="text-3xl font-black uppercase tracking-tighter leading-none mb-1">Informe de Asistencia</h1>
                <p id="formatted-date" class="text-fuchsia-200/80 text-[12px] font-bold uppercase tracking-[0.2em]">Cargando fecha...</p>
            </header>

            <div id="tables-container" class="p-2 space-y-4">
                <!-- Se inyectan las tablas aquí -->
            </div>
        </div>

        <div id="loading-state" class="hidden flex flex-col items-center justify-center py-20 gap-4">
            <div class="w-10 h-10 border-4 border-fuchsia-900 border-t-transparent rounded-full animate-spin"></div>
            <span class="text-[10px] font-black uppercase tracking-widest text-fuchsia-900/40">Sincronizando Base de Datos</span>
        </div>
    </div>

    <script type="module">
        import { firebaseConfig } from '../../script.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';

        const casetaOrder = ["Centro de control", "Encargado", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero"];
        const POWER_AUTOMATE_API = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/507bea91c30c4743b4749a474f92ad3f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=PzEbbL5wNoHu-b78wQtE7JP0H-RKDb3btp2iHGbM6vU";

        let currentMode = 'diurno';
        let personnelMap = {};
        let activeUnsubscribes = [];

        const dom = {
            dateInput: document.getElementById('report-date'),
            container: document.getElementById('tables-container'),
            loading: document.getElementById('loading-state'),
            dateLabel: document.getElementById('formatted-date'),
            emailModal: document.getElementById('email-modal')
        };

        const today = new Date();
        today.setHours(12,0,0,0);
        dom.dateInput.value = today.toISOString().split('T')[0];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await fetchPersonnel();
                loadData();
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        async function fetchPersonnel() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', 'ElementosPP');
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                personnelMap = snap.data();
            }
        }

        window.setMode = (mode) => {
            currentMode = mode;
            document.getElementById('btn-diurno').classList.toggle('active', mode === 'diurno');
            document.getElementById('btn-nocturno').classList.toggle('active', mode === 'nocturno');
            loadData();
        };

        window.loadData = function() {
            activeUnsubscribes.forEach(u => u());
            activeUnsubscribes = [];

            const rawDate = dom.dateInput.value;
            if(!rawDate) return;

            const dObj = new Date(rawDate + "T12:00:00");
            dom.dateLabel.innerText = dObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();

            dom.loading.classList.remove('hidden');
            dom.container.innerHTML = '';

            const dateN = rawDate;
            const dateNMinus1Obj = new Date(dObj);
            dateNMinus1Obj.setDate(dateNMinus1Obj.getDate() - 1);
            const dateNMinus1 = dateNMinus1Obj.toISOString().split('T')[0];

            let sections = [];
            if (currentMode === 'diurno') {
                sections = [
                    { id: 'matutino', label: 'Turno Matutino', date: dateN },
                    { id: 'vespertino', label: 'Turno Vespertino', date: dateN },
                    { id: 'nocturno', label: 'Turno Nocturno', date: dateN }
                ];
            } else {
                sections = [
                    { id: 'nocturno', label: 'Turno Nocturno Anterior', date: dateNMinus1 },
                    { id: 'matutino', label: 'Turno Matutino Hoy', date: dateN }
                ];
            }

            const trimKeys = [...new Set(sections.map(s => {
                const parts = s.date.split('-');
                return `Trim${Math.ceil(parseInt(parts[1])/3)}-${parts[0]}`;
            }))];

            const cacheData = {};
            let loaded = 0;

            trimKeys.forEach(trimId => {
                const trimRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', trimId);
                const unsub = onSnapshot(trimRef, (snap) => {
                    cacheData[trimId] = snap.exists() ? snap.data() : {};
                    loaded++;
                    if (loaded >= trimKeys.length) processReport(sections, cacheData);
                });
                activeUnsubscribes.push(unsub);
            });
        };

        function processReport(sections, cacheData) {
            dom.container.innerHTML = '';
            dom.loading.classList.add('hidden');

            // 1. Renderizar Turnos Operativos
            sections.forEach(sec => {
                const parts = sec.date.split('-');
                const dateId = `${parts[2]}${parts[1]}${parts[0]}`;
                const trimId = `Trim${Math.ceil(parseInt(parts[1])/3)}-${parts[0]}`;
                
                const dayData = cacheData[trimId]?.[dateId] || {};
                let list = Object.entries(dayData)
                    .filter(([sid, shifts]) => shifts[sec.id])
                    .map(([sid, shifts]) => {
                        const personnelKey = Object.keys(personnelMap).find(k => (personnelMap[k].socioId === sid || k === sid));
                        const user = personnelMap[personnelKey] || { nombre: 'S/N', socioId: sid };
                        return { sid, uid: personnelKey || sid, nombre: user.nombre, id_empleado: user.socioId, ...shifts[sec.id] };
                    });

                if (list.length > 0) renderSection(sec.label, list, sec.id, sec.date);
            });

            // 2. Renderizar Ausentismos e Incidencias (Excluyendo Descansos)
            const rawDate = dom.dateInput.value;
            const parts = rawDate.split('-');
            const dateId = `${parts[2]}${parts[1]}${parts[0]}`;
            const trimId = `Trim${Math.ceil(parseInt(parts[1])/3)}-${parts[0]}`;
            const dayData = cacheData[trimId]?.[dateId] || {};

            let absencesList = Object.entries(dayData)
                .filter(([sid, shifts]) => shifts.ausentismo && shifts.ausentismo.motivo !== "Descanso")
                .map(([sid, shifts]) => {
                    const personnelKey = Object.keys(personnelMap).find(k => (personnelMap[k].socioId === sid || k === sid));
                    const user = personnelMap[personnelKey] || { nombre: 'S/N', socioId: sid };
                    return { 
                        sid, 
                        uid: personnelKey || sid,
                        nombre: user.nombre, 
                        id_empleado: user.socioId, 
                        ...shifts.ausentismo, 
                        isAbsenceSection: true 
                    };
                });

            if (absencesList.length > 0) {
                renderSection("Ausentismos e Incidencias", absencesList, "ausentismo", rawDate);
            }
        }

        function renderSection(label, list, type, date) {
            const isAbsence = type === "ausentismo";

            list.sort((a, b) => {
                if (!isAbsence) {
                    const idxA = casetaOrder.findIndex(c => (a.Caseta || "").toLowerCase().includes(c.toLowerCase()));
                    const idxB = casetaOrder.findIndex(c => (b.Caseta || "").toLowerCase().includes(c.toLowerCase()));
                    const prioA = idxA === -1 ? 99 : idxA;
                    const prioB = idxB === -1 ? 99 : idxB;
                    if (prioA !== prioB) return prioA - prioB;
                }
                return a.nombre.localeCompare(b.nombre);
            });

            const headerDate = new Date(date + "T12:00:00").toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }).toUpperCase();
            
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="shift-divider ${isAbsence ? 'absences' : ''}">
                    <span>${label}</span>
                    <span class="opacity-40">${headerDate}</span>
                </div>
                <div class="table-container"><div class="table-responsive"><table>
                    <thead><tr>
                        <th class="col-id">ID</th><th class="col-nombre">Nombre</th><th class="col-estado">Estado / Incidencia</th>
                        <th class="col-tiempo">${isAbsence ? 'Origen' : 'Entrada'}</th>
                        <th class="col-tiempo">${isAbsence ? '---' : 'Salida'}</th>
                        <th class="col-comentario">Observaciones</th>
                        <th class="col-accion"></th>
                    </tr></thead>
                    <tbody>${list.map(item => `
                        <tr>
                            <td class="font-mono text-[11px] text-slate-400">${item.id_empleado}</td>
                            <td class="font-bold text-indigo-950">${item.nombre}</td>
                            <td><div class="flex flex-wrap gap-1">${renderStatus(item)}</div></td>
                            <td class="font-bold text-slate-500 font-mono text-[11px] uppercase">${isAbsence ? (item.originShift || 'N/A') : (item.entrada_real || '--:--')}</td>
                            <td class="font-bold text-slate-400 font-mono text-[11px]">${isAbsence ? '---' : (item.salida_real || '--:--')}</td>
                            <td class="italic text-slate-400 text-[11px]">${item.comentario || ''}</td>
                            <td class="col-accion">
                                <button onclick="openDetails('${item.uid}', '${date}')" class="detail-btn no-print" title="Ver Detalle">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                            </td>
                        </tr>
                    `).join('')}</tbody>
                </table></div></div>
            `;
            dom.container.appendChild(div);
        }

        function renderStatus(item) {
            if (item.isAbsenceSection) {
                const motivo = (item.motivo || "").toLowerCase();
                let cls = "badge-default-abs";
                
                if (motivo.includes("vacaciones")) cls = "badge-vacaciones";
                else if (motivo.includes("falta")) cls = "badge-falta";
                else if (motivo.includes("suspensión") || motivo.includes("suspension")) cls = "badge-suspension";
                else if (motivo.includes("permiso")) cls = "badge-permiso";

                return `<span class="badge ${cls}">${item.motivo}</span>`;
            }

            // Estado base de asistencia para turnos normales
            let html = item.salida_real ? '<span class="badge bg-finished">Finalizado</span>' : 
                       (item.entrada_real ? '<span class="badge bg-in-turn">En Turno</span>' : '<span class="badge bg-finished opacity-40">Pendiente</span>');
            
            if (item.retardo) html += '<span class="badge bg-late ml-1">Retardo</span>';
            if (item.es_festivo) html += '<span class="badge bg-holiday ml-1">Festivo</span>';
            if (item.es_extra) html += '<span class="badge bg-special ml-1">Horas Extra</span>';
            if (item.es_recuperacion) html += '<span class="badge bg-special ml-1">Recuperación</span>';
            
            return html;
        }

        window.openDetails = (uid, date) => {
            window.parent.postMessage({ 
                action: 'openRightPanel', 
                content: `<iframe src="../Complementos/RegUs/Detalle.html?socioId=${uid}&date=${date}&tab=gestion" class="w-full h-full border-none"></iframe>` 
            }, '*');
        };

        window.openEmailModal = () => dom.emailModal.style.display = 'flex';
        window.closeEmailModal = () => dom.emailModal.style.display = 'none';

        window.setEmailPreset = (mode) => {
            const to = document.getElementById('email-to');
            const cc = document.getElementById('email-cc');
            if (mode === 'prueba') { to.value = "proteccion.instalaciones@armur.com"; cc.value = ""; }
            else { to.value = "juan.paniagua@armur.com;jesuseduardo.gutierrez@armur.com"; cc.value = "josedavid.montano@armur.com;roberto.rodriguez@armur.com"; }
        };

        window.prepareAndSend = async () => {
            const to = document.getElementById('email-to').value.trim();
            const cc = document.getElementById('email-cc').value.trim();
            const btn = document.getElementById('btn-confirm-send');
            if (!to) return;
            
            btn.disabled = true; 
            btn.innerText = "PROCESANDO IMAGEN...";

            // Ocultar botones de detalle para la captura
            const actionButtons = document.querySelectorAll('.no-print');
            actionButtons.forEach(b => b.style.display = 'none');

            try {
                const canvas = await html2canvas(document.getElementById('report-content'), { 
                    scale: 1.5, 
                    useCORS: true, 
                    backgroundColor: '#ffffff' 
                });
                
                const base64 = canvas.toDataURL('image/png', 0.9).split(',')[1];
                const subject = `REPORTE ASISTENCIA - ${dom.dateLabel.innerText}`;
                
                btn.innerText = "ENVIANDO CORREO...";
                await fetch(POWER_AUTOMATE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, cc, subject, body: `<img src="data:image/png;base64,${base64}" style="width:100%" />` })
                });

                btn.innerText = "¡ENVIADO!";
                setTimeout(() => { closeEmailModal(); btn.disabled = false; btn.innerText = "Confirmar Envío"; }, 2000);
            } catch (err) { 
                btn.disabled = false; 
                btn.innerText = "ERROR - REINTENTAR"; 
            } finally {
                // Restaurar visibilidad de botones
                actionButtons.forEach(b => b.style.display = 'flex');
            }
        };

    </script>
</body>
</html>