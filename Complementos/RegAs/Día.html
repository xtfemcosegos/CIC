<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Diaria Continua - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow-y: auto;
        }

        /* --- Header Fijo e Inmóvil --- */
        .fixed-header {
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #e2e8f0;
            padding: 0.75rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            height: 80px;
        }

        .day-label-large {
            font-size: 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -0.04em;
            color: #0f172a;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Controles de Fecha --- */
        .date-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 14px;
            border: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .date-nav-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: white;
            color: #64748b;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #e2e8f0;
        }
        .date-nav-btn:hover {
            background: #d946ef;
            color: white;
            border-color: #d946ef;
            box-shadow: 0 4px 10px rgba(217, 70, 239, 0.2);
        }

        .date-picker-wrapper {
            background: white;
            padding: 0 12px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            border: 1px solid #e2e8f0;
        }
        
        #dateSelector {
            background: transparent;
            border: none;
            outline: none;
            font-size: 10px;
            font-weight: 900;
            color: #0f172a;
            text-transform: uppercase;
            cursor: pointer;
        }

        /* --- Contenedor Principal --- */
        #timelineContainer {
            padding-top: 80px; 
            min-height: 101vh; /* Evita que el header se mueva por falta de scroll inicial */
        }

        .day-section {
            padding: 2rem 2rem 3rem 2rem;
            border-bottom: 1px solid #f1f5f9;
        }

        /* --- Tarjetas Compactas --- */
        .user-card-mini {
            background: white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
        }
        .user-card-mini:hover {
            border-color: #d946ef;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        .photo-container {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: #f1f5f9;
            position: relative;
        }
        .photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .shift-indicator {
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .dot-matutino { background: #f59e0b; }
        .dot-vespertino { background: #3b82f6; }
        .dot-nocturno { background: #8b5cf6; }
        .dot-ausentismo { background: #ef4444; }

        .btn-load-more {
            width: 100%;
            padding: 4rem;
            text-align: center;
            color: #94a3b8;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.4em;
            cursor: pointer;
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Header Fijo e Inmóvil -->
    <header class="fixed-header">
        <div class="flex items-center gap-4 overflow-hidden">
            <div class="w-1 h-8 bg-fuchsia-600 rounded-full flex-shrink-0"></div>
            <h2 id="currentDayLabel" class="day-label-large">---</h2>
        </div>

        <div class="flex items-center gap-6">
            <!-- Navegación de Fecha -->
            <div class="date-controls">
                <button onclick="navigateDate(-1)" class="date-nav-btn" title="Ayer">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <div class="date-picker-wrapper">
                    <input type="date" id="dateSelector">
                </div>
                <button onclick="navigateDate(1)" class="date-nav-btn" title="Mañana">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>

            <!-- Leyenda Visual -->
            <div class="hidden xl:flex items-center gap-4 border-l pl-6 border-slate-200">
                <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-amber-500"></div><span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Mat</span></div>
                <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-blue-500"></div><span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Ves</span></div>
                <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-purple-500"></div><span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Noc</span></div>
            </div>
        </div>
    </header>

    <div id="timelineContainer" class="max-w-7xl mx-auto">
        <!-- Contenido generado por JS -->
    </div>

    <div id="loader" class="flex flex-col items-center justify-center py-20">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-fuchsia-600 mb-4"></div>
        <p class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400">Sincronizando registros...</p>
    </div>

    <div id="btnLoadMore" class="btn-load-more hidden" onclick="loadMoreDays()">
        Cargar flujo de días ↓
    </div>

    <script type="module">
        import { firebaseConfig } from '../../script.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';

        const casetasPrioridad = ["centro de control", "edison", "recepcion edison", "impulso", "michelena", "simon bolivar", "carranza", "universidad", "rondinero"];

        let allPersonnel = [];
        let activeDate = new Date();
        activeDate.setHours(12, 0, 0, 0);
        let activeSnapshots = new Map();
        let scrollObserver = null;

        const dom = {
            timeline: document.getElementById('timelineContainer'),
            loader: document.getElementById('loader'),
            dateInput: document.getElementById('dateSelector'),
            dayLabel: document.getElementById('currentDayLabel'),
            loadMore: document.getElementById('btnLoadMore')
        };

        const updateMainHeader = (date = activeDate) => {
            dom.dayLabel.textContent = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            dom.dateInput.value = date.toISOString().split('T')[0];
        };

        // --- Observer para scroll ---
        const initScrollObserver = () => {
            if (scrollObserver) scrollObserver.disconnect();

            scrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio >= 0.1) {
                        const dateStr = entry.target.dataset.date;
                        if (dateStr) {
                            const dateObj = new Date(dateStr + "T12:00:00");
                            updateMainHeader(dateObj);
                        }
                    }
                });
            }, {
                root: null,
                rootMargin: '-81px 0px -80% 0px',
                threshold: [0, 0.1, 0.2]
            });
        };

        async function fetchPersonnel() {
            const usersRef = doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', 'ElementosPP');
            const snap = await getDoc(usersRef);
            if (snap.exists()) {
                allPersonnel = Object.entries(snap.data()).map(([uid, d]) => ({
                    uid, socioId: String(d.socioId || ''), nombre: d.nombre || 'S/N',
                    photo: d.photo || null,
                    puesto: d.operativa?.puesto || d.puesto || 'PERSONAL',
                    status: (d.operativa?.estatus || d.status || 'Activo').toLowerCase()
                })).filter(u => u.status !== 'baja' && u.socioId);
            }
        }

        // --- CORRECCIÓN DE FOTOS: Paso directo del elemento para evitar race conditions ---
        async function resolveImage(path, imgElement) {
            if (!path || !imgElement) return;
            try {
                if (path.startsWith('gs://')) {
                    // Limpieza robusta del prefijo gs://bucket-name/
                    const storagePath = path.replace(/gs:\/\/[^\/]+\//, '');
                    const url = await getDownloadURL(ref(storage, storagePath));
                    imgElement.src = url;
                } else if (path.startsWith('http')) {
                    imgElement.src = path;
                }
            } catch (err) {}
        }

        function startTimeline() {
            activeSnapshots.forEach(unsub => unsub());
            activeSnapshots.clear();
            
            dom.timeline.innerHTML = '';
            updateMainHeader();
            initScrollObserver();
            
            for(let i=0; i < 5; i++) {
                const date = new Date(activeDate);
                date.setDate(date.getDate() + i);
                renderDaySection(date);
            }
            dom.loader.classList.add('hidden');
            dom.loadMore.classList.remove('hidden');
        }

        function renderDaySection(date) {
            const iso = date.toISOString().split('T')[0];
            const dateId = `${String(date.getDate()).padStart(2, '0')}${String(date.getMonth() + 1).padStart(2, '0')}${date.getFullYear()}`;
            const trimId = `Trim${Math.ceil((date.getMonth() + 1) / 3)}-${date.getFullYear()}`;
            const dayText = date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
            
            const section = document.createElement('div');
            section.className = 'day-section';
            section.id = `section-${dateId}`;
            section.dataset.date = iso;
            section.innerHTML = `
                <div class="mb-4 flex items-center gap-3">
                    <span class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">${dayText}</span>
                    <div class="h-px bg-slate-100 flex-1"></div>
                </div>
                <div id="grid-${dateId}" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-3"></div>
            `;
            dom.timeline.appendChild(section);

            if (scrollObserver) scrollObserver.observe(section);

            const attRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', trimId);
            const unsub = onSnapshot(attRef, (snap) => {
                const dayData = snap.exists() ? (snap.data()[dateId] || {}) : {};
                updateDayGrid(dateId, dayData, date);
            });
            activeSnapshots.set(dateId, unsub);
        }

        function updateDayGrid(dateId, dayData, dateObj) {
            const grid = document.getElementById(`grid-${dateId}`);
            if (!grid) return;

            const filtered = allPersonnel.filter(u => dayData[u.socioId]);
            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-8 text-center text-[10px] font-bold text-slate-200 uppercase tracking-widest">Sin registros registrados</div>`;
                return;
            }

            const getPriority = (id) => {
                const e = dayData[id];
                let shiftPrio = 5, caseta = "";
                if (e.matutino) { shiftPrio = 1; caseta = e.matutino.Caseta; }
                else if (e.vespertino) { shiftPrio = 2; caseta = e.vespertino.Caseta; }
                else if (e.nocturno) { shiftPrio = 3; caseta = e.nocturno.Caseta; }
                else if (e.ausentismo) { shiftPrio = 4; }

                let casetaPrio = 99;
                if (caseta) {
                    const idx = casetasPrioridad.findIndex(c => caseta.toLowerCase().includes(c));
                    if (idx !== -1) casetaPrio = idx;
                }
                return { shiftPrio, casetaPrio };
            };

            filtered.sort((a, b) => {
                const pA = getPriority(a.socioId), pB = getPriority(b.socioId);
                if (pA.shiftPrio !== pB.shiftPrio) return pA.shiftPrio - pB.shiftPrio;
                if (pA.casetaPrio !== pB.casetaPrio) return pA.casetaPrio - pB.casetaPrio;
                return a.nombre.localeCompare(b.nombre);
            });

            grid.innerHTML = '';
            filtered.forEach(person => grid.appendChild(createMiniCard(person, dayData[person.socioId], dateObj)));
        }

        function createMiniCard(person, entry, dateObj) {
            const div = document.createElement('div');
            div.className = 'user-card-mini';
            let dotClass = 'dot-ausentismo';
            if (entry.matutino) dotClass = 'dot-matutino';
            else if (entry.vespertino) dotClass = 'dot-vespertino';
            else if (entry.nocturno) dotClass = 'dot-nocturno';

            const iso = dateObj.toISOString().split('T')[0];
            const avatar = `https://ui-avatars.com/api/?name=${person.nombre}&background=f1f5f9&color=64748b`;

            div.innerHTML = `
                <div class="photo-container shadow-sm">
                    <img src="${avatar}" onerror="this.src='${avatar}'">
                    <div class="shift-indicator ${dotClass}"></div>
                </div>
                <div class="overflow-hidden leading-tight">
                    <h4 class="text-[10px] font-black uppercase truncate text-slate-800">${person.nombre}</h4>
                    <p class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter truncate">${person.puesto}</p>
                </div>
            `;
            
            div.onclick = () => window.parent.postMessage({ 
                action: 'openRightPanel', 
                content: `<iframe src="../Complementos/RegUs/Detalle.html?socioId=${person.uid}&date=${iso}&tab=gestion" class="w-full h-full border-none"></iframe>` 
            }, '*');

            // Llamada directa al elemento IMG contenido en el DIV
            if (person.photo) resolveImage(person.photo, div.querySelector('img'));
            return div;
        }

        window.navigateDate = (offset) => {
            activeDate.setDate(activeDate.getDate() + offset);
            startTimeline();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.loadMoreDays = () => {
            const offset = activeSnapshots.size;
            const lastDate = new Date(activeDate);
            lastDate.setDate(lastDate.getDate() + offset);
            for(let i=0; i < 5; i++) {
                const date = new Date(lastDate);
                date.setDate(date.getDate() + i);
                renderDaySection(date);
            }
        };

        dom.dateInput.onchange = (e) => {
            activeDate = new Date(e.target.value + "T12:00:00");
            startTimeline();
        };

        onAuthStateChanged(auth, async (u) => { 
            if (u) { await fetchPersonnel(); startTimeline(); } 
            else if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
        });
    </script>
</body>
</html>