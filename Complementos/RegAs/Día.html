<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Diaria Continua - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            overscroll-behavior-y: contain;
        }

        #timelineContainer {
            padding: 1rem 0;
            min-height: 101vh; 
            width: 100%;
        }

        .day-section {
            padding: 2.5rem 1.5rem;
            border-bottom: 8px solid #f1f5f9;
            transition: opacity 0.3s ease;
        }

        /* Encabezado de fecha */
        .day-header-pill {
            background: #d946ef;
            color: white;
            padding: 0.6rem 2rem;
            border-radius: 99px;
            font-size: 16px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            box-shadow: 0 10px 25px -5px rgba(217, 70, 239, 0.4);
            display: inline-block;
        }

        .shift-drawer {
            margin-bottom: 1.5rem;
            scroll-margin-top: 20px;
        }

        .shift-header {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #64748b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .shift-tools { display: flex; align-items: center; gap: 0.75rem; }

        .tool-check-label { display: flex; align-items: center; gap: 0.4rem; cursor: pointer; user-select: none; }
        .tool-check-label input { display: none; }
        .tool-check-box {
            width: 18px; height: 18px; border: 2px solid #e2e8f0; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s; background: white;
        }
        .tool-check-label input:checked + .tool-check-box { background: #d946ef; border-color: #d946ef; }
        .tool-check-label i { font-size: 10px; color: white; display: none; }
        .tool-check-label input:checked + .tool-check-box i { display: block; }

        .double-shift-btn { padding: 4px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; border: 1px solid #e2e8f0; background: white; color: #64748b; transition: all 0.2s; }
        .double-shift-btn.active { background: #fdf4ff; border-color: #d946ef; color: #d946ef; }

        .header-add-btn {
            width: 32px; height: 32px; border-radius: 8px; background: #f1f5f9; color: #64748b;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s; border: 1px solid #e2e8f0;
        }
        .header-add-btn:hover { background: #d946ef; color: white; border-color: #d946ef; transform: scale(1.1); }

        /* --- Tarjetas --- */
        .user-card-mini {
            background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.6rem;
            display: flex; flex-direction: row; align-items: center; gap: 0.75rem; cursor: pointer;
            position: relative; min-height: 80px; transition: all 0.2s;
        }
        .user-card-mini:hover { border-color: #d946ef; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
        .user-card-mini.is-double { border-width: 2px; border-color: #f0abfc; background: #fffaff; }

        .photo-container { width: 60px; height: 60px; border-radius: 10px; overflow: hidden; flex-shrink: 0; background: #f1f5f9; position: relative; }
        .photo-container img { width: 100%; height: 100%; object-fit: cover; }

        .double-badge { position: absolute; top: -5px; right: -5px; background: #d946ef; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; border: 2px solid white; z-index: 5; }

        .indicators-strip { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; display: flex; }
        .dot-indicator { flex: 1; height: 100%; }
        .bg-matutino { background: #fef08a; } .bg-vespertino { background: #60a5fa; } .bg-nocturno { background: #1e3a8a; } .bg-ausentismo { background: #ef4444; } 

        .info-group { display: flex; flex-direction: column; justify-content: center; gap: 1px; flex: 1; min-width: 0; }

        .caseta-select { font-size: 10px; font-weight: 700; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 3px 6px; margin-top: 2px; width: fit-content; max-width: 100%; outline: none; color: #475569; cursor: pointer; }

        .action-btn { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
        .btn-entry { background: #10b981; color: white; } 
        .btn-exit { background: #ef4444; color: white; } 
        .btn-late { background: #fef08a; color: #ef4444; border-color: #ef4444; }
        .btn-absence { background: #ef4444; color: #fef08a; }
        .btn-complete { background: #94a3b8; color: white; cursor: default; }

        /* Menú Contextual Premium */
        #context-menu {
            display: none;
            position: fixed;
            z-index: 5000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 6px;
            min-width: 180px;
        }
        .context-item {
            padding: 10px 14px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            color: #64748b;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .context-item:hover { background: #fdf4ff; color: #d946ef; }
        .context-item i { font-size: 12px; width: 16px; text-align: center; }

        #infiniteSentinel { height: 20px; margin-bottom: 50px; }

        ::-webkit-scrollbar { width: 7px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="timelineContainer" class="max-w-[1920px] mx-auto px-6"></div>

    <div id="infiniteSentinel"></div>

    <div id="loader" class="flex flex-col items-center justify-center py-32">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-fuchsia-600 mb-6"></div>
        <p class="text-[11px] font-black uppercase tracking-widest text-slate-400">Sincronizando información...</p>
    </div>

    <!-- MENÚ CONTEXTUAL -->
    <div id="context-menu">
        <div class="context-item" onclick="openByContext('expediente')"><i class="fa-solid fa-address-card"></i> Expediente</div>
        <div class="context-item" onclick="openByContext('operacion')"><i class="fa-solid fa-briefcase"></i> Función Operativa</div>
        <div class="context-item" onclick="openByContext('gestion')"><i class="fa-solid fa-clock"></i> Gestión de Turno</div>
        <div class="context-item" onclick="openByContext('patrones')"><i class="fa-solid fa-calendar-days"></i> Patrones</div>
    </div>

    <script type="module">
        import { firebaseConfig } from '../../script.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';

        const casetasPrioridad = ["Centro de Control", "Encargado", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero", "Otro"];
        const motivosAusentismo = ["Descanso", "Falta", "Vacaciones", "Suspensión", "Incapacidades", "Permiso"];
        const shifts = ['matutino', 'vespertino', 'nocturno', 'ausentismo'];

        let allPersonnel = [];
        let activeDate = new Date();
        activeDate.setHours(12, 0, 0, 0);
        let lastLoadedDate = new Date(activeDate);
        let currentFilter = 'todos';
        let dayDataCache = new Map();
        let activeSnapshots = new Map();
        const shiftFilterState = {};

        const timeline = document.getElementById('timelineContainer');
        const sentinel = document.getElementById('infiniteSentinel');
        const contextMenu = document.getElementById('context-menu');

        async function fetchPersonnel() {
            try {
                const usersRef = doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', 'ElementosPP');
                const snap = await getDoc(usersRef);
                if (snap.exists()) {
                    allPersonnel = Object.entries(snap.data()).map(([uid, d]) => ({
                        uid, socioId: String(d.socioId || ''), nombre: d.nombre || 'S/N',
                        photo: d.photo || null,
                        puesto: d.operativa?.puesto || d.puesto || 'PERSONAL',
                        status: (d.operativa?.estatus || d.status || 'Activo').toLowerCase(),
                        casetaDefault: d.operativa?.caseta || ""
                    })).filter(u => u.status !== 'baja' && u.socioId);
                }
            } catch (e) { console.error("Error fetching personnel:", e); }
        }

        async function resolveImage(path, imgElement) {
            if (!path || !imgElement) return;
            try {
                if (path.startsWith('gs://')) {
                    const storagePath = path.replace(/gs:\/\/[^\/]+\//, '');
                    const url = await getDownloadURL(ref(storage, storagePath));
                    imgElement.src = url;
                } else if (path.startsWith('http')) {
                    imgElement.src = path;
                }
            } catch (err) {}
        }

        async function renderDaySection(date) {
            const iso = date.toISOString().split('T')[0];
            const dateId = `${String(date.getDate()).padStart(2, '0')}${String(date.getMonth() + 1).padStart(2, '0')}${date.getFullYear()}`;
            const trimId = `Trim${Math.ceil((date.getMonth() + 1) / 3)}-${date.getFullYear()}`;
            
            if (document.getElementById(`section-${dateId}`)) return;

            const section = document.createElement('div');
            section.className = 'day-section';
            section.id = `section-${dateId}`;
            section.dataset.date = iso;

            section.innerHTML = `
                <div class="mb-12 flex items-center gap-6">
                    <div class="day-header-pill">${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
                    <div class="h-px bg-slate-200 flex-1"></div>
                </div>
                <div id="drawers-${dateId}">
                    ${shifts.map(shift => {
                        const shiftLabel = shift === 'ausentismo' ? 'Ausentismo' : shift.charAt(0).toUpperCase() + shift.slice(1);
                        const dotColor = shift === 'matutino' ? 'bg-yellow-200' : shift === 'vespertino' ? 'bg-blue-400' : shift === 'nocturno' ? 'bg-blue-900' : 'bg-red-500';
                        const drawerId = shift === 'matutino' ? 'mat' : shift === 'vespertino' ? 'ves' : shift === 'nocturno' ? 'noc' : 'aus';
                        return `
                            <div class="shift-drawer" id="${drawerId}-${dateId}" data-shift="${shift}">
                                <div class="shift-header">
                                    <div class="flex items-center gap-3">
                                        <div class="dot w-2.5 h-2.5 rounded-full ${dotColor}"></div> ${shiftLabel}
                                    </div>
                                    <div class="shift-tools">
                                        <button onclick="openAddPanel('${dateId}', '${shift}')" title="Agregar Elemento" class="header-add-btn"><i class="fa-solid fa-plus text-xs"></i></button>
                                        <button id="double-btn-${shift}-${dateId}" onclick="toggleShiftTool('${dateId}', '${shift}', 'highlightDouble')" class="double-shift-btn"><i class="fa-solid fa-clone mr-1"></i> DOBLE</button>
                                        <label class="tool-check-label"><input type="checkbox" onchange="toggleShiftTool('${dateId}', '${shift}', 'hideComplete')"><div class="tool-check-box"><i class="fa-solid fa-check"></i></div><span class="text-[9px] font-black">OCULTAR COMPLETOS</span></label>
                                        <button onclick="openWaPanel('${dateId}', '${shift}')" class="wa-btn-header text-slate-400 px-2 hover:text-green-500 transition-colors"><i class="fa-brands fa-whatsapp text-xl"></i></button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-5 grid-container" data-dateid="${dateId}" data-shift="${shift}"></div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            timeline.appendChild(section);

            section.querySelectorAll('.shift-drawer').forEach(d => scrollObserver.observe(d));

            const attRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', trimId);
            const unsub = onSnapshot(attRef, (snap) => {
                if (snap.exists()) {
                    const fullData = snap.data();
                    const dayData = fullData[dateId] || {};
                    dayDataCache.set(dateId, { data: dayData, date: new Date(date), trimId: trimId }); 
                    updateDayGrid(dateId, dayData, new Date(date));
                }
            }, (err) => console.error("Snapshot error:", err));
            activeSnapshots.set(dateId, unsub);
        }

        function updateDayGrid(dateId, dayData, dateObj) {
            const today = new Date();
            today.setHours(12, 0, 0, 0);
            const isToday = dateObj.getTime() === today.getTime();
            const section = document.getElementById(`section-${dateId}`);

            if (currentFilter === 'proximos') {
                if (section) section.style.display = isToday ? 'block' : 'none';
            } else {
                if (section) section.style.display = 'block';
            }

            const drawersMap = { matutino: 'mat', vespertino: 'ves', nocturno: 'noc', ausentismo: 'aus' };
            shifts.forEach(shiftKey => {
                const drawerKey = drawersMap[shiftKey];
                const drawer = document.getElementById(`${drawerKey}-${dateId}`);
                if(!drawer) return;
                const grid = drawer.querySelector('.grid-container');
                const filterKey = `${dateId}_${shiftKey}`;
                const config = shiftFilterState[filterKey] || { hideComplete: false, highlightDouble: false };

                let list = allPersonnel.filter(person => {
                    const entry = dayData[person.socioId];
                    if (currentFilter === 'proximos') {
                        if (!isToday || shiftKey === 'ausentismo') return false;
                        let hasActiveSession = false;
                        for (let [cacheId, cacheObj] of dayDataCache) {
                            const historicShift = cacheObj.data[person.socioId]?.[shiftKey];
                            if (historicShift?.entrada_real && !historicShift?.salida_real) {
                                hasActiveSession = true;
                                break;
                            }
                        }
                        if (hasActiveSession) return true;
                        const planTimeStr = entry?.[shiftKey]?.entrada_planificada || "";
                        if (planTimeStr) {
                            const [pHours, pMins] = planTimeStr.split(':').map(Number);
                            const now = new Date();
                            const nowMinutes = now.getHours() * 60 + now.getMinutes();
                            const planMinutes = pHours * 60 + pMins;
                            if (nowMinutes >= planMinutes - 60 && nowMinutes <= planMinutes + 30) return true;
                        }
                        return false;
                    }
                    if (!entry || !entry[shiftKey]) return false;
                    if (config.hideComplete && entry[shiftKey].entrada_real && entry[shiftKey].salida_real) return false;
                    if (currentFilter !== 'todos' && currentFilter !== shiftKey) return false;
                    return true;
                });

                list.sort((a, b) => {
                    if (shiftKey === 'ausentismo') return a.nombre.localeCompare(b.nombre);
                    const casetaA = (dayData[a.socioId]?.[shiftKey]?.Caseta) || "Otro";
                    const casetaB = (dayData[b.socioId]?.[shiftKey]?.Caseta) || "Otro";
                    const sortA = casetasPrioridad.indexOf(casetaA) === -1 ? 999 : casetasPrioridad.indexOf(casetaA);
                    const sortB = casetasPrioridad.indexOf(casetaB) === -1 ? 999 : casetasPrioridad.indexOf(casetaB);
                    if (sortA !== sortB) return sortA - sortB;
                    return a.nombre.localeCompare(b.nombre);
                });

                drawer.style.display = (list.length > 0 || currentFilter === 'todos') ? 'block' : 'none';
                grid.innerHTML = '';
                list.forEach(person => {
                    let targetEntry = dayData[person.socioId];
                    if (currentFilter === 'proximos' && (!targetEntry || !targetEntry[shiftKey]?.entrada_real)) {
                        for (let [cacheId, cacheObj] of dayDataCache) {
                            if (cacheObj.data[person.socioId]?.[shiftKey]?.entrada_real) {
                                targetEntry = cacheObj.data[person.socioId];
                                break;
                            }
                        }
                    }
                    grid.appendChild(createMiniCard(person, targetEntry, shiftKey, dateObj, dateId, config, isToday));
                });
            });
        }

        function createMiniCard(person, entry, activeShift, dateObj, dateId, config, isToday) {
            const div = document.createElement('div');
            div.className = 'user-card-mini';
            const iso = dateObj.toISOString().split('T')[0];
            
            // LOGICA: Abrir detalle al dar clic en la tarjeta
            div.onclick = (e) => {
                if (e.target.closest('button') || e.target.closest('select')) return;
                openDetails(person.uid, iso, 'expediente');
            };

            // LOGICA: Menú contextual al dar clic derecho
            div.oncontextmenu = (e) => {
                e.preventDefault();
                showContextMenu(e, person.uid, iso);
            };

            const shiftsCount = shifts.filter(s => entry?.[s] && s !== 'ausentismo').length;
            if (config.highlightDouble && shiftsCount > 1) div.classList.add('is-double');

            const avatar = `https://ui-avatars.com/api/?name=${person.nombre}&background=f1f5f9&color=64748b`;
            const shiftInfo = entry?.[activeShift] || {};

            let actionButtonsHtml = '';
            if (isToday) {
                const now = new Date();
                const nowM = now.getHours() * 60 + now.getMinutes();
                const planStr = shiftInfo.entrada_planificada || "";
                const plan = planStr.split(':').map(Number);
                const hasIn = !!shiftInfo.entrada_real, hasOut = !!shiftInfo.salida_real;

                if (hasIn && hasOut) actionButtonsHtml = `<div class="action-btn btn-complete"><i class="fa-solid fa-check-double"></i></div>`;
                else if (hasIn) actionButtonsHtml = `<button class="action-btn btn-exit" onclick="registerAttendance('${person.socioId}', '${activeShift}', '${dateId}', 'salida')"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>`;
                else if (activeShift !== 'ausentismo') {
                    const isLate = plan.length === 2 && nowM > (plan[0] * 60 + plan[1]);
                    if (isLate) actionButtonsHtml = `<div class="flex gap-1.5"><button class="action-btn btn-late" onclick="registerAttendance('${person.socioId}', '${activeShift}', '${dateId}', 'entrada', true)"><i class="fa-solid fa-business-time"></i></button><button class="action-btn btn-absence" onclick="registerAttendance('${person.socioId}', '${activeShift}', '${dateId}', 'falta')"><i class="fa-solid fa-user-times"></i></button></div>`;
                    else actionButtonsHtml = `<button class="action-btn btn-entry" onclick="registerAttendance('${person.socioId}', '${activeShift}', '${dateId}', 'entrada')"><i class="fa-solid fa-door-open"></i></button>`;
                }
            } else if (shiftInfo.entrada_real && shiftInfo.salida_real) actionButtonsHtml = `<div class="action-btn btn-complete"><i class="fa-solid fa-check-double"></i></div>`;

            div.innerHTML = `
                ${shiftsCount > 1 && config.highlightDouble ? `<div class="double-badge"><i class="fa-solid fa-clone"></i></div>` : ''}
                <div class="photo-container shadow-sm">
                    <img src="${avatar}" onerror="this.src='${avatar}'">
                    <div class="indicators-strip">${shifts.map(s => entry?.[s] ? `<div class="dot-indicator bg-${s}"></div>` : '').join('')}</div>
                </div>
                <div class="info-group">
                    <h4 class="text-[11px] font-black uppercase truncate text-slate-800 leading-none">${person.nombre}</h4>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter truncate">${person.puesto}</p>
                    ${activeShift === 'ausentismo' ? `
                        <select class="caseta-select" onchange="updateMotivo('${person.socioId}', '${dateId}', this.value)">
                            ${motivosAusentismo.map(m => `<option value="${m}" ${ (shiftInfo.motivo||shiftInfo.Motivo) === m ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    ` : `
                        <select class="caseta-select" onchange="updateCaseta('${person.socioId}', '${activeShift}', '${dateId}', this.value)">
                            ${casetasPrioridad.map(c => `<option value="${c}" ${shiftInfo.Caseta === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                    `}
                </div>
                <div class="flex-shrink-0">${actionButtonsHtml}</div>
            `;
            if (person.photo) resolveImage(person.photo, div.querySelector('img'));
            return div;
        }

        // MENU CONTEXTUAL
        function showContextMenu(e, uid, iso) {
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.dataset.uid = uid;
            contextMenu.dataset.iso = iso;
        }

        window.openByContext = (tab) => {
            const { uid, iso } = contextMenu.dataset;
            openDetails(uid, iso, tab);
            contextMenu.style.display = 'none';
        };

        document.addEventListener('click', () => { contextMenu.style.display = 'none'; });

        window.registerAttendance = async (socioId, shift, dateId, type, isLate = false) => {
            const cache = dayDataCache.get(dateId);
            if (!cache) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', cache.trimId);
            const timeStr = new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });
            const updateObj = {};
            if (type === 'falta') { updateObj[`${dateId}.${socioId}.ausentismo`] = { motivo: "Falta", originShift: shift }; updateObj[`${dateId}.${socioId}.${shift}`] = null; }
            else { updateObj[`${dateId}.${socioId}.${shift}.${type === 'entrada' ? 'entrada_real' : 'salida_real'}`] = timeStr; if (isLate) updateObj[`${dateId}.${socioId}.${shift}.retardo`] = true; }
            try { await updateDoc(docRef, updateObj); } catch (err) { console.error(err); }
        };

        const infiniteObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && currentFilter !== 'proximos') {
                lastLoadedDate.setDate(lastLoadedDate.getDate() + 1);
                renderDaySection(new Date(lastLoadedDate));
            }
        }, { threshold: 0.1 });

        window.addEventListener('message', async (e) => {
            if (e.data.action === 'syncDate') {
                const newDate = new Date(e.data.date + "T12:00:00");
                if (newDate.getTime() !== activeDate.getTime() || timeline.children.length === 0) {
                    activeDate = new Date(newDate);
                    lastLoadedDate = new Date(newDate);
                    timeline.innerHTML = '';
                    await renderDaySection(activeDate);
                    if (currentFilter !== 'proximos') {
                        for(let i=1; i<=2; i++) {
                            const d = new Date(activeDate);
                            d.setDate(d.getDate() + i);
                            await renderDaySection(d);
                            lastLoadedDate = d;
                        }
                    }
                }
                const drawerId = e.data.shift === 'matutino' ? 'mat' : e.data.shift === 'vespertino' ? 'ves' : e.data.shift === 'nocturno' ? 'noc' : 'aus';
                const dateId = `${String(newDate.getDate()).padStart(2, '0')}${String(newDate.getMonth() + 1).padStart(2, '0')}${newDate.getFullYear()}`;
                const target = document.getElementById(`${drawerId}-${dateId}`);
                if (target) window.scrollTo({ top: target.offsetTop, behavior: 'smooth' });
            }
            if (e.data.action === 'filter') {
                currentFilter = e.data.type;
                dayDataCache.forEach((cache, dateId) => updateDayGrid(dateId, cache.data, cache.date));
            }
        });

        const scrollObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && entry.boundingClientRect.top < 200) {
                    const shift = entry.target.dataset.shift;
                    const date = entry.target.closest('.day-section')?.dataset.date;
                    if (shift) window.parent.postMessage({ action: 'reportShift', shift: shift }, '*');
                    if (date) window.parent.postMessage({ action: 'reportDate', date: date }, '*');
                }
            });
        }, { root: null, rootMargin: '-5% 0px -80% 0px', threshold: 0 });

        onAuthStateChanged(auth, async (u) => { 
            if (u) { 
                await fetchPersonnel(); 
                const today = new Date();
                today.setHours(12, 0, 0, 0);
                activeDate = new Date(today);
                lastLoadedDate = new Date(today);
                await renderDaySection(today);
                document.getElementById('loader').classList.add('hidden');
                infiniteObserver.observe(sentinel);
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            }
        });

        window.openAddPanel = (dateId, shift) => window.parent.postMessage({ action: 'openRightPanel', content: `<iframe src="../Complementos/RegAs/Agregar_Elemento.html?dateId=${dateId}&shift=${shift}" class="w-full h-full border-none"></iframe>` }, '*');
        window.openWaPanel = (dateId, shift) => window.parent.postMessage({ action: 'openRightPanel', content: `<iframe src="../Complementos/RegAs/Wa.html?dateId=${dateId}&shift=${shift}" class="w-full h-full border-none"></iframe>` }, '*');
        
        // ACTUALIZADO: Función openDetails ahora acepta el tab
        window.openDetails = (uid, iso, tab) => window.parent.postMessage({ action: 'openRightPanel', content: `<iframe src="../Complementos/RegUs/Detalle.html?socioId=${uid}&date=${iso}&tab=${tab}" class="w-full h-full border-none"></iframe>` }, '*');
        
        window.toggleShiftTool = (dateId, shift, tool) => {
            const key = `${dateId}_${shift}`;
            if (!shiftFilterState[key]) shiftFilterState[key] = { hideComplete: false, highlightDouble: false };
            shiftFilterState[key][tool] = !shiftFilterState[key][tool];
            const cache = dayDataCache.get(dateId);
            if (cache) updateDayGrid(dateId, cache.data, cache.date);
        };

        window.updateCaseta = async (socioId, shift, dateId, newValue) => {
            const cache = dayDataCache.get(dateId);
            if (!cache) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', cache.trimId);
            try { await updateDoc(docRef, { [`${dateId}.${socioId}.${shift}.Caseta`]: newValue }); } catch (err) { console.error(err); }
        };

        window.updateMotivo = async (socioId, dateId, newValue) => {
            const cache = dayDataCache.get(dateId);
            if (!cache) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', cache.trimId);
            try { await updateDoc(docRef, { [`${dateId}.${socioId}.ausentismo.motivo`]: newValue }); } catch (err) { console.error(err); }
        };
    </script>
</body>
</html>