<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte WhatsApp - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --accent-fiusha: #d946ef;
            --md-background: #f8fafc;
            --md-outline: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--md-background);
            color: #1e293b;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-material {
            background: white;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            box-sizing: border-box;
            gap: 0.75rem;
        }

        .mini-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f1f5f9;
            flex-shrink: 0;
        }

        /* Contenedor de acciones en el encabezado */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-header-action {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            color: #94a3b8;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .btn-header-action:hover {
            background: #f8fafc;
            color: var(--accent-fiusha);
            border-color: #f1f5f9;
            transform: translateY(-1px);
        }

        .btn-close:hover {
            color: #ef4444;
            background: #fef2f2;
            border-color: #fee2e2;
        }

        .input-standard {
            width: 100%;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
            outline: none;
            transition: all 0.2s;
        }
        .input-standard:focus { 
            border-color: var(--accent-fiusha); 
            background: white;
        }

        .report-box {
            width: 100%;
            flex: 1;
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 0.75rem;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.5;
            resize: none;
            outline: none;
            color: #e2e8f0;
            overflow-y: auto;
        }

        .btn-copy {
            background: linear-gradient(135deg, #d946ef 0%, #a21caf 100%);
            color: white;
            border-radius: 0.5rem;
            padding: 0.6rem;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.05em;
            width: 100%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
        }
        .btn-copy:hover { transform: translateY(-1px); filter: brightness(1.05); }

        .toast { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #0f172a; 
            color: white; 
            padding: 10px 20px; 
            border-radius: 10px; 
            font-size: 10px; 
            font-weight: 800; 
            text-transform: uppercase; 
            display: none; 
            z-index: 1000; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
        }
        
        .label-mini {
            font-size: 8px;
            font-weight: 800;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 2px;
            display: block;
        }

        .footer-controls {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="card-material">
        <!-- 1. Encabezado con Acciones -->
        <div class="mini-header">
            <i class="fa-brands fa-whatsapp text-green-500 text-base"></i>
            <h2 class="text-[10px] font-black text-slate-900 uppercase tracking-widest flex-1">Generador de Reporte</h2>
            
            <div id="loading-indicator" class="hidden text-[8px] font-bold text-fuchsia-500 animate-pulse mr-2">SINCRO...</div>
            
            <div class="header-actions">
                <!-- Abrir en panel principal (Comunicación directa con Administración) -->
                <button onclick="openMainReport()" class="btn-header-action" title="Abrir Reporte Diario en el centro">
                    <i class="fa-solid fa-file-lines"></i>
                </button>
                <!-- Cerrar panel derecho -->
                <button onclick="closePanel()" class="btn-header-action btn-close" title="Cerrar Panel">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
        
        <!-- 2. Botón de Copiar -->
        <button onclick="copyReport()" class="btn-copy">
            <i class="fa-solid fa-copy text-[10px]"></i>
            Copiar Reporte
        </button>

        <!-- 3. Área de Reporte -->
        <textarea id="report-text" class="report-box" readonly placeholder="Generando reporte..."></textarea>

        <!-- 4. Controles de Filtrado -->
        <div class="footer-controls">
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="label-mini">Fecha</label>
                    <input type="date" id="report-date" class="input-standard">
                </div>
                <div>
                    <label class="label-mini">Turno</label>
                    <select id="report-shift" class="input-standard">
                        <option value="matutino">MATUTINO</option>
                        <option value="vespertino">VESPERTINO</option>
                        <option value="nocturno">NOCTURNO</option>
                        <option value="ausentismo">AUSENTISMO</option>
                    </select>
                </div>
            </div>

            <label class="flex items-center gap-2 cursor-pointer py-1">
                <input type="checkbox" id="include-time" class="w-3 h-3 accent-fuchsia-500">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wide">Incluir hora de ingreso</span>
            </label>
        </div>
    </div>

    <div id="toast" class="toast">¡Reporte Copiado!</div>

    <script type="module">
        import { firebaseConfig } from '../../script.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';

        const casetasOrden = ["Centro de Control", "Encargado", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero"];

        let personnelMap = {};
        let activeUnsubscribe = null;

        const dateInput = document.getElementById('report-date');
        const shiftSelect = document.getElementById('report-shift');
        const includeTimeCheck = document.getElementById('include-time');
        const reportArea = document.getElementById('report-text');

        // Configuración inicial basada en URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlDateId = urlParams.get('dateId');
        const urlShift = urlParams.get('shift');

        if (urlDateId) {
            const day = urlDateId.substring(0, 2), month = urlDateId.substring(2, 4), year = urlDateId.substring(4, 8);
            dateInput.value = `${year}-${month}-${day}`;
        } else {
            dateInput.value = new Date().toISOString().split('T')[0];
        }

        if (urlShift) shiftSelect.value = urlShift;

        // Función para cerrar el panel derecho (Habla con Administración.html)
        window.closePanel = () => {
            window.parent.postMessage({ action: 'closeRightPanel' }, '*');
        };

        // Función para abrir el Reporte Diario en el panel principal (Habla con Administración.html)
        window.openMainReport = () => {
            window.parent.postMessage({ 
                action: 'openApp', 
                path: 'Complementos/RegAs/Reporte_Diario.html' 
            }, '*');
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) { 
                await loadPersonnel(); 
                startSync(); 
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        async function loadPersonnel() {
            try {
                const usersRef = doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', 'ElementosPP');
                const snap = await getDoc(usersRef);
                if (snap.exists()) personnelMap = snap.data();
            } catch (err) { console.error("Error cargando personal:", err); }
        }

        function startSync() {
            if (activeUnsubscribe) activeUnsubscribe();
            const rawDate = dateInput.value;
            if (!rawDate) return;

            const dateObj = new Date(rawDate + "T12:00:00");
            const dateId = `${String(dateObj.getDate()).padStart(2,'0')}${String(dateObj.getMonth()+1).padStart(2,'0')}${dateObj.getFullYear()}`;
            const trimId = `Trim${Math.ceil((dateObj.getMonth() + 1) / 3)}-${dateObj.getFullYear()}`;
            
            document.getElementById('loading-indicator').classList.remove('hidden');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', trimId);
            
            activeUnsubscribe = onSnapshot(docRef, (snap) => {
                const dayData = (snap.exists() ? snap.data() : {})[dateId] || {};
                generateText(dayData);
                document.getElementById('loading-indicator').classList.add('hidden');
            }, (err) => {
                console.error("Error en tiempo real:", err);
                document.getElementById('loading-indicator').classList.add('hidden');
            });
        }

        function generateText(dayData) {
            const rawDate = dateInput.value;
            const shiftId = shiftSelect.value;
            const includeTime = includeTimeCheck.checked;
            const dateObj = new Date(rawDate + "T12:00:00");
            const longDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const capitalizedDate = longDate.charAt(0).toUpperCase() + longDate.slice(1);

            let text = `*DISTRIBUCIÓN TURNO ${shiftId.toUpperCase()}*\n`;
            text += `\`\`\`${capitalizedDate}\`\`\`\n\n`;

            const activeElements = Object.entries(dayData)
                .filter(([sid, shifts]) => shifts[shiftId])
                .map(([sid, shifts]) => ({
                    sid, ...shifts[shiftId],
                    nombre: personnelMap[sid]?.nombre || personnelMap[sid.toLowerCase()]?.nombre || 'S/N'
                }));

            if (shiftId === 'ausentismo') {
                text += `*REPORTE DE INCIDENCIAS*\n`;
                activeElements.forEach(el => {
                    text += `• ${el.nombre}: ${el.motivo || 'Falta'}\n`;
                });
            } else {
                casetasOrden.forEach(caseta => {
                    const assigned = activeElements.filter(el => (el.Caseta || "").toLowerCase().trim() === caseta.toLowerCase().trim());
                    if (assigned.length > 0) {
                        text += `*${caseta.toUpperCase()}*\n`;
                        assigned.forEach(el => {
                            const timeStr = includeTime ? `*${el.entrada_real || "--:--"}* hrs. ` : "";
                            text += `${timeStr}${el.nombre}\n`;
                        });
                        text += `\n`;
                    }
                });
            }

            reportArea.value = text.trim();
        }

        // Eventos de control
        dateInput.onchange = startSync;
        shiftSelect.onchange = startSync;
        includeTimeCheck.onchange = () => startSync();

        window.copyReport = () => {
            reportArea.select();
            try {
                // Compatibilidad con entornos iFrame
                document.execCommand('copy');
                const toast = document.getElementById('toast');
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 2000);
            } catch (err) {
                console.error("Error al copiar:", err);
            }
        };
    </script>
</body>
</html>