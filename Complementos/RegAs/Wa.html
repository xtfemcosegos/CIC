<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte WhatsApp - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --accent-fiusha: #d946ef;
            --accent-fiusha-dark: #701a75;
            --md-surface: #ffffff;
            --md-background: #f8fafc;
            --md-outline: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--md-background);
            color: #1e293b;
            padding: 2rem 1rem;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .card-material {
            background: white;
            border-radius: 2rem;
            border: 1px solid var(--md-outline);
            padding: 2.5rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 700px;
        }

        .input-standard {
            width: 100%;
            background: #f8fafc;
            border: 2px solid #f1f5f9;
            border-radius: 1rem;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            outline: none;
            transition: all 0.2s;
        }
        .input-standard:focus { 
            border-color: var(--accent-fiusha); 
            background: white;
            box-shadow: 0 0 0 4px rgba(217, 70, 239, 0.05);
        }

        .label-style {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            color: #94a3b8;
            margin-left: 4px;
            margin-bottom: 6px;
            display: block;
            letter-spacing: 0.1em;
        }

        .report-box {
            width: 100%;
            height: 380px;
            background: #0f172a;
            border: 2px solid #1e293b;
            border-radius: 1.25rem;
            padding: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            color: #e2e8f0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
        }

        .btn-copy {
            background: linear-gradient(135deg, #d946ef 0%, #a21caf 100%);
            color: white;
            border-radius: 1.25rem;
            padding: 1rem;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.1em;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 25px rgba(217, 70, 239, 0.2);
        }
        .btn-copy:hover { transform: translateY(-3px); filter: brightness(1.1); }

        .check-container { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 8px; border-radius: 12px; }
        .check-box { width: 22px; height: 22px; border: 2.5px solid var(--md-outline); border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; }
        .check-box svg { display: none; color: white; width: 14px; height: 14px; stroke-width: 4; }
        input:checked + .check-box { background: var(--accent-fiusha); border-color: var(--accent-fiusha); }
        input:checked + .check-box svg { display: block; }

        .toast { position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%); background: #0f172a; color: white; padding: 14px 28px; border-radius: 16px; font-size: 11px; font-weight: 800; text-transform: uppercase; box-shadow: 0 20px 40px rgba(0,0,0,0.3); display: none; z-index: 1000; }
        .loading-pulse { width: 8px; height: 8px; background: var(--accent-fiusha); border-radius: 50%; animation: pulse-glow 1.5s infinite; }
        @keyframes pulse-glow { 0%, 100% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } }
    </style>
</head>
<body>

    <div class="card-material animate-in fade-in duration-500">
        <div class="flex items-center gap-4 mb-8">
            <div class="w-10 h-10 bg-fuchsia-50 text-fuchsia-600 rounded-xl flex items-center justify-center">
                <i class="fa-brands fa-whatsapp text-xl"></i>
            </div>
            <div>
                <h2 class="text-sm font-black text-slate-900 uppercase tracking-widest">Generador de Reporte</h2>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Formato oficial para grupos de WhatsApp</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
            <div>
                <label class="label-style">Fecha de Consulta</label>
                <input type="date" id="report-date" class="input-standard">
            </div>
            <div>
                <label class="label-style">Turno a Reportar</label>
                <select id="report-shift" class="input-standard">
                    <option value="matutino">MATUTINO</option>
                    <option value="vespertino">VESPERTINO</option>
                    <option value="nocturno">NOCTURNO</option>
                </select>
            </div>
        </div>

        <div class="flex items-center justify-between mb-8 px-2">
            <label class="check-container group">
                <input type="checkbox" id="include-time" checked class="hidden">
                <div class="check-box group-hover:border-fuchsia-300 transition-colors"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Incluir hora de ingreso</span>
            </label>
            
            <div id="loading-indicator" class="hidden flex items-center gap-3">
                <div class="loading-pulse"></div>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Sincronizando...</span>
            </div>
        </div>

        <textarea id="report-text" class="report-box no-scrollbar shadow-inner" readonly placeholder="Procesando registros de asistencia..."></textarea>

        <div class="mt-8">
            <button onclick="copyReport()" class="btn-copy">
                <i class="fa-solid fa-copy"></i>
                Copiar para WhatsApp
            </button>
            <p class="text-[8px] text-center text-slate-300 mt-4 font-bold uppercase tracking-widest">Listo para pegar en el grupo oficial</p>
        </div>
    </div>

    <div id="toast" class="toast">Portapapeles Actualizado</div>

    <script type="module">
        import { firebaseConfig } from '../../script.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';

        const casetasOrden = ["Centro de control", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero"];

        let personnelMap = {};
        let activeUnsubscribe = null;

        const dateInput = document.getElementById('report-date');
        const shiftSelect = document.getElementById('report-shift');
        const includeTimeCheck = document.getElementById('include-time');
        const reportArea = document.getElementById('report-text');

        const today = new Date();
        today.setHours(12, 0, 0, 0);
        dateInput.value = today.toISOString().split('T')[0];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadPersonnel();
                startSync();
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        async function loadPersonnel() {
            const usersRef = doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', 'ElementosPP');
            const snap = await getDoc(usersRef);
            if (snap.exists()) { personnelMap = snap.data(); }
        }

        function startSync() {
            if (activeUnsubscribe) activeUnsubscribe();
            const rawDate = dateInput.value;
            if (!rawDate) return;
            const dateObj = new Date(rawDate + "T12:00:00");
            const dateId = `${String(dateObj.getDate()).padStart(2,'0')}${String(dateObj.getMonth()+1).padStart(2,'0')}${dateObj.getFullYear()}`;
            const trimId = `Trim${Math.ceil((dateObj.getMonth() + 1) / 3)}-${dateObj.getFullYear()}`;
            document.getElementById('loading-indicator').classList.remove('hidden');
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', trimId);
            activeUnsubscribe = onSnapshot(docRef, (snap) => {
                const dayData = (snap.exists() ? snap.data() : {})[dateId] || {};
                generateText(dayData);
                document.getElementById('loading-indicator').classList.add('hidden');
            }, (err) => {
                document.getElementById('loading-indicator').classList.add('hidden');
            });
        }

        function generateText(dayData) {
            const rawDate = dateInput.value;
            const shiftId = shiftSelect.value;
            const includeTime = includeTimeCheck.checked;
            const dateObj = new Date(rawDate + "T12:00:00");
            const longDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const capitalizedDate = longDate.charAt(0).toUpperCase() + longDate.slice(1);

            let text = `*DISTRIBUCIÓN TURNO ${shiftId.toUpperCase()}*\n`;
            text += `\`\`\`${capitalizedDate}\`\`\`\n\n`;

            const activeElements = Object.entries(dayData)
                .filter(([sid, shifts]) => shifts[shiftId])
                .map(([sid, shifts]) => ({
                    sid, ...shifts[shiftId],
                    nombre: personnelMap[sid.toLowerCase().replace(/[^a-z0-9]/g, '_')]?.nombre || personnelMap[sid]?.nombre || 'S/N'
                }));

            casetasOrden.forEach(caseta => {
                const assigned = activeElements.filter(el => (el.Caseta || "").toLowerCase().trim() === caseta.toLowerCase().trim());
                if (assigned.length > 0) {
                    text += `*${caseta.toUpperCase()}*\n`;
                    assigned.forEach(el => {
                        const timeStr = includeTime ? `*${el.entrada_real || "--:--"}* hrs. ` : "";
                        text += `${timeStr}${el.nombre}\n`;
                    });
                    text += `\n`;
                }
            });

            // SE HA ELIMINADO LA SECCIÓN DE AUSENTISMOS POR INSTRUCCIÓN DEL USUARIO
            reportArea.value = text.trim();
        }

        dateInput.onchange = startSync;
        shiftSelect.onchange = startSync;
        includeTimeCheck.onchange = () => startSync();

        window.copyReport = () => {
            reportArea.select();
            try {
                document.execCommand('copy');
                const toast = document.getElementById('toast');
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 2500);
            } catch (err) {}
        };
    </script>
</body>
</html>