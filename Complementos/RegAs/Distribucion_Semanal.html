<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribución Semanal - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Librería dom-to-image para capturas de alta fidelidad -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <style>
        :root {
            --metal-fuchsia-dark: #1a031c;
            --metal-fuchsia-mid: #4a044e;
            --md-outline: #94a3b8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            padding: 1.5rem;
        }

        .glass-card {
            background: white;
            border-radius: 24px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 10px 40px rgba(0,0,0,0.04);
            overflow: hidden;
            width: fit-content;
            min-width: 850px;
            margin: 0 auto;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--metal-fuchsia-dark) 0%, var(--metal-fuchsia-mid) 100%);
            padding: 24px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-controls {
            padding: 12px 24px;
            background: white;
            border-bottom: 1px solid #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .btn-nav {
            padding: 6px 14px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            background: #f1f5f9;
            color: #64748b;
            transition: all 0.2s;
        }
        .btn-nav:hover { background: #e2e8f0; color: var(--metal-fuchsia-mid); }
        .btn-nav.active { background: var(--metal-fuchsia-mid); color: white; }

        .btn-action {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        .btn-copy { background: #25d366; color: white; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.2); }
        .btn-copy:hover { transform: translateY(-1px); background: #1eb954; }

        .restore-select {
            background: #fdf4ff;
            border: 1px solid #f0abfc;
            border-radius: 10px;
            padding: 4px 10px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            color: #701a75;
            outline: none;
            cursor: pointer;
        }

        /* Estilos de Tabla Compacta y Centrada */
        .table-container { 
            width: 100%; 
            display: flex;
            justify-content: center;
            background: white; 
            padding: 1px;
        }
        
        table { 
            border-collapse: collapse; 
            table-layout: auto;
            margin: 0 auto;
        }
        
        th {
            background: #f8fafc;
            padding: 6px 12px;
            text-align: center;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            color: #475569;
            border: 1px solid #94a3b8;
            letter-spacing: 0.05em;
            height: 36px;
        }

        td {
            padding: 0 !important;
            font-size: 11px;
            border: 1px solid #cbd5e1;
            text-align: center;
            vertical-align: middle;
            min-width: 48px;
            height: 36px;
        }

        /* Fila Unificada: Caseta + Fechas */
        .caseta-combined-header {
            background: #1e293b;
            height: 36px;
        }

        .caseta-label-cell {
            color: white;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            padding: 0 12px 0 56px !important; /* Sangría a la izquierda */
            text-align: left !important;
            letter-spacing: 0.12em;
            border-right: 2px solid #94a3b8 !important;
            background: #1e293b;
        }

        .date-header-cell {
            background: #334155;
            color: #f1f5f9;
            font-size: 8px;
            font-weight: 800;
            text-transform: uppercase;
            border: 1px solid #475569;
            height: 36px;
        }

        .btn-hide-caseta {
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
            cursor: pointer;
            padding: 2px 8px;
            color: #fca5a5;
        }
        .btn-hide-caseta:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .person-col { 
            width: 240px; 
            text-align: left !important;
            padding: 0 12px !important;
            background: #fdf4ff;
            border-right: 2px solid #94a3b8 !important;
        }

        /* Etiquetas "Full-Cell" */
        .abbr-tag {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-weight: 900;
            font-size: 12px;
        }
        .abbr-D { color: #854d0e; background: #fef9c3; }
        .abbr-T { color: #1e40af; background: #dbeafe; }
        .abbr-N { color: white; background: #1e1b4b; }
        .abbr-DT { color: #701a75; background: #fdf2f8; }
        .abbr-Vac { color: #166534; background: #dcfce7; font-size: 10px; }
        .abbr-Sus { color: #b91c1c; background: #fee2e2; font-size: 10px; }
        .abbr-other { color: #64748b; background: #f1f5f9; font-size: 10px; }

        .person-info { display: flex; align-items: center; gap: 8px; max-width: 215px; }
        .micro-photo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #cbd5e1;
            background: #fff;
            flex-shrink: 0;
        }
        .person-name-container { flex: 1; min-width: 0; }
        .person-name { 
            font-size: 10px; 
            font-weight: 800; 
            color: #4a044e; 
            line-height: 1; 
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .person-id { font-size: 7px; font-weight: 900; color: #94a3b8; font-family: 'JetBrains Mono'; margin-top: 1px; }

        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9);
            backdrop-filter: blur(4px); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }

        .no-print { user-select: none; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-fuchsia-200 border-t-fuchsia-700 rounded-full animate-spin"></div>
        <p class="text-[9px] font-black uppercase mt-4 tracking-widest text-fuchsia-950">Sincronizando Tablero...</p>
    </div>

    <div class="glass-card">
        <header class="panel-header">
            <div>
                <h1 class="text-xl font-black uppercase tracking-tight">Distribución Semanal</h1>
                <p id="week-label" class="text-[10px] font-bold text-fuchsia-200/50 uppercase tracking-widest mt-1">Lunes a Domingo</p>
            </div>
            <div class="flex gap-3">
                <button onclick="copyAsImage()" class="btn-action btn-copy" title="Copiar para WhatsApp">
                    <i class="fa-brands fa-whatsapp text-lg"></i> Enviar a WhatsApp
                </button>
            </div>
        </header>

        <div class="week-controls">
            <div class="flex gap-2">
                <button onclick="changeWeek(-1)" class="btn-nav">Anterior</button>
                <button onclick="resetToNextWeek()" class="btn-nav active">Siguiente</button>
                <button onclick="changeWeek(1)" class="btn-nav">Semana +2</button>
            </div>
            
            <div class="flex items-center gap-3">
                <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Casetas Ocultas:</span>
                <select id="restore-caseta-select" class="restore-select" onchange="restoreCaseta(this.value)">
                    <option value="" disabled selected>Recuperar Caseta...</option>
                </select>
            </div>
        </div>

        <div id="capture-area" class="table-container">
            <table id="distribution-table">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

        <div class="px-6 py-3 bg-slate-50 border-t flex justify-between items-center">
            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Plan Operativo CIC 7.1</span>
            <span class="text-[9px] font-bold text-slate-300 uppercase tracking-widest">Protección Patrimonial OS</span>
        </div>
    </div>

    <script type="module">
        import { firebaseConfig } from '../../script.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';

        const casetasPrioridad = ["Centro de Control", "Encargado", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero", "Portero U.N.", "Otro"];
        
        let personnelMap = {};
        let weekStart = new Date();
        let weekDays = [];
        let weekData = {};
        let hiddenCasetas = new Set(["Centro de Control"]);

        // Configuración inicial (Lunes de la próxima semana)
        const today = new Date();
        const nextMonday = new Date(today);
        nextMonday.setDate(today.getDate() + ((1 + 7 - today.getDay()) % 7 || 7));
        weekStart = nextMonday;
        weekStart.setHours(12,0,0,0);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadPersonnel();
                await fetchWeekData();
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            }
        });

        async function loadPersonnel() {
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', 'ElementosPP'));
            if (snap.exists()) {
                const data = snap.data();
                Object.entries(data).forEach(([uid, u]) => {
                    if ((u.operativa?.estatus || u.status || "").toLowerCase() === 'baja') return;
                    personnelMap[u.socioId || uid] = {
                        uid,
                        nombre: u.nombre,
                        photo: u.photo || null,
                        socioId: u.socioId,
                        casetaBase: u.operativa?.caseta || "Otro"
                    };
                });
            }
        }

        window.changeWeek = (offset) => {
            weekStart.setDate(weekStart.getDate() + (offset * 7));
            document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
            fetchWeekData();
        };

        window.resetToNextWeek = () => {
            const t = new Date();
            const nm = new Date(t);
            nm.setDate(t.getDate() + ((1 + 7 - t.getDay()) % 7 || 7));
            weekStart = nm; weekStart.setHours(12,0,0,0);
            document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
            document.querySelector('button[onclick="resetToNextWeek()"]').classList.add('active');
            fetchWeekData();
        };

        async function fetchWeekData() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';

            weekDays = [];
            weekData = {};
            const trimIds = new Set();

            for(let i=0; i<7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                weekDays.push(d);
                trimIds.add(`Trim${Math.ceil((d.getMonth() + 1) / 3)}-${d.getFullYear()}`);
            }

            const first = weekDays[0].toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
            const last = weekDays[6].toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
            document.getElementById('week-label').innerText = `Del ${first} al ${last}`;

            const caches = {};
            for (const tId of trimIds) {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', tId));
                caches[tId] = snap.exists() ? snap.data() : {};
            }

            weekDays.forEach((date, idx) => {
                const dateId = `${String(date.getDate()).padStart(2,'0')}${String(date.getMonth()+1).padStart(2,'0')}${date.getFullYear()}`;
                const trimId = `Trim${Math.ceil((date.getMonth() + 1) / 3)}-${date.getFullYear()}`;
                weekData[idx] = caches[trimId]?.[dateId] || {};
            });

            await renderWeek();
            overlay.style.display = 'none';
        }

        function getShiftAbbr(dayDataForUser) {
            if (!dayDataForUser) return "";
            if (dayDataForUser.ausentismo) {
                const motivo = (dayDataForUser.ausentismo.motivo || "").toLowerCase();
                if (motivo.includes("vacaciones")) return "Vac";
                if (motivo.includes("suspensión") || motivo.includes("suspension")) return "Sus";
                if (motivo.includes("descanso")) return "Dsc";
                return motivo.substring(0, 3).toUpperCase();
            }
            const hasMat = !!dayDataForUser.matutino, hasVes = !!dayDataForUser.vespertino, hasNoc = !!dayDataForUser.nocturno;
            if (hasMat && hasVes) return "D/T";
            if (hasMat) return "D";
            if (hasVes) return "T";
            if (hasNoc) return "N";
            return "";
        }

        function getAbbrClass(abbr) {
            if (abbr === "D") return "abbr-D";
            if (abbr === "T") return "abbr-T";
            if (abbr === "N") return "abbr-N";
            if (abbr === "D/T") return "abbr-DT";
            if (abbr === "Vac") return "abbr-Vac";
            if (abbr === "Sus") return "abbr-Sus";
            if (abbr) return "abbr-other";
            return "";
        }

        window.hideCaseta = (name) => {
            hiddenCasetas.add(name);
            renderWeek();
        };

        window.restoreCaseta = (name) => {
            if (!name) return;
            hiddenCasetas.delete(name);
            renderWeek();
        };

        function updateRestoreSelect() {
            const select = document.getElementById('restore-caseta-select');
            select.innerHTML = '<option value="" disabled selected>Recuperar Caseta...</option>';
            const hidden = Array.from(hiddenCasetas).sort();
            hidden.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                select.appendChild(opt);
            });
            select.style.display = hidden.length > 0 ? 'block' : 'none';
        }

        // --- FUNCIÓN PARA ABRIR EL DETALLE ---
        window.openShiftDetail = (uid, date) => {
            window.parent.postMessage({ 
                action: 'openRightPanel', 
                content: `<iframe src="../Complementos/RegUs/Detalle.html?socioId=${uid}&date=${date}&tab=gestion" class="w-full h-full border-none"></iframe>` 
            }, '*');
        };

        window.renderWeek = async () => {
            const head = document.getElementById('table-head');
            const body = document.getElementById('table-body');

            head.innerHTML = '';

            let bodyHtml = "";
            const sortedPersonnel = Object.values(personnelMap).sort((a, b) => a.nombre.localeCompare(b.nombre));

            for (const caseta of casetasPrioridad) {
                if (hiddenCasetas.has(caseta)) continue;

                const personnelInCaseta = sortedPersonnel.filter(p => p.casetaBase === caseta);
                if (personnelInCaseta.length === 0) continue;

                let combinedHeaderHtml = `
                    <tr class="caseta-combined-header">
                        <td class="caseta-label-cell">
                            <div class="flex items-center justify-between">
                                <span>${caseta.toUpperCase()}</span>
                                <div class="btn-hide-caseta no-print" onclick="hideCaseta('${caseta}')" title="Ocultar de la tabla">
                                    <i class="fa-solid fa-eye-slash"></i>
                                </div>
                            </div>
                        </td>
                        ${weekDays.map(d => `
                            <td class="date-header-cell">
                                ${d.toLocaleDateString('es-ES', { weekday: 'short' })}<br>${d.getDate()} ${d.toLocaleDateString('es-ES', { month: 'short' })}
                            </td>
                        `).join('')}
                    </tr>`;

                let rowsForCaseta = "";
                for (const person of personnelInCaseta) {
                    let rowCells = "";
                    for(let i=0; i<7; i++) {
                        const dayData = weekData[i][person.socioId];
                        const abbr = getShiftAbbr(dayData);
                        const cls = getAbbrClass(abbr);
                        const isoDate = weekDays[i].toISOString().split('T')[0];
                        
                        // Añadimos el evento onclick y clases de hover para la interactividad
                        rowCells += `
                            <td class="cursor-pointer hover:bg-slate-50 transition-colors" 
                                onclick="openShiftDetail('${person.uid}', '${isoDate}')">
                                ${abbr ? `<div class="abbr-tag ${cls}">${abbr}</div>` : ''}
                            </td>`;
                    }

                    const avatar = `https://ui-avatars.com/api/?name=${person.nombre}&background=f1f5f9&color=64748b&size=40`;
                    rowsForCaseta += `
                        <tr>
                            <td class="person-col cursor-pointer hover:bg-fuchsia-50 transition-colors" onclick="openShiftDetail('${person.uid}', '${weekDays[0].toISOString().split('T')[0]}')">
                                <div class="person-info">
                                    <img src="${avatar}" data-sid="${person.socioId}" class="micro-photo" alt="">
                                    <div class="person-name-container">
                                        <div class="person-name">${person.nombre}</div>
                                        <div class="person-id">${person.socioId}</div>
                                    </div>
                                </div>
                            </td>
                            ${rowCells}
                        </tr>
                    `;
                }

                bodyHtml += combinedHeaderHtml + rowsForCaseta;
            }

            body.innerHTML = bodyHtml;
            updateRestoreSelect();

            // Resolver fotos
            const images = document.querySelectorAll('.micro-photo');
            images.forEach(async img => {
                const sid = img.dataset.sid;
                const person = personnelMap[sid];
                if (person && person.photo) {
                    try {
                        let path = person.photo;
                        if (path.startsWith('gs://')) {
                            const storagePath = path.replace(/gs:\/\/[^\/]+\//, '');
                            const url = await getDownloadURL(ref(storage, storagePath));
                            img.src = url;
                        } else img.src = path;
                    } catch (e) {}
                }
            });
        };

        window.copyAsImage = async () => {
            const btn = document.querySelector('.btn-copy');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> Generando...';

            try {
                const node = document.getElementById('capture-area');
                const blob = await domtoimage.toBlob(node, { 
                    bgcolor: '#ffffff',
                    width: node.scrollWidth,
                    height: node.scrollHeight
                });
                
                const item = new ClipboardItem({ "image/png": blob });
                await navigator.clipboard.write([item]);
                
                btn.innerHTML = '<i class="fa-solid fa-check"></i> ¡Copiado!';
                setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 2000);
            } catch (err) {
                console.error(err);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

    </script>
</body>
</html>