<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Registro - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fffaf8; padding: 1.5rem; color: #431407; }
        .form-card { background: white; border: 1px solid #fed7aa; border-radius: 24px; padding: 1.5rem; max-width: 800px; margin: 0 auto; box-shadow: 0 10px 25px rgba(124, 45, 18, 0.05); }
        .input-style { width: 100%; background: #fffaf8; border: 2px solid #fed7aa; border-radius: 14px; padding: 0.75rem 1rem; font-size: 14px; font-weight: 600; outline: none; transition: all 0.2s; }
        .input-style:focus { border-color: #f97316; background: white; }
        .label-mini { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #9a3412; margin-bottom: 0.5rem; display: block; letter-spacing: 0.05em; }
        
        /* Mapa Estilos */
        .map-container { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 20px; padding: 1rem; margin-top: 1rem; overflow: hidden; }
        .map-svg { width: 100%; height: auto; max-height: 400px; }
        .map-zone { fill: #e2e8f0; stroke: #94a3b8; stroke-width: 1; cursor: pointer; transition: all 0.2s; }
        .map-zone:hover { fill: #fed7aa; stroke: #f97316; }
        .map-zone.selected { fill: #f97316; stroke: #ea580c; }
        .map-text { font-size: 8px; font-weight: bold; pointer-events: none; fill: #475569; text-anchor: middle; }

        .category-btn { border: 2px solid #fed7aa; border-radius: 16px; padding: 0.75rem; text-align: center; cursor: pointer; background: white; transition: all 0.2s; }
        .category-btn.active { border-color: #f97316; background: #fff7ed; }
        
        .photo-preview { width: 100%; height: 200px; border: 2px dashed #fed7aa; border-radius: 16px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background: #fffaf8; }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }

        #auth-lock { position: fixed; inset: 0; background: #fffaf8; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="auth-lock">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mb-4"></div>
        <p class="text-[10px] font-black uppercase tracking-widest text-orange-800/40">Iniciando Formulario...</p>
    </div>

    <div class="form-card">
        <header class="mb-6 border-b border-orange-50 pb-4">
            <h2 class="text-xl font-black uppercase text-indigo-950">Recepción de Objeto</h2>
            <p class="text-[9px] font-bold text-slate-400 uppercase">Gestión de Inventario y Resguardo</p>
        </header>

        <form id="lostForm" class="space-y-6">
            <!-- SECCIÓN 1: FOTO -->
            <div>
                <label class="label-mini">Fotografía del Objeto</label>
                <div class="photo-preview" onclick="document.getElementById('fileInput').click()">
                    <div id="photo-placeholder" class="text-center">
                        <i class="fa-solid fa-camera text-3xl text-orange-200 mb-2"></i>
                        <p class="text-[9px] font-black text-orange-300 uppercase">Tocar para capturar</p>
                    </div>
                    <img id="img-output" class="hidden">
                </div>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="previewImage(this)">
            </div>

            <!-- SECCIÓN 2: DATOS BÁSICOS -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label-mini">Estado del Objeto</label>
                    <select id="estado" class="input-style" onchange="toggleFoundDetails()">
                        <option value="Resguardado">Resguardado (Encontrado)</option>
                        <option value="Extraviado">Reporte de Extravío</option>
                    </select>
                </div>
                <div>
                    <label class="label-mini">Categoría</label>
                    <select id="categoria" class="input-style">
                        <option value="Electrónica">Electrónica</option>
                        <option value="Ropa">Ropa</option>
                        <option value="Llaves">Llaves</option>
                        <option value="Cartera">Cartera</option>
                        <option value="Documentos">Documentos</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
            </div>

            <!-- SECCIÓN 3: DATOS DE ENTREGA (CONDICIONAL) -->
            <div id="found-details" class="p-4 bg-orange-50 rounded-2xl border border-orange-100 space-y-4">
                <p class="text-[10px] font-black text-orange-600 uppercase mb-2">Datos de quien entrega</p>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-mini">Número de Socio</label>
                        <input type="text" id="entrega_socio" class="input-style" placeholder="ID Socio">
                    </div>
                    <div>
                        <label class="label-mini">Nombre Completo</label>
                        <input type="text" id="entrega_nombre" class="input-style" placeholder="Nombre de quien encontró">
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 4: UBICACIÓN Y MAPA -->
            <div class="space-y-4">
                <div>
                    <label class="label-mini">Edificio / Ubicación General</label>
                    <select id="edificio" class="input-style" onchange="handleBuildingChange()">
                        <option value="Complejo OS">Complejo OS</option>
                        <option value="Michelena">Michelena</option>
                        <option value="Simón Bolívar">Simón Bolívar</option>
                        <option value="Estacionamiento">Estacionamiento</option>
                    </select>
                </div>

                <div id="map-section" class="hidden">
                    <label class="label-mini">Punto exacto del hallazgo (Michelena)</label>
                    <div class="flex gap-2 mb-2">
                        <button type="button" onclick="setMapLevel('PB')" id="btn-pb" class="px-3 py-1 bg-orange-100 text-orange-700 rounded-lg text-[10px] font-black">Planta Baja</button>
                        <button type="button" onclick="setMapLevel('PISOS')" id="btn-pisos" class="px-3 py-1 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black">Pisos 1-4</button>
                    </div>
                    
                    <div class="map-container" id="map-render">
                        <!-- SVG Map for Michelena -->
                    </div>
                    <input type="hidden" id="lugar_exacto">
                </div>

                <div>
                    <label class="label-mini">Referencia Manual (Lugar)</label>
                    <input type="text" id="lugar" class="input-style" placeholder="Ej. Sala de juntas 3, Comedor..." required>
                </div>
            </div>

            <!-- SECCIÓN 5: DESCRIPCIÓN -->
            <div>
                <label class="label-mini">Nombre del Objeto</label>
                <input type="text" id="nombre" class="input-style" placeholder="Ej. iPhone 13 Pro color Negro" required>
            </div>
            <div>
                <label class="label-mini">Descripción Detallada</label>
                <textarea id="descripcion" class="input-style h-24 resize-none" placeholder="Indique marcas, daños, o señas particulares..."></textarea>
            </div>

            <button type="submit" id="btnSave" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-black py-4 rounded-2xl uppercase tracking-widest shadow-lg shadow-orange-200 transition-all">
                Guardar Registro
            </button>
        </form>
    </div>

    <script type="module">
        import { firebaseConfig } from '../../script.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-lock').style.display = 'none';
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        document.getElementById('auth-lock').innerHTML = `<p class="text-xs font-black text-red-500">SESIÓN REQUERIDA</p>`;
                    }
                } catch (e) { console.error(e); }
            }
        });

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('img-output').src = e.target.result;
                    document.getElementById('img-output').classList.remove('hidden');
                    document.getElementById('photo-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.toggleFoundDetails = () => {
            const estado = document.getElementById('estado').value;
            document.getElementById('found-details').classList.toggle('hidden', estado !== 'Resguardado');
        };

        window.handleBuildingChange = () => {
            const edificio = document.getElementById('edificio').value;
            const mapSection = document.getElementById('map-section');
            mapSection.classList.toggle('hidden', edificio !== 'Michelena');
            if(edificio === 'Michelena') setMapLevel('PB');
        };

        window.setMapLevel = (level) => {
            const render = document.getElementById('map-render');
            const btnPb = document.getElementById('btn-pb');
            const btnPisos = document.getElementById('btn-pisos');

            btnPb.className = level === 'PB' ? 'px-3 py-1 bg-orange-600 text-white rounded-lg text-[10px] font-black' : 'px-3 py-1 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black';
            btnPisos.className = level === 'PISOS' ? 'px-3 py-1 bg-orange-600 text-white rounded-lg text-[10px] font-black' : 'px-3 py-1 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black';

            if(level === 'PB') {
                render.innerHTML = `
                    <svg viewBox="0 0 200 150" class="map-svg">
                        <rect x="10" y="10" width="180" height="130" fill="none" stroke="#ccc" />
                        <!-- Ramp -->
                        <path d="M 120 40 Q 180 40 180 80 Q 180 120 120 120 L 120 110" fill="none" stroke="#f97316" stroke-width="8" opacity="0.2"/>
                        
                        <!-- Zones -->
                        <rect x="20" y="100" width="40" height="30" class="map-zone" data-name="PB - Puerta Emergencia" onclick="selectZone(this)"/>
                        <text x="40" y="118" class="map-text">Emerge.</text>

                        <rect x="70" y="100" width="60" height="30" class="map-zone" data-name="PB - Entrada Principal" onclick="selectZone(this)"/>
                        <text x="100" y="118" class="map-text">Entrada</text>

                        <rect x="80" y="50" width="40" height="30" class="map-zone" data-name="PB - Recepción" onclick="selectZone(this)"/>
                        <text x="100" y="68" class="map-text">Recep.</text>

                        <circle cx="100" cy="25" r="10" class="map-zone" data-name="PB - Elevadores" onclick="selectZone(this)"/>
                        <text x="100" y="28" class="map-text">Elev.</text>

                        <rect x="20" y="20" width="50" height="60" class="map-zone" data-name="PB - Oficinas Posteriores" onclick="selectZone(this)"/>
                        <text x="45" y="55" class="map-text">Oficinas</text>
                        
                        <rect x="10" y="10" width="30" height="15" class="map-zone" data-name="PB - Entrada Secundaria" onclick="selectZone(this)"/>
                        <text x="25" y="20" class="map-text" style="font-size:5px">Snd. Ent.</text>
                    </svg>
                `;
            } else {
                render.innerHTML = `
                    <svg viewBox="0 0 200 150" class="map-svg">
                        <rect x="10" y="10" width="180" height="130" fill="none" stroke="#ccc" />
                        <!-- Central Core -->
                        <circle cx="100" cy="75" r="12" class="map-zone" data-name="Pisos - Lobby Elevadores" onclick="selectZone(this)"/>
                        <text x="100" y="78" class="map-text">Elev.</text>

                        <!-- Corridors -->
                        <rect x="20" y="30" width="70" height="90" class="map-zone" data-name="Pisos - Pasillo Izquierdo" onclick="selectZone(this)"/>
                        <text x="55" y="78" class="map-text">Pasillo A</text>

                        <rect x="110" y="30" width="70" height="90" class="map-zone" data-name="Pisos - Pasillo Derecho" onclick="selectZone(this)"/>
                        <text x="145" y="78" class="map-text">Pasillo B</text>

                        <!-- Emergency -->
                        <rect x="10" y="65" width="10" height="20" class="map-zone" data-name="Pisos - Emergencia Izq" onclick="selectZone(this)"/>
                        <rect x="180" y="65" width="10" height="20" class="map-zone" data-name="Pisos - Emergencia Der" onclick="selectZone(this)"/>
                    </svg>
                `;
            }
        };

        window.selectZone = (el) => {
            document.querySelectorAll('.map-zone').forEach(z => z.classList.remove('selected'));
            el.classList.add('selected');
            const zoneName = el.getAttribute('data-name');
            document.getElementById('lugar_exacto').value = zoneName;
            document.getElementById('lugar').value = zoneName;
        };

        document.getElementById('lostForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.textContent = 'Procesando...';

        const data = {
                nombre: document.getElementById('nombre').value.trim(),
                categoria: document.getElementById('categoria').value,
                descripcion: document.getElementById('descripcion').value.trim(),
                edificio: document.getElementById('edificio').value,
                lugar: document.getElementById('lugar').value.trim(),
                lugar_exacto: document.getElementById('lugar_exacto').value,
                estado: document.getElementById('estado').value,
                fecha: new Date().toISOString().split('T')[0],
                creado_en: serverTimestamp(),
                registrado_por: auth.currentUser.email
            };

            // Datos de entrega si aplica
            if (data.estado === 'Resguardado') {
                data.entrega_socio = document.getElementById('entrega_socio').value.trim();
                data.entrega_nombre = document.getElementById('entrega_nombre').value.trim();
            }

            // Manejo de Foto (Simulado para este entorno, se guardaría en Storage)
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                // Aquí iría el upload a Firebase Storage
                // uploadBytes(ref(storage, ...), file)
                data.has_photo = true;
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'RegLost'), data);
                alert("Objeto registrado con éxito.");
                location.reload();
            } catch (err) {
                console.error(err);
                alert("Error al guardar.");
                btn.disabled = false;
                btn.textContent = 'Guardar Registro';
            }
        };
    </script>
</body>
</html>