<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Siniestro - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --accent-blue: #2563eb;
            --accent-blue-dark: #1e3a8a;
            --md-surface: #ffffff;
            --md-background: #f8fafc;
            --md-outline: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--md-background);
            color: #1e293b;
            padding: 1rem;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* --- Est√©tica Metalizada --- */
        .header-card {
            background: linear-gradient(180deg, #1e3a8a 0%, #2563eb 50%, #1e3a8a 100%);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(30, 58, 138, 0.3);
            border: 1px solid #1e3a8a;
            position: relative;
            overflow: hidden;
        }

        .header-card::before {
            content: ""; position: absolute; inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(255, 255, 255, 0.05) 1px, rgba(255, 255, 255, 0.05) 2px);
            pointer-events: none;
        }

        .form-card {
            background: white;
            border-radius: 1.5rem;
            border: 1px solid var(--md-outline);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .standard-input {
            width: 100%;
            padding: 10px 14px;
            background-color: #f8fafc;
            border: 1.5px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            outline: none;
        }
        .standard-input:focus {
            border-color: var(--accent-blue);
            background-color: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.05);
        }

        /* --- Editor --- */
        .ribbon-toolbar {
            background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        .toolbar-group { display: flex; align-items: center; background: white; padding: 2px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .toolbar-btn {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px; color: #475569; font-size: 12px;
            transition: all 0.1s; cursor: pointer; position: relative;
        }
        .toolbar-btn:hover { background-color: #f1f5f9; color: var(--accent-blue); }

        .editor-content { 
            min-height: 300px; padding: 1.5rem; outline: none; 
            font-size: 14px; line-height: 1.7; background: white; 
        }
        .editor-content:empty:before { content: attr(placeholder); color: #94a3b8; pointer-events: none; }

        /* --- Paleta de Colores --- */
        .color-palette-container {
            padding: 12px; background: white; border: 1px solid #e2e8f0; border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); position: absolute; z-index: 1000;
            top: 110%; left: 0; width: 240px;
        }
        .color-row { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
        .color-swatch { width: 24px; height: 24px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        .color-indicator-bar { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 18px; height: 3px; border-radius: 1px; }

        /* --- Buscador --- */
        #search-results { 
            max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; background: white; z-index: 100; position: absolute; width: 100%; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
        }
        .result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .result-item:hover { background-color: #eff6ff; border-left: 4px solid var(--accent-blue); }

        .step-pill {
            font-size: 10px; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.1em; background: #eff6ff; color: var(--accent-blue);
            padding: 4px 12px; border-radius: 99px;
        }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[2000] flex flex-col justify-center items-center transition-opacity duration-500">
        <div class="w-10 h-10 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400">Sincronizando Sistema...</p>
    </div>

    <div class="max-w-4xl mx-auto space-y-6 pb-20">
        <header class="header-card text-white p-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center border border-white/20">
                    <i class="fa-solid fa-triangle-exclamation text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tight">Registro de Siniestros</h1>
                    <p class="text-[9px] text-blue-100/60 font-bold uppercase tracking-widest">Protocolo de Atenci√≥n CIC 7.1</p>
                </div>
            </div>
            <div id="clockSin" class="hidden sm:block text-xs font-black bg-black/20 px-3 py-1 rounded-lg">00:00:00</div>
        </header>

        <main>
            <form id="formSiniestros" class="form-card overflow-hidden">
                <div class="p-6 md:p-10 space-y-10" id="formUI">
                    
                    <!-- PASO 1: UBICACI√ìN -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 1</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Ubicaci√≥n</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üè¢ Negocio</label>
                                <select id="Negocio" class="standard-input" required>
                                    <option value="Oficinas de servicio Oxxo" selected>Oficinas de servicio Oxxo</option>
                                    <option value="Club de Futbol Monterrey">Club de Futbol Monterrey</option>
                                    <option value="Femsa">Femsa</option>
                                    <option value="Otras">Otras</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üìç Plaza / Oficina</label>
                                <select id="Plaza" class="standard-input" required>
                                    <option value="Oficina de servicio (OS)" selected>Oficina de servicio (OS)</option>
                                    <option value="Otras">Otras</option>
                                </select>
                                <input type="text" id="PlazaOtro" class="standard-input mt-2 hidden" placeholder="Especifique plaza">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üèóÔ∏è Edificio / Sede</label>
                            <select id="Edificio" class="standard-input" required>
                                <option value="Edison" selected>Edison</option>
                                <option value="Almac√©n Dr. Mora">Almac√©n Dr. Mora</option>
                                <option value="Anexo OS">Anexo OS</option>
                                <option value="Corporativo Femsa">Corporativo Femsa</option>
                                <option value="Fundadores">Fundadores</option>
                                <option value="Michelena">Michelena</option>
                                <option value="Xpertal">Xpertal</option>
                            </select>
                        </div>
                    </div>

                    <!-- PASO 2: CLASIFICACI√ìN -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 2</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Tipo de Incidente</h3>
                        </div>
                        <div class="space-y-4 p-6 bg-slate-50/50 rounded-3xl border border-slate-100 relative">
                            <div class="relative space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üîç Buscar Subtipo</label>
                                <input type="text" id="subtipoSearch" class="standard-input" placeholder="Escriba para filtrar incidentes...">
                                <div id="search-results" class="hidden"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">‚ö†Ô∏è Categor√≠a</label>
                                    <select id="TipoSiniestroSelect" class="standard-input font-bold uppercase" required></select>
                                    <input type="hidden" id="TipoSiniestro" required>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üìå Subtipo</label>
                                    <select id="SubtipoSelect" class="standard-input font-bold uppercase" required></select>
                                    <input type="hidden" id="Subtipo" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 3: DESCRIPCI√ìN -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 3</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Descripci√≥n</h3>
                        </div>
                        <div class="border border-slate-200 rounded-3xl overflow-hidden shadow-sm focus-within:border-blue-500 transition-all">
                            <div class="ribbon-toolbar" id="editorToolbar">
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-btn" onclick="formatDoc('bold')"><i class="fa-solid fa-bold"></i></button>
                                    <button type="button" class="toolbar-btn" onclick="formatDoc('italic')"><i class="fa-solid fa-italic"></i></button>
                                    <button type="button" class="toolbar-btn" onclick="formatDoc('underline')"><i class="fa-solid fa-underline"></i></button>
                                </div>
                                <div class="toolbar-group relative">
                                    <button type="button" class="toolbar-btn" id="colorBtn" title="Color de fuente"><i class="fa-solid fa-font"></i><div id="currentColorIndicator" class="color-indicator-bar" style="background: #000"></div></button>
                                    <button type="button" class="toolbar-btn" id="bgColorBtn" title="Resaltado"><i class="fa-solid fa-highlighter"></i><div id="currentBgColorIndicator" class="color-indicator-bar" style="background: transparent; border: 1px solid #ddd"></div></button>
                                    <div id="colorPalette" class="color-palette-container hidden flex flex-col gap-2"></div>
                                </div>
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-btn" onclick="formatDoc('insertUnorderedList')"><i class="fa-solid fa-list-ul"></i></button>
                                    <button type="button" class="toolbar-btn" onclick="formatDoc('removeFormat')"><i class="fa-solid fa-eraser"></i></button>
                                </div>
                            </div>
                            <div id="descripcion" contenteditable="true" class="editor-content" placeholder="Relate detalladamente los hechos ocurridos..."></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="p-4 bg-white border border-slate-100 rounded-2xl flex items-center justify-between cursor-pointer hover:bg-slate-50 transition-colors">
                                <span class="text-[11px] font-bold text-slate-600 uppercase">üöë Lesionados en sitio</span>
                                <input type="checkbox" name="personasAfectadas[]" value="Lesionados" class="w-5 h-5 accent-blue-600">
                            </label>
                            <label class="p-4 bg-white border border-slate-100 rounded-2xl flex items-center justify-between cursor-pointer hover:bg-slate-50 transition-colors">
                                <span class="text-[11px] font-bold text-slate-600 uppercase">‚öñÔ∏è Personas Detenidas</span>
                                <input type="checkbox" name="personasAfectadas[]" value="Detenidos" class="w-5 h-5 accent-blue-600">
                            </label>
                        </div>
                    </div>

                    <!-- PASO 4: RESPONSABLES -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 4</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Personal</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üë§ Quien reporta</label>
                                <input type="text" id="reporta" class="standard-input" placeholder="Nombre completo" required>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üßë‚Äçüíº Realiza (CCO)</label>
                                <select id="realiza" class="standard-input" required></select>
                                <input type="text" id="realizaOtro" class="standard-input mt-2 hidden" placeholder="Nombre completo del operador">
                            </div>
                        </div>
                    </div>

                    <!-- PASO 5: NOTIFICACIONES -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 5</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Notificaciones</h3>
                        </div>
                        <div class="space-y-4">
                            <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üì® Notificar adicionalmente a:</label>
                            <div class="grid grid-cols-1 gap-2" id="extraEmailsList">
                                <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-blue-50 cursor-pointer transition-colors">
                                    <input type="checkbox" class="w-4 h-4 accent-blue-600" name="correosExtra" value="jesuseduardo.gutierrez@armur.com;juan.paniagua@armur.com;ana.martinezisai@armur.com">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase italic">Supervisores y RH</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-blue-50 cursor-pointer transition-colors">
                                    <input type="checkbox" class="w-4 h-4 accent-blue-600" name="correosExtra" value="emmanuel.zapata@oxxogas.com;andreac.rodriguez@oxxogas.com">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase italic">Oxxo Gas</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-blue-50 cursor-pointer transition-colors">
                                    <input type="checkbox" class="w-4 h-4 accent-blue-600" name="correosExtra" value="treycy.arreguin@oxxo.com">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase italic">Treycy Arreguin</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 bg-slate-50/50 rounded-xl hover:bg-slate-50 cursor-pointer border border-transparent hover:border-slate-200 transition-colors">
                                    <input type="checkbox" class="w-4 h-4 accent-[#450a0a]" name="correosExtra" value="josea.palacios@armur.com">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase tracking-tighter italic">Jos√© Antonio Palacios (josea.palacios@armur.com)</span>
                                </label>
                            </div>
                            <div class="mt-2">
                                <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">‚úèÔ∏è Otros correos (separados por ;)</label>
                                <input type="text" id="correosOtros" class="standard-input" placeholder="ejemplo@correo.com">
                            </div>
                        </div>
                        <div id="emailPreviewSection" class="p-5 bg-blue-50 border border-blue-100 rounded-2xl space-y-3 hidden">
                            <label class="text-[9px] font-black text-blue-900 uppercase tracking-widest block">üìã Destinatarios confirmados:</label>
                            <div id="emailListDisplay" class="flex flex-wrap gap-2"></div>
                        </div>
                        
                    </div>

                    <div class="pt-6 space-y-4">
                        <button type="submit" id="btnSubmit" class="w-full py-5 bg-blue-600 text-white rounded-[2rem] font-black text-xs uppercase tracking-[0.2em] shadow-xl hover:bg-blue-700 transition-all flex items-center justify-center gap-3">
                            <i class="fa-solid fa-paper-plane"></i> Finalizar y Registrar
                        </button>
                        <div class="flex justify-center items-center opacity-30 hover:opacity-100 transition-opacity">
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="testMode" class="w-3 h-3 accent-slate-400">
                                <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Modo de prueba (Solo remitente)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- √âXITO -->
                <div id="successUI" class="hidden py-24 text-center space-y-6">
                    <div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center mx-auto text-4xl border border-emerald-100 shadow-sm">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tighter">¬°Registro Exitoso!</h3>
                        <p class="text-sm text-slate-500 max-w-xs mx-auto mt-2">El incidente ha sido registrado y notificado correctamente.</p>
                    </div>
                    <button type="button" onclick="location.reload()" class="px-10 py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl">Crear Nuevo Reporte</button>
                </div>
            </form>
        </main>
    </div>

    <script>
        const URL_RECUPERAR = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/097a63200e254f4db1c47d052f2613ef/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=4GE6KXcJvL1j7ih9cl-ubC93RoycRieLuJuz2DdbFU4";
        const URL_ENVIAR = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/28a6ecf6c40e4d14aa520a51c8430065/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=4DbF_Lj5HOOWUNIaV_lSLMZH1j5etCF1n18CTLRDkxs";

        let matrix = [];
        let activeColorCommand = 'foreColor';

        const dom = {
            tipo: document.getElementById('TipoSiniestroSelect'),
            subtipo: document.getElementById('SubtipoSelect'),
            tipoHidden: document.getElementById('TipoSiniestro'),
            subtipoHidden: document.getElementById('Subtipo'),
            search: document.getElementById('subtipoSearch'),
            results: document.getElementById('search-results'),
            realiza: document.getElementById('realiza'),
            realizaOtro: document.getElementById('realizaOtro'),
            editor: document.getElementById('descripcion'),
            colorBtn: document.getElementById('colorBtn'),
            bgColorBtn: document.getElementById('bgColorBtn'),
            colorPalette: document.getElementById('colorPalette'),
            indicator: document.getElementById('currentColorIndicator'),
            bgIndicator: document.getElementById('currentBgColorIndicator'),
            loader: document.getElementById('loader')
        };

        const colorGroups = [
            { label: 'Neutrales', colors: ['#000000', '#2d3748', '#4a5568', '#718096', '#a0aec0', '#cbd5e0', '#e2e8f0', '#FFFFFF'] },
            { label: 'Alertas', colors: ['#450a0a', '#7f1d1d', '#991b1b', '#b91c1c', '#dc2626', '#ef4444', '#f87171', '#fca5a5'] },
            { label: 'Siniestros', colors: ['#1e3a8a', '#1d4ed8', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#eff6ff'] }
        ];

        window.formatDoc = (cmd, val = null) => { dom.editor.focus(); document.execCommand(cmd, false, val); };

        async function init() {
            try {
                const [rMatriz, rUsers] = await Promise.all([
                    fetch(URL_RECUPERAR, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ Mode: "Tipos" }) }),
                    fetch(URL_RECUPERAR, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ Mode: "ElementosPP" }) })
                ]);

                const dMatriz = await rMatriz.json();
                const dUsers = await rUsers.json();
                matrix = dMatriz.Matriz || [];
                
                const tipos = [...new Set(matrix.map(i => i.Tipo))].sort();
                dom.tipo.innerHTML = '<option value="">Seleccione Categor√≠a</option>' + tipos.map(t => `<option value="${t}">${t}</option>`).join('');

                const operadores = (dUsers.Usuarios || []).filter(u => u.Area === "Centro de Control").sort((a,b) => a.Nombre.localeCompare(b.Nombre));
                dom.realiza.innerHTML = '<option value="">Seleccione Operador</option>' + operadores.map(u => `<option value="${u.Nombre}">${u.Nombre}</option>`).join('') + '<option value="Otro">Otro (Especificar)</option>';

                buildColorPalette();
                hideLoader();
            } catch (err) { hideLoader(); }
        }

        function hideLoader() { dom.loader.classList.add('opacity-0'); setTimeout(() => dom.loader.style.display = 'none', 500); }

        function buildColorPalette() {
            dom.colorPalette.innerHTML = '';
            colorGroups.forEach(g => {
                const l = document.createElement('div'); l.className = 'text-[7px] font-black uppercase text-slate-400 mt-2 mb-1'; l.innerText = g.label;
                dom.colorPalette.appendChild(l);
                const r = document.createElement('div'); r.className = 'color-row';
                g.colors.forEach(c => {
                    const s = document.createElement('div'); s.className = 'color-swatch'; s.style.backgroundColor = c;
                    s.onmousedown = (e) => { 
                        e.preventDefault(); formatDoc(activeColorCommand, c); 
                        if (activeColorCommand === 'foreColor') dom.indicator.style.background = c;
                        else dom.bgIndicator.style.background = c;
                        dom.colorPalette.classList.add('hidden'); 
                    };
                    r.appendChild(s);
                });
                dom.colorPalette.appendChild(r);
            });
        }

        dom.colorBtn.onmousedown = (e) => { e.preventDefault(); activeColorCommand = 'foreColor'; dom.colorPalette.classList.toggle('hidden'); };
        dom.bgColorBtn.onmousedown = (e) => { e.preventDefault(); activeColorCommand = 'hiliteColor'; dom.colorPalette.classList.toggle('hidden'); };

        dom.tipo.onchange = () => {
            const val = dom.tipo.value;
            dom.tipoHidden.value = val;
            const subs = matrix.filter(i => i.Tipo === val).sort((a,b) => a.Subtipo.localeCompare(b.Subtipo));
            dom.subtipo.innerHTML = '<option value="">Seleccione Subtipo</option>' + subs.map(s => `<option value="${s.Subtipo}">${s.Subtipo}</option>`).join('');
            updateEmailPreview();
        };

        dom.subtipo.onchange = () => { dom.subtipoHidden.value = dom.subtipo.value; dom.search.value = dom.subtipo.value; updateEmailPreview(); };

        dom.search.oninput = (e) => {
            const v = e.target.value.toLowerCase().trim();
            if (v.length < 2) { dom.results.classList.add('hidden'); return; }
            const res = matrix.filter(i => i.Subtipo.toLowerCase().includes(v) || i.Tipo.toLowerCase().includes(v)).slice(0, 10);
            if (res.length > 0) {
                dom.results.innerHTML = res.map(i => `
                    <div class="result-item" onclick="selectIncident('${i.Tipo.replace(/'/g, "\\'")}', '${i.Subtipo.replace(/'/g, "\\'")}')">
                        <p class="text-[7px] font-black text-blue-600 uppercase">${i.Tipo}</p>
                        <p class="text-[11px] font-bold text-slate-700 uppercase">${i.Subtipo}</p>
                    </div>`).join('');
                dom.results.classList.remove('hidden');
            } else dom.results.classList.add('hidden');
        };

        window.selectIncident = (t, s) => {
            dom.tipo.value = t; dom.tipo.onchange();
            dom.subtipo.value = s; dom.subtipoHidden.value = s; dom.search.value = s;
            dom.results.classList.add('hidden'); updateEmailPreview();
        };

        const updateEmailPreview = () => {
            const isTest = document.getElementById('testMode').checked;
            let todos = [];
            if (isTest) todos = ["proteccion.instalaciones@armur.com"];
            else {
                const match = matrix.find(item => item.Tipo === dom.tipoHidden.value && item.Subtipo === dom.subtipoHidden.value);
                let base = match?.["Listado de correos"] ? match["Listado de correos"].split(";").map(e => e.trim().toLowerCase()) : [];
                let extras = Array.from(document.querySelectorAll("input[name='correosExtra']:checked")).flatMap(cb => cb.value.split(";")).map(e => e.trim().toLowerCase());
                let manual = document.getElementById("correosOtros").value.split(";").map(e => e.trim().toLowerCase()).filter(c => c && c.includes('@'));
                todos = [...new Set([...base, ...extras, ...manual])].filter(c => c && c.includes('@'));
            }
            const section = document.getElementById('emailPreviewSection');
            const display = document.getElementById('emailListDisplay');
            if (todos.length > 0) {
                section.classList.remove('hidden');
                display.innerHTML = todos.map(e => `<span class="px-2 py-1 bg-white border border-blue-100 text-blue-900 text-[9px] font-bold rounded-lg lowercase shadow-sm">${e}</span>`).join('');
            } else section.classList.add('hidden');
            return todos.join("; ");
        };

        document.getElementById('formSiniestros').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            if (!dom.editor.innerText.trim()) return alert("Debe incluir una descripci√≥n.");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin"></i> Registrando...';

            const payload = {
                negocioSeleccionado: document.getElementById('Negocio').value,
                plazaSeleccionada: document.getElementById('Plaza').value === 'Otras' ? document.getElementById('PlazaOtro').value : document.getElementById('Plaza').value,
                edificioSeleccionado: document.getElementById('Edificio').value,
                tipoSiniestroSeleccionado: dom.tipoHidden.value,
                subtipoSeleccionado: dom.subtipoHidden.value,
                descripcionIncidente: dom.editor.innerHTML,
                descripcionTextoPlano: dom.editor.innerText,
                personasAfectadas: Array.from(document.querySelectorAll("input[name='personasAfectadas[]']")).map(cb => `${cb.value}: ${cb.checked ? "S√≠" : "No"}`).join('\n'),
                nombreReporta: document.getElementById('reporta').value,
                nombreRealiza: dom.realiza.value === 'Otro' ? dom.realizaOtro.value : dom.realiza.value,
                listadoCorreos: updateEmailPreview(),
                timestamp: new Date().toISOString()
            };

            try {
                const res = await fetch(URL_ENVIAR, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload) });
                if (res.ok) {
                    document.getElementById('formUI').style.display = 'none';
                    document.getElementById('successUI').classList.remove('hidden');
                } else throw new Error();
            } catch (err) {
                alert("Error al enviar reporte.");
                btn.disabled = false; btn.innerHTML = 'Finalizar y Registrar';
            }
        };

        document.getElementById('Plaza').onchange = function() { document.getElementById('PlazaOtro').classList.toggle('hidden', this.value !== 'Otras'); };
        dom.realiza.onchange = function() { dom.realizaOtro.classList.toggle('hidden', this.value !== 'Otro'); };
        document.getElementById('testMode').onchange = updateEmailPreview;
        document.getElementById('correosOtros').oninput = updateEmailPreview;
        document.querySelectorAll("input[name='correosExtra']").forEach(cb => cb.onchange = updateEmailPreview);

        setInterval(() => { document.getElementById('clockSin').textContent = new Date().toLocaleTimeString('es-MX', { hour12: false }); }, 1000);
        init();
    </script>
</body>
</html>