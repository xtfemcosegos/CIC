<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nav - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body {
            background: transparent;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 1rem;
            color: #1f2937;
            overflow-x: hidden;
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 1.25rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.04);
        }

        .user-avatar {
            height: 3.5rem;
            width: 3.5rem;
            border-radius: 1rem;
            object-fit: cover;
            background-color: #f3f4f6;
            border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .app-button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem 0.75rem;
            width: 100%;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: #4b5563;
            border: 1px solid transparent;
        }

        .app-button:hover {
            background: white;
            border-color: #f1f5f9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            transform: translateX(4px);
            color: #0f172a;
        }

        .icon-box {
            height: 2.25rem;
            width: 2.25rem;
            border-radius: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            padding: 0.4rem;
        }

        .icon-box img {
            height: 100%;
            width: 100%;
            object-fit: contain;
        }

        /* Scrollbar discreto */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Perfil de Usuario Dinámico -->
    <div class="profile-card p-3 mb-8 flex items-center gap-3">
        <div class="relative shrink-0">
            <img id="userPhoto" 
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cbd5e1'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'%3E%3C/path%3E%3C/svg%3E" 
                alt="Usuario" 
                class="user-avatar"
                onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23cbd5e1%22%3E%3Cpath d=%22M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z%22%3E%3C/path%3E%3C/svg%3E';">
            <div class="absolute -bottom-1 -right-1 h-3.5 w-3.5 bg-green-500 border-2 border-white rounded-full"></div>
        </div>
        
        <div class="flex-1 min-w-0">
            <h3 id="userName" class="text-sm font-black text-slate-800 truncate leading-tight">Cargando...</h3>
            <p id="userRole" class="text-[9px] font-bold text-teal-600 uppercase tracking-wider truncate">Socio del Sistema</p>
        </div>

        <button id="logoutBtn" title="Cerrar Sesión" class="shrink-0 p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        </button>
    </div>

    <!-- Navegación de Aplicaciones -->
    <nav class="space-y-1">
        <p class="text-[9px] uppercase tracking-[0.25em] text-slate-400 font-black px-3 mb-3">Módulos CIC 7.1</p>
        
        <button onclick="openApp('Apps/home.html', 'Inicio')" class="app-button">
            <div class="icon-box bg-slate-900 shadow-sm">
                <img src="../MM/Home.png" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <span class="text-white text-[10px] font-black hidden">IN</span>
            </div>
            <span>Inicio</span>
        </button>

        <button onclick="openApp('Apps/RegAs.html', 'Asistencia')" class="app-button">
            <div class="icon-box bg-purple-700 shadow-sm">
                <img src="../MM/RegAs.png" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <span class="text-white text-[10px] font-black hidden">RA</span>
            </div>
            <span>Asistencia</span>
        </button>

        <button onclick="openApp('Apps/RegSin.html', 'Reportes')" class="app-button">
            <div class="icon-box bg-blue-600 shadow-sm">
                <img src="../MM/RegSin.png" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <span class="text-white text-[10px] font-black hidden">RS</span>
            </div>
            <span>Siniestros y Reportes</span>
        </button>

        <button onclick="openApp('Apps/RegUs.html', 'Usuarios')" class="app-button">
            <div class="icon-box bg-teal-600 shadow-sm">
                <img src="../MM/RegUs.png" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <span class="text-white text-[10px] font-black hidden">RU</span>
            </div>
            <span>Directorio de Socios</span>
        </button>

        <button onclick="openApp('Apps/Marbetes.html', 'Marbetes')" class="app-button">
            <div class="icon-box bg-emerald-500 shadow-sm">
                <img src="../MM/RegMa.png" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <span class="text-white text-[10px] font-black hidden">RM</span>
            </div>
            <span>Control de Marbetes</span>
        </button>

        <button onclick="openApp('Apps/RegIn.html', 'Ingresos')" class="app-button">
            <div class="icon-box bg-indigo-900 shadow-sm">
                <img src="../MM/RegIn.png" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <span class="text-white text-[10px] font-black hidden">RI</span>
            </div>
            <span>Registro de Ingresos</span>
        </button>

        <button onclick="openApp('Apps/MiSpace.html', 'Mi Espacio')" class="app-button">
            <div class="icon-box bg-rose-600 shadow-sm">
                <img src="../MM/MiSpace.png" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <span class="text-white text-[10px] font-black hidden">ME</span>
            </div>
            <span>Mi Espacio Académico</span>
        </button>
    </nav>

    <script type="module">
        import { firebaseConfig } from '../script.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic-71';

        const userName = document.getElementById('userName');
        const userPhoto = document.getElementById('userPhoto');
        const userRole = document.getElementById('userRole');
        const logoutBtn = document.getElementById('logoutBtn');

        async function resolvePhoto(path) {
            if (!path) return;
            try {
                if (path.startsWith('gs://')) {
                    const storagePath = path.replace(/gs:\/\/[^\/]+\//, '');
                    const url = await getDownloadURL(ref(storage, storagePath));
                    userPhoto.src = url;
                } else {
                    userPhoto.src = path;
                }
            } catch (e) { console.error("Error al cargar foto:", e); }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Sincronizar datos reales desde Firestore
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', 'ElementosPP');
                    const snap = await getDoc(docRef);
                    
                    if (snap.exists()) {
                        const usuarios = snap.data();
                        let socioData = null;

                        // Buscar por email
                        for (const key in usuarios) {
                            if (usuarios[key].contacto?.email?.toLowerCase() === user.email.toLowerCase()) {
                                socioData = usuarios[key];
                                break;
                            }
                        }

                        if (socioData) {
                            // Validar permisos en tiempo real
                            if (socioData.hasAuth === false) {
                                await signOut(auth);
                                return;
                            }
                            
                            // Actualizar UI con datos oficiales
                            userName.textContent = socioData.nombre || user.email.split('@')[0];
                            userRole.textContent = socioData.operativa?.puesto || socioData.puesto || "Personal CIC";
                            if (socioData.photo) await resolvePhoto(socioData.photo);
                        } else {
                            userName.textContent = user.email.split('@')[0];
                        }
                    }
                } catch (err) {
                    console.error("Error al sincronizar perfil:", err);
                    userName.textContent = user.email.split('@')[0];
                }
            } else {
                window.parent.location.href = "../index.html";
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.parent.location.href = "../index.html";
            } catch (error) { console.error(error); }
        });

        window.openApp = function(url, name) {
            window.parent.postMessage({ action: 'openApp', url: url, name: name }, '*');
        };
    </script>
</body>
</html>