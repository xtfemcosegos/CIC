<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Data Migrator - Pro CIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .input-focus:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); outline: none; }
        .transition-all { transition: all 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .preview-scroll { max-height: 500px; overflow-y: auto; scrollbar-width: thin; }
        .preview-scroll::-webkit-scrollbar { width: 6px; }
        .preview-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .selection-list { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 p-4 lg:p-8">

    <div class="max-w-7xl mx-auto space-y-6 pb-20">
        <!-- Encabezado Principal -->
        <header class="bg-blue-900 text-white p-6 rounded-[2rem] shadow-2xl flex flex-col md:flex-row justify-between items-center gap-4 border-b-4 border-blue-700">
            <div class="flex items-center gap-4">
                <div class="bg-white/10 p-3 rounded-2xl">
                    <svg class="w-8 h-8 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black uppercase tracking-tighter">Migrador Firebase CIC</h1>
                    <p class="text-blue-300 text-xs font-bold uppercase tracking-widest opacity-80">Gesti√≥n y Transferencia de Datos</p>
                </div>
            </div>
            <div id="status-log" class="hidden px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest animate-pulse border text-white"></div>
        </header>

        <!-- Cuadr√≠cula Principal (2 Columnas) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
            
            <!-- COLUMNA IZQUIERDA: ORIGEN -->
            <div class="space-y-6">
                <!-- Paso 1: Acceso Origen -->
                <section id="step-1-container" class="glass p-6 rounded-[2.5rem] shadow-xl border border-slate-200 transition-all">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-sm font-black text-blue-800 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-[10px]">01</span>
                            Acceso Origen
                        </h2>
                        <div id="saved-projects-src" class="hidden animate-fade-in">
                            <select onchange="loadProject(this.value, 'src')" 
                                    class="projects-dropdown text-[10px] font-bold p-2 bg-slate-100 border border-slate-200 rounded-xl text-blue-700 outline-none cursor-pointer">
                                <option value="">üìÇ Cargar guardado...</option>
                            </select>
                        </div>
                    </div>

                    <div id="project-summary-src" class="hidden flex items-center justify-between bg-blue-50 p-4 rounded-2xl border border-blue-100 animate-fade-in mb-2">
                        <div>
                            <p class="summary-name text-xs font-black text-blue-900 uppercase"></p>
                            <p class="summary-email text-[10px] text-blue-600 font-bold"></p>
                        </div>
                        <button onclick="expandStep('src')" class="text-[9px] font-black text-blue-700 hover:underline uppercase">Editar</button>
                    </div>

                    <div id="fields-src" class="space-y-4">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="project-name-src" class="col-span-2 p-3 border border-slate-200 rounded-xl bg-slate-50 input-focus text-xs font-bold" placeholder="Nombre del Proyecto">
                            <textarea id="config-src" class="col-span-2 p-3 border border-slate-200 rounded-xl bg-slate-50 input-focus font-mono text-[10px] h-24" placeholder='Config JSON Origen { "apiKey": "..." }'></textarea>
                            <input type="email" id="email-src" class="p-3 border border-slate-200 rounded-xl bg-slate-50 input-focus text-xs font-mono" placeholder="correo@origen.com">
                            <input type="password" id="pass-src" class="p-3 border border-slate-200 rounded-xl bg-slate-50 input-focus text-xs font-mono" placeholder="Contrase√±a">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="saveProject('src')" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-black py-3 rounded-xl text-[10px] uppercase shadow-md transition-all active:scale-95">Guardar Localmente</button>
                            <button onclick="deleteProject('src')" class="hidden btn-delete bg-rose-50 text-rose-500 px-4 rounded-xl border border-rose-100">üóëÔ∏è</button>
                        </div>
                    </div>
                </section>

                <!-- Paso 2: Ruta Origen -->
                <section id="step-2-container" class="glass p-6 rounded-[2.5rem] shadow-xl border border-slate-200">
                    <h2 class="text-sm font-black text-emerald-700 uppercase tracking-widest flex items-center gap-2 mb-6">
                        <span class="w-6 h-6 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center text-[10px]">02</span>
                        Definir Ruta
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-2 px-1">
                                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Ruta Firestore</label>
                                <span id="path-type" class="text-[9px] text-slate-400 font-bold uppercase italic">Detectando...</span>
                            </div>
                            <input type="text" id="path-src" oninput="detectPathType(this.value)" class="w-full p-4 border border-slate-200 rounded-2xl bg-white input-focus text-xs font-mono shadow-sm" placeholder="Ej: artifacts/cic.pp/public/data/CCTV">
                        </div>
                        <div id="export-mode-container" class="hidden p-4 bg-slate-50 rounded-2xl border border-slate-200 flex justify-around">
                            <label class="flex items-center gap-2 text-[10px] font-bold text-slate-600 cursor-pointer"><input type="radio" name="export-mode" value="single" checked> Consolidado</label>
                            <label class="flex items-center gap-2 text-[10px] font-bold text-slate-600 cursor-pointer"><input type="radio" name="export-mode" value="individual"> Individual</label>
                        </div>
                        <button id="btn-process" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-2xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-3 text-xs uppercase">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            Procesar Origen
                        </button>
                    </div>
                </section>
            </div>

            <!-- COLUMNA DERECHA: DESTINO -->
            <div id="step-4-container" class="hidden space-y-6 animate-fade-in">
                <section class="glass p-6 rounded-[2.5rem] shadow-xl border border-indigo-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-sm font-black text-indigo-800 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-6 h-6 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center text-[10px]">04</span>
                            Acceso Destino
                        </h2>
                        <div id="saved-projects-dest" class="animate-fade-in">
                            <select onchange="loadProject(this.value, 'dest')" 
                                    class="projects-dropdown text-[10px] font-bold p-2 bg-slate-100 border border-slate-200 rounded-xl text-indigo-700 outline-none cursor-pointer">
                                <option value="">üìÇ Cargar guardado...</option>
                            </select>
                        </div>
                    </div>

                    <div id="project-summary-dest" class="hidden flex items-center justify-between bg-indigo-50 p-4 rounded-2xl border border-indigo-100 animate-fade-in mb-4">
                        <div>
                            <p class="summary-name text-xs font-black text-indigo-900 uppercase"></p>
                            <p class="summary-email text-[10px] text-indigo-600 font-bold"></p>
                        </div>
                        <button onclick="expandStep('dest')" class="text-[9px] font-black text-indigo-700 hover:underline uppercase">Editar</button>
                    </div>

                    <div id="fields-dest" class="space-y-4">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="project-name-dest" class="col-span-2 p-3 border border-slate-200 rounded-xl bg-slate-50 input-focus text-xs font-bold" placeholder="Nombre del Proyecto Destino">
                            <textarea id="config-dest" class="col-span-2 p-3 border border-slate-200 rounded-xl bg-slate-50 input-focus font-mono text-[10px] h-24" placeholder="Config JSON Destino..."></textarea>
                            <input type="email" id="email-dest" class="p-3 border border-slate-200 rounded-xl bg-slate-50 input-focus text-xs font-mono" placeholder="correo@destino.com">
                            <input type="password" id="pass-dest" class="p-3 border border-slate-200 rounded-xl bg-slate-50 input-focus text-xs font-mono" placeholder="Contrase√±a">
                        </div>
                        <button onclick="saveProject('dest')" class="w-full bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-black py-3 rounded-xl text-[10px] uppercase shadow-sm transition-all">Guardar en Memoria</button>
                    </div>

                    <div class="mt-8 space-y-4 pt-6 border-t border-slate-100">
                        <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Ruta en Firestore Destino</label>
                        <input type="text" id="path-dest" class="w-full p-4 border border-indigo-200 rounded-2xl bg-white input-focus text-xs font-mono shadow-sm" placeholder="Ej: artifacts/nuevo/data/CCTV_MIGRADO">
                        
                        <button id="btn-upload" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-5 rounded-2xl shadow-xl transition-all active:scale-95 flex items-center justify-center gap-3 uppercase text-xs">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            Subir a Proyecto Destino
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- SECCI√ìN INFERIOR: PREVISUALIZACI√ìN Y TRANSMUTACI√ìN (ANCHO COMPLETO) -->
        <section id="preview-section" class="hidden glass p-8 rounded-[3rem] shadow-2xl border border-emerald-100 animate-fade-in space-y-6">
            <div class="flex flex-col md:row justify-between items-start md:items-center gap-4">
                <div class="flex items-center gap-3">
                    <h2 class="text-lg font-black text-slate-700 uppercase tracking-tight flex items-center gap-2">
                        <span class="w-8 h-8 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center text-xs italic">03</span>
                        Datos Extra√≠dos
                    </h2>
                    <span id="doc-count-badge" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-[10px] font-black uppercase">0 Documentos</span>
                </div>
                <div class="flex flex-wrap gap-2 w-full md:w-auto">
                    <button onclick="toggleSelectionPanel()" id="btn-toggle-selection" class="hidden bg-blue-100 text-blue-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-blue-200 transition-all">üìã Seleccionar Docs</button>
                    <button onclick="toggleTransmutation()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all shadow-md">‚ú® Transmutar Campos</button>
                    <button id="btn-download-json" class="border-2 border-emerald-500 text-emerald-600 hover:bg-emerald-50 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all">Descargar JSON</button>
                </div>
            </div>

            <!-- Panel de Selecci√≥n/Fusi√≥n -->
            <div id="selection-panel" class="hidden p-6 bg-blue-50 border border-blue-200 rounded-[2rem] animate-fade-in shadow-inner">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black text-blue-900 uppercase italic">
                        üì¶ Seleccionar Documentos para Fusi√≥n
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="selectAll(true)" class="text-[9px] font-bold text-blue-600 hover:underline uppercase">Todos</button>
                        <button onclick="selectAll(false)" class="text-[9px] font-bold text-blue-600 hover:underline uppercase">Ninguno</button>
                    </div>
                </div>
                <div id="selection-list-container" class="selection-list grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 mb-4 p-1">
                    <!-- Checkboxes din√°micos -->
                </div>
                <div class="flex gap-2">
                    <button onclick="applySelectionMerge()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-black py-3 rounded-xl text-[10px] uppercase shadow-md transition-all">Fusionar Seleccionados</button>
                    <button onclick="toggleSelectionPanel()" class="bg-slate-200 text-slate-600 px-6 rounded-xl text-[10px] font-bold uppercase transition-all">Cerrar</button>
                </div>
            </div>

            <!-- Panel de Transmutaci√≥n -->
            <div id="transmutation-panel" class="hidden p-6 bg-amber-50 border border-amber-200 rounded-[2rem] animate-fade-in shadow-inner">
                <h3 class="text-xs font-black text-amber-900 uppercase mb-4 flex items-center gap-2 italic">
                    üõ†Ô∏è Mapeo de Transmutaci√≥n
                </h3>
                <div id="mapping-container" class="grid grid-cols-1 md:grid-cols-3 gap-3 max-h-60 overflow-y-auto pr-2 mb-4 p-1">
                    <!-- Se llena v√≠a JS -->
                </div>
                <div class="flex gap-2">
                    <button onclick="applyTransmutation()" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-black py-3 rounded-xl text-[10px] uppercase shadow-md transition-all">Confirmar Transmutaci√≥n</button>
                    <button onclick="toggleTransmutation()" class="bg-slate-200 text-slate-600 px-6 rounded-xl text-[10px] font-bold uppercase transition-all">Cancelar</button>
                </div>
            </div>

            <div class="bg-slate-900 rounded-[2rem] p-6 shadow-2xl border-4 border-slate-800">
                <pre id="json-preview" class="preview-scroll text-emerald-400 font-mono text-[11px] leading-relaxed"></pre>
            </div>
        </section>

        <footer class="text-center text-slate-400 text-[9px] uppercase font-black tracking-widest pt-10">
            CIC - Centro de Control ¬© 2026 | Sistema de Migraci√≥n Segura
        </footer>
    </div>

    <script type="module">
        import { initializeApp, deleteApp, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Elementos UI
        const statusLog = document.getElementById('status-log');
        const pathTypeLabel = document.getElementById('path-type');
        const previewSection = document.getElementById('preview-section');
        const jsonPreview = document.getElementById('json-preview');
        const docCountBadge = document.getElementById('doc-count-badge');
        const transmutationPanel = document.getElementById('transmutation-panel');
        const mappingContainer = document.getElementById('mapping-container');
        const selectionPanel = document.getElementById('selection-panel');
        const selectionListContainer = document.getElementById('selection-list-container');
        const step4 = document.getElementById('step-4-container');

        let rawFetchedData = null; // Almacenamos el fetch original completo
        let currentFetchedData = null; // Almacenamos lo que se est√° visualizando/migrando

        // --- GESTI√ìN DE MEMORIA LOCAL ---

        function getSavedProjects() {
            return JSON.parse(localStorage.getItem('cic_firebase_projects') || '{}');
        }

        window.updateProjectsUI = () => {
            const projects = getSavedProjects();
            const names = Object.keys(projects);
            document.querySelectorAll('.projects-dropdown').forEach(dd => {
                const container = dd.parentElement;
                if (names.length === 0) {
                    container.classList.add('hidden');
                } else {
                    container.classList.remove('hidden');
                    dd.innerHTML = '<option value="">üìÇ Cargar guardado...</option>';
                    names.forEach(name => dd.innerHTML += `<option value="${name}">${name}</option>`);
                }
            });
        };

        window.saveProject = (suffix) => {
            const name = document.getElementById(`project-name-${suffix}`).value.trim();
            const config = document.getElementById(`config-${suffix}`).value.trim();
            const email = document.getElementById(`email-${suffix}`).value.trim();
            const pass = document.getElementById(`pass-${suffix}`).value.trim();

            if (!name || !config || !email || !pass) return showLog("Error: Faltan campos.", "error");

            const projects = getSavedProjects();
            projects[name] = { config, email, pass };
            localStorage.setItem('cic_firebase_projects', JSON.stringify(projects));
            updateProjectsUI();
            loadProject(name, suffix);
            showLog(`"${name}" guardado.`, "success");
        };

        window.loadProject = (name, suffix) => {
            if (!name) return;
            const p = getSavedProjects()[name];
            if (p) {
                document.getElementById(`project-name-${suffix}`).value = name;
                document.getElementById(`config-${suffix}`).value = p.config;
                document.getElementById(`email-${suffix}`).value = p.email;
                document.getElementById(`pass-${suffix}`).value = p.pass;
                
                document.getElementById(`fields-${suffix}`).classList.add('hidden');
                const summary = document.getElementById(`project-summary-${suffix}`);
                summary.classList.remove('hidden');
                summary.querySelector('.summary-name').innerText = name;
                summary.querySelector('.summary-email').innerText = p.email;
            }
        };

        window.expandStep = (suffix) => {
            document.getElementById(`fields-${suffix}`).classList.remove('hidden');
            document.getElementById(`project-summary-${suffix}`).classList.add('hidden');
        };

        window.deleteProject = (suffix) => {
            const name = document.getElementById(`project-name-${suffix}`).value.trim();
            if (!name) return;
            if (confirm(`¬øEliminar permanentemente "${name}"?`)) {
                const projects = getSavedProjects();
                delete projects[name];
                localStorage.setItem('cic_firebase_projects', JSON.stringify(projects));
                updateProjectsUI();
                expandStep(suffix);
                showLog("Proyecto eliminado.", "info");
            }
        };

        // --- L√ìGICA DE SELECCI√ìN Y FUSI√ìN ---

        window.toggleSelectionPanel = () => {
            if (!Array.isArray(rawFetchedData)) {
                showLog("La selecci√≥n solo est√° disponible para colecciones.", "error");
                return;
            }
            if (selectionPanel.classList.contains('hidden')) {
                renderSelectionList();
                selectionPanel.classList.remove('hidden');
            } else {
                selectionPanel.classList.add('hidden');
            }
        };

        function renderSelectionList() {
            selectionListContainer.innerHTML = '';
            rawFetchedData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-2 bg-white border border-blue-100 rounded-lg shadow-sm hover:bg-blue-50 transition-all';
                div.innerHTML = `
                    <input type="checkbox" class="doc-selector w-4 h-4 cursor-pointer" data-id="${item.id}" checked>
                    <span class="text-[10px] font-mono text-slate-600 truncate uppercase">${item.id}</span>
                `;
                selectionListContainer.appendChild(div);
            });
        }

        window.selectAll = (check) => {
            document.querySelectorAll('.doc-selector').forEach(cb => cb.checked = check);
        };

        window.applySelectionMerge = () => {
            const selectedIds = Array.from(document.querySelectorAll('.doc-selector:checked')).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) {
                showLog("Selecciona al menos un documento para fusionar.", "error");
                return;
            }

            currentFetchedData = rawFetchedData.filter(item => selectedIds.includes(item.id));
            jsonPreview.textContent = JSON.stringify(currentFetchedData, null, 2);
            docCountBadge.innerText = `${currentFetchedData.length} SELECCIONADOS`;
            showLog("Fusi√≥n aplicada a la previsualizaci√≥n.", "success");
            selectionPanel.classList.add('hidden');
        };

        // --- L√ìGICA DE TRANSMUTACI√ìN ---

        window.toggleTransmutation = () => {
            if (transmutationPanel.classList.contains('hidden')) {
                generateMappingUI();
                transmutationPanel.classList.remove('hidden');
            } else {
                transmutationPanel.classList.add('hidden');
            }
        };

        function generateMappingUI() {
            if (!currentFetchedData) return;
            mappingContainer.innerHTML = '';
            const sample = Array.isArray(currentFetchedData) ? currentFetchedData[0] : currentFetchedData;
            if (!sample) return;
            const keys = Object.keys(sample).filter(k => k !== 'id');

            keys.forEach(key => {
                const row = document.createElement('div');
                row.className = 'flex flex-col gap-1 p-3 bg-white border border-amber-200 rounded-xl shadow-sm hover:border-amber-400 transition-all';
                row.innerHTML = `
                    <span class="text-[8px] font-black text-amber-800 uppercase italic truncate">${key}</span>
                    <input type="text" data-old="${key}" class="mapping-input w-full p-2 border border-slate-100 rounded-lg text-[10px] font-bold bg-slate-50 input-focus" placeholder="Nuevo nombre" value="${key}">
                `;
                mappingContainer.appendChild(row);
            });
        }

        window.applyTransmutation = () => {
            const inputs = document.querySelectorAll('.mapping-input');
            const mapping = {};
            inputs.forEach(i => mapping[i.dataset.old] = i.value.trim());

            const transform = (obj) => {
                const newObj = { id: obj.id };
                Object.keys(obj).forEach(oldKey => {
                    if (oldKey === 'id') return;
                    const newKey = mapping[oldKey] || oldKey;
                    newObj[newKey] = obj[oldKey];
                });
                return newObj;
            };

            currentFetchedData = Array.isArray(currentFetchedData) ? currentFetchedData.map(transform) : transform(currentFetchedData);
            jsonPreview.textContent = JSON.stringify(currentFetchedData, null, 2);
            showLog("Transmutaci√≥n aplicada.", "success");
            transmutationPanel.classList.add('hidden');
        };

        // --- L√ìGICA DE OPERACI√ìN ---

        window.detectPathType = (val) => {
            const segments = val.split('/').filter(s => s.length > 0).length;
            const mode = document.getElementById('export-mode-container');
            if (segments % 2 !== 0 && segments > 0) {
                pathTypeLabel.innerText = "Tipo: Colecci√≥n";
                pathTypeLabel.className = "text-[9px] text-emerald-600 font-bold uppercase";
                mode.classList.remove('hidden');
            } else {
                pathTypeLabel.innerText = segments === 0 ? "Detectando..." : "Tipo: Documento";
                pathTypeLabel.className = "text-[9px] text-blue-600 font-bold uppercase";
                mode.classList.add('hidden');
            }
        };

        function showLog(msg, type = 'info') {
            statusLog.innerText = msg;
            statusLog.classList.remove('hidden', 'bg-blue-900', 'text-blue-300', 'border-blue-700', 'bg-red-900', 'text-red-300', 'border-red-700', 'bg-emerald-900', 'text-emerald-300', 'border-emerald-700');
            if(type === 'error') statusLog.classList.add('bg-red-900', 'text-red-300', 'border-red-700');
            else if(type === 'success') statusLog.classList.add('bg-emerald-900', 'text-emerald-300', 'border-emerald-700');
            else statusLog.classList.add('bg-blue-900', 'text-blue-300', 'border-blue-700');
            statusLog.classList.remove('hidden');
        }

        document.getElementById('btn-process').addEventListener('click', async () => {
            const configRaw = document.getElementById('config-src').value.trim();
            const email = document.getElementById('email-src').value.trim();
            const pass = document.getElementById('pass-src').value.trim();
            const path = document.getElementById('path-src').value.trim().replace(/\/$/, "");

            try {
                const config = JSON.parse(configRaw);
                showLog("Conectando Origen...");
                try { await deleteApp(getApp("sourceApp")); } catch(e){}
                const app = initializeApp(config, "sourceApp");
                const auth = getAuth(app);
                const db = getFirestore(app);

                await signInWithEmailAndPassword(auth, email, pass);
                const segments = path.split('/').filter(s => s.length > 0).length;

                if (segments % 2 !== 0) {
                    const snap = await getDocs(query(collection(db, path)));
                    if (snap.empty) throw new Error("Vac√≠o.");
                    rawFetchedData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    currentFetchedData = [...rawFetchedData];
                    docCountBadge.innerText = `${snap.size} DOCUMENTOS`;
                    document.getElementById('btn-toggle-selection').classList.remove('hidden');
                } else {
                    const snap = await getDoc(doc(db, path));
                    if (!snap.exists()) throw new Error("No existe.");
                    rawFetchedData = { id: snap.id, ...snap.data() };
                    currentFetchedData = {...rawFetchedData};
                    docCountBadge.innerText = "1 DOCUMENTO";
                    document.getElementById('btn-toggle-selection').classList.add('hidden');
                }

                previewSection.classList.remove('hidden');
                step4.classList.remove('hidden');
                jsonPreview.textContent = JSON.stringify(currentFetchedData, null, 2);
                showLog("Datos listos.", "success");
                window.scrollTo({ top: previewSection.offsetTop - 20, behavior: 'smooth' });

            } catch (err) { showLog("Error Origen: " + err.message, "error"); }
        });

        document.getElementById('btn-upload').addEventListener('click', async () => {
            if (!currentFetchedData) return;
            const configRaw = document.getElementById('config-dest').value.trim();
            const email = document.getElementById('email-dest').value.trim();
            const pass = document.getElementById('pass-dest').value.trim();
            const path = document.getElementById('path-dest').value.trim().replace(/\/$/, "");

            if (!path) return showLog("Falta ruta de destino.", "error");

            try {
                const config = JSON.parse(configRaw);
                showLog("Conectando Destino...");
                try { await deleteApp(getApp("destApp")); } catch(e){}
                const app = initializeApp(config, "destApp");
                const auth = getAuth(app);
                const db = getFirestore(app);

                await signInWithEmailAndPassword(auth, email, pass);
                showLog("Migrando datos...");

                const dataArray = Array.isArray(currentFetchedData) ? currentFetchedData : [currentFetchedData];
                for (const item of dataArray) {
                    const docId = item.id || Date.now().toString();
                    const cleanData = { ...item };
                    delete cleanData.id; 
                    await setDoc(doc(db, path, docId), cleanData);
                }
                showLog(`${dataArray.length} subidos con √©xito.`, "success");
            } catch (err) { showLog("Error Destino: " + err.message, "error"); }
        });

        document.getElementById('btn-download-json').addEventListener('click', () => {
            if (!currentFetchedData) return;
            const blob = new Blob([JSON.stringify(currentFetchedData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `cic_export_${Date.now()}.json`;
            link.click();
            showLog("JSON descargado.", "success");
        });

        updateProjectsUI();
    </script>
</body>
</html>