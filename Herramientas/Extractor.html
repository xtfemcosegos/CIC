<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Data Explorer & Downloader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-inactive { display: none; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <div class="max-w-4xl mx-auto py-10 px-4">
        <header class="mb-10 text-center">
            <h1 class="text-3xl font-bold text-gray-800">Firebase Data Tool</h1>
            <p class="text-gray-600 mt-2">Configura, Autentica y Descarga datos de Firestore</p>
        </header>

        <!-- Mensajes de Estado -->
        <div id="status-container" class="hidden mb-6 p-4 rounded-lg text-sm"></div>

        <div class="grid gap-8">
            
            <!-- PASO 1: Configuración del Proyecto -->
            <section id="step-1" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center mb-4">
                    <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3">1</span>
                    <h2 class="text-xl font-semibold text-gray-700">Configuración del Proyecto</h2>
                </div>
                <p class="text-sm text-gray-500 mb-4">Pega el objeto JSON de configuración de tu proyecto Firebase (SDK Setup).</p>
                <textarea id="config-input" class="w-full h-48 p-3 font-mono text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder='{ "apiKey": "...", "authDomain": "...", ... }'></textarea>
                <button id="btn-init" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                    Inicializar Proyecto
                </button>
            </section>

            <!-- SECCIÓN DE REGLAS (NUEVA) -->
            <section class="bg-amber-50 p-6 rounded-xl shadow-sm border border-amber-200">
                <div class="flex items-center mb-2">
                    <svg class="w-5 h-5 text-amber-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <h2 class="text-sm font-bold text-amber-800 uppercase tracking-wider">Reglas de Seguridad de Firestore</h2>
                </div>
                <p class="text-xs text-amber-700 mb-3">Copia y pega estas reglas en la pestaña "Rules" de tu consola Firebase para permitir el acceso a usuarios autenticados:</p>
                <pre class="bg-amber-100 p-3 rounded border border-amber-300 font-mono text-[10px] text-amber-900 overflow-x-auto">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}</pre>
            </section>

            <!-- PASO 2: Autenticación -->
            <section id="step-2" class="step-inactive bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center mb-4">
                    <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3">2</span>
                    <h2 class="text-xl font-semibold text-gray-700">Autenticación de Usuario</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="auth-email" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="usuario@ejemplo.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                        <input type="password" id="auth-password" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="••••••••">
                    </div>
                </div>
                <button id="btn-login" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                    Iniciar Sesión
                </button>
            </section>

            <!-- PASO 3: Ruta de Firestore -->
            <section id="step-3" class="step-inactive bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center mb-4">
                    <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3">3</span>
                    <h2 class="text-xl font-semibold text-gray-700">Extraer Datos de Firestore</h2>
                </div>
                <p class="text-sm text-gray-500 mb-4">Ingresa la ruta de la colección (ej: <code class="bg-gray-100 px-1">usuarios</code>) o documento (ej: <code class="bg-gray-100 px-1">usuarios/ID123</code>).</p>
                <div class="flex gap-2">
                    <input type="text" id="db-path" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="usuarios/mi-documento">
                    <button id="btn-fetch" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                        Obtener Datos
                    </button>
                </div>
                
                <div id="results-preview" class="hidden mt-6">
                    <h3 class="text-sm font-bold text-gray-700 mb-2 uppercase tracking-wider">Vista previa de resultados</h3>
                    <pre id="json-display" class="bg-gray-900 text-green-400 p-4 rounded-lg text-xs overflow-auto max-h-60 mb-4"></pre>
                    <button id="btn-download" class="w-full bg-gray-800 hover:bg-black text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center transition-transform active:scale-95">
                        Descargar JSON
                    </button>
                </div>
            </section>
        </div>
    </div>

    <!-- Scripts de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        let firebaseApp, auth, db;
        let lastData = null;

        // --- Helpers de UI ---
        const showStatus = (message, type = 'info') => {
            const container = document.getElementById('status-container');
            container.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            
            if (type === 'error') {
                container.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                container.classList.add('bg-green-100', 'text-green-700');
            } else {
                container.classList.add('bg-blue-100', 'text-blue-700');
            }
            
            container.innerText = message;
            container.scrollIntoView({ behavior: 'smooth' });
        };

        const toggleLoading = (btnId, isLoading, originalText) => {
            const btn = document.getElementById(btnId);
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<span class="loader"></span> Procesando...`;
            } else {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // --- Lógica del Paso 1: Inicialización ---
        document.getElementById('btn-init').addEventListener('click', () => {
            const configText = document.getElementById('config-input').value.trim();
            if (!configText) return showStatus('Por favor, ingresa el JSON de configuración.', 'error');

            try {
                const config = JSON.parse(configText);
                firebaseApp = initializeApp(config);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);

                showStatus('Proyecto inicializado correctamente.', 'success');
                document.getElementById('step-2').classList.remove('step-inactive');
                document.getElementById('step-1').classList.add('opacity-50', 'pointer-events-none');
            } catch (e) {
                showStatus('Error al parsear el JSON: ' + e.message, 'error');
            }
        });

        // --- Lógica del Paso 2: Login ---
        document.getElementById('btn-login').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;

            if (!email || !pass) return showStatus('Ingresa email y contraseña.', 'error');

            toggleLoading('btn-login', true);
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                showStatus('Autenticación exitosa. Bienvenido.', 'success');
                document.getElementById('step-3').classList.remove('step-inactive');
                document.getElementById('step-2').classList.add('opacity-50', 'pointer-events-none');
            } catch (e) {
                showStatus('Error de autenticación: ' + e.message, 'error');
            } finally {
                toggleLoading('btn-login', false, 'Iniciar Sesión');
            }
        });

        // --- Lógica del Paso 3: Fetch y Descarga ---
        document.getElementById('btn-fetch').addEventListener('click', async () => {
            const path = document.getElementById('db-path').value.trim().replace(/^\/|\/$/g, '');
            if (!path) return showStatus('Ingresa una ruta de Firestore.', 'error');

            toggleLoading('btn-fetch', true);
            try {
                const segments = path.split('/');
                const isDocument = segments.length % 2 === 0;

                let data;
                if (isDocument) {
                    const docRef = doc(db, path);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        data = { id: docSnap.id, ...docSnap.data() };
                    } else {
                        throw new Error('El documento no existe.');
                    }
                } else {
                    const colRef = collection(db, path);
                    const querySnapshot = await getDocs(colRef);
                    data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (data.length === 0) showStatus('La colección está vacía.', 'info');
                }

                lastData = data;
                document.getElementById('json-display').textContent = JSON.stringify(data, null, 2);
                document.getElementById('results-preview').classList.remove('hidden');
                showStatus('Datos recuperados con éxito.', 'success');

            } catch (e) {
                showStatus('Error al obtener datos: ' + e.message, 'error');
                document.getElementById('results-preview').classList.add('hidden');
            } finally {
                toggleLoading('btn-fetch', false, 'Obtener Datos');
            }
        });

        document.getElementById('btn-download').addEventListener('click', () => {
            if (!lastData) return;
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(lastData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            const fileName = document.getElementById('db-path').value.replace(/\//g, '_') + '.json';
            
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });
    </script>
</body>
</html>