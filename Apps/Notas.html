<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas Pro - Protección Patrimonial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f1f5f9;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1e293b;
        }

        /* --- ENCABEZADO PRO --- */
        .pro-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 16px 32px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 50;
        }

        /* --- SISTEMA DE PESTAÑAS --- */
        .tab-bar {
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 32px;
            display: flex;
            align-items: center;
            gap: 4px;
            height: 48px;
            overflow-x: auto;
        }

        .tab-bar::-webkit-scrollbar { display: none; }

        .note-tab {
            padding: 0 16px;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            user-select: none;
        }

        .note-tab:hover { background: #f8fafc; color: #334155; }
        .note-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background: #f5f3ff;
        }

        .add-tab-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #475569;
            margin-left: 8px;
            transition: all 0.2s;
        }
        .add-tab-btn:hover { background: #e2e8f0; color: #0f172a; }

        /* --- BARRA DE HERRAMIENTAS --- */
        .toolbar {
            background: #ffffff;
            padding: 8px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tool-btn, .tool-select {
            height: 32px;
            padding: 0 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            background: white;
            outline: none;
        }
        .tool-btn:hover { background: #f1f5f9; color: #0f172a; }
        .tool-btn.active { background: #4f46e5; color: white; border-color: #4f46e5; }
        
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid #e2e8f0;
            padding: 0 6px;
            border-radius: 6px;
            height: 32px;
        }
        
        .color-picker {
            width: 20px;
            height: 20px;
            padding: 0;
            border: none;
            cursor: pointer;
            background: none;
        }

        /* --- ÁREA DE EDICIÓN --- */
        .editor-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px 5%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #editor {
            width: 100%;
            max-width: 900px;
            min-height: 100%;
            background: white;
            padding: 50px;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            outline: none;
            font-size: 16px;
            line-height: 1.8;
            color: #334155;
            transition: opacity 0.3s;
        }

        #editor h1 { font-size: 2em; font-weight: 800; margin-bottom: 0.5em; color: #0f172a; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        #editor h2 { font-size: 1.5em; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; color: #1e293b; }
        #editor ul { list-style-type: disc; margin-left: 2em; }
        #editor ol { list-style-type: decimal; margin-left: 2em; }

        .status-badge {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 4px 10px;
            border-radius: 100px;
        }
        .status-saving { background: #fef3c7; color: #92400e; }
        .status-saved { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

    <!-- Header Profesional -->
    <header class="pro-header">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
            </div>
            <div>
                <h1 class="text-sm font-black uppercase tracking-widest text-white leading-none">Intelligence Notes</h1>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Gestión Documental CIC 6.2</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="status" class="status-badge status-saved">Sincronizado</div>
            <button onclick="closePanel()" class="w-8 h-8 flex items-center justify-center bg-white/10 hover:bg-red-500 rounded-lg transition-all text-white/70 hover:text-white" title="Cerrar Panel">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
    </header>

    <!-- Barra de Pestañas -->
    <div class="tab-bar" id="tab-list">
        <button class="add-tab-btn" onclick="addNewNote()" title="Nueva Nota">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="3" stroke-linecap="round"/></svg>
        </button>
    </div>

    <!-- Barra de Herramientas Avanzada -->
    <div class="toolbar">
        <!-- Fuente y Estilo -->
        <select onchange="execCmd('fontName', this.value); this.value='';" class="tool-select w-32" title="Tipo de Fuente">
            <option value="">FUENTE</option>
            <option value="'Plus Jakarta Sans', sans-serif">Sans Serif</option>
            <option value="'Inter', sans-serif">Inter</option>
            <option value="Georgia, serif">Serif</option>
            <option value="'Roboto Mono', monospace">Monospaced</option>
        </select>
        
        <select onchange="execCmd('formatBlock', this.value); this.value='';" class="tool-select w-32">
            <option value="">ESTILO</option>
            <option value="h1">TÍTULO 1</option>
            <option value="h2">TÍTULO 2</option>
            <option value="p">PÁRRAFO</option>
        </select>

        <div class="w-px h-6 bg-slate-200 mx-1"></div>

        <!-- Color de Fuente -->
        <div class="color-picker-wrapper" title="Color de Texto">
            <span class="text-[10px] font-black text-slate-400">COLOR</span>
            <input type="color" class="color-picker" onchange="execCmd('foreColor', this.value)">
        </div>

        <div class="w-px h-6 bg-slate-200 mx-1"></div>

        <!-- Formato de Texto -->
        <button class="tool-btn font-bold w-10" onclick="execCmd('bold')" title="Negrita">B</button>
        <button class="tool-btn italic w-10" onclick="execCmd('italic')" title="Cursiva">I</button>
        <button class="tool-btn underline w-10" onclick="execCmd('underline')" title="Subrayado">U</button>

        <div class="w-px h-6 bg-slate-200 mx-1"></div>

        <!-- Alineación -->
        <button class="tool-btn" onclick="execCmd('justifyLeft')" title="Izquierda">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h10M4 18h16" stroke-width="2.5" stroke-linecap="round"/></svg>
        </button>
        <button class="tool-btn" onclick="execCmd('justifyCenter')" title="Centro">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M7 12h10M4 18h16" stroke-width="2.5" stroke-linecap="round"/></svg>
        </button>

        <div class="w-px h-6 bg-slate-200 mx-1"></div>

        <!-- Sangría -->
        <button class="tool-btn" onclick="execCmd('outdent')" title="Reducir Sangría">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 17l-5-5m0 0l5-5m-5 5h12" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <button class="tool-btn" onclick="execCmd('indent')" title="Aumentar Sangría">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 17l5-5m0 0l-5-5m5 5H6" stroke-width="2" stroke-linecap="round"/></svg>
        </button>

        <div class="w-px h-6 bg-slate-200 mx-1"></div>

        <!-- Listas -->
        <button class="tool-btn" onclick="execCmd('insertUnorderedList')" title="Viñetas">• Lista</button>
        
        <div class="flex-1"></div>

        <button class="tool-btn text-red-500 border-red-100 hover:bg-red-50" onclick="deleteCurrentNote()" title="Borrar Nota">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
    </div>

    <!-- Editor -->
    <div class="editor-container">
        <div id="editor" contenteditable="true" placeholder="Redacta el contenido de esta sección..."></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU", 
            authDomain: "cic6-pp-web.firebaseapp.com", 
            projectId: "cic6-pp-web", 
            appId: "1:248659087868:web:a277ef700d83c7f1d22279" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'cic.pp';

        let currentNoteId = null;
        let notesData = [];
        let saveTimeout = null;
        let isFirstLoad = true;

        const editor = document.getElementById('editor');
        const statusEl = document.getElementById('status');
        const tabList = document.getElementById('tab-list');

        // Ejecutar comandos de edición
        window.execCmd = (command, value = null) => {
            document.execCommand(command, false, value);
            editor.focus();
        };

        // Cerrar panel lateral enviando mensaje al padre
        window.closePanel = () => {
            window.parent.postMessage({ type: 'CLOSE_SIDE_PANEL' }, '*');
        };

        onAuthStateChanged(auth, async (user) => {
            if (!user) return;

            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'NotasEstructuradas');
            
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    notesData = data.notes || [];
                    
                    if (isFirstLoad) {
                        currentNoteId = notesData.length > 0 ? notesData[0].id : null;
                        isFirstLoad = false;
                    }
                    renderTabs();
                    updateEditorContent();
                } else if (isFirstLoad) {
                    addNewNote();
                    isFirstLoad = false;
                }
            });

            editor.addEventListener('input', () => {
                if (!currentNoteId) return;
                
                statusEl.textContent = 'Escribiendo...';
                statusEl.className = 'status-badge status-saving';

                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(async () => {
                    const noteIndex = notesData.findIndex(n => n.id === currentNoteId);
                    if (noteIndex !== -1) {
                        notesData[noteIndex].content = editor.innerHTML;
                        await syncWithFirebase();
                    }
                }, 1200);
            });
        });

        window.addNewNote = async () => {
            const newNote = {
                id: Date.now().toString(),
                title: 'Nueva Sección',
                content: '<h1>Nueva Sección</h1><p>Comienza a escribir...</p>'
            };
            notesData.push(newNote);
            currentNoteId = newNote.id;
            await syncWithFirebase();
        };

        window.selectNote = (id) => {
            currentNoteId = id;
            renderTabs();
            updateEditorContent();
        };

        window.deleteCurrentNote = async () => {
            if (notesData.length <= 1) {
                editor.innerHTML = '';
                const noteIndex = notesData.findIndex(n => n.id === currentNoteId);
                if (noteIndex !== -1) notesData[noteIndex].content = '';
                await syncWithFirebase();
                return;
            }
            notesData = notesData.filter(n => n.id !== currentNoteId);
            currentNoteId = notesData[0].id;
            await syncWithFirebase();
        };

        window.renameNote = async (id) => {
            const note = notesData.find(n => n.id === id);
            const newTitle = prompt('Nombre de la sección:', note.title);
            if (newTitle && newTitle.trim() !== '') {
                note.title = newTitle;
                await syncWithFirebase();
            }
        };

        function renderTabs() {
            const addBtn = tabList.querySelector('.add-tab-btn');
            tabList.innerHTML = '';
            
            notesData.forEach(note => {
                const tab = document.createElement('div');
                tab.className = `note-tab ${note.id === currentNoteId ? 'active' : ''}`;
                tab.innerHTML = `
                    <span>${note.title}</span>
                    <div class="opacity-0 group-hover:opacity-100 p-1" onclick="event.stopPropagation(); renameNote('${note.id}')">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2.5"/></svg>
                    </div>
                `;
                tab.onclick = () => selectNote(note.id);
                tab.ondblclick = () => renameNote(note.id);
                tabList.appendChild(tab);
            });
            
            tabList.appendChild(addBtn);
        }

        function updateEditorContent() {
            const currentNote = notesData.find(n => n.id === currentNoteId);
            if (currentNote && document.activeElement !== editor) {
                editor.innerHTML = currentNote.content || '';
            }
        }

        async function syncWithFirebase() {
            const user = auth.currentUser;
            if (!user) return;

            statusEl.textContent = 'Guardando...';
            statusEl.className = 'status-badge status-saving';

            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'NotasEstructuradas'), {
                    notes: notesData,
                    lastModified: new Date().toISOString()
                }, { merge: true });
                statusEl.textContent = 'Sincronizado';
                statusEl.className = 'status-badge status-saved';
            } catch (e) {
                statusEl.textContent = 'Error';
                statusEl.className = 'status-badge bg-red-100 text-red-600';
            }
        }
    </script>
</body>
</html>