<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIC6 - Expediente Maestro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDoGMql48pFyB9VFETw0c_dxFaC5yXRyVQ&libraries=places"></script>
    <style>
        :root {
            /* Paleta Sky Blue & Metal (Coherente con Admin_Users.html) */
            --md-primary: #0369a1;
            --md-primary-container: #e0f2fe;
            --md-surface: #f8fafc;
            --md-surface-variant: #f1f5f9;
            --md-outline: #94a3b8;
            --md-divider: #e2e8f0; 
            --metal-dark: #000c24;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-surface);
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        h1, h2, h3, .font-heading {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        /* --- Animación de Cabecera (Scroll) --- */
        #header-container {
            position: fixed; top: 0; left: 0; right: 0; width: 100%; z-index: 100; height: 440px;
            overflow: hidden; background: var(--metal-dark); 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: height, background-color;
        }
        #header-container.compact { height: 80px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }

        .content-spacer { height: 440px; width: 100%; }

        #photo-wrapper { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            overflow: hidden; z-index: 1; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: var(--metal-dark); /* Fondo para la silueta */
        }
        #photo-wrapper.compact {
            width: 50px; height: 50px; left: 20px; top: 15px;
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
        }

        #main-photo { width: 100%; height: 100%; object-fit: cover; }

        #overlay-container {
            position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: flex-end; 
            padding: 48px 24px; pointer-events: none; z-index: 2;
            background: linear-gradient(to top, rgba(0, 12, 36, 0.95) 0%, rgba(0, 12, 36, 0.2) 50%, transparent 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #overlay-container.compact { padding: 0 24px 0 85px; justify-content: center; background: transparent; }

        #header-nombre-disp { transition: all 0.4s ease; border: none; background: transparent; color: white; font-weight: 800; font-size: 1.875rem; outline: none; }
        #header-nombre-disp.compact { font-size: 1.125rem; }

        /* --- Menú Contextual --- */
        #gallery-context-menu {
            position: fixed; z-index: 10000; background: white; border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15); padding: 6px; display: none;
            border: 1px solid var(--md-outline); min-width: 180px;
        }
        .context-item {
            padding: 10px 14px; font-size: 12px; font-weight: 600; color: #0369a1;
            cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 10px;
            transition: background 0.2s;
        }
        .context-item:hover { background: var(--md-surface-variant); }
        .context-item.danger { color: #ef4444; }
        .context-item.danger:hover { background: #fef2f2; }

        /* --- UI Material Components --- */
        #status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 0px; border-radius: 12px; }
        .status-label { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 8px currentColor; }
        .status-saved { color: #10b981; }
        .status-syncing { color: #f59e0b; }

        .data-section { padding: 24px; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .section-header { display: flex; align-items: center; justify-content: space-between; width: 100%; cursor: pointer; margin-bottom: 24px; }
        .section-label {
            font-family: 'Plus Jakarta Sans', sans-serif; font-size: 11px; font-weight: 800; color: #ffffff;
            background-color: var(--md-primary); padding: 6px 16px; border-radius: 999px; display: inline-flex;
            align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.05em;
        }

        .info-label { font-size: 10px; font-weight: 700; color: var(--md-outline); margin-bottom: 6px; margin-left: 4px; display: block; text-transform: uppercase; }
        .info-control {
            width: 100%; background: #fff; border: 1.5px solid var(--md-divider); border-radius: 12px;
            padding: 10px 14px; font-size: 14px; font-weight: 500; color: #1e293b; outline: none; transition: all 0.2s;
        }
        .info-control:focus { border-color: var(--md-primary); box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1); }
        .info-control.monospace { font-family: 'Courier New', Courier, monospace; letter-spacing: 1px; }

        .mini-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; padding-bottom: 20px; }
        .gallery-thumb { aspect-ratio: 1; border-radius: 16px; overflow: hidden; background: #f8fafc; border: 1.5px solid var(--md-divider); position: relative; cursor: pointer; transition: transform 0.2s; }
        .gallery-thumb:hover { transform: scale(1.05); z-index: 10; border-color: var(--md-primary); }

        .sub-item-card { background: #fff; border: 1.5px solid var(--md-divider); border-radius: 16px; padding: 16px; margin-bottom: 16px; position: relative; }
        .btn-add-fab { background: var(--md-primary-container); color: var(--md-primary); padding: 8px 16px; border-radius: 10px; font-size: 10px; font-weight: 800; text-transform: uppercase; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(3, 105, 161, 0.1); }
        .btn-add-fab:hover { background: #bae6fd; }

        #map-container { width: 100%; height: 200px; border-radius: 16px; margin-top: 12px; border: 1.5px solid var(--md-divider); display: none; }
        
        .pac-container { border-radius: 12px; margin-top: 4px; box-shadow: 0 8px 30px rgba(0,0,0,0.1) !important; border: 1px solid var(--md-outline) !important; z-index: 10000 !important; }
    </style>
</head>
<body>

    <!-- Menú Contextual Galería -->
    <div id="gallery-context-menu">
        <div class="context-item" id="ctx-set-main">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            Establecer como principal
        </div>
        <div class="context-item danger" id="ctx-delete">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            Eliminar foto
        </div>
    </div>

    <!-- Modales -->
    <div id="photo-modal" class="fixed inset-0 flex items-center justify-center p-4 cursor-zoom-out hidden z-[1000] bg-black/90 backdrop-blur-md" onclick="this.classList.add('hidden')">
        <img id="modal-img" src="" class="max-w-full max-h-full rounded-2xl shadow-2xl object-contain">
    </div>

    <div id="camera-overlay" class="fixed inset-0 bg-black z-[2000] hidden flex-col items-center justify-center">
        <video id="video-feed" autoplay playsinline class="w-full max-w-md aspect-[4/5] object-cover rounded-3xl bg-neutral-900 mb-8"></video>
        <div class="flex gap-4">
            <button onclick="capturePhoto()" class="bg-white text-black px-10 py-4 rounded-2xl font-black uppercase text-xs">Capturar</button>
            <button onclick="closeCamera()" class="bg-white/10 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs border border-white/20">Cerrar</button>
        </div>
    </div>

    <div class="side-panel">
        <!-- Encabezado Dinámico -->
        <div id="header-container">
            <div class="hero-photo-wrapper" id="photo-wrapper">
                <img id="main-photo" src="">
            </div>
            <div class="photo-overlay" id="overlay-container">
                <div id="text-content" class="w-full">
                    <input type="text" id="header-nombre-disp" readonly value="Cargando...">
                    <div class="flex items-center justify-between w-full">
                        <span id="header-puesto-disp" class="text-sky-200 text-[11px] font-bold uppercase tracking-[0.2em]">PUESTO</span>
                        <div id="status-badge" class="status-saved">
                            <div class="status-dot bg-current"></div>
                            <span id="status-text" class="status-label">Sincronizado</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-spacer"></div>

        <form id="expediente-form" class="relative z-10 bg-white rounded-t-[40px] -mt-6 shadow-[0_-24px_48px_rgba(0,0,0,0.08)]">
            
            <!-- SECCIÓN: IDENTIDAD -->
            <section class="data-section pt-12">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-label">Identidad del Usuario</div>
                </div>
                <div class="section-content">
                    <div class="grid grid-cols-2 gap-x-6">
                        <div class="info-row col-span-2 mb-4">
                            <label class="info-label">Nombre Completo</label>
                            <input type="text" name="nombre" id="inp-nombre" class="info-control" oninput="syncHeader()">
                        </div>
                        <div class="info-row">
                            <label class="info-label">ID Empleado / Nómina</label>
                            <input type="number" name="id_empleado" class="info-control">
                        </div>
                        <div class="info-row">
                            <label class="info-label">Estatus Laboral</label>
                            <select name="status" class="info-control">
                                <option value="Activo">Activo</option>
                                <option value="Baja">Baja</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 border-t border-slate-100 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-black uppercase text-sky-800 tracking-widest">Lote de Identificación</span>
                            <div class="flex gap-2">
                                <button type="button" onclick="openCamera()" class="btn-add-fab">Cámara</button>
                                <button type="button" onclick="document.getElementById('gallery-input').click()" class="btn-add-fab">Subir</button>
                            </div>
                        </div>
                        <div id="gallery-grid" class="mini-gallery"></div>
                    </div>
                </div>
            </section>

            <!-- SECCIÓN: LABORAL -->
            <section class="data-section bg-slate-50/50">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-label">Configuración Laboral</div>
                </div>
                <div class="section-content">
                    <div class="grid grid-cols-2 gap-x-6">
                        <div class="info-row col-span-2 mb-4">
                            <label class="info-label">Puesto Administrativo</label>
                            <select name="puesto" id="sel-puesto" class="info-control" onchange="syncHeader()">
                                <option value="Administrador">Administrador</option>
                                <option value="Operador CCO">Operador CCO</option>
                                <option value="Encargado">Encargado</option>
                                <option value="Guardia">Guardia</option>
                                <option value="Prestador de servicios">Prestador de servicios</option>
                                <option value="Colaborador">Colaborador</option>
                                <option value="Caseta">Caseta</option>
                            </select>
                        </div>
                        <div class="info-row">
                            <label class="info-label">Compañía / Outsourcing</label>
                            <input type="text" name="compania" class="info-control">
                        </div>
                        <div class="info-row">
                            <label class="info-label">Acceso Predeterminado</label>
                            <input type="text" name="acceso_predeterminado" class="info-control">
                        </div>
                        <div class="info-row mt-4">
                            <label class="info-label">Fecha de Ingreso</label>
                            <input type="date" name="fecha_ingreso" class="info-control" onchange="calcSeniority(this.value)">
                        </div>
                        <div class="info-row mt-4">
                            <label class="info-label">Antigüedad (Calculada)</label>
                            <input type="text" id="val-antiguedad" readonly class="info-control font-bold" value="0 años">
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECCIÓN: PERSONAL -->
            <section class="data-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-label">Datos Personales</div>
                </div>
                <div class="section-content">
                    <div class="grid grid-cols-2 gap-x-6">
                        <div class="info-row">
                            <label class="info-label">Fecha de Nacimiento</label>
                            <input type="date" name="fecha_nacimiento" class="info-control" onchange="calcAge(this.value)">
                        </div>
                        <div class="info-row">
                            <label class="info-label">Sexo</label>
                            <select name="sexo" class="info-control">
                                <option value="Hombre">Hombre</option>
                                <option value="Mujer">Mujer</option>
                            </select>
                        </div>
                        <div class="info-row mt-4">
                            <label class="info-label">Estado Civil</label>
                            <select name="estado_civil" class="info-control">
                                <option value="Soltero">Soltero</option>
                                <option value="Casado">Casado</option>
                                <option value="Unión Libre">Unión Libre</option>
                            </select>
                        </div>
                        <div class="info-row mt-4">
                            <label class="info-label">Escolaridad</label>
                            <input type="text" name="escolaridad" class="info-control">
                        </div>
                        <div class="info-row col-span-2 mt-2">
                            <label class="info-label italic text-[9px]">Edad calculada:</label>
                            <input type="text" id="val-edad" readonly class="bg-transparent border-none text-[11px] font-bold text-sky-800 outline-none p-0" value="0 años">
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECCIÓN: UBICACIÓN -->
            <section class="data-section bg-slate-50/50">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-label">Ubicación y Domicilio</div>
                </div>
                <div class="section-content">
                    <div class="info-row mb-4">
                        <label class="info-label">Lugar de Nacimiento</label>
                        <input type="text" name="nacimiento_lugar" id="inp-nac-lugar" class="info-control" placeholder="Buscar municipio o estado...">
                    </div>
                    <div class="info-row relative">
                        <label class="info-label">Domicilio Actual (Mapa Geográfico)</label>
                        <input type="text" name="domicilio" id="inp-domicilio" class="info-control" placeholder="Escriba su dirección actual...">
                    </div>
                    <div id="map-container"></div>
                </div>
            </section>

            <!-- SECCIÓN: LEGAL Y SALUD -->
            <section class="data-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-label">Legal, Salud y Tallas</div>
                </div>
                <div class="section-content">
                    <div class="grid grid-cols-2 gap-x-6">
                        <div class="info-row">
                            <label class="info-label">CURP</label>
                            <input type="text" name="curp" class="info-control uppercase">
                        </div>
                        <div class="info-row">
                            <label class="info-label">RFC</label>
                            <input type="text" name="rfc" class="info-control uppercase">
                        </div>
                        <div class="info-row mt-4">
                            <label class="info-label">NSS</label>
                            <input type="text" name="nss" class="info-control monospace">
                        </div>
                        <div class="info-row mt-4">
                            <label class="info-label">Tipo de Sangre</label>
                            <select name="tipo_sangre" class="info-control">
                                <option value="O+">O+</option><option value="O-">O-</option>
                                <option value="A+">A+</option><option value="A-">A-</option>
                                <option value="B+">B+</option><option value="B-">B-</option>
                            </select>
                        </div>
                        <div class="info-row col-span-2 mt-4">
                            <label class="info-label">Alergias Conocidas</label>
                            <textarea name="alergias" class="info-control h-20 py-2"></textarea>
                        </div>
                        <div class="info-row mt-4">
                            <label class="info-label">Talla Camisa</label>
                            <input type="text" name="talla_camisa" class="info-control uppercase">
                        </div>
                        <div class="info-row mt-4">
                            <label class="info-label">Talla Calzado</label>
                            <input type="number" name="talla_calzado" class="info-control" step="0.5">
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECCIÓN: CONTACTO -->
            <section class="data-section bg-slate-50/50">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-label">Canales de Comunicación</div>
                </div>
                <div class="section-content">
                    <div class="grid grid-cols-2 gap-x-6">
                        <div class="info-row">
                            <label class="info-label">Celular</label>
                            <div class="flex gap-2">
                                <input type="tel" name="celular" id="inp-celular" class="info-control">
                                <button type="button" onclick="openWhatsApp()" class="p-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 transition-colors shadow-lg shadow-emerald-500/20">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="info-row">
                            <label class="info-label">Correo Principal</label>
                            <div class="flex gap-2">
                                <input type="email" name="correo_principal" id="inp-email" class="info-control">
                                <button type="button" onclick="openMail()" class="p-3 bg-sky-500 text-white rounded-xl hover:bg-sky-600 transition-colors shadow-lg shadow-sky-500/20">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECCIÓN: ADICIONAL -->
            <section class="data-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-label">Registros Adicionales</div>
                </div>
                <div class="section-content">
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Familia / Hijos</span>
                            <button type="button" onclick="addItem('hijos')" class="btn-add-fab">Agregar</button>
                        </div>
                        <div id="container-hijos" class="space-y-4"></div>
                    </div>
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Emergencias</span>
                            <button type="button" onclick="addItem('emergencias')" class="btn-add-fab">Agregar</button>
                        </div>
                        <div id="container-emergencias" class="space-y-4"></div>
                    </div>
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Cursos y Certificaciones</span>
                            <button type="button" onclick="addItem('cursos')" class="btn-add-fab">Agregar</button>
                        </div>
                        <div id="container-cursos" class="space-y-4"></div>
                    </div>
                </div>
            </section>

            <section class="data-section pb-40">
                <p class="text-center text-[10px] text-slate-300 font-bold uppercase tracking-[0.4em]">Fin del Expediente Maestro</p>
            </section>
        </form>
    </div>

    <!-- Utils Ocultos -->
    <input type="file" id="gallery-input" class="hidden" multiple accept="image/*">
    <canvas id="photo-canvas" class="hidden" width="1000" height="1250"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            messagingSenderId: "248659087868",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'cic.pp';
        const currentDocUid = new URLSearchParams(window.location.search).get('uid');

        // SVG de Silueta profesional como fallback
        const SILHOUETTE_SVG = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2394a3b8"><rect width="24" height="24" fill="%23000c24"/><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;

        let isSaving = false;
        let stream = null;
        let map, marker;
        let autocompletes = {};
        let activeCtxPhoto = { id: null, data: null };

        window.onload = () => {
            initGoogleMaps();
            initScrollAnimation();
            onAuthStateChanged(auth, user => { if (user) loadExpediente(); else signInAnonymously(auth); });
            document.addEventListener('click', () => document.getElementById('gallery-context-menu').style.display = 'none');
        };

        function initGoogleMaps() {
            try {
                const inpDom = document.getElementById('inp-domicilio');
                autocompletes.domicilio = new google.maps.places.Autocomplete(inpDom, { fields: ["formatted_address", "geometry", "name"], types: ["address"] });
                map = new google.maps.Map(document.getElementById('map-container'), { zoom: 15, center: { lat: 25.6866, lng: -100.3161 }, mapTypeControl: false, streetViewControl: false });
                marker = new google.maps.Marker({ map: map });
                autocompletes.domicilio.addListener('place_changed', () => {
                    const place = autocompletes.domicilio.getPlace();
                    if (!place.geometry) return;
                    inpDom.value = place.formatted_address || place.name;
                    document.getElementById('map-container').style.display = 'block';
                    map.setCenter(place.geometry.location); marker.setPosition(place.geometry.location);
                    autoSave();
                });

                const inpNac = document.getElementById('inp-nac-lugar');
                autocompletes.nacimiento = new google.maps.places.Autocomplete(inpNac, { fields: ["formatted_address", "name"], types: ["(regions)"] });
                autocompletes.nacimiento.addListener('place_changed', () => {
                    const place = autocompletes.nacimiento.getPlace();
                    if (place.name) { inpNac.value = place.formatted_address || place.name; autoSave(); }
                });

                const observer = new MutationObserver(() => {
                    document.querySelectorAll('.pac-container').forEach(pac => {
                        pac.addEventListener('mousedown', e => e.stopImmediatePropagation(), true);
                        pac.addEventListener('click', e => {
                            const item = e.target.closest('.pac-item');
                            if (item) setTimeout(() => {
                                const activeInp = document.activeElement;
                                if (activeInp && activeInp.tagName === 'INPUT') activeInp.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', keyCode: 13, bubbles: true }));
                            }, 100);
                        });
                    });
                });
                observer.observe(document.body, { childList: true, subtree: true });
            } catch (e) { console.error("Maps Error:", e); }
        }

        function initScrollAnimation() {
            const header = document.getElementById('header-container');
            const photo = document.getElementById('photo-wrapper');
            const overlay = document.getElementById('overlay-container');
            const nombre = document.getElementById('header-nombre-disp');

            window.addEventListener('scroll', () => {
                const isCompact = window.scrollY > 180;
                header.classList.toggle('compact', isCompact);
                photo.classList.toggle('compact', isCompact);
                overlay.classList.toggle('compact', isCompact);
                nombre.classList.toggle('compact', isCompact);
            });
        }

        async function loadExpediente() {
            if (!currentDocUid) return;
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', currentDocUid));
            if (snap.exists()) {
                const data = snap.data();
                const form = document.getElementById('expediente-form');

                Object.keys(data).forEach(k => { if (form.elements[k]) form.elements[k].value = data[k]; });

                document.getElementById('header-nombre-disp').value = data.nombre || "Usuario";
                document.getElementById('header-puesto-disp').innerText = (data.puesto || "MIEMBRO").toUpperCase();
                
                // --- LÓGICA DE SILUETA DE RESPALDO ---
                const photoEl = document.getElementById('main-photo');
                if(data.foto && data.foto !== "") {
                    photoEl.src = data.foto;
                } else {
                    photoEl.src = SILHOUETTE_SVG;
                }
                
                if(data.fecha_ingreso) calcSeniority(data.fecha_ingreso);
                if(data.fecha_nacimiento) calcAge(data.fecha_nacimiento);

                ['hijos', 'emergencias', 'cursos'].forEach(type => {
                    if(data[type]) {
                        document.getElementById(`container-${type}`).innerHTML = "";
                        data[type].forEach(item => restoreItem(type, item));
                    }
                });

                if(data.domicilio) {
                    const geo = new google.maps.Geocoder();
                    geo.geocode({ address: data.domicilio }, (res, stat) => {
                        if (stat === 'OK') { document.getElementById('map-container').style.display = 'block'; map.setCenter(res[0].geometry.location); marker.setPosition(res[0].geometry.location); }
                    });
                }
                loadGallery();
                initAutoSaveListeners();
            }
        }

        function initAutoSaveListeners() {
            document.getElementById('expediente-form').querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('change', autoSave);
            });
        }

        async function autoSave() {
            if (isSaving || !currentDocUid) return;
            isSaving = true;
            document.getElementById('status-badge').className = "status-syncing";
            document.getElementById('status-text').innerText = "Sincronizando";

            const form = document.getElementById('expediente-form');
            const payload = Object.fromEntries(new FormData(form).entries());

            ['hijos', 'emergencias', 'cursos'].forEach(type => {
                const container = document.getElementById(`container-${type}`);
                payload[type] = Array.from(container.children).map(card => {
                    const obj = {};
                    card.querySelectorAll('[data-key]').forEach(f => obj[f.getAttribute('data-key')] = f.value);
                    return obj;
                });
            });

            // Guardamos la foto actual (si es la silueta, no sobreescribimos con data URI innecesariamente si es posible)
            const currentSrc = document.getElementById('main-photo').src;
            payload.foto = currentSrc === SILHOUETTE_SVG ? "" : currentSrc;
            payload.lastUpdate = new Date().toISOString();

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', currentDocUid), payload, { merge: true });
                setTimeout(() => {
                    document.getElementById('status-badge').className = "status-saved";
                    document.getElementById('status-text').innerText = "Sincronizado";
                    isSaving = false;
                }, 800);
            } catch (e) { isSaving = false; }
        }

        window.addItem = (type) => {
            const container = document.getElementById(`container-${type}`);
            const div = document.createElement('div');
            div.className = "sub-item-card fade-in";
            let html = '';
            if (type === 'hijos') {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div><label class="info-label">Nombre</label><input type="text" class="info-control" data-key="nombre"></div>
                    <div><label class="info-label">F. Nacimiento</label><input type="date" class="info-control" data-key="fecha_nacimiento"></div>
                </div>`;
            } else if (type === 'emergencias') {
                html = `<div class="grid grid-cols-3 gap-4">
                    <div class="col-span-3 mb-2"><label class="info-label">Nombre del Contacto</label><input type="text" class="info-control" data-key="nombre"></div>
                    <div><label class="info-label">Vínculo</label><input type="text" class="info-control" data-key="parentesco"></div>
                    <div class="col-span-2"><label class="info-label">Teléfono Móvil</label><input type="tel" class="info-control" data-key="telefono"></div>
                </div>`;
            } else if (type === 'cursos') {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 mb-2"><label class="info-label">Curso o Taller</label><input type="text" class="info-control" data-key="nombre"></div>
                    <div><label class="info-label">Fecha de Término</label><input type="date" class="info-control" data-key="fecha"></div>
                    <div><label class="info-label">Certificación</label><select class="info-control" data-key="certificado"><option value="Si">Sí cuenta</option><option value="No">No cuenta</option></select></div>
                </div>`;
            }
            div.innerHTML = html + `<button type="button" onclick="this.parentElement.remove(); autoSave();" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors">✕</button>`;
            container.appendChild(div);
            div.querySelectorAll('input, select').forEach(el => el.addEventListener('change', autoSave));
        };

        function restoreItem(type, values) {
            addItem(type);
            const container = document.getElementById(`container-${type}`);
            const card = container.lastElementChild;
            Object.keys(values).forEach(key => {
                const field = card.querySelector(`[data-key="${key}"]`);
                if (field) field.value = values[key];
            });
        }

        function loadGallery() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios', currentDocUid, 'Fotos'), snap => {
                const grid = document.getElementById('gallery-grid');
                grid.innerHTML = '';
                snap.forEach(d => {
                    const pic = d.data();
                    const div = document.createElement('div');
                    div.className = "gallery-thumb";
                    div.innerHTML = `<img src="${pic.photoData}" class="w-full h-full object-cover">`;
                    div.onclick = (e) => { e.stopPropagation(); document.getElementById('modal-img').src = pic.photoData; document.getElementById('photo-modal').classList.remove('hidden'); };
                    div.oncontextmenu = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        activeCtxPhoto = { id: d.id, data: pic.photoData };
                        const menu = document.getElementById('gallery-context-menu');
                        menu.style.display = 'block'; menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';
                    };
                    grid.appendChild(div);
                });
            });
        }

        document.getElementById('ctx-set-main').onclick = () => { document.getElementById('main-photo').src = activeCtxPhoto.data; autoSave(); };
        document.getElementById('ctx-delete').onclick = async () => { if(confirm("¿Eliminar foto del registro?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Usuarios', currentDocUid, 'Fotos', activeCtxPhoto.id)); };

        window.openCamera = () => {
            const overlay = document.getElementById('camera-overlay');
            const video = document.getElementById('video-feed');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }).then(s => { stream = s; video.srcObject = s; overlay.style.display = 'flex'; });
        };
        window.closeCamera = () => { if (stream) stream.getTracks().forEach(t => t.stop()); document.getElementById('camera-overlay').style.display = 'none'; };
        window.capturePhoto = async () => {
            const canvas = document.getElementById('photo-canvas');
            canvas.getContext('2d').drawImage(document.getElementById('video-feed'), 0, 0, 1000, 1250);
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios', currentDocUid, 'Fotos'), { photoData: canvas.toDataURL('image/jpeg', 0.8), timestamp: new Date().toISOString() });
            closeCamera();
        };

        document.getElementById('gallery-input').onchange = async (e) => {
            for (let f of e.target.files) {
                const reader = new FileReader();
                reader.onload = async () => await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios', currentDocUid, 'Fotos'), { photoData: reader.result, timestamp: new Date().toISOString() });
                reader.readAsDataURL(f);
            }
        };

        window.calcAge = (date) => {
            if(!date) return;
            const years = Math.floor((new Date() - new Date(date)) / (1000 * 60 * 60 * 24 * 365.25));
            document.getElementById('val-edad').value = `${years} años`;
        };

        window.calcSeniority = (date) => {
            if(!date) return;
            const years = Math.floor((new Date() - new Date(date)) / (1000 * 60 * 60 * 24 * 365.25));
            document.getElementById('val-antiguedad').value = `${years} años`;
        };

        window.syncHeader = () => {
            document.getElementById('header-nombre-disp').value = document.getElementById('inp-nombre').value || "Usuario";
            document.getElementById('header-puesto-disp').innerText = document.getElementById('sel-puesto').value.toUpperCase();
            autoSave();
        };

        window.openWhatsApp = () => { const n = document.getElementById('inp-celular').value; if(n) window.open(`https://wa.me/${n.replace(/\D/g,'')}`, '_blank'); };
        window.openMail = () => { const m = document.getElementById('inp-email').value; if(m) window.location.href = `mailto:${m}`; };
        window.toggleSection = (el) => { const content = el.nextElementSibling; content.style.display = (content.style.display === 'none' || !content.style.display) ? 'block' : 'none'; };

    </script>
</body>
</html>