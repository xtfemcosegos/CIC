<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Siniestro - CIC6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --md-primary: #450a0a;
            --md-surface: #ffffff;
            --md-background: #fdf8f8;
            --md-outline: #e5e7eb;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--md-background);
            color: #1e293b;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* --- Estilos del Editor --- */
        .editor-content:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
            pointer-events: none;
            display: block;
        }
        .editor-content { 
            min-height: 350px; 
            padding: 2rem; 
            outline: none; 
            font-size: 15px; 
            line-height: 1.7; 
            color: #1e293b; 
            background: white; 
        }

        /* --- Form Cards --- */
        .form-card {
            background: white;
            border-radius: 2.5rem;
            border: 1px solid var(--md-outline);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        .standard-input {
            width: 100%;
            padding: 12px 16px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            outline: none;
            color: #1e293b;
        }
        .standard-input:focus {
            border-color: var(--md-primary);
            background-color: white;
            box-shadow: 0 0 0 4px rgba(69, 10, 10, 0.05);
        }

        /* --- Toolbar --- */
        .ribbon-toolbar {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        .toolbar-group {
            display: flex;
            align-items: center;
            background: white;
            padding: 2px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .toolbar-btn {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: #475569;
            transition: all 0.1s;
            font-size: 13px;
            cursor: pointer;
            position: relative;
        }
        .toolbar-btn:hover { background-color: #f1f5f9; color: var(--md-primary); }
        .toolbar-btn.active { background-color: #fef2f2; color: var(--md-primary); }

        /* --- Paleta de Colores --- */
        .color-palette-container {
            padding: 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            position: absolute;
            z-index: 1000;
            top: 110%;
            left: 0;
            width: 240px;
        }
        .color-row { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
        .color-swatch { width: 24px; height: 24px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: transform 0.1s; }
        .color-swatch:hover { transform: scale(1.2); z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .color-indicator-bar { 
            position: absolute; 
            bottom: 4px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 18px; 
            height: 3px; 
            border-radius: 1px; 
        }

        /* --- Resultados de B√∫squeda --- */
        #search-results { 
            max-height: 250px; 
            overflow-y: auto; 
            border: 1px solid #e2e8f0; 
            border-radius: 1rem; 
            margin-top: 4px; 
            background: white; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
            position: absolute; 
            width: 100%; 
            z-index: 100; 
        }
        .result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
        .result-item:hover, .result-item.focused { 
            background-color: #fdf2f2; 
            border-left: 4px solid var(--md-primary); 
            padding-left: 12px; 
        }

        .step-pill {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: #fdf2f2;
            color: var(--md-primary);
            padding: 4px 12px;
            border-radius: 9999px;
        }

        .header-card {
            background: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
            border-radius: 2.5rem;
            box-shadow: 0 12px 24px -6px rgba(69, 10, 10, 0.3);
            border: 1px solid #991b1b;
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <!-- OVERLAY DE CARGA -->
    <div id="loadingOverlaySin" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[2000] flex flex-col justify-center items-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-[#450a0a] rounded-full animate-spin mb-4"></div>
        <p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Iniciando Siniestros...</p>
    </div>

    <div class="max-w-4xl mx-auto w-full space-y-8">
        <!-- CABECERA TIPO TARJETA -->
        <header class="header-card text-white p-6 md:p-8 flex items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 md:w-14 md:h-14 bg-white/10 rounded-2xl flex items-center justify-center text-white border border-white/20 shadow-inner">
                    <i class="fa-solid fa-triangle-exclamation text-xl md:text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-black tracking-tight uppercase leading-none">Registro de Siniestros</h1>
                    <p class="text-[10px] text-red-200/70 font-bold uppercase tracking-widest mt-1.5">Control de incidentes CIC-6</p>
                </div>
            </div>
            <div class="hidden sm:flex flex-col items-end gap-1">
                <div id="clockSin" class="text-xs font-black text-white uppercase tracking-widest bg-black/20 px-3 py-1 rounded-lg">00:00:00</div>
                <span class="text-[8px] font-bold text-red-200/40 uppercase tracking-[0.2em]">Live Monitoring</span>
            </div>
        </header>

        <main class="animate-in fade-in slide-in-from-bottom-4 duration-700">
            <form id="formSiniestros" class="form-card overflow-hidden" autocomplete="off">
                <div class="p-6 md:p-12 space-y-10" id="formUI">
                    
                    <!-- PASO 1: UBICACI√ìN -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 1</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Ubicaci√≥n</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üè¢ Negocio</label>
                                <select id="Negocio" class="standard-input" required>
                                    <option value="Oficinas de servicio Oxxo" selected>Oficinas de servicio Oxxo</option>
                                    <option value="Club de Futbol Monterrey">Club de Futbol Monterrey</option>
                                    <option value="Femsa">Femsa</option>
                                    <option value="Otras">Otras</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üìç Plaza / Oficina</label>
                                <select id="Plaza" class="standard-input" required>
                                    <option value="Oficina de servicio (OS)" selected>Oficina de servicio (OS)</option>
                                    <option value="Otras">Otras</option>
                                </select>
                                <input type="text" id="PlazaOtro" class="standard-input mt-2 hidden" placeholder="Escriba el nombre de la plaza">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üèóÔ∏è Edificio / Sede</label>
                            <select id="Edificio" class="standard-input" required>
                                <option value="Edison" selected>Edison</option>
                                <option value="Almac√©n Dr. Mora">Almac√©n Dr. Mora</option>
                                <option value="Anexo OS">Anexo OS</option>
                                <option value="Corporativo Femsa">Corporativo Femsa</option>
                                <option value="Fundadores">Fundadores</option>
                                <option value="Michelena">Michelena</option>
                                <option value="Xpertal">Xpertal</option>
                            </select>
                        </div>
                    </div>

                    <!-- PASO 2: CLASIFICACI√ìN -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 2</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Tipo de Incidente</h3>
                        </div>

                        <div class="space-y-4 p-6 bg-slate-50/50 rounded-3xl border border-slate-100">
                            <div class="relative space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üîç Buscar Subtipo</label>
                                <input type="text" id="subtipoSearch" class="standard-input" placeholder="Escriba para filtrar incidentes..." autocomplete="off">
                                <div id="search-results" class="hidden"></div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">‚ö†Ô∏è Categor√≠a</label>
                                    <select id="TipoSiniestroSelect" class="standard-input font-bold uppercase" required>
                                        <option value="">Seleccione Tipo</option>
                                    </select>
                                    <input type="hidden" id="TipoSiniestro" required>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üìå Subtipo</label>
                                    <select id="SubtipoSelect" class="standard-input font-bold uppercase" required>
                                        <option value="">Seleccione Subtipo</option>
                                    </select>
                                    <input type="hidden" id="Subtipo" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 3: NARRATIVA -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 3</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Descripci√≥n</h3>
                        </div>

                        <div class="space-y-3">
                            <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üìù Detalle de los hechos</label>
                            <div class="border border-slate-200 rounded-3xl overflow-hidden bg-white shadow-sm focus-within:border-red-900 transition-all">
                                <div class="ribbon-toolbar" id="editorToolbar">
                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatDocSin('bold')"><i class="fa-solid fa-bold"></i></button>
                                        <button type="button" class="toolbar-btn" onclick="formatDocSin('italic')"><i class="fa-solid fa-italic"></i></button>
                                        <button type="button" class="toolbar-btn" onclick="formatDocSin('underline')"><i class="fa-solid fa-underline"></i></button>
                                    </div>
                                    <div class="toolbar-group relative">
                                        <button type="button" class="toolbar-btn" id="colorBtnSin" title="Color de fuente">
                                            <i class="fa-solid fa-font"></i>
                                            <div id="currentColorIndicatorSin" class="color-indicator-bar" style="background: #000"></div>
                                        </button>
                                        <button type="button" class="toolbar-btn" id="bgColorBtnSin" title="Resaltado">
                                            <i class="fa-solid fa-highlighter"></i>
                                            <div id="currentBgColorIndicatorSin" class="color-indicator-bar" style="background: transparent; border: 1px solid #ddd"></div>
                                        </button>
                                        <div id="colorPaletteSin" class="color-palette-container hidden flex-col gap-2"></div>
                                    </div>
                                    <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatDocSin('insertUnorderedList')"><i class="fa-solid fa-list-ul"></i></button>
                                        <button type="button" class="toolbar-btn" onclick="formatDocSin('removeFormat')"><i class="fa-solid fa-eraser"></i></button>
                                    </div>
                                </div>
                                <div id="descripcion" contenteditable="true" class="editor-content" placeholder="Relate detalladamente los hechos ocurridos..."></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="p-4 bg-white border border-slate-100 rounded-2xl flex items-center justify-between cursor-pointer hover:bg-slate-50 transition-colors">
                                <span class="text-[11px] font-bold text-slate-600 uppercase">üöë Lesionados en sitio</span>
                                <input type="checkbox" name="personasAfectadas[]" value="Lesionados" class="w-5 h-5 accent-[#450a0a]">
                            </label>
                            <label class="p-4 bg-white border border-slate-100 rounded-2xl flex items-center justify-between cursor-pointer hover:bg-slate-50 transition-colors">
                                <span class="text-[11px] font-bold text-slate-600 uppercase">‚öñÔ∏è Personas Detenidas</span>
                                <input type="checkbox" name="personasAfectadas[]" value="Detenidos" class="w-5 h-5 accent-[#450a0a]">
                            </label>
                        </div>
                    </div>

                    <!-- PASO 4: RESPONSABLES -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 4</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Personal</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üë§ Quien reporta</label>
                                <input type="text" id="reporta" class="standard-input" placeholder="Nombre completo" required>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üßë‚Äçüíº Realiza (CCO)</label>
                                <select id="realiza" class="standard-input" required>
                                    <option value="">Seleccione Operador</option>
                                </select>
                                <input type="text" id="realizaOtro" class="standard-input mt-2 hidden" placeholder="Nombre completo del operador">
                            </div>
                        </div>
                    </div>

                    <!-- PASO 5: NOTIFICACIONES -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <span class="step-pill">Paso 5</span>
                            <div class="h-px bg-slate-100 flex-1"></div>
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Notificaciones</h3>
                        </div>

                        <div class="space-y-4">
                            <label class="text-[10px] font-black text-slate-400 uppercase block ml-1">üì® Notificar adicionalmente a:</label>
                            <div class="grid grid-cols-1 gap-2" id="extraEmailsList">
                                <!-- Opci√≥n 1: Seguridad Operativa -->
                                <label class="flex items-center gap-3 p-3 bg-slate-50/50 rounded-xl hover:bg-slate-50 cursor-pointer border border-transparent hover:border-slate-200 transition-colors">
                                    <input type="checkbox" class="w-4 h-4 accent-[#450a0a]" name="correosExtra" value="jesuseduardo.gutierrez@armur.com;juan.paniagua@armur.com;ana.martinezisai@armur.com">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase tracking-tighter italic">Supervisores y RH (Gutierrez / Paniagua / Martinez)</span>
                                </label>
                                <!-- Opci√≥n 2: Oxxo Gas -->
                                <label class="flex items-center gap-3 p-3 bg-slate-50/50 rounded-xl hover:bg-slate-50 cursor-pointer border border-transparent hover:border-slate-200 transition-colors">
                                    <input type="checkbox" class="w-4 h-4 accent-[#450a0a]" name="correosExtra" value="emmanuel.zapata@oxxogas.com;andreac.rodriguez@oxxogas.com">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase tracking-tighter italic">Oxxo Gas (Zapata / Rodriguez)</span>
                                </label>
                                <!-- Opci√≥n 3: Treycy Arreguin -->
                                <label class="flex items-center gap-3 p-3 bg-slate-50/50 rounded-xl hover:bg-slate-50 cursor-pointer border border-transparent hover:border-slate-200 transition-colors">
                                    <input type="checkbox" class="w-4 h-4 accent-[#450a0a]" name="correosExtra" value="treycy.arreguin@oxxo.com">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase tracking-tighter italic">Treycy Arreguin (treycy.arreguin@oxxo.com)</span>
                                </label>
                                <!-- Opci√≥n 4: Jos√© Antonio Palacios -->
                                <label class="flex items-center gap-3 p-3 bg-slate-50/50 rounded-xl hover:bg-slate-50 cursor-pointer border border-transparent hover:border-slate-200 transition-colors">
                                    <input type="checkbox" class="w-4 h-4 accent-[#450a0a]" name="correosExtra" value="josea.palacios@armur.com">
                                    <span class="text-[10px] font-bold text-slate-600 uppercase tracking-tighter italic">Jos√© Antonio Palacios (josea.palacios@armur.com)</span>
                                </label>
                            </div>
                            <div class="mt-2">
                                <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">‚úèÔ∏è Otros correos (separados por ;)</label>
                                <input type="text" id="correosOtros" class="standard-input" placeholder="ejemplo@correo.com">
                            </div>
                        </div>

                        <!-- VISTA PREVIA -->
                        <div id="emailPreviewSection" class="p-5 bg-red-50 border border-red-100 rounded-2xl space-y-3 hidden">
                            <label class="text-[9px] font-black text-red-900 uppercase tracking-widest block">üìã Destinatarios confirmados:</label>
                            <div id="emailListDisplay" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <div class="pt-6 space-y-4">
                        <button type="submit" id="btnSubmit" class="w-full py-5 bg-slate-900 text-white rounded-[2rem] font-black text-xs uppercase tracking-[0.2em] shadow-xl hover:bg-[#450a0a] transition-all flex items-center justify-center gap-3">
                            <i class="fa-solid fa-paper-plane"></i>
                            Finalizar y Registrar
                        </button>
                        <div class="flex justify-center items-center opacity-30 hover:opacity-100 transition-opacity">
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="testMode" class="w-3 h-3 accent-slate-400">
                                <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest group-hover:text-slate-600">Modo de prueba (Solo remitente)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- √âXITO -->
                <div id="successUI" class="hidden py-24 text-center space-y-6">
                    <div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center mx-auto text-4xl border border-emerald-100 shadow-sm">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tighter">¬°Registro Exitoso!</h3>
                        <p class="text-sm text-slate-500 max-w-xs mx-auto mt-2">El incidente ha sido registrado y notificado correctamente.</p>
                    </div>
                    <button type="button" id="btnNewReport" class="px-10 py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl active:scale-95 transition-all">Crear Nuevo Reporte</button>
                </div>
            </form>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            messagingSenderId: "248659087868",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279",
            measurementId: "G-ZMC7H7710Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'cic.pp';

        const URL_RECUPERAR = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/097a63200e254f4db1c47d052f2613ef/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=4GE6KXcJvL1j7ih9cl-ubC93RoycRieLuJuz2DdbFU4";
        const URL_ENVIAR = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/28a6ecf6c40e4d14aa520a51c8430065/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=4DbF_Lj5HOOWUNIaV_lSLMZH1j5etCF1n18CTLRDkxs";

        const CACHE_KEY_MATRIZ = 'CIC6_RegSin_Matriz';
        const CACHE_KEY_OPERADORES = 'CIC6_RegSin_Operadores';

        let dataArray = [];
        let filteredResults = [];
        let focusedResultIndex = -1;
        let currentUser = null;
        let activeColorCommand = 'foreColor';

        const editor = document.getElementById('descripcion');
        const colorPalette = document.getElementById('colorPaletteSin');
        const colorBtn = document.getElementById('colorBtnSin');
        const bgColorBtn = document.getElementById('bgColorBtnSin');
        const indicator = document.getElementById('currentColorIndicatorSin');
        const bgIndicator = document.getElementById('currentBgColorIndicatorSin');
        const tipoSelect = document.getElementById('TipoSiniestroSelect');
        const subtipoSelect = document.getElementById('SubtipoSelect');
        const searchInput = document.getElementById('subtipoSearch');
        const searchResultsDiv = document.getElementById('search-results');
        const realizaSelect = document.getElementById('realiza');
        const tipoHidden = document.getElementById('TipoSiniestro');
        const subtipoHidden = document.getElementById('Subtipo');

        const colorGroups = [
            { label: 'Neutrales', colors: ['#000000', '#2d3748', '#4a5568', '#718096', '#a0aec0', '#cbd5e0', '#e2e8f0', '#FFFFFF'] },
            { label: 'Marca CIC', colors: ['#450a0a', '#7f1d1d', '#991b1b', '#b91c1c', '#dc2626', '#ef4444', '#f87171', '#fca5a5'] },
            { label: 'Alertas', colors: ['#c2410c', '#ea580c', '#f97316', '#fb923c', '#ca8a04', '#eab308', '#facc15', '#fef08a'] },
            { label: 'Estado', colors: ['#166534', '#15803d', '#16a34a', '#22c55e', '#4ade80', '#86efac', '#bbf7d0', '#f0fdf4'] },
            { label: 'Sistema', colors: ['#1e40af', '#1d4ed8', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#eff6ff'] }
        ];

        window.formatDocSin = (cmd, val = null) => { editor.focus(); document.execCommand(cmd, false, val); };
        const cleanEmail = (e) => e.trim().replace(/^mailto:/i, "").toLowerCase();

        const updateEmailPreview = () => {
            const isTest = document.getElementById('testMode').checked;
            let todos = [];
            if (isTest) {
                todos = ["proteccion.instalaciones@armur.com"];
            } else {
                const tipo = tipoHidden.value;
                const subtipo = subtipoHidden.value;
                const match = dataArray.find(item => item.Tipo === tipo && item.Subtipo === subtipo);
                let base = match && match["Listado de correos"] ? match["Listado de correos"].split(";").map(cleanEmail) : [];
                let extras = Array.from(document.querySelectorAll("input[name='correosExtra']:checked")).flatMap(cb => cb.value.split(";")).map(cleanEmail);
                let manual = document.getElementById("correosOtros").value.split(";").map(cleanEmail).filter(c => c);
                todos = [...new Set([...base, ...extras, ...manual])].filter(c => c && c.includes('@'));
            }
            const section = document.getElementById('emailPreviewSection');
            const display = document.getElementById('emailListDisplay');
            if (todos.length > 0) {
                section.classList.remove('hidden');
                display.innerHTML = todos.map(e => `<span class="px-2 py-1 bg-white border border-red-100 text-red-900 text-[9px] font-bold rounded-lg lowercase shadow-sm">${e}</span>`).join('');
            } else { section.classList.add('hidden'); }
            return todos.join("; ");
        };

        async function initModule() {
            const cachedMatriz = localStorage.getItem(CACHE_KEY_MATRIZ);
            const cachedOperadores = localStorage.getItem(CACHE_KEY_OPERADORES);
            if (cachedMatriz) { dataArray = JSON.parse(cachedMatriz); populateTipoSelect(); hideLoader(); }
            if (cachedOperadores) { updateOperadoresUI(JSON.parse(cachedOperadores)); }
            fetchBackgroundData();
        }

        async function fetchBackgroundData() {
            try {
                const resTipos = await fetch(URL_RECUPERAR, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ Mode: "Tipos" }) });
                const d = await resTipos.json();
                if (d?.Matriz) {
                    dataArray = d.Matriz;
                    localStorage.setItem(CACHE_KEY_MATRIZ, JSON.stringify(dataArray));
                    populateTipoSelect();
                    hideLoader();
                }
                const resUsers = await fetch(URL_RECUPERAR, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ Mode: "ElementosPP" }) });
                const du = await resUsers.json();
                if (du?.Usuarios) {
                    const operadores = du.Usuarios.filter(u => u.Area === "Centro de Control");
                    localStorage.setItem(CACHE_KEY_OPERADORES, JSON.stringify(operadores));
                    updateOperadoresUI(operadores);
                }
            } catch (e) { console.error(e); }
        }

        function updateOperadoresUI(operadores) {
            const currentVal = realizaSelect.value;
            realizaSelect.innerHTML = '<option value="">Seleccione Operador</option>';
            operadores.forEach(u => {
                const opt = document.createElement("option");
                opt.value = u.Nombre; opt.textContent = u.Nombre; 
                realizaSelect.appendChild(opt);
            });
            const optO = document.createElement("option"); optO.value = "Otro"; optO.textContent = "Otro (Especificar)"; 
            realizaSelect.appendChild(optO);
            if (currentVal) realizaSelect.value = currentVal;
        }

        function populateTipoSelect() {
            const currentTipo = tipoSelect.value;
            const tipos = [...new Set(dataArray.map(i => i.Tipo))].sort();
            tipoSelect.innerHTML = '<option value="">Seleccione Tipo</option>';
            tipos.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.textContent = t;
                tipoSelect.appendChild(opt);
            });
            if (currentTipo) { tipoSelect.value = currentTipo; populateSubtipoSelect(currentTipo); }
        }

        function populateSubtipoSelect(tipo) {
            const currentSub = subtipoSelect.value;
            const subtipos = dataArray.filter(i => i.Tipo === tipo).map(i => i.Subtipo).sort();
            subtipoSelect.innerHTML = '<option value="">Seleccione Subtipo</option>';
            subtipos.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.textContent = s;
                subtipoSelect.appendChild(opt);
            });
            if (currentSub && subtipos.includes(currentSub)) subtipoSelect.value = currentSub;
        }

        function hideLoader() {
            document.getElementById('loadingOverlaySin').classList.add('opacity-0');
            setTimeout(() => document.getElementById('loadingOverlaySin').style.display = 'none', 500);
        }

        tipoSelect.addEventListener('change', (e) => {
            const tipo = e.target.value;
            tipoHidden.value = tipo;
            subtipoHidden.value = ""; subtipoSelect.value = ""; searchInput.value = "";
            populateSubtipoSelect(tipo); updateEmailPreview();
        });

        subtipoSelect.addEventListener('change', (e) => {
            const subtipo = e.target.value;
            subtipoHidden.value = subtipo; searchInput.value = subtipo;
            updateEmailPreview();
        });

        document.getElementById('Plaza').addEventListener('change', function() {
            document.getElementById('PlazaOtro').classList.toggle('hidden', this.value !== 'Otras');
        });

        function buildColorPalette() {
            colorPalette.innerHTML = '';
            colorGroups.forEach(g => {
                const l = document.createElement('div'); l.className = 'text-[7px] font-black uppercase text-slate-400 mt-2 mb-1'; l.innerText = g.label;
                colorPalette.appendChild(l);
                const r = document.createElement('div'); r.className = 'color-row';
                g.colors.forEach(c => {
                    const s = document.createElement('div'); s.className = 'color-swatch'; s.style.backgroundColor = c;
                    s.onmousedown = (e) => { 
                        e.preventDefault(); 
                        formatDocSin(activeColorCommand, c); 
                        if (activeColorCommand === 'foreColor') indicator.style.background = c;
                        else bgIndicator.style.background = c;
                        colorPalette.classList.add('hidden'); 
                    };
                    r.appendChild(s);
                });
                colorPalette.appendChild(r);
            });
        }
        buildColorPalette();

        colorBtn.onmousedown = (e) => { e.preventDefault(); activeColorCommand = 'foreColor'; colorPalette.classList.toggle('hidden'); };
        bgColorBtn.onmousedown = (e) => { e.preventDefault(); activeColorCommand = 'hiliteColor'; colorPalette.classList.toggle('hidden'); };

        searchInput.addEventListener('input', (e) => {
            const v = e.target.value.toLowerCase().trim();
            if (v.length < 1) { searchResultsDiv.classList.add('hidden'); return; }
            filteredResults = dataArray.filter(i => i.Subtipo.toLowerCase().includes(v) || i.Tipo.toLowerCase().includes(v));
            if (filteredResults.length > 0) {
                searchResultsDiv.innerHTML = filteredResults.map((item, index) => `
                    <div class="result-item" onclick="selectSinIncident('${item.Tipo.replace(/'/g, "\\'")}', '${item.Subtipo.replace(/'/g, "\\")}')">
                        <p class="text-[8px] font-black text-red-800 uppercase">${item.Tipo}</p>
                        <p class="text-sm font-bold text-slate-800 uppercase">${item.Subtipo}</p>
                    </div>`).join('');
                searchResultsDiv.classList.remove('hidden');
            } else { searchResultsDiv.classList.add('hidden'); }
        });

        window.selectSinIncident = (t, s) => {
            tipoHidden.value = t; subtipoHidden.value = s; tipoSelect.value = t;
            populateSubtipoSelect(t); subtipoSelect.value = s; searchInput.value = s;
            searchResultsDiv.classList.add('hidden'); updateEmailPreview();
        };

        document.getElementById('formSiniestros').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const isTest = document.getElementById('testMode').checked;
            
            // Validaciones b√°sicas
            if (!editor.textContent.trim()) { editor.focus(); return; }
            if (!tipoHidden.value || !subtipoHidden.value) { searchInput.focus(); return; }
            if (!currentUser) {
                console.warn("Usuario no autenticado. Reintentando anonimamente...");
                await signInAnonymously(auth);
            }

            btn.disabled = true; 
            btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin"></i> Registrando...';
            
            const destinatarios = updateEmailPreview();
            const payload = {
                negocioSeleccionado: document.getElementById("Negocio").value,
                plazaSeleccionada: document.getElementById("Plaza").value === 'Otras' ? document.getElementById("PlazaOtro").value : document.getElementById("Plaza").value,
                edificioSeleccionado: document.getElementById("Edificio").value,
                tipoSiniestroSeleccionado: tipoHidden.value,
                subtipoSeleccionado: subtipoHidden.value, 
                descripcionIncidente: editor.innerHTML,
                descripcionTextoPlano: editor.innerText,
                personasAfectadas: Array.from(document.querySelectorAll("input[name='personasAfectadas[]']")).map(cb => `<b>${cb.value}</b>: ${cb.checked ? "S√≠" : "No"}`).join('\n'),
                nombreReporta: document.getElementById("reporta").value,
                nombreRealiza: realizaSelect.value === 'Otro' ? document.getElementById("realizaOtro").value : realizaSelect.value,
                listadoCorreos: destinatarios,
                timestamp: new Date().toISOString(),
                createdAt: serverTimestamp(),
                uid: auth.currentUser?.uid || 'anonymous',
                testMode: isTest
            };

            try {
                // 1. Guardar en Firebase (Garantizado primero)
                // Ruta: /artifacts/cic.pp/public/data/Siniestros
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'Siniestros'), payload);
                console.log("Firebase: Registro guardado exitosamente.");

                // 2. Enviar a Power Automate
                await fetch(URL_ENVIAR, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify(payload) 
                });
                console.log("Power Automate: Notificaci√≥n enviada.");

                // Mostrar √©xito
                document.getElementById("formUI").style.display = "none";
                document.getElementById("successUI").classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (err) { 
                console.error("Fallo cr√≠tico en el registro:", err);
                btn.disabled = false; 
                btn.innerHTML = 'Fallo al guardar. Reintentar'; 
            }
        };

        setInterval(() => { document.getElementById('clockSin').textContent = new Date().toLocaleTimeString('es-MX', { hour12: false }); }, 1000);
        onAuthStateChanged(auth, (u) => { 
            if (u) { 
                currentUser = u; 
                initModule(); 
            } else {
                signInAnonymously(auth);
            }
        });

        document.getElementById('btnNewReport').onclick = () => location.reload();
        document.getElementById('realiza').onchange = function() { document.getElementById('realizaOtro').classList.toggle('hidden', this.value !== 'Otro'); };
        document.getElementById('testMode').onchange = updateEmailPreview;
        document.getElementById('correosOtros').oninput = updateEmailPreview;
        document.querySelectorAll("input[name='correosExtra']").forEach(cb => cb.onchange = updateEmailPreview);
    </script>
</body>
</html>