<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas de Asistencia - CIC6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --metal-fuchsia-dark: #2d0630;
            --metal-fuchsia-mid: #4a044e;
            --metal-fuchsia-light: #701a75;
            --md-background: #f8fafc;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--md-background);
            color: #1e293b;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .stats-header {
            background: white;
            border-radius: 24px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }

        .period-selector {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 12px;
            gap: 4px;
        }

        .period-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 9px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            color: #64748b;
            transition: all 0.2s;
        }

        .period-btn.active {
            background: white;
            color: var(--metal-fuchsia-mid);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* --- KPI CARDS --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 18px;
            border: 1px solid #e2e8f0;
            position: relative;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1;
        }

        .stat-label {
            font-size: 9px;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* --- CONSOLA DE PROCESO --- */
        .engine-status {
            background: #0f172a;
            color: #38bdf8;
            border-radius: 12px;
            padding: 10px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        .progress-bar {
            width: 120px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            background: #38bdf8;
            width: 0%;
            transition: width 0.3s;
        }

        /* --- DETALLES --- */
        .details-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .panel-box {
            background: white;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--metal-fuchsia-dark) 0%, var(--metal-fuchsia-mid) 100%);
            padding: 14px 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-header h3 { font-size: 10px; font-weight: 800; text-transform: uppercase; }

        .list-item {
            padding: 10px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="no-scrollbar">

    <!-- Encabezado de Control -->
    <header class="stats-header">
        <div class="flex flex-col md:flex-row justify-between gap-4">
            <div class="space-y-3">
                <h1 class="text-lg font-black text-slate-900 uppercase tracking-tight">Estadísticas Operativas</h1>
                <div class="period-selector">
                    <button onclick="setPeriod('dia')" id="btn-period-dia" class="period-btn active">Día</button>
                    <button onclick="setPeriod('semana')" id="btn-period-semana" class="period-btn">Semana</button>
                    <button onclick="setPeriod('mes')" id="btn-period-mes" class="period-btn">Mes</button>
                    <button onclick="setPeriod('año')" id="btn-period-año" class="period-btn">Año</button>
                </div>
            </div>

            <div class="flex flex-col items-end gap-2">
                <div class="flex items-center gap-2">
                    <button onclick="jumpTo(-1)" class="p-2 bg-slate-50 border border-slate-200 rounded-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="3"/></svg>
                    </button>
                    <div class="bg-slate-900 px-4 py-2 rounded-xl border border-slate-700 min-w-[180px] text-center">
                        <span id="display-range" class="text-[10px] font-black uppercase text-sky-400">Cargando...</span>
                    </div>
                    <button onclick="jumpTo(1)" class="p-2 bg-slate-50 border border-slate-200 rounded-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="3"/></svg>
                    </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetToCurrent()" class="text-[8px] font-black uppercase py-1.5 px-3 bg-fuchsia-100 text-fuchsia-900 rounded-lg">Actualizar Periodo Actual</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Estado del Motor (Consola) -->
    <div class="engine-status">
        <div class="flex items-center gap-3">
            <div id="status-dot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span id="engine-msg">Motor Listo: Sistema en Caché</span>
        </div>
        <div class="flex items-center gap-4">
            <div class="progress-bar"><div id="progress-fill"></div></div>
            <span id="progress-text" class="opacity-60">100%</span>
        </div>
    </div>

    <!-- Malla de Indicadores -->
    <div class="stats-grid">
        <div class="stat-card">
            <div id="val-asistencias" class="stat-value text-emerald-600">0</div>
            <div class="stat-label">Asistencias</div>
        </div>
        <div class="stat-card">
            <div id="val-faltas" class="stat-value text-rose-600">0</div>
            <div class="stat-label">Faltas</div>
        </div>
        <div class="stat-card">
            <div id="val-retardos" class="stat-value text-amber-500">0</div>
            <div class="stat-label">Retardos</div>
        </div>
        <div class="stat-card">
            <div id="val-extras" class="stat-value text-fuchsia-600">0</div>
            <div class="stat-label">T. Extras</div>
        </div>
        <div class="stat-card">
            <div id="val-rec" class="stat-value text-slate-700">0</div>
            <div class="stat-label">Recuperaciones</div>
        </div>
    </div>

    <!-- Paneles de Detalle -->
    <div class="details-grid">
        <div class="panel-box">
            <div class="panel-header">
                <h3>Resumen por Fecha</h3>
                <span class="text-[9px] opacity-60">Historial del Periodo</span>
            </div>
            <div id="history-list" class="max-h-[300px] overflow-y-auto no-scrollbar">
                <!-- Se inyecta historial -->
            </div>
        </div>
        <div class="panel-box">
            <div class="panel-header">
                <h3>Cobertura Casetas</h3>
                <span id="overall-coverage" class="text-[9px] font-black">0%</span>
            </div>
            <div id="coverage-list" class="max-h-[300px] overflow-y-auto no-scrollbar">
                <!-- Se inyecta cobertura -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU", authDomain: "cic6-pp-web.firebaseapp.com", projectId: "cic6-pp-web", appId: "1:248659087868:web:a277ef700d83c7f1d22279" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'cic.pp';

        const casetasOrden = ["Centro de control", "Encargado", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero"];
        
        let currentMode = 'mes';
        let anchorDate = new Date();
        anchorDate.setHours(12,0,0,0);

        // --- SISTEMA DE CACHÉ ---
        let storage = JSON.parse(localStorage.getItem('cic_stats_db_v2') || '{}');
        const saveStorage = () => localStorage.setItem('cic_stats_db_v2', JSON.stringify(storage));

        const getTodayId = () => {
            const n = new Date();
            return `${n.getDate().toString().padStart(2,'0')}${(n.getMonth()+1).toString().padStart(2,'0')}${n.getFullYear()}`;
        };

        // --- NAVEGACIÓN ---
        window.setPeriod = (m) => { currentMode = m; updateUI(); sync(); };
        window.jumpTo = (step) => {
            if(currentMode === 'dia') anchorDate.setDate(anchorDate.getDate() + step);
            if(currentMode === 'semana') anchorDate.setDate(anchorDate.getDate() + (step*7));
            if(currentMode === 'mes') anchorDate.setMonth(anchorDate.getMonth() + step);
            if(currentMode === 'año') anchorDate.setFullYear(anchorDate.getFullYear() + step);
            updateUI(); sync();
        };
        window.resetToCurrent = () => { anchorDate = new Date(); anchorDate.setHours(12,0,0,0); updateUI(); sync(); };

        function getDatesInRange() {
            let start = new Date(anchorDate), end = new Date(anchorDate);
            if(currentMode === 'semana') {
                start.setDate(anchorDate.getDate() - anchorDate.getDay() + (anchorDate.getDay() === 0 ? -6 : 1));
                end = new Date(start); end.setDate(start.getDate() + 6);
            } else if(currentMode === 'mes') {
                start = new Date(anchorDate.getFullYear(), anchorDate.getMonth(), 1);
                end = new Date(anchorDate.getFullYear(), anchorDate.getMonth() + 1, 0);
            } else if(currentMode === 'año') {
                start = new Date(anchorDate.getFullYear(), 0, 1);
                end = new Date(anchorDate.getFullYear(), 11, 31);
            }
            start.setHours(0,0,0,0); end.setHours(23,59,59,999);
            const res = []; let dt = new Date(start);
            while(dt <= end) {
                res.push(`${dt.getDate().toString().padStart(2,'0')}${(dt.getMonth()+1).toString().padStart(2,'0')}${dt.getFullYear()}`);
                dt.setDate(dt.getDate()+1);
                if(res.length > 366) break;
            }
            return res;
        }

        // --- MOTOR DE DESCARGA ---
        async function fetchDay(dId) {
            const stats = { asistencias: 0, faltas: 0, retardos: 0, extras: 0, rec: 0, coverage: {} };
            casetasOrden.forEach(c => stats.coverage[c] = 0);
            
            const shifts = ['matutino', 'vespertino', 'nocturno'];
            for(const s of shifts) {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'RegAs', dId, s));
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.entrada_real) {
                        stats.asistencias++;
                        if(d.retardo) stats.retardos++;
                        if(d.es_extra) stats.extras++;
                        if(d.es_recuperacion) stats.rec++;
                        if(d.Caseta) stats.coverage[d.Caseta] = (stats.coverage[d.Caseta] || 0) + 1;
                    }
                });
            }
            const aus = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'RegAs', dId, 'ausentismo'));
            aus.forEach(doc => { if(doc.data().motivo === 'Falta') stats.faltas++; });
            return stats;
        }

        async function sync() {
            const dates = getDatesInRange();
            const todayId = getTodayId();
            const toFetch = dates.filter(id => !storage[id] || id === todayId);
            
            // Paso 1: Renderizar lo que ya tenemos (Caché)
            renderResults();

            if(toFetch.length === 0) {
                document.getElementById('engine-msg').innerText = "Datos Sincronizados (Desde Caché)";
                document.getElementById('progress-fill').style.width = '100%';
                document.getElementById('progress-text').innerText = '100%';
                return;
            }

            // Paso 2: Descargar faltantes de forma secuencial para no saturar
            let count = 0;
            for(const id of toFetch) {
                count++;
                const perc = Math.round((count / toFetch.length) * 100);
                document.getElementById('engine-msg').innerText = `Descargando: ${id}...`;
                document.getElementById('progress-fill').style.width = `${perc}%`;
                document.getElementById('progress-text').innerText = `${perc}%`;
                
                try {
                    storage[id] = await fetchDay(id);
                    saveStorage();
                    renderResults(); // Actualizar UI progresivamente
                } catch(e) { console.error("Error en " + id, e); }
            }
            document.getElementById('engine-msg').innerText = "Sincronización Completa";
        }

        function renderResults() {
            const dates = getDatesInRange();
            const totals = { asistencias: 0, faltas: 0, retardos: 0, extras: 0, rec: 0 };
            const covMap = {}; casetasOrden.forEach(c => covMap[c] = 0);
            
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';

            dates.reverse().forEach(id => {
                const day = storage[id];
                if(day) {
                    totals.asistencias += day.asistencias;
                    totals.faltas += day.faltas;
                    totals.retardos += day.retardos;
                    totals.extras += day.extras;
                    totals.rec += day.rec;
                    Object.keys(day.coverage).forEach(c => covMap[c] += day.coverage[c]);
                    
                    const row = document.createElement('div');
                    row.className = 'list-item';
                    row.innerHTML = `<span>${id.substring(0,2)}/${id.substring(2,4)}/${id.substring(4)}</span><b>${day.asistencias} Asist.</b>`;
                    historyList.appendChild(row);
                }
            });

            // Actualizar KPIs
            document.getElementById('val-asistencias').innerText = totals.asistencias;
            document.getElementById('val-faltas').innerText = totals.faltas;
            document.getElementById('val-retardos').innerText = totals.retardos;
            document.getElementById('val-extras').innerText = totals.extras;
            document.getElementById('val-rec').innerText = totals.rec;

            // Cobertura
            const covList = document.getElementById('coverage-list');
            covList.innerHTML = '';
            let totalTurns = dates.length * 3 * casetasOrden.length; // Estimado
            let realSum = 0;

            Object.keys(covMap).sort((a,b) => covMap[a] - covMap[b]).forEach(c => {
                realSum += covMap[c];
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `<span>${c}</span><span class="uncovered-badge">${covMap[c]} Turnos</span>`;
                covList.appendChild(item);
            });
        }

        function updateUI() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.toggle('active', b.id === `btn-period-${currentMode}`));
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            const el = document.getElementById('display-range');
            if(currentMode === 'dia') el.innerText = anchorDate.toLocaleDateString('es-MX', options);
            else if(currentMode === 'mes') el.innerText = anchorDate.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });
            else el.innerText = `Periodo Seleccionado`;
        }

        window.addEventListener('message', (e) => {
            if (e.data.type === 'INIT_SUBMODULE') {
                if (e.data.date) anchorDate = new Date(e.data.date + 'T12:00:00');
                updateUI(); sync();
            }
        });

        window.onload = () => { updateUI(); sync(); };
    </script>
</body>
</html>