<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Perfiles - RegAs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-primary: #450a0a;
            --md-surface: #fdf8f8;
            --md-outline: #e5e7eb;
            --neon-green: #34d399;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: white;
            color: #1f1a1a;
            padding: 16px;
            scroll-behavior: smooth;
        }

        .search-container {
            position: sticky;
            top: 0;
            background: white;
            padding-bottom: 16px;
            z-index: 50;
        }
        .search-bar {
            width: 100%;
            background: #f1f5f9;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 12px 16px 12px 40px;
            font-size: 13px;
            font-weight: 600;
            outline: none;
            transition: all 0.2s;
        }
        .search-bar:focus {
            background: white;
            border-color: var(--md-primary);
            box-shadow: 0 4px 12px rgba(69, 10, 10, 0.05);
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 8px 6px 8px;
            margin-top: 12px;
            border-bottom: 1.5px solid #f1f5f9;
            transition: all 0.4s ease;
            border-radius: 12px 12px 0 0;
        }

        /* Clase de Resaltado Dinámico */
        .group-header.highlighted-group {
            background: #f0fdf4;
            border: 2px solid var(--neon-green);
            border-bottom: 2.5px solid var(--neon-green);
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.2);
            position: relative;
            transform: scale(1.02);
            z-index: 10;
        }

        .group-title {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #94a3b8;
        }
        .highlighted-group .group-title {
            color: #065f46;
        }

        .group-count {
            font-size: 9px;
            font-weight: 900;
            background: #f1f5f9;
            color: #64748b;
            padding: 2px 8px;
            border-radius: 6px;
        }

        .profile-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: white;
            border-radius: 16px;
            border: 1px solid #f1f5f9;
            margin-top: 8px;
            cursor: grab;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }
        .profile-card:hover { border-color: #cbd5e1; background: #f8fafc; transform: translateX(4px); }
        .profile-card:active { cursor: grabbing; transform: scale(0.98); }

        .avatar-box {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            object-fit: cover;
            background: #f1f5f9;
            flex-shrink: 0;
        }

        .info-main { flex-grow: 1; min-width: 0; }
        .name-txt { font-size: 11px; font-weight: 700; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .id-txt { font-size: 8px; font-weight: 800; text-transform: uppercase; color: #94a3b8; margin-top: 1px; }

        .role-badge { font-size: 7px; font-weight: 900; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; background: #fef2f2; color: #991b1b; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="search-container">
        <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="profile-search" oninput="filterProfiles()" placeholder="Buscar por nombre o ID..." class="search-bar">
        </div>
    </div>

    <div id="profiles-container" class="space-y-2">
        <div class="flex flex-col items-center justify-center py-20 gap-3 opacity-30">
            <div class="w-6 h-6 border-2 border-red-900 border-t-transparent rounded-full animate-spin"></div>
            <span class="text-[9px] font-black uppercase tracking-widest">Sincronizando Personal</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            messagingSenderId: "248659087868",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'cic.pp';

        const casetasOrden = ["Centro de control", "Encargado", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero", "SIN ASIGNAR"];
        let allProfiles = [];

        // Leer parámetro de resaltado de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const highlightedCaseta = urlParams.get('highlight');

        onAuthStateChanged(auth, (user) => {
            if (user) listenProfiles();
            else signInAnonymously(auth);
        });

        function listenProfiles() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios'), (snap) => {
                allProfiles = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    if ((data.status || "").toLowerCase() !== 'baja') allProfiles.push({ uid: doc.id, ...data });
                });
                renderProfiles(allProfiles);
            });
        }

        window.filterProfiles = () => {
            const term = document.getElementById('profile-search').value.toLowerCase().trim();
            const filtered = allProfiles.filter(p => (p.nombre || "").toLowerCase().includes(term) || (p.id_empleado || "").toString().includes(term) || (p.acceso_predeterminado || "").toLowerCase().includes(term));
            renderProfiles(filtered);
        };

        function renderProfiles(list) {
            const container = document.getElementById('profiles-container');
            container.innerHTML = '';
            if (list.length === 0) {
                container.innerHTML = `<div class="empty-state"><p class="text-[10px] font-bold uppercase tracking-widest">No se encontraron resultados</p></div>`;
                return;
            }

            const groups = list.reduce((acc, p) => {
                const groupName = p.acceso_predeterminado || "SIN ASIGNAR";
                if (!acc[groupName]) acc[groupName] = [];
                acc[groupName].push(p);
                return acc;
            }, {});

            const sortedGroupKeys = casetasOrden.filter(k => groups[k]);
            Object.keys(groups).forEach(k => { if (!sortedGroupKeys.includes(k)) sortedGroupKeys.push(k); });

            sortedGroupKeys.forEach(groupName => {
                const elements = groups[groupName];
                if (!elements || elements.length === 0) return;
                elements.sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""));

                const header = document.createElement('div');
                header.className = "group-header";
                header.id = `group-${normalizeId(groupName)}`;
                
                // Resaltar si coincide con el parámetro
                if (groupName === highlightedCaseta) {
                    header.classList.add('highlighted-group');
                    setTimeout(() => {
                        header.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 500);
                }

                header.innerHTML = `<span class="group-title">${groupName}</span><span class="group-count">${elements.length}</span>`;
                container.appendChild(header);

                elements.forEach(p => {
                    const card = document.createElement('div');
                    card.className = "profile-card animate-in fade-in slide-in-from-left-1 duration-300";
                    card.draggable = true;
                    card.ondragstart = (e) => { e.dataTransfer.setData("text/plain", JSON.stringify({ uid: p.uid, name: p.nombre, id_empleado: p.id_empleado })); card.style.opacity = '0.4'; };
                    card.ondragend = () => card.style.opacity = '1';
                    card.onclick = () => window.parent.postMessage({ type: 'navigateRight', url: `Apps/Perfil.html?uid=${p.uid}` }, '*');
                    
                    const photo = p.foto || `https://ui-avatars.com/api/?background=450a0a&color=fff&name=${encodeURIComponent(p.nombre || 'U')}`;
                    card.innerHTML = `<img src="${photo}" class="avatar-box" onerror="this.src='https://ui-avatars.com/api/?background=450a0a&color=fff&name=?'"><div class="info-main"><div class="name-txt">${p.nombre || '---'}</div><div class="id-txt">ID: ${p.id_empleado || '---'}</div></div><span class="role-badge">${(p.puesto || 'MIEMBRO').substring(0,6)}</span>`;
                    container.appendChild(card);
                });
            });
        }
        function normalizeId(s) { return s.toLowerCase().replace(/\s+/g, '-'); }
    </script>
</body>
</html>