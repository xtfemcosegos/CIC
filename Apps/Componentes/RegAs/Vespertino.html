<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turno Vespertino - CIC6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-primary: #4a044e;
            --md-primary-dark: #2d0630;
            --md-surface: #ffffff;
            --md-background: #f5f3ff;
            --md-outline: #ddd6fe;
            
            /* Colores Metal Fiusha */
            --metal-fuchsia-dark: #2d0630;
            --metal-fuchsia-mid: #4a044e;
            --metal-fuchsia-light: #701a75;
        }

        @keyframes subtle-glow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-background);
            color: #1e293b;
            margin: 0;
            padding: 16px;
            padding-top: 76px;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        h1, h2, h3, .font-heading {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        /* --- HEADER DE CONTEXTO --- */
        .date-context-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: white;
            border-bottom: 2px solid var(--md-outline);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        .date-context-header.is-not-today {
            background: #fffbeb;
            border-bottom-color: #fde68a;
        }

        .view-label {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--metal-fuchsia-mid);
            letter-spacing: 0.15em;
        }

        .current-date-text {
            font-size: 13px;
            font-weight: 800;
            color: var(--metal-fuchsia-dark);
            text-transform: uppercase;
        }

        .btn-today {
            background: var(--metal-fuchsia-mid);
            color: white;
            padding: 6px 16px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        /* --- GRID DE CASETAS --- */
        .caseta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }

        .caseta-card {
            background: white;
            border-radius: 24px;
            border: 1px solid var(--md-outline);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            min-height: 140px;
        }

        .caseta-card.drag-over {
            background: #fdf2f8;
            border: 2px dashed var(--metal-fuchsia-mid);
            transform: scale(1.02);
        }

        .caseta-header {
            background: linear-gradient(135deg, var(--metal-fuchsia-dark) 0%, var(--metal-fuchsia-mid) 100%);
            padding: 12px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .caseta-header::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.05) 0%, transparent 70%);
            animation: subtle-glow 8s infinite ease-in-out;
        }

        .caseta-title {
            color: white;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            position: relative;
            z-index: 1;
        }

        .btn-header-action {
            color: rgba(255,255,255,0.8);
            transition: all 0.2s;
            padding: 4px;
            border-radius: 8px;
            position: relative;
            z-index: 1;
        }
        .btn-header-action:hover { color: white; background: rgba(255,255,255,0.1); }

        .element-list {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        /* --- CARDS DE ELEMENTOS --- */
        .element-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: #f8fafc;
            border-radius: 16px;
            border: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .element-item:hover { 
            border-color: var(--md-outline); 
            background: white; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
        }
        
        .element-item.is-late { border-left: 4px solid #ef4444; }

        .avatar-mini {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            object-fit: cover;
            background: #e2e8f0;
        }

        .btn-quick {
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 8px;
            font-weight: 900;
            text-transform: uppercase;
            transition: all 0.2s;
            border: none;
        }

        .btn-entry { background: #10b981; color: white; }
        .btn-exit { background: #ffffff; color: #475569; border: 1px solid #cbd5e1; }

        .tag-rec { background: #166534; color: white; font-size: 6px; padding: 2px 5px; border-radius: 5px; font-weight: 900; }
        .tag-tex { background: #d946ef; color: white; font-size: 6px; padding: 2px 5px; border-radius: 5px; font-weight: 900; }

        #loading-state { background: var(--md-background); z-index: 2000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="no-scrollbar">

    <!-- Pantalla de Carga -->
    <div id="loading-state" class="fixed inset-0 flex flex-col items-center justify-center gap-4">
        <div class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <span class="text-[10px] font-black text-slate-400 uppercase mt-4 tracking-widest">Sincronizando Vespertino</span>
    </div>

    <!-- Header de Contexto -->
    <div id="date-header" class="date-context-header">
        <div class="flex flex-col">
            <span class="view-label">Planificación Vespertina</span>
            <span id="display-date-long" class="current-date-text">---</span>
        </div>
        <div id="today-action-area" class="hidden">
            <button onclick="window.goToToday()" class="btn-today">Ir a Hoy</button>
        </div>
    </div>

    <div class="caseta-grid" id="caseta-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, onSnapshot, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU", authDomain: "cic6-pp-web.firebaseapp.com", projectId: "cic6-pp-web", appId: "1:248659087868:web:a277ef700d83c7f1d22279" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'cic.pp';

        const casetasOrden = ["Centro de control", "Encargado", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero"];
        let currentAssignments = [];
        let userDataCache = {};
        let selectedDate = new Date().toISOString().split('T')[0];
        let operatorContext = null;
        let unsubListener = null;

        const formatDateToId = (isoStr) => isoStr.split('-').reverse().join('');

        onAuthStateChanged(auth, (user) => { if (user) init(); else signInAnonymously(auth); });

        async function init() {
            const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios'));
            usersSnap.forEach(d => userDataCache[d.id] = d.data());
            syncHeader();
            loadData();
        }

        function syncHeader() {
            const today = new Date().toISOString().split('T')[0];
            const isNotToday = selectedDate !== today;
            const header = document.getElementById('date-header');
            const dateLabel = document.getElementById('display-date-long');
            const dateObj = new Date(selectedDate + "T00:00:00");
            dateLabel.innerText = dateObj.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            header.classList.toggle('is-not-today', isNotToday);
            document.getElementById('today-action-area').classList.toggle('hidden', !isNotToday);
        }

        function loadData() {
            if (unsubListener) unsubListener();
            const dateId = formatDateToId(selectedDate);
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, 'vespertino');
            unsubListener = onSnapshot(colRef, (snap) => {
                currentAssignments = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const user = userDataCache[docSnap.id] || { nombre: 'Desconocido' };
                    currentAssignments.push({ uid: docSnap.id, nombre: user.nombre, foto: user.foto, ...data });
                });
                renderDashboard();
                document.getElementById('loading-state').style.display = 'none';
            });
        }

        function renderDashboard() {
            const container = document.getElementById('caseta-container');
            container.innerHTML = '';
            casetasOrden.forEach(casetaName => {
                const assigned = currentAssignments.filter(a => a.Caseta === casetaName);
                const card = document.createElement('div');
                card.className = "caseta-card animate-in fade-in zoom-in-95 duration-300";
                card.innerHTML = `
                    <div class="caseta-header">
                        <span class="caseta-title">${casetaName}</span>
                        <button onclick="openPerfiles('${casetaName}')" class="btn-header-action">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div class="element-list" id="list-${normalizeId(casetaName)}"></div>
                `;

                card.ondragover = (e) => { e.preventDefault(); card.classList.add('drag-over'); };
                card.ondragleave = () => card.classList.remove('drag-over');
                card.ondrop = (e) => handleDrop(e, casetaName);

                container.appendChild(card);
                const list = card.querySelector('.element-list');
                if (assigned.length === 0) {
                    list.innerHTML = `<p class="text-[8px] text-center py-8 text-slate-300 font-bold uppercase tracking-widest">Puesto Disponible</p>`;
                } else {
                    assigned.forEach(el => list.appendChild(createElementRow(el)));
                }
            });
        }

        function createElementRow(el) {
            const div = document.createElement('div');
            div.className = `element-item ${el.retardo ? 'is-late' : ''}`;
            
            div.draggable = true;
            div.ondragstart = (e) => {
                e.dataTransfer.setData("text/plain", JSON.stringify({ 
                    uid: el.uid, 
                    fromCaseta: el.Caseta, 
                    type: 'vespertino', 
                    internal: true 
                }));
                div.style.opacity = '0.5';
            };
            div.ondragend = () => div.style.opacity = '1';

            div.onclick = (e) => {
                if (e.target.closest('button')) return;
                window.parent.postMessage({ type: 'navigateRight', url: `Detalle.html?uid=${el.uid}&date=${selectedDate}` }, '*');
            };

            let actionBtnHtml = '';
            if (!el.entrada_real) {
                actionBtnHtml = `<button onclick="quickAttendance('${el.uid}', 'entrada')" class="btn-quick btn-entry">In</button>`;
            } else if (!el.salida_real) {
                actionBtnHtml = `<button onclick="quickAttendance('${el.uid}', 'salida')" class="btn-quick btn-exit">Out</button>`;
            }

            div.innerHTML = `
                <div class="absolute -top-2 right-4 flex gap-1">
                    ${el.es_recuperacion ? '<span class="tag-rec">REC</span>' : ''}
                    ${el.es_extra ? '<span class="tag-tex">TEx</span>' : ''}
                </div>
                <img src="${el.foto || ''}" class="avatar-mini" onerror="this.src='https://ui-avatars.com/api/?name=${el.nombre}&background=4c1d95&color=fff'">
                <div class="flex-grow min-w-0">
                    <p class="text-[10px] font-black text-slate-800 truncate uppercase tracking-tight">${el.nombre}</p>
                    <p class="text-[8px] font-bold text-slate-400 uppercase">${el.entrada_planificada} • ${el.entrada_real || '--:--'}</p>
                </div>
                <div onclick="event.stopPropagation()">${actionBtnHtml}</div>
            `;
            return div;
        }

        async function handleDrop(e, targetCaseta) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            try {
                const data = JSON.parse(e.dataTransfer.getData("text/plain"));
                const dateId = formatDateToId(selectedDate);
                
                if (data.internal) {
                    if (data.fromCaseta === targetCaseta) return;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, 'vespertino', data.uid), { 
                        Caseta: targetCaseta 
                    });
                } else {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, 'ausentismo', data.uid));
                    
                    let planTime = (targetCaseta === 'Centro de control' ? "14:00" : "15:00");
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, 'vespertino', data.uid), { 
                        Caseta: targetCaseta, 
                        turno: 'vespertino', 
                        entrada_planificada: planTime, 
                        es_recuperacion: false, 
                        es_festivo: false, 
                        es_extra: false, 
                        entrada_real: null, 
                        salida_real: null, 
                        retardo: false 
                    }, { merge: true });
                }
            } catch (err) { console.error("Error en drop:", err); }
        }

        window.quickAttendance = async (uid, type) => {
            const dateId = formatDateToId(selectedDate);
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, 'vespertino', uid);
            const nowTime = new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });
            if (type === 'entrada') {
                const snap = await getDoc(docRef);
                const [pH, pM] = (snap.data().entrada_planificada || "15:00").split(':').map(Number);
                const plan = new Date(); plan.setHours(pH, pM, 0);
                await updateDoc(docRef, { entrada_real: nowTime, retardo: new Date() > plan, operador_registro: operatorContext?.nombre || 'SISTEMA' });
            } else await updateDoc(docRef, { salida_real: nowTime });
        };

        window.openPerfiles = (casetaName) => {
            window.parent.postMessage({ type: 'navigateRight', url: `Perfiles.html?highlight=${encodeURIComponent(casetaName)}` }, '*');
        };

        window.goToToday = () => {
            const today = new Date().toISOString().split('T')[0];
            window.parent.postMessage({ type: 'DATE_CHANGED', date: today }, '*');
        };

        function normalizeId(s) { return s.toLowerCase().replace(/\s+/g, '-'); }

        window.addEventListener('message', (e) => {
            if (e.data.type === 'INIT_SUBMODULE') {
                operatorContext = e.data.user;
                selectedDate = e.data.date;
                syncHeader();
                loadData();
            }
            if (e.data.type === 'DATE_CHANGED' || e.data.type === 'regas_date_change') {
                selectedDate = e.data.date;
                syncHeader();
                loadData();
            }
        });
    </script>
</body>
</html>