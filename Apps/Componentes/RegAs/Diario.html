<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Diario - CIC6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Librería para captura de pantalla -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* Paleta Fiusha Metal Premium */
            --metal-fuchsia-dark: #1a031c;
            --metal-fuchsia-mid: #4a044e;
            --metal-fuchsia-light: #701a75;
            
            --md-primary: var(--metal-fuchsia-mid);
            --md-surface: #f8fafc;
            --md-outline: #e2e8f0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--md-surface);
            color: #1e293b;
            padding: 4px; 
            margin: 0;
            width: 100%;
            box-sizing: border-box;
        }

        @media (min-width: 768px) {
            body { padding: 12px; }
        }

        /* --- Contenedor del Reporte --- */
        #report-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 10px 25px rgba(30, 27, 75, 0.05);
            overflow: hidden;
            border: 1px solid var(--md-outline);
        }

        /* --- Header Estilo Fiusha Metal --- */
        .report-header {
            background: linear-gradient(135deg, var(--metal-fuchsia-dark) 0%, var(--metal-fuchsia-mid) 100%);
            color: white;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .report-header::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 11px);
        }

        /* --- Divisor de Turnos --- */
        .shift-divider {
            background: #0f172a;
            color: white;
            padding: 12px 20px;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Tablas --- */
        .table-container {
            background: white;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            table-layout: fixed; 
            min-width: 1000px; 
        }

        th { 
            background: #f8fafc; 
            padding: 10px 8px; 
            text-align: left; 
            font-size: 10px; 
            font-weight: 900; 
            text-transform: uppercase; 
            color: #64748b; 
            border-bottom: 2px solid #f1f5f9;
            letter-spacing: 0.05em;
        }

        td { 
            padding: 10px 8px; 
            font-size: 14px; 
            border-bottom: 1px solid #f1f5f9; 
            color: #334155; 
            vertical-align: middle;
            word-wrap: break-word;
        }

        /* Definición de anchos fijos para evitar desplazamientos en captura */
        .col-id { width: 75px; }
        .col-nombre { width: 330px; } 
        .col-estado { width: 170px; }
        .col-tiempo { width: 105px; }
        .col-comentario { width: auto; }
        .col-accion { width: 50px; }

        /* --- Badges de Estado --- */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            white-space: nowrap;
            line-height: 1;
        }
        .bg-in-turn { background: #fdf2f8; color: #701a75; border: 1px solid #fbcfe8; }
        .bg-finished { background: #f1f5f9; color: #64748b; }
        .bg-late { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .bg-special { background: #ede9fe; color: #4c1d95; }

        /* --- Colores de Ausentismo --- */
        .abs-vacaciones { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .abs-permiso { background: #ffedd5; color: #064e3b; border: 1px solid #fed7aa; }
        .abs-suspendido { background: #ffedd5; color: #9a3412; border: 1px solid #fdba74; }
        .abs-incapacidad { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .abs-falta { background: #fef08a; color: #991b1b; border: 1px solid #facc15; }
        .abs-descanso { background: #f1f5f9; color: #64748b; }

        .btn-detail {
            color: #94a3b8;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
        }
        .btn-detail:hover { color: var(--metal-fuchsia-mid); transform: scale(1.2); }

        /* Controles */
        .mode-selector {
            display: flex;
            background: #e2e8f0;
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }
        .mode-btn {
            padding: 8px 16px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            border-radius: 9px;
            transition: all 0.2s;
            color: #64748b;
        }
        .mode-btn.active { background: white; color: var(--metal-fuchsia-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .btn-email {
            background: var(--metal-fuchsia-dark);
            color: white;
            border-radius: 12px;
            padding: 10px 24px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(45, 6, 48, 0.2);
            transition: all 0.2s;
        }
        .btn-email:hover { transform: translateY(-1px); background: var(--metal-fuchsia-mid); }

        .input-date {
            background: white;
            border: 2px solid var(--md-outline);
            border-radius: 12px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 800;
            color: var(--metal-fuchsia-dark);
            outline: none;
            transition: border-color 0.2s;
        }
        .input-date:focus { border-color: var(--metal-fuchsia-mid); }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(26, 3, 28, 0.4); backdrop-filter: blur(8px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; border-radius: 24px; width: 90%; max-width: 420px;
            padding: 32px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- Modal de Envío de Correo -->
    <div id="email-modal" class="modal-overlay">
        <div class="modal-content space-y-6">
            <div class="text-center">
                <div class="w-12 h-12 bg-fuchsia-100 text-fuchsia-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </div>
                <h3 class="text-lg font-black uppercase text-indigo-950 tracking-tight">Enviar Reporte</h3>
                <p class="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">Sincronización Automática</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="setEmailPreset('prueba')" class="flex-1 py-2 px-3 bg-slate-100 hover:bg-slate-200 rounded-xl text-[10px] font-black uppercase text-slate-600 transition-all">Prueba</button>
                <button onclick="setEmailPreset('default')" class="flex-1 py-2 px-3 bg-fuchsia-50 hover:bg-fuchsia-100 rounded-xl text-[10px] font-black uppercase text-fuchsia-900 transition-all">Oficial</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">Destinatarios:</label>
                    <input type="text" id="email-to" class="w-full bg-slate-50 border-2 border-slate-100 focus:border-fuchsia-600 rounded-xl px-4 py-3 text-[13px] font-semibold outline-none transition-all" placeholder="correo@ejemplo.com">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">CC (Copia):</label>
                    <input type="text" id="email-cc" class="w-full bg-slate-50 border-2 border-slate-100 focus:border-fuchsia-600 rounded-xl px-4 py-3 text-[13px] font-semibold outline-none transition-all" placeholder="Copia a...">
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="closeEmailModal()" class="flex-1 py-3 text-[11px] font-black uppercase text-slate-400 hover:text-slate-600">Cerrar</button>
                <button id="btn-confirm-send" onclick="prepareAndSend()" class="flex-[2] bg-indigo-950 text-white rounded-xl py-3 text-[11px] font-black uppercase shadow-lg active:scale-95 transition-all">Confirmar Envío</button>
            </div>
        </div>
    </div>

    <div class="max-w-full mx-auto space-y-8">
        
        <!-- Barra de Herramientas Superior -->
        <div class="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm flex flex-col lg:flex-row items-center justify-between gap-6 mx-2 mt-4">
            <div class="flex flex-wrap items-center gap-8">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Filtro de Turnos</label>
                    <div class="mode-selector">
                        <button id="btn-diurno" onclick="setMode('diurno')" class="mode-btn active">Diurno (M/V/N)</button>
                        <button id="btn-nocturno" onclick="setMode('nocturno')" class="mode-btn">Nocturno (N-1/M)</button>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Fecha Base</label>
                    <input type="date" id="report-date" onchange="loadData()" class="input-date">
                </div>
            </div>

            <button onclick="openEmailModal()" class="btn-email">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                Enviar Reporte
            </button>
        </div>

        <div id="report-content" class="bg-white">
            <!-- Header del Documento -->
            <header class="report-header flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-black uppercase tracking-tight leading-none mb-1">Reporte de Asistencia</h1>
                    <p id="formatted-date" class="text-fuchsia-200/80 text-[11px] font-bold uppercase tracking-widest">---</p>
                </div>
            </header>

            <div id="tables-container" class="p-2 space-y-4">
                <!-- Secciones Dinámicas -->
            </div>
        </div>

        <div id="loading-state" class="hidden flex flex-col items-center justify-center py-20 gap-4">
            <div class="w-10 h-10 border-4 border-fuchsia-900 border-t-transparent rounded-full animate-spin"></div>
            <span class="text-[10px] font-black uppercase tracking-widest text-fuchsia-900/40">Sincronizando Base de Datos</span>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, getDocs, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            messagingSenderId: "248659087868",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'cic.pp';

        const casetaOrder = ["Centro de control", "Encargado", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero"];

        const POWER_AUTOMATE_API = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/507bea91c30c4743b4749a474f92ad3f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=PzEbbL5wNoHu-b78wQtE7JP0H-RKDb3btp2iHGbM6vU";

        let currentMode = 'diurno';
        let userDataCache = {};
        let activeUnsubscribes = [];

        const dateInput = document.getElementById('report-date');

        // Función para obtener fecha local YYYY-MM-DD sin errores de zona horaria (Tomorrow bug fix)
        function getLocalISODate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        dateInput.value = getLocalISODate();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await fetchUsers();
                loadData();
            } else signInAnonymously(auth);
        });

        async function fetchUsers() {
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios'));
            snap.forEach(d => userDataCache[d.id] = d.data());
        }

        window.setMode = (mode) => {
            if(currentMode === mode) return;
            currentMode = mode;
            document.getElementById('btn-diurno').classList.toggle('active', mode === 'diurno');
            document.getElementById('btn-nocturno').classList.toggle('active', mode === 'nocturno');
            loadData();
        };

        function getDateId(isoDate) { return isoDate.split('-').reverse().join(''); }
        
        function formatHeaderDate(isoDate) {
            const d = new Date(isoDate + "T00:00:00");
            return d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
        }

        window.loadData = function() {
            activeUnsubscribes.forEach(u => u());
            activeUnsubscribes = [];

            const rawDate = dateInput.value;
            if(!rawDate) return;

            const dateD = rawDate;
            const dateDMinus1Obj = new Date(rawDate + "T00:00:00");
            dateDMinus1Obj.setDate(dateDMinus1Obj.getDate() - 1);
            const dateDMinus1 = dateDMinus1Obj.toISOString().split('T')[0];
            
            const dObj = new Date(rawDate + "T00:00:00");
            document.getElementById('formatted-date').innerText = dObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();

            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('tables-container').innerHTML = '';

            let sections = [];
            if (currentMode === 'diurno') {
                sections = [
                    { id: 'matutino', label: 'Turno Matutino', date: dateD },
                    { id: 'vespertino', label: 'Turno Vespertino', date: dateD },
                    { id: 'nocturno', label: 'Turno Nocturno', date: dateD },
                    { id: 'ausentismo', label: 'Ausentismos', date: dateD }
                ];
            } else {
                sections = [
                    { id: 'nocturno', label: 'Turno Nocturno', date: dateDMinus1 },
                    { id: 'matutino', label: 'Turno Matutino', date: dateD },
                    { id: 'ausentismo', label: 'Ausentismos', date: dateDMinus1 },
                    { id: 'ausentismo', label: 'Ausentismos', date: dateD }
                ];
            }

            // Identificar meses únicos requeridos
            const uniqueMonths = [...new Set(sections.map(s => {
                const parts = s.date.split('-');
                return `${parts[1]}${parts[0]}`; // MMYYYY
            }))];

            const monthsData = {};
            let loadedMonths = 0;

            uniqueMonths.forEach(mKey => {
                const mm = mKey.substring(0, 2);
                const yyyy = mKey.substring(2);
                const monthRef = doc(db, 'artifacts', appId, 'public', 'data', 'RegAs2', yyyy, 'Meses', mm);
                
                const unsub = onSnapshot(monthRef, (snap) => {
                    monthsData[mKey] = snap.exists() ? snap.data() : {};
                    loadedMonths++;
                    if (loadedMonths >= uniqueMonths.length) {
                        processAndRender(sections, monthsData);
                    }
                });
                activeUnsubscribes.push(unsub);
            });
        }

        function processAndRender(sections, monthsData) {
            const dataStore = sections.map(sec => {
                const parts = sec.date.split('-');
                const monthKey = `${parts[1]}${parts[0]}`;
                const dateId = `${parts[2]}${parts[1]}${parts[0]}`;
                const dayData = monthsData[monthKey]?.[dateId] || {};
                const listRaw = dayData[sec.id] || {};
                
                const list = Object.entries(listRaw).map(([uid, data]) => {
                    const user = userDataCache[uid] || { nombre: 'Desconocido', id_empleado: '---' };
                    return {
                        uid,
                        id_empleado: user.id_empleado || '---',
                        nombre: user.nombre,
                        ...data
                    };
                });

                return { ...sec, list };
            });

            renderReport(dataStore);
        }

        function renderReport(dataStore) {
            const container = document.getElementById('tables-container');
            container.innerHTML = '';
            document.getElementById('loading-state').classList.add('hidden');

            dataStore.forEach(sec => {
                let list = sec.list;
                if (sec.id === 'ausentismo') {
                    list = list.filter(item => (item.motivo || "").toLowerCase() !== 'descanso');
                }
                if (list.length === 0) return;

                list.sort((a, b) => {
                    const indexA = casetaOrder.indexOf(a.Caseta || "");
                    const indexB = casetaOrder.indexOf(b.Caseta || "");
                    const valA = indexA === -1 ? 999 : indexA;
                    const valB = indexB === -1 ? 999 : indexB;
                    if (valA !== valB) return valA - valB;
                    return a.nombre.localeCompare(b.nombre);
                });

                const wrapper = document.createElement('div');
                wrapper.innerHTML = `
                    <div class="shift-divider">
                        <span>${sec.label}</span>
                        <span class="opacity-40">${formatHeaderDate(sec.date)}</span>
                    </div>
                    <div class="table-container">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="col-id">ID</th>
                                        <th class="col-nombre">Nombre del Elemento</th>
                                        <th class="col-estado">Estado</th>
                                        ${sec.id === 'ausentismo' ? '<th colspan="2">Motivo</th>' : '<th class="col-tiempo">Entrada</th><th class="col-tiempo">Salida</th>'}
                                        <th class="col-comentario">Observaciones</th>
                                        <th class="col-accion"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${list.map(item => renderRow(item, sec.id, sec.date)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(wrapper);
            });
        }

        function renderRow(item, type, date) {
            let statusHtml = '';
            if (type === 'ausentismo') {
                statusHtml = '<span class="badge bg-finished">Inasistencia</span>';
            } else {
                if (item.salida_real) statusHtml += '<span class="badge bg-finished">Finalizado</span>';
                else if (item.entrada_real) statusHtml += '<span class="badge bg-in-turn">En Turno</span>';
                else statusHtml += '<span class="badge bg-finished opacity-40">Pendiente</span>';
                
                if (item.retardo) statusHtml += '<span class="badge bg-late ml-1">Retardo</span>';
                if (item.es_recuperacion) statusHtml += '<span class="badge bg-special ml-1">Recup.</span>';
                if (item.es_extra) statusHtml += '<span class="badge bg-special ml-1">Extra</span>';
            }

            let timingHtml = '';
            if (type === 'ausentismo') {
                const motive = (item.motivo || "Falta").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const motiveClass = `abs-${motive.replace(/ /g, '')}`;
                timingHtml = `<td colspan="2"><span class="badge ${motiveClass}">${item.motivo ? item.motivo.toUpperCase() : 'FALTA'}</span></td>`;
            } else {
                timingHtml = `<td class="font-bold text-slate-500 font-mono text-[11px]">${item.entrada_real || '--:--'}</td><td class="font-bold text-slate-400 font-mono text-[11px]">${item.salida_real || '--:--'}</td>`;
            }

            return `
                <tr>
                    <td class="font-mono text-[11px] text-slate-400">${item.id_empleado}</td>
                    <td class="font-bold text-indigo-950 text-[13px]">${item.nombre}</td>
                    <td><div class="flex flex-wrap gap-1">${statusHtml}</div></td>
                    ${timingHtml}
                    <td class="italic text-slate-400 text-[11px] leading-snug">${item.comentario || ''}</td>
                    <td class="text-right"><button onclick="openDetail('${item.uid}', '${date}')" class="btn-detail"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></button></td>
                </tr>`;
        }

        window.openDetail = (uid, date) => {
            window.parent.postMessage({ type: 'navigateRight', url: `Detalle.html?uid=${uid}&date=${date}` }, '*');
        };

        window.openEmailModal = () => document.getElementById('email-modal').style.display = 'flex';
        window.closeEmailModal = () => document.getElementById('email-modal').style.display = 'none';

        window.setEmailPreset = (mode) => {
            if (mode === 'prueba') {
                document.getElementById('email-to').value = "proteccion.instalaciones@armur.com";
                document.getElementById('email-cc').value = "";
            } else {
                document.getElementById('email-to').value = "juan.paniagua@armur.com;jesuseduardo.gutierrez@armur.com";
                document.getElementById('email-cc').value = "josedavid.montano@armur.com;roberto.rodriguez@armur.com";
            }
        };

        window.prepareAndSend = async () => {
            const to = document.getElementById('email-to').value.trim();
            const cc = document.getElementById('email-cc').value.trim();
            const btn = document.getElementById('btn-confirm-send');

            if (!to) return;

            btn.disabled = true;
            btn.innerText = "PROCESANDO...";

            try {
                const captureArea = document.getElementById('report-content');
                const detailBtns = captureArea.querySelectorAll('.btn-detail');
                
                detailBtns.forEach(b => b.style.visibility = 'hidden');
                await new Promise(r => setTimeout(r, 200));

                const canvas = await html2canvas(captureArea, {
                    scale: 1.5,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    logging: false,
                    windowWidth: 1200,
                    onclone: (clonedDoc) => {
                        const content = clonedDoc.getElementById('report-content');
                        content.style.width = "1180px";
                        content.style.margin = "0 auto";
                        content.style.boxShadow = "none";
                        content.style.border = "1px solid #e2e8f0";
                    }
                });

                detailBtns.forEach(b => b.style.visibility = 'visible');
                const base64Image = canvas.toDataURL('image/png', 0.95).split(',')[1];
                
                const fechaStr = document.getElementById('formatted-date').innerText;
                const emailHtmlBody = `<div style="background:#f1f5f9; padding:30px; font-family: sans-serif;"><div style="max-width:1100px; margin:0 auto; background:#ffffff; border-radius:16px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.1); border:1px solid #e2e8f0;"><img src="data:image/png;base64,${base64Image}" style="width: 100%; height: auto; display: block; border: 0;" alt="Reporte" /></div></div>`;

                btn.innerText = "ENVIANDO...";
                await fetch(POWER_AUTOMATE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        to, 
                        cc, 
                        subject: `REPORTE ASISTENCIA - ${fechaStr}`,
                        body: emailHtmlBody 
                    })
                });
                
                btn.innerText = "¡ENVIADO!";
                setTimeout(() => {
                    closeEmailModal();
                    btn.disabled = false;
                    btn.innerText = "Confirmar Envío";
                }, 2000);

            } catch (err) {
                console.error(err);
                btn.disabled = false;
                btn.innerText = "ERROR - REINTENTAR";
            }
        };

        // Escuchar mensajes de cambio de fecha global si aplica
        window.addEventListener('message', (e) => {
            if (e.data.type === 'DATE_CHANGED' && e.data.date) {
                dateInput.value = e.data.date;
                loadData();
            }
        });
    </script>
</body>
</html>