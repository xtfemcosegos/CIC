<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Maestro Excel - CIC6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    <!-- Librerías para generación de Excel y Captura -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --metal-fuchsia-dark: #1a031c;
            --metal-fuchsia-mid: #4a044e;
            --metal-fuchsia-light: #701a75;
            --md-outline: #e2e8f0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        .glass-card {
            background: white;
            border-radius: 24px;
            border: 1px solid var(--md-outline);
            box-shadow: 0 10px 40px rgba(0,0,0,0.04);
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--metal-fuchsia-dark) 0%, var(--metal-fuchsia-mid) 100%);
            padding: 28px 24px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- FILTROS CONFIGURACIÓN --- */
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr) 180px; 
            gap: 20px;
            padding: 24px;
            background: #ffffff;
            border-bottom: 1px solid var(--md-outline);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .input-group label {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.08em;
            margin-left: 4px;
        }

        /* --- TOGGLE LOGICO --- */
        .logic-switch {
            width: 32px;
            height: 18px;
            background: var(--metal-fuchsia-mid);
            border-radius: 20px;
            display: flex;
            align-items: center;
            padding: 2px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            user-select: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .logic-switch.or-mode { background: #1e1b4b; }
        .logic-switch::after {
            content: 'Y';
            position: absolute;
            right: 6px;
            font-size: 8px;
            font-weight: 900;
            color: white;
            opacity: 0.8;
        }
        .logic-switch.or-mode::after {
            content: 'O';
            left: 6px;
            right: auto;
        }
        .logic-switch .dot {
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .logic-switch.or-mode .dot { transform: translateX(14px); }

        .form-control {
            background: #f1f5f9;
            border: 2px solid transparent;
            border-radius: 14px;
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 600;
            outline: none;
            transition: all 0.2s ease;
            width: 100%;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 44px;
            color: #334155;
        }

        .form-control:hover { background: #e2e8f0; }
        .form-control:focus, .form-control.active {
            background: white;
            border-color: var(--metal-fuchsia-mid);
            box-shadow: 0 4px 15px rgba(74, 4, 78, 0.08);
        }

        /* --- CUSTOM COMBOBOX --- */
        .combobox-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--md-outline);
            border-radius: 18px;
            margin-top: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            z-index: 100;
            display: none;
            max-height: 260px;
            overflow-y: auto;
            padding: 10px;
        }

        .combobox-dropdown.show { display: block; animation: fadeInScale 0.2s ease-out; }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-8px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid #f1f5f9;
        }

        .btn-toggle-all {
            background: white;
            color: var(--metal-fuchsia-mid);
            font-size: 8px;
            font-weight: 900;
            text-transform: uppercase;
            padding: 6px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.05em;
            border: 1px solid var(--md-outline);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .btn-toggle-all:hover {
            background: var(--metal-fuchsia-mid);
            color: white;
            border-color: var(--metal-fuchsia-mid);
            transform: translateY(-1px);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.2s;
            color: #475569;
        }

        .dropdown-item:hover { background: #fdf2f8; color: var(--metal-fuchsia-mid); }
        .dropdown-item input { accent-color: var(--metal-fuchsia-mid); width: 16px; height: 16px; }

        /* --- TABLA DE RESULTADOS --- */
        .results-container {
            padding: 0;
            overflow-x: auto;
            max-height: calc(100vh - 420px);
            min-height: 200px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            min-width: 1300px;
        }

        thead { position: sticky; top: 0; z-index: 10; }

        th {
            background: #f8fafc;
            padding: 16px 14px;
            text-align: left;
            font-weight: 800;
            text-transform: uppercase;
            color: #64748b;
            border-bottom: 2px solid #f1f5f9;
            font-size: 10px;
            letter-spacing: 0.08em;
        }

        td { padding: 14px; border-bottom: 1px solid #f1f5f9; color: #334155; font-weight: 500; }
        tr:hover td { background-color: #fdf4ff; }

        /* --- BOTONES PRINCIPALES --- */
        .btn-search {
            background: var(--metal-fuchsia-mid);
            color: white;
            font-weight: 800;
            text-transform: uppercase;
            padding: 10px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(74, 4, 78, 0.25);
            height: 54px;
            flex-shrink: 0;
        }
        .btn-search:hover { transform: translateY(-2px); background: var(--metal-fuchsia-dark); box-shadow: 0 12px 24px rgba(74, 4, 78, 0.35); }
        .btn-search:active { transform: translateY(0); }

        .btn-secondary-action {
            padding: 10px 4px;
            border-radius: 14px;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-export-style { background: #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
        .btn-export-style:hover { background: #059669; transform: translateY(-2px); }

        .btn-email-style { background: var(--metal-fuchsia-dark); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .btn-email-style:hover { background: var(--metal-fuchsia-mid); transform: translateY(-2px); }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(26, 3, 28, 0.6); backdrop-filter: blur(8px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; border-radius: 28px; width: 90%; max-width: 440px;
            padding: 36px; box-shadow: 0 30px 60px -12px rgba(0,0,0,0.45);
        }

        /* --- BADGES --- */
        .badge { font-size: 9px; font-weight: 800; padding: 3px 10px; border-radius: 8px; text-transform: uppercase; }
        .bg-mat { background: #fef9c3; color: #854d0e; }
        .bg-ves { background: #dbeafe; color: #1e40af; }
        .bg-noc { background: #1e1b4b; color: white; }
        .bg-aus { background: #f1f5f9; color: #475569; }

        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.85);
            backdrop-filter: blur(6px); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="no-scrollbar">

    <div id="loading-overlay">
        <div class="w-14 h-14 border-4 border-fuchsia-200 border-t-fuchsia-700 rounded-full animate-spin"></div>
        <p class="text-[10px] font-black uppercase mt-5 tracking-[0.2em] text-fuchsia-950">Optimizando Reporte...</p>
        <span id="load-progress" class="text-[10px] font-bold text-slate-400 mt-2">0%</span>
    </div>

    <!-- Modal de Envío de Correo -->
    <div id="email-modal" class="modal-overlay">
        <div class="modal-content space-y-8">
            <div class="text-center">
                <div class="w-14 h-14 bg-fuchsia-100 text-fuchsia-700 rounded-2xl flex items-center justify-center mx-auto mb-5 rotate-3 shadow-lg shadow-fuchsia-100">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </div>
                <h3 class="text-xl font-black uppercase text-slate-900 tracking-tight">Consolidado Digital</h3>
                <p class="text-[10px] font-bold text-slate-400 uppercase mt-2 tracking-widest">Motor de Distribución • CIC-6</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="setEmailPreset('prueba')" class="flex-1 py-2.5 px-4 bg-slate-100 hover:bg-slate-200 rounded-xl text-[10px] font-black uppercase text-slate-600 transition-all border border-slate-200">Prueba</button>
                <button onclick="setEmailPreset('default')" class="flex-1 py-2.5 px-4 bg-fuchsia-50 hover:bg-fuchsia-100 rounded-xl text-[10px] font-black uppercase text-fuchsia-900 transition-all border border-fuchsia-100">Oficial</button>
            </div>

            <div class="space-y-5">
                <div class="input-group">
                    <label>Para:</label>
                    <input type="text" id="email-to" class="w-full bg-slate-50 border-2 border-slate-100 focus:border-fuchsia-600 rounded-xl px-4 py-3.5 text-[13px] font-semibold outline-none transition-all" placeholder="destinatarios@ejemplo.com">
                </div>
                <div class="input-group">
                    <label>Copia (CC):</label>
                    <input type="text" id="email-cc" class="w-full bg-slate-50 border-2 border-slate-100 focus:border-fuchsia-600 rounded-xl px-4 py-3.5 text-[13px] font-semibold outline-none transition-all" placeholder="cc@ejemplo.com">
                </div>
            </div>

            <div class="flex gap-4 pt-4">
                <button onclick="closeEmailModal()" class="flex-1 py-3 text-[11px] font-black uppercase text-slate-400 hover:text-slate-600 transition-colors">Cancelar</button>
                <button id="btn-confirm-send" onclick="prepareAndSend()" class="flex-[2] bg-slate-900 text-white rounded-2xl py-3.5 text-[11px] font-black uppercase shadow-xl active:scale-95 transition-all">Enviar Reporte</button>
            </div>
        </div>
    </div>

    <div class="glass-card">
        <header class="panel-header">
            <div>
                <h1 class="text-2xl font-black uppercase tracking-tighter">Reporte Maestro de Operaciones</h1>
                <p class="text-[11px] font-bold text-fuchsia-200/50 uppercase tracking-[0.2em] mt-1.5">Inteligencia de Datos • Control de Asistencia</p>
            </div>
        </header>

        <div class="filter-grid" id="filter-panel">
            <div class="input-group">
                <label>Periodo Sugerido</label>
                <select id="filter-preset" class="form-control" onchange="applyDatePreset(this.value)">
                    <option value="custom">PERSONALIZADO</option>
                    <option value="curr_week">ESTA SEMANA</option>
                    <option value="last_week">SEMANA PASADA</option>
                    <option value="curr_month">ESTE MES</option>
                    <option value="last_month">MES PASADO</option>
                </select>
            </div>
            <div class="input-group">
                <label>Desde</label>
                <input type="date" id="filter-start" class="form-control">
            </div>
            <div class="input-group">
                <label>Hasta</label>
                <input type="date" id="filter-end" class="form-control">
            </div>
            <div class="input-group">
                <label>Turnos Operativos</label>
                <div class="form-control" onclick="toggleDropdown('shift-dropdown')">
                    <span id="shift-label" class="truncate">Todos</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <div id="shift-dropdown" class="combobox-dropdown no-scrollbar">
                    <div class="dropdown-header">
                        <span class="text-[9px] font-black uppercase text-slate-400 tracking-wider">Turnos Base</span>
                        <span class="btn-toggle-all" onclick="toggleAll('shift', event)">Alternar</span>
                    </div>
                    <div id="shift-options">
                        <label class="dropdown-item"><input type="checkbox" class="shift-checkbox" value="matutino" checked onchange="handleShiftChange()"> MATUTINO</label>
                        <label class="dropdown-item"><input type="checkbox" class="shift-checkbox" value="vespertino" checked onchange="handleShiftChange()"> VESPERTINO</label>
                        <label class="dropdown-item"><input type="checkbox" class="shift-checkbox" value="nocturno" checked onchange="handleShiftChange()"> NOCTURNO</label>
                    </div>
                </div>
            </div>

            <div class="input-group row-span-2 flex flex-col gap-3">
                <button onclick="runQuery()" class="btn-search w-full">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    <span class="text-[11px] tracking-widest font-black uppercase">Filtrar</span>
                </button>
                <div class="grid grid-cols-2 gap-3 flex-grow">
                    <button onclick="openEmailModal()" class="btn-secondary-action btn-email-style">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                        <span>E-Mail</span>
                    </button>
                    <button onclick="exportToExcel()" class="btn-secondary-action btn-export-style">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                        <span>Excel</span>
                    </button>
                </div>
            </div>

            <div class="input-group">
                <label>Elementos</label>
                <div class="form-control" onclick="toggleDropdown('user-dropdown')">
                    <span id="user-label" class="truncate">Cargando...</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <div id="user-dropdown" class="combobox-dropdown no-scrollbar">
                    <div class="dropdown-header">
                        <span class="text-[9px] font-black uppercase text-slate-400 tracking-wider">Personal</span>
                        <span class="btn-toggle-all" onclick="toggleAll('user', event)">Alternar</span>
                    </div>
                    <div id="user-options"></div>
                </div>
            </div>

            <div class="input-group">
                <div class="flex justify-between items-center pr-1">
                    <label>Zonas / Casetas</label>
                    <div id="op-caseta" onclick="toggleLogic('caseta')" class="logic-switch" title="Operador lógico">
                        <div class="dot"></div>
                    </div>
                </div>
                <div class="form-control" onclick="toggleDropdown('caseta-dropdown')">
                    <span id="caseta-label" class="truncate">Todas</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <div id="caseta-dropdown" class="combobox-dropdown no-scrollbar">
                    <div class="dropdown-header">
                        <span class="text-[9px] font-black uppercase text-slate-400 tracking-wider">Ubicaciones</span>
                        <span class="btn-toggle-all" onclick="toggleAll('caseta', event)">Alternar</span>
                    </div>
                    <div id="caseta-options"></div>
                </div>
            </div>

            <div class="input-group">
                <div class="flex justify-between items-center pr-1">
                    <label>Motivos</label>
                    <div id="op-motive" onclick="toggleLogic('motive')" class="logic-switch" title="Operador lógico">
                        <div class="dot"></div>
                    </div>
                </div>
                <div class="form-control" onclick="toggleDropdown('motive-dropdown')">
                    <span id="motive-label" class="truncate">Todos</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <div id="motive-dropdown" class="combobox-dropdown no-scrollbar">
                    <div class="dropdown-header">
                        <span class="text-[9px] font-black uppercase text-slate-400 tracking-wider">Ausentismos</span>
                        <span class="btn-toggle-all" onclick="toggleAll('motive', event)">Alternar</span>
                    </div>
                    <div id="motive-options">
                        <label class="dropdown-item"><input type="checkbox" class="motive-checkbox" value="Descanso" checked onchange="handleMotiveChange()"> DESCANSO</label>
                        <label class="dropdown-item"><input type="checkbox" class="motive-checkbox" value="Vacaciones" checked onchange="handleMotiveChange()"> VACACIONES</label>
                        <label class="dropdown-item"><input type="checkbox" class="motive-checkbox" value="Falta" checked onchange="handleMotiveChange()"> FALTA</label>
                        <label class="dropdown-item"><input type="checkbox" class="motive-checkbox" value="Incapacidad" checked onchange="handleMotiveChange()"> INCAPACIDAD</label>
                        <label class="dropdown-item"><input type="checkbox" class="motive-checkbox" value="Suspendido" checked onchange="handleMotiveChange()"> SUSPENDIDO</label>
                        <label class="dropdown-item"><input type="checkbox" class="motive-checkbox" value="Permiso" checked onchange="updateLabels()"> PERMISO</label>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <div class="flex justify-between items-center pr-1">
                    <label>Incidencias</label>
                    <div id="op-incidence" onclick="toggleLogic('incidence')" class="logic-switch" title="Operador lógico">
                        <div class="dot"></div>
                    </div>
                </div>
                <div class="form-control" onclick="toggleDropdown('incidence-dropdown')">
                    <span id="incidence-label" class="truncate">Cualquiera</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                </div>
                <div id="incidence-dropdown" class="combobox-dropdown no-scrollbar">
                    <div class="dropdown-header">
                        <span class="text-[9px] font-black uppercase text-slate-400 tracking-wider">Alertas</span>
                        <span class="btn-toggle-all" onclick="toggleAll('incidence', event)">Alternar</span>
                    </div>
                    <div id="incidence-options">
                        <label class="dropdown-item"><input type="checkbox" class="incidence-checkbox" value="retardo" checked onchange="updateLabels()"> RETARDOS</label>
                        <label class="dropdown-item"><input type="checkbox" class="incidence-checkbox" value="es_extra" checked onchange="updateLabels()"> TIEMPO EXTRA</label>
                        <label class="dropdown-item"><input type="checkbox" class="incidence-checkbox" value="es_recuperacion" checked onchange="updateLabels()"> RECUPERACIONES</label>
                        <label class="dropdown-item"><input type="checkbox" class="incidence-checkbox" value="es_festivo" checked onchange="updateLabels()"> FESTIVOS</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="capture-area">
            <div class="results-container no-scrollbar">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th style="width: 100px;">Fecha</th>
                            <th style="width: 80px;">ID</th>
                            <th style="width: 250px;">Nombre del Elemento</th>
                            <th style="width: 110px;">Turno</th>
                            <th style="width: 220px;">Caseta / Motivo</th>
                            <th style="width: 80px;">Entrada</th>
                            <th style="width: 80px;">Salida</th>
                            <th style="width: 150px;">Incidencias</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr>
                            <td colspan="9" class="text-center py-24 text-slate-300 font-bold uppercase tracking-[0.3em]">Configure filtros y ejecute consulta</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="px-6 py-4 bg-slate-50 border-t flex justify-between items-center">
            <span id="results-count" class="text-[10px] font-black text-slate-400 uppercase tracking-widest">0 Registros encontrados</span>
            <span class="text-[10px] font-bold text-slate-300 uppercase tracking-[0.2em]">CIC-6 Analytics v4.3</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU", authDomain: "cic6-pp-web.firebaseapp.com", projectId: "cic6-pp-web", appId: "1:248659087868:web:a277ef700d83c7f1d22279" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'cic.pp';

        const POWER_AUTOMATE_API = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/507bea91c30c4743b4749a474f92ad3f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=PzEbbL5wNoHu-b78wQtE7JP0H-RKDb3btp2iHGbM6vU";

        const casetasOrden = ["Centro de control", "Encargado", "Edison", "Recepción Edison", "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero"];
        let usersMap = {};
        let rawResults = [];
        let filterLogic = { caseta: 'AND', motive: 'AND', incidence: 'AND' };

        onAuthStateChanged(auth, async (user) => {
            if (user) { await loadInitialData(); } else signInAnonymously(auth);
        });

        async function loadInitialData() {
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios'));
            const userOptions = document.getElementById('user-options');
            snap.forEach(d => {
                const u = d.data();
                if ((u.status || "").toLowerCase() === 'baja') return;
                usersMap[d.id] = u;
                const label = document.createElement('label');
                label.className = "dropdown-item";
                label.innerHTML = `<input type="checkbox" class="user-checkbox" value="${d.id}" checked onchange="updateLabels()"> ${u.nombre.toUpperCase()}`;
                userOptions.appendChild(label);
            });

            const casetaOptions = document.getElementById('caseta-options');
            casetasOrden.forEach(c => {
                const label = document.createElement('label');
                label.className = "dropdown-item";
                label.innerHTML = `<input type="checkbox" class="caseta-checkbox" value="${c}" checked onchange="updateLabels()"> ${c.toUpperCase()}`;
                casetaOptions.appendChild(label);
            });

            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('filter-start').value = firstDay.toISOString().split('T')[0];
            document.getElementById('filter-end').value = today.toISOString().split('T')[0];
            updateLabels();
        }

        window.toggleLogic = (key) => {
            const el = document.getElementById(`op-${key}`);
            filterLogic[key] = filterLogic[key] === 'AND' ? 'OR' : 'AND';
            el.classList.toggle('or-mode', filterLogic[key] === 'OR');
        };

        window.toggleDropdown = (id) => {
            const dropdowns = document.querySelectorAll('.combobox-dropdown');
            dropdowns.forEach(d => { if(d.id !== id) d.classList.remove('show'); });
            document.getElementById(id).classList.toggle('show');
        };

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-group')) {
                document.querySelectorAll('.combobox-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        window.toggleAll = (type, event) => {
            if(event) event.stopPropagation();
            const checks = document.querySelectorAll(`.${type}-checkbox`);
            const allChecked = Array.from(checks).every(c => c.checked);
            checks.forEach(c => c.checked = !allChecked);
            
            if(type === 'shift' && !allChecked) handleShiftChange();
            if(type === 'motive' && !allChecked) handleMotiveChange();
            
            updateLabels();
        };

        window.handleMotiveChange = () => {
            const motiveChecks = document.querySelectorAll('.motive-checkbox');
            const shiftChecks = document.querySelectorAll('.shift-checkbox');
            const allMotivesChecked = Array.from(motiveChecks).every(c => c.checked);
            
            if (!allMotivesChecked) {
                shiftChecks.forEach(c => c.checked = false);
            }
            updateLabels();
        };

        window.handleShiftChange = () => {
            const shiftChecks = document.querySelectorAll('.shift-checkbox');
            const motiveChecks = document.querySelectorAll('.motive-checkbox');
            const allShiftsChecked = Array.from(shiftChecks).every(c => c.checked);
            
            if (!allShiftsChecked) {
                motiveChecks.forEach(c => c.checked = false);
            }
            updateLabels();
        };

        window.updateLabels = () => {
            const types = ['user', 'caseta', 'motive', 'incidence', 'shift'];
            types.forEach(t => {
                const total = document.querySelectorAll(`.${t}-checkbox`).length;
                const checked = document.querySelectorAll(`.${t}-checkbox:checked`).length;
                const el = document.getElementById(`${t}-label`);
                if(!el) return;
                if (checked === 0) el.innerText = "Ninguno";
                else if (checked === total) el.innerText = (t === 'incidence' ? "Cualquiera" : "Todos");
                else el.innerText = `${checked} Seleccionados`;
            });
        };

        window.applyDatePreset = (preset) => {
            const now = new Date();
            let start = new Date(), end = new Date();
            switch(preset) {
                case 'curr_week':
                    const day = now.getDay();
                    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                    start = new Date(new Date().setDate(diff)); end = new Date();
                    break;
                case 'last_week':
                    const pm = new Date(); pm.setDate(now.getDate() - (now.getDay() || 7) - 6);
                    const ps = new Date(); ps.setDate(now.getDate() - (now.getDay() || 7));
                    start = pm; end = ps;
                    break;
                case 'curr_month':
                    start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date();
                    break;
                case 'last_month':
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
            }
            document.getElementById('filter-start').value = start.toISOString().split('T')[0];
            document.getElementById('filter-end').value = end.toISOString().split('T')[0];
        };

        window.runQuery = async () => {
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;

            const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(c => c.value);
            const selectedCasetas = Array.from(document.querySelectorAll('.caseta-checkbox:checked')).map(c => c.value);
            const selectedMotives = Array.from(document.querySelectorAll('.motive-checkbox:checked')).map(c => c.value);
            const selectedIncidences = Array.from(document.querySelectorAll('.incidence-checkbox:checked')).map(c => c.value);
            const selectedShifts = Array.from(document.querySelectorAll('.shift-checkbox:checked')).map(c => c.value);

            const allUsersChecked = selectedUsers.length === document.querySelectorAll('.user-checkbox').length;
            const allCasetasChecked = selectedCasetas.length === document.querySelectorAll('.caseta-checkbox').length;
            const allMotivesChecked = selectedMotives.length === document.querySelectorAll('.motive-checkbox').length;
            const allIncChecked = selectedIncidences.length === document.querySelectorAll('.incidence-checkbox').length;

            if (!start || !end) return;

            const overlay = document.getElementById('loading-overlay');
            const progress = document.getElementById('load-progress');
            overlay.style.display = 'flex';

            const startDate = new Date(start + "T00:00:00");
            const endDate = new Date(end + "T00:00:00");
            const diffDays = Math.ceil(Math.abs(endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            rawResults = [];
            let processed = 0;

            const applyOp = (current, op, condition) => op === 'AND' ? (current && condition) : (current || condition);

            // DETECTOR DE FILTRADO ACTIVO POR CATEGORÍA
            const isFilteringMotive = filterLogic.motive === 'AND' && !allMotivesChecked;
            const isFilteringIncidence = filterLogic.incidence === 'AND' && !allIncChecked;

            for (let i = 0; i < diffDays; i++) {
                const currentDateObj = new Date(startDate);
                currentDateObj.setDate(startDate.getDate() + i);
                const dateId = currentDateObj.getDate().toString().padStart(2, '0') + (currentDateObj.getMonth() + 1).toString().padStart(2, '0') + currentDateObj.getFullYear();
                const displayDate = currentDateObj.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });

                // Turnos a buscar: Todos los marcados + Ausentismo (si hay motivos seleccionados)
                let shiftsToSearch = [...selectedShifts];
                if (selectedMotives.length > 0 || allMotivesChecked) shiftsToSearch.push('ausentismo');
                
                if (shiftsToSearch.length === 0) {
                    processed = diffDays;
                    break;
                }

                for (const s of shiftsToSearch) {
                    const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, s));
                    snap.forEach(docSnap => {
                        const d = docSnap.data();
                        const uid = docSnap.id;
                        const user = usersMap[uid] || { nombre: '---', id_empleado: '---', acceso_predeterminado: '---' };

                        const isUserMatch = allUsersChecked || selectedUsers.includes(uid);
                        const casetaBase = (d.Caseta || user.acceso_predeterminado || '---');
                        const isCasetaMatch = allCasetasChecked || selectedCasetas.includes(casetaBase);

                        // Filtro de Categoría Inteligente (Solución al conflicto de combinación)
                        let passCategory = true;
                        
                        const isMotiveMatch = allMotivesChecked || selectedMotives.includes(d.motivo);
                        const isIncMatch = allIncChecked || (
                            (selectedIncidences.includes('retardo') && d.retardo) ||
                            (selectedIncidences.includes('es_extra') && d.es_extra) ||
                            (selectedIncidences.includes('es_recuperacion') && d.es_recuperacion) ||
                            (selectedIncidences.includes('es_festivo') && d.es_festivo)
                        );

                        if (s === 'ausentismo') {
                            // Si estoy en ausentismo, mi pase depende de si coincido con el motivo buscado
                            if (isFilteringMotive) passCategory = isMotiveMatch;
                            
                            // Si SOLO estamos buscando incidencias específicas (AND) y NO estamos buscando motivos,
                            // entonces este ausentismo debe ocultarse. Pero si buscamos ambos, mostramos los que coincidan con motivo.
                            if (isFilteringIncidence && !isFilteringMotive) passCategory = false;
                        } else {
                            // Si estoy en un turno normal, mi pase depende de si coincido con la incidencia buscada
                            if (isFilteringIncidence) passCategory = isIncMatch;

                            // Si SOLO estamos buscando motivos específicos (AND) y NO estamos buscando incidencias,
                            // entonces este registro normal debe ocultarse.
                            if (isFilteringMotive && !isFilteringIncidence) passCategory = false;
                        }

                        // El resultado final requiere que el Usuario y la Caseta coincidan, 
                        // Y que pase el filtro de su respectiva categoría
                        const matchesFinal = isUserMatch && isCasetaMatch && passCategory;

                        if (!matchesFinal) return;

                        let lugarDisplay = casetaBase.toUpperCase();
                        if (s === 'ausentismo') {
                            const motivo = (d.motivo || 'AUS').toUpperCase();
                            lugarDisplay = `${lugarDisplay} • ${motivo}`;
                        }

                        rawResults.push({
                            fecha: displayDate, id: user.id_empleado || '---', nombre: user.nombre,
                            turno: s.toUpperCase(), lugar: lugarDisplay,
                            entrada: d.entrada_real || '--:--', salida: d.salida_real || '--:--',
                            incidencias: formatIncidences(d, s), nota: d.comentario || ''
                        });
                    });
                }
                processed++;
                progress.innerText = Math.round((processed / diffDays) * 100) + "%";
            }

            renderTable();
            overlay.style.display = 'none';
        };

        function formatIncidences(d, s) {
            let res = [];
            if (d.es_extra) res.push("EXTRA");
            if (d.es_recuperacion) res.push("RECUP");
            if (d.retardo) res.push("RETARDO");
            if (d.es_festivo) res.push("FESTIVO");
            if (s === 'ausentismo') res.push("AUSENCIA");
            return res.join(", ");
        }

        function renderTable() {
            const body = document.getElementById('table-body');
            document.getElementById('results-count').innerText = `${rawResults.length} Registros encontrados`;
            body.innerHTML = '';
            if (rawResults.length === 0) {
                body.innerHTML = '<tr><td colspan="9" class="text-center py-20 text-slate-300 font-bold uppercase tracking-widest">No se encontraron coincidencias</td></tr>';
                return;
            }
            rawResults.forEach(r => {
                const tr = document.createElement('tr');
                const shiftClass = r.turno === 'MATUTINO' ? 'bg-mat' : r.turno === 'VESPERTINO' ? 'bg-ves' : r.turno === 'NOCTURNO' ? 'bg-noc' : 'bg-aus';
                tr.innerHTML = `
                    <td class="font-bold text-slate-400">${r.fecha}</td>
                    <td class="font-mono text-slate-400">${r.id}</td>
                    <td class="font-bold text-indigo-950">${r.nombre.toUpperCase()}</td>
                    <td><span class="badge ${shiftClass}">${r.turno}</span></td>
                    <td class="font-black text-slate-600 text-[11px] leading-tight">${r.lugar}</td>
                    <td class="font-mono font-bold">${r.entrada}</td>
                    <td class="font-mono font-bold">${r.salida}</td>
                    <td class="font-black text-red-600">${r.incidencias}</td>
                    <td class="italic text-slate-400 text-[11px] leading-tight">${r.nota}</td>
                `;
                body.appendChild(tr);
            });
        }

        window.exportToExcel = () => {
            if (rawResults.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(rawResults.map(r => ({ 'FECHA': r.fecha, 'ID': r.id, 'NOMBRE': r.nombre, 'TURNO': r.turno, 'CASETA / MOTIVO': r.lugar, 'ENTRADA': r.entrada, 'SALIDA': r.salida, 'INCIDENCIAS': r.incidencias, 'OBSERVACIONES': r.nota })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Asistencia");
            ws['!cols'] = [{wch: 15}, {wch: 10}, {wch: 40}, {wch: 15}, {wch: 35}, {wch: 10}, {wch: 10}, {wch: 20}, {wch: 50}];
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            XLSX.writeFile(wb, `REPORTE_ASISTENCIA_${start}_${end}.xlsx`);
        };

        window.openEmailModal = () => document.getElementById('email-modal').style.display = 'flex';
        window.closeEmailModal = () => document.getElementById('email-modal').style.display = 'none';

        window.setEmailPreset = (mode) => {
            if (mode === 'prueba') {
                document.getElementById('email-to').value = "proteccion.instalaciones@armur.com";
                document.getElementById('email-cc').value = "";
            } else {
                document.getElementById('email-to').value = "juan.paniagua@armur.com;jesuseduardo.gutierrez@armur.com";
                document.getElementById('email-cc').value = "josedavid.montano@armur.com;roberto.rodriguez@armur.com";
            }
        };

        window.prepareAndSend = async () => {
            const to = document.getElementById('email-to').value.trim();
            const cc = document.getElementById('email-cc').value.trim();
            const btn = document.getElementById('btn-confirm-send');
            if (!to) return;
            if (rawResults.length === 0) return;
            btn.disabled = true; btn.innerText = "CAPTURANDO...";
            try {
                const captureArea = document.getElementById('capture-area');
                const canvas = await html2canvas(captureArea, {
                    scale: 2.0, 
                    backgroundColor: '#ffffff', 
                    useCORS: true, 
                    logging: false,
                    onclone: (clonedDoc) => {
                        const resultsCont = clonedDoc.querySelector('.results-container');
                        if (resultsCont) {
                            resultsCont.style.maxHeight = 'none';
                            resultsCont.style.height = 'auto';
                            resultsCont.style.overflow = 'visible';
                        }
                    }
                });
                
                const base64Image = canvas.toDataURL('image/png', 1.0).split(',')[1];
                const start = document.getElementById('filter-start').value;
                const end = document.getElementById('filter-end').value;
                btn.innerText = "ENVIANDO...";
                await fetch(POWER_AUTOMATE_API, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, cc, subject: `CONSOLIDADO ASISTENCIA - ${start} AL ${end}`, body: `<div style="background:#f1f5f9; padding:20px; font-family:sans-serif;"><div style="max-width:1200px; margin:0 auto; background:white; padding:15px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);"><p style="font-size:12px; color:#64748b; margin-bottom:15px; text-transform:uppercase; font-weight:bold;">Reporte de asistencias e incidencias - CIC-6</p><img src="data:image/png;base64,${base64Image}" style="width: 100%; border-radius: 8px;" /></div></div>` })
                });
                btn.innerText = "¡ENVIADO!";
                setTimeout(() => { closeEmailModal(); btn.disabled = false; btn.innerText = "Confirmar Envío"; }, 2000);
            } catch (err) { console.error(err); btn.disabled = false; btn.innerText = "ERROR"; }
        };
    </script>
</body>
</html>