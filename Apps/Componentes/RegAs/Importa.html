<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Datos - RegAs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Librería para procesamiento de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --md-primary: #450a0a;
            --md-surface: #fdf8f8;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: white; color: #1e293b; }
        
        .tab-btn {
            flex: 1; padding: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.1em; border-bottom: 3px solid transparent; transition: all 0.2s;
            color: #94a3b8;
        }
        .tab-btn.active { color: var(--md-primary); border-bottom-color: var(--md-primary); }

        .drop-zone {
            border: 2px dashed #e2e8f0;
            border-radius: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f8fafc;
        }
        .drop-zone.drag-over { border-color: var(--md-primary); background: #fff1f2; transform: scale(0.99); }

        .action-card {
            border: 1px solid #f1f5f9; border-radius: 20px; padding: 16px;
            transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 16px;
        }
        .action-card:hover { border-color: var(--md-primary); background: #fdf8f8; transform: translateX(4px); }

        .loader {
            width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid var(--md-primary);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .log-container::-webkit-scrollbar { width: 4px; }
        .log-container::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="p-6">

    <!-- Navegación de Pestañas -->
    <div class="flex border-b border-slate-100 mb-6">
        <button onclick="switchMode('import')" id="tab-import" class="tab-btn active">Importar Datos</button>
        <button onclick="switchMode('export')" id="tab-export" class="tab-btn">Exportar / Backup</button>
    </div>

    <!-- SECCIÓN IMPORTAR -->
    <div id="section-import" class="space-y-6">
        <div class="text-center">
            <h2 class="text-lg font-extrabold text-slate-800 uppercase tracking-tight leading-tight">Carga de Información</h2>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Soporta formatos Excel (.xlsx) y JSON</p>
        </div>

        <div id="drop-zone" class="drop-zone p-10 text-center cursor-pointer hover:bg-slate-50 transition-colors">
            <div class="flex flex-col items-center gap-4">
                <div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center text-red-900">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <div class="space-y-1">
                    <p class="text-xs font-black text-slate-700 uppercase">Seleccionar archivo para importar</p>
                    <p class="text-[10px] font-bold text-slate-400">Arrastra aquí o haz clic para explorar</p>
                </div>
            </div>
            <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls, .json">
        </div>

        <div class="bg-amber-50 border border-amber-100 rounded-2xl p-4">
            <h4 class="text-[10px] font-black text-amber-800 uppercase tracking-wider mb-2">Nota Técnica:</h4>
            <p class="text-[9px] font-bold text-amber-700/80">Si importas un Excel, asegúrate de que la hoja principal se llame "RegAs". El sistema sobrescribirá las asignaciones existentes para las fechas y empleados indicados.</p>
        </div>
    </div>

    <!-- SECCIÓN EXPORTAR -->
    <div id="section-export" class="hidden space-y-4">
        <div class="text-center mb-6">
            <h2 class="text-lg font-extrabold text-slate-800 uppercase tracking-tight leading-tight">Gestión de Salida</h2>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Descarga y respaldo de información</p>
        </div>

        <div onclick="exportMasterExcel()" class="action-card">
            <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            </div>
            <div class="flex-grow">
                <h4 class="text-xs font-black text-slate-800 uppercase tracking-tight">Exportar Todo a Excel</h4>
                <p class="text-[9px] font-bold text-slate-400 uppercase">Genera un reporte consolidado de toda la historia</p>
            </div>
        </div>

        <div onclick="exportDatabaseJSON()" class="action-card">
            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="16 16 12 12 8 16"/></svg>
            </div>
            <div class="flex-grow">
                <h4 class="text-xs font-black text-slate-800 uppercase tracking-tight">Respaldar Base de Datos (JSON)</h4>
                <p class="text-[9px] font-bold text-slate-400 uppercase">Copia de seguridad completa para restauración</p>
            </div>
        </div>

        <div onclick="downloadTemplate()" class="action-card">
            <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            </div>
            <div class="flex-grow">
                <h4 class="text-xs font-black text-slate-800 uppercase tracking-tight">Descargar Plantilla</h4>
                <p class="text-[9px] font-bold text-slate-400 uppercase">Formato Excel listo para llenar planeación</p>
            </div>
        </div>
    </div>

    <!-- PANTALLA DE PROCESAMIENTO -->
    <div id="step-processing" class="hidden space-y-6 animate-in fade-in zoom-in duration-300">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="loader" id="main-loader"></div>
                <div>
                    <h2 id="status-title" class="text-sm font-black text-slate-800 uppercase">Trabajando...</h2>
                    <p id="progress-text" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Sincronizando flujos de datos</p>
                </div>
            </div>
            <span id="percentage-text" class="text-xl font-black text-red-900">0%</span>
        </div>

        <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
            <div id="progress-bar" class="bg-red-900 h-full w-0 transition-all duration-300"></div>
        </div>

        <div class="card bg-slate-50 border border-slate-100 rounded-2xl p-4 overflow-hidden">
            <div id="log-container" class="log-container h-48 overflow-y-auto space-y-2 pr-2">
                <!-- Logs dinámicos -->
            </div>
        </div>

        <button id="btn-finish" onclick="location.reload()" class="hidden w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-lg shadow-slate-900/20 active:scale-95 transition-all">
            Nueva Tarea
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            messagingSenderId: "248659087868",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'cic.pp';

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const logContainer = document.getElementById('log-container');
        
        let idEmpleadoToUidMap = new Map();
        let userDataCache = {};

        onAuthStateChanged(auth, (user) => {
            if (!user) signInAnonymously(auth);
        });

        // --- NAVEGACIÓN ---
        window.switchMode = (mode) => {
            document.getElementById('section-import').classList.toggle('hidden', mode !== 'import');
            document.getElementById('section-export').classList.toggle('hidden', mode !== 'export');
            document.getElementById('tab-import').classList.toggle('active', mode === 'import');
            document.getElementById('tab-export').classList.toggle('active', mode === 'export');
        };

        // --- IMPORTACIÓN ---
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        };
        fileInput.onchange = (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        };

        async function handleFile(file) {
            document.getElementById('section-import').classList.add('hidden');
            document.getElementById('section-export').classList.add('hidden');
            document.getElementById('step-processing').classList.remove('hidden');

            const isJSON = file.name.endsWith('.json');
            await buildUserMap();

            const reader = new FileReader();
            reader.onload = async (e) => {
                if (isJSON) {
                    await processJSONImport(JSON.parse(e.target.result));
                } else {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheet = workbook.Sheets["RegAs"];
                    if (!sheet) { addLog("Error: No se encontró la hoja 'RegAs'.", "error"); finish(true); return; }
                    await processExcelRows(XLSX.utils.sheet_to_json(sheet));
                }
            };
            if (isJSON) reader.readAsText(file);
            else reader.readAsArrayBuffer(file);
        }

        async function buildUserMap() {
            addLog("Mapeando identidades de la base de datos...", "info");
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios'));
            snap.forEach(d => {
                const u = d.data();
                userDataCache[d.id] = u;
                const opId = u.id || u.id_empleado;
                if (opId) idEmpleadoToUidMap.set(String(opId).trim(), d.id);
            });
        }

        async function processExcelRows(rows) {
            const total = rows.length;
            addLog(`Importando ${total} registros desde Excel...`, "success");

            for (let i = 0; i < total; i++) {
                updateProgress(i + 1, total, rows[i]["Nombre"]);
                try { await processSingleExcelRow(rows[i]); }
                catch (err) { addLog(`Error en fila ${i+1}: ${err.message}`, "error"); }
            }
            finish();
        }

        async function processSingleExcelRow(row) {
            const uid = idEmpleadoToUidMap.get(String(row["ID"] || "").trim());
            if (!uid) throw new Error("ID no reconocido");

            let dateId = "";
            const rawFecha = row["Fecha"];
            if (rawFecha instanceof Date) {
                dateId = rawFecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '');
            } else if (typeof rawFecha === 'string') {
                const parts = rawFecha.split(/[-/]/);
                dateId = parts[0].length === 4 ? parts[2]+parts[1]+parts[0] : parts[0].padStart(2,'0')+parts[1].padStart(2,'0')+parts[2];
            } else throw new Error("Fecha inválida");

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId), {}, { merge: true });
            const shifts = ['matutino', 'vespertino', 'nocturno', 'ausentismo'];
            for (const s of shifts) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, s, uid));

            const isAus = String(row["Ausentismo"] || "").toLowerCase();
            if (isAus === 'si' || isAus === 'sí' || row["Motivo"]) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, 'ausentismo', uid), { Ausentismo: true, motivo: row["Motivo"] || "Descanso" });
                return;
            }

            const processShift = async (suffix) => {
                const tName = String(row[`Turno${suffix}`] || "").toLowerCase().trim();
                if (!['matutino', 'vespertino', 'nocturno'].includes(tName)) return;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, tName, uid), {
                    Caseta: row[`Caseta${suffix}`] || "Sin Asignar", turno: tName,
                    entrada_planificada: row[`Entrada${suffix}`] || "07:00",
                    salida_real: row[`Salida${suffix}`] || null,
                    comentario: row[`Comentario${suffix}`] || "",
                    es_festivo: checkBool(row[`Festivo${suffix}`]),
                    es_extra: checkBool(row[`Textra${suffix}`]),
                    es_recuperacion: checkBool(row[`Recuperación${suffix}`]),
                    retardo: checkBool(row[`Retardo${suffix}`])
                });
            };
            await processShift("1"); await processShift("2");
        }

        // --- EXPORTACIÓN ---
        window.exportMasterExcel = async () => {
            prepareProcessingUI("Exportando Maestro");
            await buildUserMap();
            
            try {
                const datesSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'RegAs'));
                const dateIds = datesSnap.docs.map(d => d.id);
                const results = [];
                const shiftTypes = ['matutino', 'vespertino', 'nocturno', 'ausentismo'];

                for (let i = 0; i < dateIds.length; i++) {
                    const dateId = dateIds[i];
                    updateProgress(i + 1, dateIds.length, `Fecha: ${dateId}`);

                    for (const shift of shiftTypes) {
                        const sSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, shift));
                        sSnap.forEach(dSnap => {
                            const data = dSnap.data();
                            const user = userDataCache[dSnap.id] || { nombre: 'Desconocido', id_empleado: '---' };
                            results.push({
                                "Fecha": dateId, "ID": user.id_empleado || user.id, "Nombre": user.nombre,
                                "Turno": data.Ausentismo ? 'AUSENCIA' : (data.turno || shift).toUpperCase(),
                                "Caseta": data.Caseta || 'N/A', "Entrada": data.entrada_real || (data.Ausentismo ? data.motivo : '--:--'),
                                "Salida": data.salida_real || '--:--', "Estatus": getStatusText(data), "Comentario": data.comentario || ''
                            });
                        });
                    }
                }

                const ws = XLSX.utils.json_to_sheet(results);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Historico_RegAs");
                XLSX.writeFile(wb, `Reporte_Maestro_RegAs_${new Date().toISOString().split('T')[0]}.xlsx`);
                finish();
            } catch (err) { addLog(err.message, "error"); finish(true); }
        };

        window.exportDatabaseJSON = async () => {
            prepareProcessingUI("Generando Backup JSON");
            try {
                const datesSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'RegAs'));
                const fullBackup = {};
                
                for (let i = 0; i < datesSnap.docs.length; i++) {
                    const dateId = datesSnap.docs[i].id;
                    updateProgress(i+1, datesSnap.docs.length, dateId);
                    fullBackup[dateId] = {};
                    const shiftTypes = ['matutino', 'vespertino', 'nocturno', 'ausentismo'];
                    for (const s of shiftTypes) {
                        const sSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, s));
                        fullBackup[dateId][s] = {};
                        sSnap.forEach(ds => fullBackup[dateId][s][ds.id] = ds.data());
                    }
                }

                const blob = new Blob([JSON.stringify(fullBackup, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `RegAs_Backup_Full_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                finish();
            } catch (err) { addLog(err.message, "error"); finish(true); }
        };

        window.downloadTemplate = async () => {
            const dataToExport = [];
            await buildUserMap();
            idEmpleadoToUidMap.forEach((uid, opId) => {
                const u = userDataCache[uid];
                dataToExport.push({
                    "Fecha": new Date().toISOString().split('T')[0], "ID": opId, "Nombre": u.nombre,
                    "Turno1": "", "Caseta1": "", "Entrada1": "", "Salida1": "", "Comentario1": "", "Festivo1": "No", "Textra1": "No", "Recuperación1": "No", "Retardo1": "No",
                    "Turno2": "", "Caseta2": "", "Entrada2": "", "Salida2": "", "Comentario2": "", "Festivo2": "No", "Textra2": "No", "Recuperación2": "No", "Retardo2": "No",
                    "Ausentismo": "No", "Motivo": ""
                });
            });
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "RegAs");
            XLSX.writeFile(wb, `Plantilla_RegAs_Llenado.xlsx`);
        };

        // --- UTILS ---
        function addLog(msg, type) {
            const div = document.createElement('div');
            div.className = `text-[9px] font-bold p-2 rounded-lg border flex items-start gap-2 ${type === 'error' ? 'bg-red-50 border-red-100 text-red-700' : type === 'success' ? 'bg-emerald-50 border-emerald-100 text-emerald-700' : 'bg-slate-100 border-slate-200 text-slate-500'}`;
            div.innerHTML = `<span class="mt-0.5">${type === 'error' ? '✕' : type === 'success' ? '✓' : 'ℹ'}</span><span>${msg}</span>`;
            logContainer.prepend(div);
        }

        function updateProgress(current, total, label) {
            const perc = Math.round((current / total) * 100);
            document.getElementById('progress-bar').style.width = `${perc}%`;
            document.getElementById('percentage-text').innerText = `${perc}%`;
            document.getElementById('progress-text').innerText = label || "Trabajando...";
        }

        function prepareProcessingUI(title) {
            document.getElementById('section-import').classList.add('hidden');
            document.getElementById('section-export').classList.add('hidden');
            document.getElementById('step-processing').classList.remove('hidden');
            document.getElementById('status-title').innerText = title;
        }

        function finish(failed = false) {
            document.getElementById('main-loader').classList.add('hidden');
            document.getElementById('status-title').innerText = failed ? "Tarea Fallida" : "Tarea Completada";
            document.getElementById('btn-finish').classList.remove('hidden');
        }

        function checkBool(v) { const s = String(v || "").toLowerCase(); return s === 'si' || s === 'sí' || s === 'true' || s === '1'; }
        function getStatusText(d) {
            if (d.Ausentismo) return "AUSENTE";
            let p = [];
            if (d.retardo) p.push("RETARDO");
            if (d.es_festivo) p.push("FESTIVO");
            if (d.es_extra) p.push("EXTRA");
            return p.length ? p.join(" | ") : "NORMAL";
        }

    </script>
</body>
</html>