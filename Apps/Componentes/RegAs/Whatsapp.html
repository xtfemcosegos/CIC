<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte WhatsApp - CIC6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-primary: #4c1d95;
            --md-primary-dark: #1e1b4b;
            --md-accent: #7c3aed;
            --md-surface: #ffffff;
            --md-background: #f5f3ff;
            --md-outline: #ddd6fe;
            --metallic-gradient: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--md-background);
            color: #1e293b;
            padding: 30px 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .card-material {
            background: white;
            border-radius: 32px;
            border: 1px solid var(--md-outline);
            padding: 32px;
            box-shadow: 0 20px 50px rgba(30, 27, 75, 0.04);
            width: 100%;
            max-width: 700px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .section-header svg {
            color: var(--md-primary);
        }

        .input-standard {
            width: 100%;
            background: #f8fafc;
            border: 2px solid #f1f5f9;
            border-radius: 16px;
            padding: 14px 18px;
            font-size: 14px;
            font-weight: 700;
            color: var(--md-primary-dark);
            outline: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-standard:focus { 
            border-color: var(--md-accent); 
            background: white;
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
        }

        .label-style {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            color: #94a3b8;
            margin-left: 4px;
            margin-bottom: 6px;
            display: block;
            letter-spacing: 0.05em;
        }

        .report-box {
            width: 100%;
            height: 380px;
            background: #0f172a;
            border: 2px solid #1e293b;
            border-radius: 20px;
            padding: 24px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            color: #e2e8f0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
        }

        .btn-copy {
            background: var(--metallic-gradient);
            color: white;
            border-radius: 20px;
            padding: 18px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.1em;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 25px rgba(76, 29, 149, 0.2);
        }
        .btn-copy:hover { 
            transform: translateY(-3px); 
            filter: brightness(1.1);
            box-shadow: 0 15px 30px rgba(76, 29, 149, 0.3);
        }
        .btn-copy:active { transform: scale(0.97); }

        .check-container {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
            padding: 8px;
            border-radius: 12px;
            transition: background 0.2s;
        }
        .check-container:hover { background: #f5f3ff; }

        .check-box {
            width: 22px;
            height: 22px;
            border: 2.5px solid var(--md-outline);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: white;
        }
        .check-box svg { display: none; color: white; width: 14px; height: 14px; stroke-width: 4; }
        input:checked + .check-box { background: var(--md-primary); border-color: var(--md-primary); }
        input:checked + .check-box svg { display: block; }

        .toast {
            position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%);
            background: #1e1b4b; color: white; padding: 14px 28px; border-radius: 16px;
            font-size: 11px; font-weight: 800; text-transform: uppercase;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); display: none; z-index: 1000;
            animation: toastPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes toastPop {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        .loading-pulse {
            width: 8px; height: 8px; background: var(--md-accent); border-radius: 50%;
            animation: pulse-glow 1.5s infinite;
        }
        @keyframes pulse-glow {
            0% { transform: scale(0.8); opacity: 0.5; box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4); }
            50% { transform: scale(1.2); opacity: 1; box-shadow: 0 0 0 8px rgba(124, 58, 237, 0); }
            100% { transform: scale(0.8); opacity: 0.5; box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); }
        }
    </style>
</head>
<body>

    <div class="card-material animate-in fade-in duration-500">
        
        <div class="section-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            <h2 class="text-sm font-black text-indigo-950 uppercase tracking-widest">Generador de Reporte Operativo</h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
            <div>
                <label class="label-style">Fecha de Consulta</label>
                <input type="date" id="report-date" class="input-standard">
            </div>
            <div>
                <label class="label-style">Turno a Reportar</label>
                <select id="report-shift" class="input-standard">
                    <option value="matutino">MATUTINO</option>
                    <option value="vespertino">VESPERTINO</option>
                    <option value="nocturno">NOCTURNO</option>
                </select>
            </div>
        </div>

        <div class="flex items-center justify-between mb-8 px-2">
            <label class="check-container">
                <input type="checkbox" id="include-time" checked class="hidden">
                <div class="check-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                <span class="text-[10px] font-black text-slate-600 uppercase tracking-widest">Incluir hora de ingreso</span>
            </label>
            
            <div id="loading-indicator" class="hidden flex items-center gap-3">
                <div class="loading-pulse"></div>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Sincronizando Nube</span>
            </div>
        </div>

        <textarea id="report-text" class="report-box no-scrollbar" readonly placeholder="Procesando datos del turno..."></textarea>

        <div class="mt-8">
            <button onclick="copyReport()" class="btn-copy">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copiar para WhatsApp
            </button>
            <p class="text-[8px] text-center text-slate-300 mt-4 font-bold uppercase tracking-widest">Listo para pegar en el grupo oficial</p>
        </div>
    </div>

    <div id="toast" class="toast">Portapapeles Actualizado</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            messagingSenderId: "248659087868",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'cic.pp';

        const casetasOrden = [
            "Centro de control", "Encargado", "Edison", "Recepción Edison", 
            "Impulso", "Michelena", "Simón Bolívar", "Carranza", "Universidad", "Rondinero"
        ];

        let userDataCache = {};
        let currentRegistry = [];
        let activeUnsubscribe = null;

        const dateInput = document.getElementById('report-date');
        const shiftSelect = document.getElementById('report-shift');
        const includeTimeCheck = document.getElementById('include-time');
        const reportArea = document.getElementById('report-text');

        // Inicializar fecha actual
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadUsers();
                startListening();
            } else signInAnonymously(auth);
        });

        async function loadUsers() {
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Usuarios'));
            snap.forEach(d => userDataCache[d.id] = d.data());
        }

        function startListening() {
            if (activeUnsubscribe) activeUnsubscribe();

            const rawDate = dateInput.value;
            const dateId = rawDate.split('-').reverse().join('');
            const shiftId = shiftSelect.value;

            document.getElementById('loading-indicator').classList.remove('hidden');

            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'RegAs', dateId, shiftId);
            activeUnsubscribe = onSnapshot(colRef, (snap) => {
                currentRegistry = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const user = userDataCache[docSnap.id] || { nombre: 'Elemento Desconocido' };
                    currentRegistry.push({ uid: docSnap.id, nombre: user.nombre, ...data });
                });
                generateText();
                document.getElementById('loading-indicator').classList.add('hidden');
            });
        }

        function generateText() {
            const rawDate = dateInput.value;
            const shiftName = shiftSelect.value.toUpperCase();
            const includeTime = includeTimeCheck.checked;

            const dateObj = new Date(rawDate + "T00:00:00");
            const longDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const capitalizedDate = longDate.charAt(0).toUpperCase() + longDate.slice(1);

            let text = `*DISTRIBUCIÓN TURNO ${shiftName}*\n`;
            text += `\`\`\`${capitalizedDate}\`\`\`\n\n`;

            casetasOrden.forEach(caseta => {
                text += `*${caseta}*\n`;
                const assigned = currentRegistry.filter(r => r.Caseta === caseta);

                if (assigned.length === 0) {
                    text += `~Sin elemento~\n\n`;
                } else {
                    assigned.forEach(item => {
                        const realTime = item.entrada_real || "--:--";
                        const timeStr = includeTime ? `*${realTime}* hrs. ` : "";
                        text += `${timeStr}${item.nombre}\n`;
                    });
                    text += `\n`;
                }
            });

            reportArea.value = text.trim();
        }

        dateInput.onchange = startListening;
        shiftSelect.onchange = startListening;
        includeTimeCheck.onchange = generateText;

        window.copyReport = () => {
            const textarea = document.getElementById('report-text');
            textarea.select();
            try {
                // Compatible con iframe sandboxed
                document.execCommand('copy');
                showToast();
            } catch (err) {
                console.error('Error al copiar:', err);
            }
        };

        function showToast() {
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2500);
        }

    </script>
</body>
</html>