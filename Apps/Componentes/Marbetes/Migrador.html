<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrador de Marbetes - CIC6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-green-dark: #064e3b;
            --brand-green-mid: #059669;
            --brand-green-light: #10b981;
            --bg-main: #f0fdf4;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: #1e293b;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .metal-card {
            background: white;
            border-radius: 24px;
            border: 1px solid #d1fae5;
            box-shadow: 0 10px 25px -5px rgba(6, 78, 59, 0.05);
            overflow: hidden;
        }

        .header-metal {
            background: linear-gradient(135deg, var(--brand-green-dark) 0%, var(--brand-green-mid) 100%);
            padding: 30px;
            color: white;
            position: relative;
        }

        .progress-bar-container {
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--brand-green-mid);
            width: 0%;
            transition: width 0.3s ease;
        }

        .log-area {
            background: #1e293b;
            color: #94a3b8;
            font-family: 'Courier New', Courier, monospace;
            font-size: 11px;
            padding: 16px;
            border-radius: 12px;
            height: 200px;
            overflow-y: auto;
        }

        .log-entry { margin-bottom: 4px; }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-info { color: #3b82f6; }

        .btn-migrate {
            background: #1e293b;
            color: white;
            padding: 16px 32px;
            border-radius: 16px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(30, 41, 59, 0.2);
        }

        .btn-migrate:hover:not(:disabled) {
            background: var(--brand-green-dark);
            transform: translateY(-2px);
        }

        .btn-migrate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <div class="max-w-3xl mx-auto w-full">
        <div class="metal-card">
            <header class="header-metal text-center">
                <h1 class="text-2xl font-black uppercase tracking-tighter">Motor de Migración</h1>
                <p class="text-xs font-bold text-emerald-200/60 uppercase tracking-widest mt-1">Sincronización Cloud: Marbetes Vehiculares</p>
            </header>

            <div class="p-8 space-y-8">
                <!-- Estadísticas de Preparación -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <span class="text-[10px] font-black text-emerald-500 uppercase">Origen de Datos</span>
                        <div class="text-sm font-bold text-emerald-900 mt-1">Power Automate API</div>
                    </div>
                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <span class="text-[10px] font-black text-emerald-500 uppercase">Destino Cloud</span>
                        <div id="target-id-label" class="text-sm font-bold text-emerald-900 mt-1">Firestore / Marbetes</div>
                    </div>
                </div>

                <!-- Control de Progreso -->
                <div class="space-y-4">
                    <div class="flex justify-between items-end">
                        <div>
                            <span id="status-label" class="text-xs font-black uppercase text-slate-400 tracking-widest">Inicializando...</span>
                            <div id="status-detail" class="text-[10px] font-bold text-slate-400 mt-1">Configurando entorno de datos...</div>
                        </div>
                        <div id="percentage-label" class="text-2xl font-black text-emerald-900">0%</div>
                    </div>
                    
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar-fill"></div>
                    </div>
                </div>

                <!-- Consola de Logs -->
                <div class="space-y-2">
                    <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Consola de Eventos</span>
                    <div id="log-console" class="log-area no-scrollbar">
                        <div class="log-entry">> Sistema iniciado.</div>
                    </div>
                </div>

                <!-- Botón de Acción -->
                <button id="btn-start" class="w-full btn-migrate" disabled>
                    Esperando Autenticación...
                </button>
            </div>
        </div>
        
        <p class="text-center mt-6 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
            CIC-6 Data Management v2.2 • Transmisión Encriptada
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const API_URL = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/fe7a46f4aa314e7a993bc66528b0d03b/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=mTepaYfQc_U2RF4I-tX0PNhrniM2OgcErzU9gDtA0fw";
        
        // --- CONFIGURACIÓN EXPLÍCITA DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            messagingSenderId: "248659087868",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279",
            measurementId: "G-ZMC7H7710Z"
        };

        const appId = 'cic.pp';
        document.getElementById('target-id-label').innerText = `Firestore / ${appId} / Marbetes`;

        // --- INICIALIZACIÓN ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let user = null;

        // --- UI HELPERS ---
        function addLog(msg, type = "") {
            const consoleEl = document.getElementById('log-console');
            if (!consoleEl) return;
            const entry = document.createElement('div');
            entry.className = `log-entry ${type ? 'log-' + type : ''}`;
            entry.innerText = `> ${new Date().toLocaleTimeString()} - ${msg}`;
            consoleEl.appendChild(entry);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function updateProgress(percent, label, detail) {
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = `${percent}%`;
            
            const pctLabel = document.getElementById('percentage-label');
            if (pctLabel) pctLabel.innerText = `${Math.round(percent)}%`;
            
            if (label) document.getElementById('status-label').innerText = label;
            if (detail) document.getElementById('status-detail').innerText = detail;
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                addLog("Sesión activa detectada.", "success");
                document.getElementById('btn-start').innerText = "Iniciar Migración Masiva";
                document.getElementById('btn-start').disabled = false;
                updateProgress(0, "Listo", "Esperando inicio de migración...");
            } else {
                addLog("Sin sesión. Intentando reconexión...", "info");
                document.getElementById('btn-start').innerText = "Autenticando...";
                document.getElementById('btn-start').disabled = true;
            }
        });

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    addLog("Utilizando token administrativo...", "info");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    addLog("Token no encontrado. Intentando acceso de respaldo...", "info");
                    try {
                        await signInAnonymously(auth);
                    } catch (anonErr) {
                        if (anonErr.code === 'auth/operation-not-allowed') {
                            throw new Error("Acceso denegado: Los ingresos anónimos están deshabilitados en este proyecto de Firebase.");
                        }
                        throw anonErr;
                    }
                }
            } catch (e) {
                addLog(`Error de Autenticación: ${e.message}`, "error");
                document.getElementById('btn-start').innerText = "Acceso Restringido";
            }
        };
        
        initAuth();

        // --- MIGRATION LOGIC ---
        const startMigration = async () => {
            if (!db || !user) {
                addLog("Error: Se requiere una conexión válida para migrar.", "error");
                return;
            }

            const btn = document.getElementById('btn-start');
            btn.disabled = true;
            
            try {
                // 1. Descarga de Datos
                updateProgress(10, "Descargando", "Conectando con la API de Power Automate...");
                addLog("Solicitando datos maestros...", "info");
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fetchAll: true })
                });

                if (!response.ok) throw new Error(`Servidor de datos inaccesible (${response.status})`);
                
                const rawData = await response.json();
                const items = Array.isArray(rawData) ? rawData : (rawData.value || rawData.result || []);
                
                if (items.length === 0) throw new Error("La consulta no devolvió registros.");

                addLog(`Éxito: Se obtuvieron ${items.length} registros para procesar.`, "success");
                updateProgress(30, "Preparando", "Limpiando base de datos cloud...");

                // 2. Limpieza de Colección
                const marbetesRef = collection(db, 'artifacts', appId, 'public', 'data', 'Marbetes');
                const currentDocs = await getDocs(marbetesRef);
                
                if (!currentDocs.empty) {
                    addLog(`Removiendo ${currentDocs.size} fragmentos de datos obsoletos...`, "info");
                    for (const d of currentDocs.docs) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Marbetes', d.id));
                    }
                }

                // 3. Subida Fragmentada (Chunking)
                const chunkSize = 1000;
                const totalChunks = Math.ceil(items.length / chunkSize);
                
                addLog(`Dividiendo carga en ${totalChunks} paquetes de red.`, "info");

                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = start + chunkSize;
                    const chunk = items.slice(start, end);
                    const partId = `part_${String(i + 1).padStart(2, '0')}`;

                    updateProgress(
                        30 + ((i / totalChunks) * 70), 
                        "Subiendo", 
                        `Transmitiendo paquete ${i + 1} de ${totalChunks}...`
                    );

                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Marbetes', partId), {
                        items: chunk,
                        lastUpdate: new Date().toISOString(),
                        partIndex: i + 1,
                        totalParts: totalChunks,
                        count: chunk.length,
                        migrationSource: "PowerAutomate_API"
                    });

                    addLog(`Paquete ${partId} guardado exitosamente (${chunk.length} marbetes).`, "success");
                }

                updateProgress(100, "Completado", "Sincronización masiva finalizada con éxito.");
                addLog("=== PROCESO TERMINADO ===", "success");
                btn.innerText = "Sincronización Exitosa";
                btn.classList.replace("bg-slate-900", "bg-emerald-600");

            } catch (err) {
                console.error(err);
                addLog(`FALLO: ${err.message}`, "error");
                updateProgress(0, "Error", "El proceso se detuvo por un error crítico.");
                btn.disabled = false;
                btn.innerText = "Reintentar";
            }
        };

        // Vinculación segura del evento
        document.getElementById('btn-start').addEventListener('click', startMigration);
    </script>
</body>
</html>