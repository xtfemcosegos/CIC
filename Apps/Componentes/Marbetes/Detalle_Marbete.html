<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edición de Marbete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #ffffff; color: #1e293b; padding: 0; margin: 0; }
        
        .form-group { margin-bottom: 1rem; }
        .detail-label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; display: block; margin-bottom: 4px; }
        
        .form-input {
            width: 100%;
            background-color: #f8fafc;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 600;
            color: #334155;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #6d28d9;
            background-color: #fff;
            box-shadow: 0 0 0 4px rgba(109, 40, 217, 0.1);
        }

        .form-input:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .action-btn { transition: all 0.2s ease; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 800; font-size: 11px; text-transform: uppercase; padding: 12px; width: 100%; }
        .action-btn:active { transform: scale(0.98); }
        .bg-purple-gradient { background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%); }
        
        /* Botón Guardar Flotante */
        .save-footer {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1.5rem 2rem;
            border-top: 1px solid #f1f5f9;
            box-shadow: 0 -10px 20px rgba(0,0,0,0.02);
            z-index: 100;
        }

        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8);
            backdrop-filter: blur(4px); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }

        #empty-state { display: flex; }
        #detail-content { display: none; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"></div>
        <p class="text-[10px] font-black uppercase mt-4 tracking-widest text-purple-900">Actualizando registro...</p>
    </div>

    <!-- Pantalla de espera -->
    <div id="empty-state" class="fixed inset-0 bg-white flex flex-col items-center justify-center p-12 text-center">
        <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
            <svg class="text-slate-200" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
        </div>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Seleccione un registro en la lista</p>
    </div>

    <div id="detail-content" class="pb-4">
        <!-- Encabezado -->
        <div class="bg-purple-gradient p-8 text-white relative">
            <button onclick="closePanel()" class="absolute top-6 right-6 p-2 bg-white/10 hover:bg-white/20 rounded-full">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
            <div class="pr-12">
                <span class="text-[10px] font-black uppercase tracking-widest opacity-60">Editor de Expediente</span>
                <h1 id="header-folio" class="text-3xl font-black tracking-tighter mt-1 truncate">---</h1>
                <p id="header-nombre" class="text-sm font-bold opacity-90 mt-1 uppercase truncate">---</p>
            </div>
        </div>

        <form id="marbete-form" class="p-8 space-y-8" onsubmit="return false;">
            <!-- ID FILA (Completamente invisible) -->
            <input type="hidden" id="field-IDFila">

            <!-- SECCIÓN: ACCIONES RÁPIDAS -->
            <div class="grid grid-cols-2 gap-4">
                <a id="btn-call" href="#" class="action-btn bg-slate-100 text-slate-700 hover:bg-slate-200">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    Llamar
                </a>
                <a id="btn-whatsapp" href="#" target="_blank" class="action-btn bg-emerald-100 text-emerald-700 hover:bg-emerald-200">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                    WhatsApp
                </a>
                <a id="btn-email" href="#" class="action-btn bg-blue-100 text-blue-700 hover:bg-blue-200">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                    E-Mail
                </a>
                <a id="btn-teams" href="#" target="_blank" class="action-btn bg-indigo-100 text-indigo-700 hover:bg-indigo-200">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12.5 4a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0zm-1.5 5h-4a3 3 0 0 0-3 3v2h10v-2a3 3 0 0 0-3-3zM21 15.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0zM22 19h-6a2 2 0 0 0-2 2v1h10v-1a2 2 0 0 0-2-2z"/></svg>
                    Teams
                </a>
            </div>

            <!-- SECCIÓN: DATOS GENERALES -->
            <div class="space-y-4">
                <h2 class="text-xs font-black uppercase text-slate-400 tracking-[0.2em] border-b pb-2">Unidad</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="detail-label">Folio</label>
                        <input type="text" id="field-Folio" class="form-input" oninput="syncHeader()">
                    </div>
                    <div class="form-group">
                        <label class="detail-label">Estatus</label>
                        <select id="field-Estatus" class="form-input">
                            <option value="Sin folio">Sin folio</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Entregado">Entregado</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="detail-label">Marca</label><input type="text" id="field-Marca" class="form-input"></div>
                    <div class="form-group"><label class="detail-label">Modelo</label><input type="text" id="field-Modelo" class="form-input"></div>
                    <div class="form-group"><label class="detail-label">Color</label><input type="text" id="field-Color" class="form-input"></div>
                    <div class="form-group"><label class="detail-label">Placas</label><input type="text" id="field-Placas" class="form-input font-mono uppercase"></div>
                    <div class="form-group"><label class="detail-label">Tipo de Motor</label><input type="text" id="field-Tipo de motor" class="form-input"></div>
                    <div class="form-group"><label class="detail-label">Tipo Trámite</label><input type="text" id="field-Tipo" class="form-input"></div>
                </div>
            </div>

            <!-- SECCIÓN: PROPIETARIO -->
            <div class="space-y-4">
                <h2 class="text-xs font-black uppercase text-slate-400 tracking-[0.2em] border-b pb-2">Propietario</h2>
                <div class="space-y-4">
                    <div class="form-group">
                        <label class="detail-label">Nombre Completo</label>
                        <input type="text" id="field-Nombre" class="form-input uppercase" oninput="syncHeader()">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group"><label class="detail-label">No. Socio</label><input type="text" id="field-No de socio" class="form-input"></div>
                        <div class="form-group"><label class="detail-label">Teléfono</label><input type="text" id="field-Teléfono" class="form-input"></div>
                    </div>
                    <div class="form-group"><label class="detail-label">Correo Institucional</label><input type="email" id="field-Correo" class="form-input lowercase"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group"><label class="detail-label">Puesto</label><input type="text" id="field-Puesto" class="form-input"></div>
                        <div class="form-group"><label class="detail-label">Área</label><input type="text" id="field-Area" class="form-input"></div>
                        <div class="form-group"><label class="detail-label">Negocio</label><input type="text" id="field-Negocio" class="form-input"></div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: SEGUIMIENTO -->
            <div class="space-y-4">
                <h2 class="text-xs font-black uppercase text-slate-400 tracking-[0.2em] border-b pb-2">Seguimiento</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group"><label class="detail-label">Fecha Solicitud</label><input type="text" id="field-Fecha de solicitud" class="form-input"></div>
                    <div class="form-group"><label class="detail-label">Fecha Asignación</label><input type="text" id="field-Fecha de asignación" class="form-input"></div>
                </div>
                <div class="form-group">
                    <label class="detail-label">Comentarios / Observaciones</label>
                    <textarea id="field-Comentario" class="form-input min-h-[100px] resize-none"></textarea>
                </div>
            </div>
        </form>

        <!-- FOOTER DE GUARDADO -->
        <div class="save-footer">
            <button onclick="handleSave()" id="btn-save" class="w-full bg-slate-900 text-white font-black uppercase tracking-widest text-xs py-4 rounded-2xl shadow-xl shadow-slate-200 hover:bg-purple-900 transition-all active:scale-[0.98]">
                Guardar Cambios
            </button>
        </div>
    </div>

    <script>
        const SAVE_API = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ef2d2f799b76471f9d826c4da323c548/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Dm2VAKxKYse9NcZL_qdi6DbOAPEBmdTZKaslmg67mVE";
        
        let originalItem = null;

        function cleanPhone(tel) { return String(tel || "").replace(/\D/g, ''); }

        function closePanel() { window.parent.postMessage({ type: 'CLOSE_MARBETE_DETAIL' }, '*'); }

        function syncHeader() {
            const folio = document.getElementById('field-Folio').value;
            const nombre = document.getElementById('field-Nombre').value;
            document.getElementById('header-folio').innerText = folio || 'NUEVO';
            document.getElementById('header-nombre').innerText = String(nombre || '').toUpperCase();
        }

        // Escuchar mensaje del padre con los datos
        window.addEventListener('message', function(event) {
            if (event.data.type === 'LOAD_DATA') {
                const item = event.data.data;
                originalItem = item;
                loadForm(item);
            }
        });

        function loadForm(item) {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('detail-content').style.display = 'block';

            // Mapear campos manualmente para asegurar que los IDs coincidan con los nombres de columna de Excel
            const mapping = {
                "Folio": "field-Folio",
                "Estatus": "field-Estatus",
                "Marca": "field-Marca",
                "Modelo": "field-Modelo",
                "Color": "field-Color",
                "Placas": "field-Placas",
                "Tipo de motor": "field-Tipo de motor",
                "Tipo": "field-Tipo",
                "Nombre": "field-Nombre",
                "No de socio": "field-No de socio",
                "Teléfono": "field-Teléfono",
                "Correo": "field-Correo",
                "Puesto": "field-Puesto",
                "Area": "field-Area",
                "Negocio": "field-Negocio",
                "Fecha de solicitud": "field-Fecha de solicitud",
                "Fecha de asignación": "field-Fecha de asignación",
                "Comentario": "field-Comentario",
                "IDFila": "field-IDFila"
            };

            Object.keys(mapping).forEach(key => {
                const input = document.getElementById(mapping[key]);
                if (input) {
                    input.value = item[key] !== null && item[key] !== undefined ? item[key] : '';
                }
            });

            syncHeader();

            // Actualizar links de contacto
            const tel = cleanPhone(item["Teléfono"]);
            const email = item.Correo || "";
            const folio = item.Folio || "S/N";

            document.getElementById('btn-call').href = tel ? `tel:${tel}` : '#';
            document.getElementById('btn-whatsapp').href = tel ? `https://web.whatsapp.com/send?phone=52${tel}` : '#';
            document.getElementById('btn-email').href = email ? `mailto:${email}?subject=Consulta Marbete ${folio}` : '#';
            document.getElementById('btn-teams').href = email ? `https://teams.microsoft.com/l/chat/0/0?users=${email}` : '#';
        }

        // MOTOR DE GUARDADO: ENVÍA CAMPOS SUELTOS (OBJETO PLANO)
        async function handleSave() {
            const btn = document.getElementById('btn-save');
            const loader = document.getElementById('loading-overlay');
            
            // CONSTRUCCIÓN DEL OBJETO PLANO (SIN WRAPPERS)
            // Se toman los valores directamente de los inputs en su estado actual
            const payload = {
                "Folio": document.getElementById('field-Folio').value,
                "Estatus": document.getElementById('field-Estatus').value,
                "Marca": document.getElementById('field-Marca').value,
                "Modelo": document.getElementById('field-Modelo').value,
                "Color": document.getElementById('field-Color').value,
                "Placas": document.getElementById('field-Placas').value,
                "Tipo de motor": document.getElementById('field-Tipo de motor').value,
                "Tipo": document.getElementById('field-Tipo').value,
                "Nombre": document.getElementById('field-Nombre').value,
                "No de socio": document.getElementById('field-No de socio').value,
                "Teléfono": document.getElementById('field-Teléfono').value,
                "Correo": document.getElementById('field-Correo').value,
                "Puesto": document.getElementById('field-Puesto').value,
                "Area": document.getElementById('field-Area').value,
                "Negocio": document.getElementById('field-Negocio').value,
                "Fecha de solicitud": document.getElementById('field-Fecha de solicitud').value,
                "Fecha de asignación": document.getElementById('field-Fecha de asignación').value,
                "Comentario": document.getElementById('field-Comentario').value,
                "IDFila": document.getElementById('field-IDFila').value
            };

            if (!payload.IDFila) {
                alert("Error: No se detectó la llave del registro (IDFila).");
                return;
            }

            loader.style.display = 'flex';
            btn.disabled = true;

            try {
                // Envío directo del objeto como el cuerpo de la petición
                const response = await fetch(SAVE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                loader.style.display = 'none';
                btn.disabled = false;
                btn.innerText = "¡REGISTRO ACTUALIZADO!";
                btn.classList.replace('bg-slate-900', 'bg-emerald-600');
                
                // Notificar éxito
                window.parent.postMessage({ type: 'MARBETE_SAVED_SUCCESS', data: payload }, '*');

                setTimeout(() => {
                    btn.innerText = "Guardar Cambios";
                    btn.classList.replace('bg-emerald-600', 'bg-slate-900');
                }, 3000);

            } catch (err) {
                loader.style.display = 'none';
                btn.disabled = false;
                alert("Fallo al actualizar: Verifique su conexión o el flujo de Power Automate.");
            }
        }

        window.onload = () => {
            window.parent.postMessage({ type: 'DETAIL_IFRAME_READY' }, '*');
        };
    </script>
</body>
</html>