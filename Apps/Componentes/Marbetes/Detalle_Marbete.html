<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edición de Marbete - CIC6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta Green Vibrant Metal */
            --brand-green-dark: #064e3b;
            --brand-green-mid: #059669;
            --brand-green-light: #10b981;
            --bg-main: #f0fdf4;
            --marbete-red: #7f1d1d; /* Rojo oscuro */
            --alert-red: #ef4444;    /* Rojo brillante para alertas */
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #ffffff; 
            color: #1e293b; 
            padding: 0; 
            margin: 0; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* --- SECCIÓN FIJA --- */
        .sticky-top-section {
            position: sticky;
            top: 0;
            z-index: 50;
            background: white;
            flex-shrink: 0;
            transition: border-color 0.3s ease;
            border-bottom: 0px solid transparent;
        }

        /* Clase dinámica para el estado de Baja */
        .header-baja-active {
            border-bottom: 4px solid var(--alert-red) !important;
        }

        /* --- MARBETE VERTICAL DESIGN --- */
        .marbete-vertical {
            width: 50px;
            height: 70px;
            border-radius: 6px 6px 12px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            flex-shrink: 0;
            transition: all 0.3s ease;
            margin-right: 15px;
        }

        .marbete-hook {
            width: 12px;
            height: 12px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            position: absolute;
            top: 6px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .marbete-digits {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2px;
            margin-top: 10px;
            line-height: 1;
        }

        .digit {
            font-size: 16px;
            font-weight: 900;
            text-align: center;
        }

        /* --- HEADER & RIBBONS --- */
        .bg-green-gradient { 
            background: linear-gradient(135deg, var(--brand-green-dark) 0%, var(--brand-green-mid) 100%); 
        }

        .date-ribbon {
            background: #f1f5f9;
            padding: 4px 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .date-item { display: flex; align-items: center; gap: 5px; }
        .date-item span:first-child { font-size: 8px; font-weight: 900; text-transform: uppercase; color: #94a3b8; }
        .date-item span:last-child { font-size: 9px; font-weight: 700; color: #64748b; }

        /* Banner de Baja */
        #baja-banner {
            display: none;
            background: #fef2f2;
            color: var(--alert-red);
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            padding: 4px 0;
            letter-spacing: 0.3em;
            border-top: 1px solid #fee2e2;
        }

        .form-group { margin-bottom: 0.75rem; }
        .detail-label { 
            font-size: 9px; 
            font-weight: 800; 
            text-transform: uppercase; 
            color: #94a3b8; 
            letter-spacing: 0.05em; 
            display: block; 
            margin-bottom: 2px; 
        }
        
        .form-input {
            width: 100%;
            background-color: #f8fafc;
            border: 1px solid #f1f5f9;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 600;
            color: #334155;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--brand-green-mid);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .action-btn { 
            transition: all 0.2s ease; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            gap: 4px; 
            font-weight: 800; 
            font-size: 9px; 
            text-transform: uppercase; 
            padding: 6px 2px; 
            width: 100%;
            border: 1px solid transparent;
        }
        
        .section-block {
            padding: 1rem;
            border-radius: 14px;
            border: 1px solid #f1f5f9;
            background: #fff;
            margin-bottom: 1rem;
        }

        .main-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .save-footer {
            background: white;
            padding: 0.75rem 1.5rem;
            border-top: 1px solid #f1f5f9;
            flex-shrink: 0;
        }

        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8);
            backdrop-filter: blur(4px); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- MODAL --- */
        #assign-modal {
            position: fixed;
            inset: 0;
            background: rgba(6, 78, 59, 0.4);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-card {
            background: white;
            width: 100%;
            max-width: 320px;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #empty-state { display: flex; }
        #detail-content { display: none; height: 100%; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="w-10 h-10 border-4 border-emerald-100 border-t-emerald-600 rounded-full animate-spin"></div>
        <p class="text-[10px] font-black uppercase mt-4 tracking-widest text-emerald-900">Sincronizando...</p>
    </div>

    <!-- Modal de Asignación -->
    <div id="assign-modal">
        <div class="modal-card space-y-4 text-center">
            <h3 class="text-sm font-black uppercase tracking-tight text-emerald-900">Asignar Folio</h3>
            <p class="text-[10px] text-slate-400 font-bold uppercase">Ingrese el número de marbete</p>
            <input type="text" id="modal-folio-input" class="form-input text-center text-xl font-black text-emerald-700" placeholder="0000" autofocus>
            <div class="flex gap-2 pt-2">
                <button onclick="closeAssignModal()" class="flex-1 py-3 text-[10px] font-black uppercase text-slate-400">Cancelar</button>
                <button onclick="confirmFolioAssignment()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl text-[10px] font-black uppercase shadow-lg shadow-emerald-600/20">Asignar</button>
            </div>
        </div>
    </div>

    <!-- Pantalla de espera -->
    <div id="empty-state" class="fixed inset-0 bg-white flex flex-col items-center justify-center p-12 text-center">
        <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 border border-emerald-50">
            <svg class="text-emerald-200" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
        </div>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Seleccione un marbete</p>
    </div>

    <div id="detail-content">
        <div id="sticky-header-container" class="sticky-top-section">
            <!-- Encabezado Compacto -->
            <div class="bg-green-gradient px-5 py-3 text-white flex items-center overflow-hidden">
                <!-- Marbete Vertical Izquierda -->
                <div id="visual-marbete" class="marbete-vertical bg-white text-slate-900">
                    <div class="marbete-hook"></div>
                    <div id="marbete-num-display" class="marbete-digits">
                        <div class="digit">-</div><div class="digit">-</div>
                        <div class="digit">-</div><div class="digit">-</div>
                    </div>
                </div>

                <div class="flex-1 pr-4">
                    <span class="text-[7px] font-black uppercase tracking-[0.2em] opacity-50 block">Expediente de Usuario</span>
                    <h1 id="header-nombre" class="text-lg font-black tracking-tight uppercase truncate">---</h1>
                </div>

                <button onclick="closePanel()" class="p-1 bg-white/10 hover:bg-white/20 rounded-full">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Ribbon de Fechas -->
            <div class="date-ribbon">
                <div class="date-item">
                    <span>Solicitud:</span>
                    <span id="tag-fecha-solicitud">---</span>
                </div>
                <div class="date-item">
                    <span>Asignación:</span>
                    <span id="tag-fecha-asignacion">---</span>
                </div>
            </div>

            <!-- Banner de Baja (Oculto por defecto) -->
            <div id="baja-banner">BAJA - REGISTRO INACTIVO</div>

            <!-- Acciones Rápidas -->
            <div class="px-5 py-2">
                <div class="grid grid-cols-4 gap-2 bg-slate-50 p-1 rounded-xl border border-slate-100">
                    <a id="btn-call" href="#" class="action-btn bg-white text-slate-500 border-slate-100 hover:text-emerald-600">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                        Llamar
                    </a>
                    <a id="btn-whatsapp" href="#" target="_blank" class="action-btn bg-white text-slate-500 border-slate-100 hover:text-emerald-600">
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                        W.App
                    </a>
                    <a id="btn-email" href="#" class="action-btn bg-white text-slate-500 border-slate-100 hover:text-emerald-600">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                        E-Mail
                    </a>
                    <a id="btn-teams" href="#" target="_blank" class="action-btn bg-white text-slate-500 border-slate-100 hover:text-emerald-600">
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M12.5 4a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0zm-1.5 5h-4a3 3 0 0 0-3 3v2h10v-2a3 3 0 0 0-3-3zM21 15.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0zM22 19h-6a2 2 0 0 0-2 2v1h10v-1a2 2 0 0 0-2-2z"/></svg>
                        Teams
                    </a>
                </div>
            </div>
        </div>

        <div class="main-scroll-area">
            <!-- BLOQUE 1: FOLIO -->
            <div class="section-block space-y-3">
                <h2 class="text-[9px] font-black uppercase text-emerald-600 tracking-[0.2em] border-b border-emerald-50 pb-2">Control de Folio</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="detail-label">No. Folio</label>
                        <input type="text" id="field-Folio" class="form-input font-bold text-emerald-700" oninput="syncHeader()">
                    </div>
                    <div class="form-group">
                        <label class="detail-label">Estatus Actual</label>
                        <select id="field-Estatus" class="form-input" onchange="syncHeader()">
                            <option value="Sin folio">Sin folio</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Entregado">Entregado</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>
                </div>
                <button id="btn-assign-folio" onclick="handleAssignFolio()" class="hidden w-full py-2.5 bg-emerald-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-md">
                    Asignar y Entregar Marbete
                </button>
            </div>

            <!-- BLOQUE 2: PROPIETARIO -->
            <div class="section-block space-y-3">
                <h2 class="text-[9px] font-black uppercase text-emerald-600 tracking-[0.2em] border-b border-emerald-50 pb-2">Datos del Propietario</h2>
                <div class="form-group">
                    <label class="detail-label">Nombre Completo</label>
                    <input type="text" id="field-Nombre" class="form-input uppercase" oninput="syncHeader()">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group"><label class="detail-label">No. Socio</label><input type="text" id="field-No de socio" class="form-input"></div>
                    <div class="form-group"><label class="detail-label">Teléfono</label><input type="text" id="field-Teléfono" class="form-input"></div>
                </div>
                <div class="form-group"><label class="detail-label">Correo Institucional</label><input type="email" id="field-Correo" class="form-input lowercase"></div>
                <div class="grid grid-cols-3 gap-2">
                    <div class="form-group"><label class="detail-label text-[7px]">Puesto</label><input type="text" id="field-Puesto" class="form-input text-[11px]"></div>
                    <div class="form-group"><label class="detail-label text-[7px]">Área</label><input type="text" id="field-Area" class="form-input text-[11px]"></div>
                    <div class="form-group"><label class="detail-label text-[7px]">Negocio</label><input type="text" id="field-Negocio" class="form-input text-[11px]"></div>
                </div>
            </div>

            <!-- BLOQUE 3: VEHÍCULO -->
            <div class="section-block space-y-3">
                <h2 class="text-[9px] font-black uppercase text-emerald-600 tracking-[0.2em] border-b border-emerald-50 pb-2">Detalles del Vehículo</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="form-group"><label class="detail-label">Placas</label><input type="text" id="field-Placas" class="form-input font-mono uppercase"></div>
                    <div class="form-group"><label class="detail-label">Color</label><input type="text" id="field-Color" class="form-input uppercase"></div>
                    <div class="form-group"><label class="detail-label">Marca</label><input type="text" id="field-Marca" class="form-input uppercase"></div>
                    <div class="form-group"><label class="detail-label">Modelo</label><input type="text" id="field-Modelo" class="form-input uppercase"></div>
                    <div class="form-group"><label class="detail-label text-[7px]">Motor</label><input type="text" id="field-Tipo de motor" class="form-input text-[11px]"></div>
                    <div class="form-group"><label class="detail-label text-[7px]">Trámite</label><input type="text" id="field-Tipo" class="form-input text-[11px]"></div>
                </div>
            </div>

            <div class="form-group px-1 pb-4">
                <label class="detail-label">Observaciones</label>
                <textarea id="field-Comentario" class="form-input min-h-[60px] resize-none text-xs"></textarea>
            </div>

            <input type="hidden" id="field-IDFila">
        </div>

        <div class="save-footer">
            <button onclick="handleSave()" id="btn-save" class="w-full bg-slate-900 text-white font-black uppercase tracking-widest text-[10px] py-3.5 rounded-xl shadow-lg hover:bg-emerald-800 transition-all active:scale-[0.98]">
                Sincronizar Cambios
            </button>
        </div>
    </div>

    <script>
        const SAVE_API = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ef2d2f799b76471f9d826c4da323c548/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Dm2VAKxKYse9NcZL_qdi6DbOAPEBmdTZKaslmg67mVE";
        
        let originalItem = null;

        function cleanPhone(tel) { return String(tel || "").replace(/\D/g, ''); }
        function closePanel() { window.parent.postMessage({ type: 'CLOSE_MARBETE_DETAIL' }, '*'); }

        function syncHeader() {
            const folio = String(document.getElementById('field-Folio').value || "");
            const nombre = document.getElementById('field-Nombre').value;
            const estatus = String(document.getElementById('field-Estatus').value || "").toLowerCase();
            
            document.getElementById('header-nombre').innerText = String(nombre || '').toUpperCase();
            
            // --- MANEJO DE BAJA ---
            const headerContainer = document.getElementById('sticky-header-container');
            const bajaBanner = document.getElementById('baja-banner');
            
            if (estatus === 'baja') {
                headerContainer.classList.add('header-baja-active');
                bajaBanner.style.display = 'block';
            } else {
                headerContainer.classList.remove('header-baja-active');
                bajaBanner.style.display = 'none';
            }

            // --- ACTUALIZACIÓN MARBETE VISUAL ---
            const visual = document.getElementById('visual-marbete');
            const display = document.getElementById('marbete-num-display');
            
            let digitsToShow = "";
            if (folio.length >= 5) {
                digitsToShow = folio.slice(-4);
                visual.style.backgroundColor = "var(--marbete-red)";
                visual.style.color = "white";
                visual.style.border = "none";
            } else {
                digitsToShow = folio.padStart(4, '0');
                visual.style.backgroundColor = "white";
                visual.style.color = "black";
                visual.style.border = "1px solid #e2e8f0";
            }

            const d1 = digitsToShow[0] || "-";
            const d2 = digitsToShow[1] || "-";
            const d3 = digitsToShow[2] || "-";
            const d4 = digitsToShow[3] || "-";

            display.innerHTML = `
                <div class="digit">${d1}</div><div class="digit">${d2}</div>
                <div class="digit">${d3}</div><div class="digit">${d4}</div>
            `;

            updateAssignButtonVisibility(estatus);
        }

        window.addEventListener('message', function(event) {
            if (event.data.type === 'LOAD_DATA') {
                const item = event.data.data;
                originalItem = item;
                loadForm(item);
            }
        });

        function loadForm(item) {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('detail-content').style.display = 'flex';

            const mapping = {
                "Folio": "field-Folio", "Estatus": "field-Estatus", "Marca": "field-Marca",
                "Modelo": "field-Modelo", "Color": "field-Color", "Placas": "field-Placas",
                "Tipo de motor": "field-Tipo de motor", "Tipo": "field-Tipo",
                "Nombre": "field-Nombre", "No de socio": "field-No de socio",
                "Teléfono": "field-Teléfono", "Correo": "field-Correo",
                "Puesto": "field-Puesto", "Area": "field-Area", "Negocio": "field-Negocio",
                "Comentario": "field-Comentario", "IDFila": "field-IDFila"
            };

            Object.keys(mapping).forEach(key => {
                const input = document.getElementById(mapping[key]);
                if (input) input.value = (item[key] != null) ? item[key] : '';
            });

            document.getElementById('tag-fecha-solicitud').innerText = item["Fecha de solicitud"] || '---';
            document.getElementById('tag-fecha-asignacion').innerText = item["Fecha de asignación"] || '---';

            syncHeader();

            const tel = cleanPhone(item["Teléfono"]);
            const email = item.Correo || "";
            const folioStr = String(item.Folio || "S/N");
            document.getElementById('btn-call').href = tel ? `tel:${tel}` : '#';
            document.getElementById('btn-whatsapp').href = tel ? `https://web.whatsapp.com/send?phone=52${tel}` : '#';
            document.getElementById('btn-email').href = email ? `mailto:${email}?subject=Consulta Marbete ${folioStr}` : '#';
            document.getElementById('btn-teams').href = email ? `https://teams.microsoft.com/l/chat/0/0?users=${email}` : '#';
        }

        function updateAssignButtonVisibility(status) {
            const btn = document.getElementById('btn-assign-folio');
            const normalizedStatus = String(status || "").toLowerCase();
            if (normalizedStatus === "sin folio" || normalizedStatus === "pendiente") {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        function handleAssignFolio() {
            document.getElementById('assign-modal').style.display = 'flex';
            document.getElementById('modal-folio-input').value = '';
            document.getElementById('modal-folio-input').focus();
        }

        function closeAssignModal() { document.getElementById('assign-modal').style.display = 'none'; }

        function confirmFolioAssignment() {
            const newFolio = document.getElementById('modal-folio-input').value;
            if (newFolio && newFolio.trim() !== "") {
                document.getElementById('field-Folio').value = newFolio.trim();
                document.getElementById('field-Estatus').value = "Entregado";
                syncHeader();
                closeAssignModal();
                handleSave();
            }
        }

        async function handleSave() {
            const btn = document.getElementById('btn-save');
            const loader = document.getElementById('loading-overlay');
            const payload = {
                "Folio": document.getElementById('field-Folio').value,
                "Estatus": document.getElementById('field-Estatus').value,
                "Marca": document.getElementById('field-Marca').value,
                "Modelo": document.getElementById('field-Modelo').value,
                "Color": document.getElementById('field-Color').value,
                "Placas": document.getElementById('field-Placas').value,
                "Tipo de motor": document.getElementById('field-Tipo de motor').value,
                "Tipo": document.getElementById('field-Tipo').value,
                "Nombre": document.getElementById('field-Nombre').value,
                "No de socio": document.getElementById('field-No de socio').value,
                "Teléfono": document.getElementById('field-Teléfono').value,
                "Correo": document.getElementById('field-Correo').value,
                "Puesto": document.getElementById('field-Puesto').value,
                "Area": document.getElementById('field-Area').value,
                "Negocio": document.getElementById('field-Negocio').value,
                "Comentario": document.getElementById('field-Comentario').value,
                "IDFila": document.getElementById('field-IDFila').value,
                "Fecha de solicitud": originalItem["Fecha de solicitud"],
                "Fecha de asignación": originalItem["Fecha de asignación"]
            };

            if (!payload.IDFila) return;
            loader.style.display = 'flex';
            btn.disabled = true;

            try {
                const response = await fetch(SAVE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                loader.style.display = 'none';
                btn.disabled = false;
                btn.innerText = "¡SINCRONIZADO!";
                btn.classList.replace('bg-slate-900', 'bg-emerald-600');
                window.parent.postMessage({ type: 'MARBETE_SAVED_SUCCESS', data: payload }, '*');
                setTimeout(() => {
                    btn.innerText = "Sincronizar Cambios";
                    btn.classList.replace('bg-emerald-600', 'bg-slate-900');
                }, 3000);
            } catch (err) {
                loader.style.display = 'none';
                btn.disabled = false;
                alert("Error al actualizar.");
            }
        }

        window.onload = () => { window.parent.postMessage({ type: 'DETAIL_IFRAME_READY' }, '*'); };
        document.getElementById('modal-folio-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') confirmFolioAssignment(); });
    </script>
</body>
</html>