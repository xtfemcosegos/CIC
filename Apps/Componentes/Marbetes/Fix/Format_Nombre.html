<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .metallic-green-gradient { background: linear-gradient(145deg, #10b981, #064e3b); }
        .console-box {
            background: #020617;
            font-family: 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', monospace;
            height: calc(100vh - 320px);
            min-height: 300px;
        }
        .console-line { border-left: 2px solid #10b981; padding-left: 12px; margin-bottom: 4px; }
        .console-error { border-color: #ef4444; color: #f87171; }
        .console-success { border-color: #22c55e; color: #4ade80; }
        .console-info { border-color: #3b82f6; color: #60a5fa; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
    </style>
</head>
<body class="p-6 bg-slate-50 antialiased font-sans">

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h2 class="text-xl font-black text-emerald-900 uppercase leading-none">Corrector de Estilo: Nombres</h2>
            <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest mt-1">Auditoría de Capitalización, Espacios y Acentuación</p>
        </div>
        
        <div class="flex gap-2 w-full md:w-auto">
            <button id="btn-scan" class="flex-1 md:flex-none flex items-center justify-center gap-3 px-6 py-2.5 bg-white border border-emerald-200 text-emerald-700 rounded-xl font-black text-xs uppercase shadow-sm hover:bg-emerald-50 transition-all active:scale-95 disabled:opacity-50">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                Escanear Errores
            </button>
            <button id="btn-fix-all" disabled class="flex-1 md:flex-none flex items-center justify-center gap-3 px-8 py-2.5 metallic-green-gradient text-white rounded-xl font-black text-xs uppercase shadow-lg shadow-emerald-100 hover:scale-[1.02] transition-all active:scale-95 disabled:opacity-50 disabled:grayscale">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                Corregir Todo
            </button>
        </div>
    </div>

    <!-- Panel de Resultados Rápidos -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
            <span class="block text-[9px] font-black text-slate-400 uppercase tracking-widest">Documentos Analizados</span>
            <span id="stat-docs" class="text-2xl font-black text-slate-700">0</span>
        </div>
        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
            <span class="block text-[9px] font-black text-slate-400 uppercase tracking-widest">Nombres Revisados</span>
            <span id="stat-names" class="text-2xl font-black text-slate-700">0</span>
        </div>
        <div class="bg-rose-50 p-4 rounded-2xl border border-rose-100 shadow-sm">
            <span class="block text-[9px] font-black text-rose-400 uppercase tracking-widest">Errores Detectados</span>
            <span id="stat-errors" class="text-2xl font-black text-rose-600">0</span>
        </div>
    </div>

    <!-- Consola de Proceso -->
    <div class="bg-slate-900 rounded-3xl shadow-2xl overflow-hidden border border-slate-800">
        <div class="px-6 py-3 bg-slate-800 border-b border-slate-700 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-red-500"></div>
                <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                <span class="ml-2 text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Terminal de Mantenimiento</span>
            </div>
            <button id="btn-clear" class="text-[9px] font-black text-slate-500 hover:text-white uppercase">Limpiar Consola</button>
        </div>
        <div id="console" class="console-box p-6 overflow-y-auto custom-scroll text-[11px] text-emerald-400/90 leading-relaxed">
            <div class="console-line">Esperando instrucciones...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279"
        };

        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'cic.pp';

        const consoleEl = document.getElementById('console');
        const btnScan = document.getElementById('btn-scan');
        const btnFix = document.getElementById('btn-fix-all');
        const btnClear = document.getElementById('btn-clear');

        let documentsToUpdate = []; // Guardará { docId, itemsArrayModificado }

        function log(msg, type = '') {
            const div = document.createElement('div');
            div.className = `console-line ${type ? 'console-' + type : ''}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function toTitleCase(str) {
            return str.toLowerCase().split(' ').map(word => {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }

        function cleanName(name) {
            if (!name) return "";
            // 1. Quitar espacios extremos y dobles espacios internos
            let cleaned = name.trim().replace(/\s+/g, ' ');
            // 2. Aplicar Capitalización de Títulos
            cleaned = toTitleCase(cleaned);
            return cleaned;
        }

        async function scanData() {
            log("Iniciando escaneo de base de datos...", "info");
            btnScan.disabled = true;
            documentsToUpdate = [];
            let totalNames = 0;
            let totalErrors = 0;

            try {
                const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Marbetes'));
                document.getElementById('stat-docs').textContent = querySnapshot.size;

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data.items && Array.isArray(data.items)) {
                        let hasChanges = false;
                        const newItems = data.items.map(item => {
                            totalNames++;
                            const original = item.Nombre || item.Titular || "";
                            const corrected = cleanName(original);

                            if (original !== corrected) {
                                hasChanges = true;
                                totalErrors++;
                                log(`Detectado en Folio ${item.Folio || 'N/A'}: "${original}" -> <span class="text-white">"${corrected}"</span>`);
                                return { ...item, Nombre: corrected, Titular: corrected };
                            }
                            return item;
                        });

                        if (hasChanges) {
                            documentsToUpdate.push({ id: docSnap.id, items: newItems });
                        }
                    }
                });

                document.getElementById('stat-names').textContent = totalNames;
                document.getElementById('stat-errors').textContent = totalErrors;

                if (totalErrors > 0) {
                    log(`Escaneo finalizado. Se encontraron ${totalErrors} nombres que requieren corrección.`, "success");
                    btnFix.disabled = false;
                } else {
                    log("Escaneo finalizado. Todos los nombres están correctamente formateados.", "success");
                    btnFix.disabled = true;
                }

            } catch (error) {
                log(`Error durante el escaneo: ${error.message}`, "error");
            } finally {
                btnScan.disabled = false;
            }
        }

        async function fixAll() {
            if (!confirm("¿Está seguro de aplicar las correcciones? Esta acción modificará la base de datos de producción.")) return;
            
            log("Iniciando proceso de escritura en Firestore...", "info");
            btnFix.disabled = true;
            btnScan.disabled = true;

            let successCount = 0;
            let failCount = 0;

            for (const docUpdate of documentsToUpdate) {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'Marbetes', docUpdate.id);
                    await updateDoc(docRef, { items: docUpdate.items });
                    successCount++;
                    log(`Documento ${docUpdate.id} actualizado correctamente.`, "success");
                } catch (error) {
                    failCount++;
                    log(`Error al actualizar documento ${docUpdate.id}: ${error.message}`, "error");
                }
            }

            log(`Proceso completado. Exitosos: ${successCount}, Fallidos: ${failCount}`, successCount > 0 ? "success" : "error");
            
            // Reset stats
            document.getElementById('stat-errors').textContent = "0";
            documentsToUpdate = [];
            btnScan.disabled = false;
        }

        // Listeners
        btnScan.onclick = scanData;
        btnFix.onclick = fixAll;
        btnClear.onclick = () => {
            consoleEl.innerHTML = '<div class="console-line">Consola reiniciada...</div>';
        };

        onAuthStateChanged(auth, (user) => {
            if (user && !user.isAnonymous) {
                log("Sesión administrativa activa. Listo para operar.", "success");
            } else {
                log("Acceso denegado: Se requiere autenticación de administrador.", "error");
                window.top.location.href = '../../../index.html';
            }
        });
    </script>
</body>
</html>