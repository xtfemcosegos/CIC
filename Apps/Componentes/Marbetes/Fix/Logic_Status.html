<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .metallic-green-gradient { background: linear-gradient(145deg, #10b981, #064e3b); }
        .metallic-red-gradient { background: linear-gradient(145deg, #ef4444, #991b1b); }
        .console-box {
            background: #020617;
            font-family: 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', monospace;
            height: 150px;
        }
        .console-line { border-left: 2px solid #10b981; padding-left: 12px; margin-bottom: 4px; }
        .console-error { border-color: #ef4444; color: #f87171; }
        .console-success { border-color: #22c55e; color: #4ade80; }
        .console-info { border-color: #3b82f6; color: #60a5fa; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }

        .table-container { height: calc(100vh - 580px); min-height: 250px; }
        th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
        
        .kpi-tab { transition: all 0.2s; cursor: pointer; border: 2px solid #e2e8f0; }
        .kpi-tab.active { border-color: #10b981; background-color: #f0fdf4; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .kpi-tab.active .count-circle { background-color: #10b981; color: white; }
    </style>
</head>
<body class="p-6 bg-slate-50 antialiased font-sans flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <div class="flex-shrink-0 flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h2 class="text-xl font-black text-emerald-900 uppercase leading-none">Auditoría de Lógica y Estatus</h2>
            <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest mt-1">Regla: Entregado (5 Dígitos) | Inconsistencias | Bajas</p>
        </div>
        
        <div class="flex gap-2 w-full md:w-auto">
            <button id="btn-scan" class="flex-1 md:flex-none flex items-center justify-center gap-3 px-6 py-2.5 bg-white border border-emerald-200 text-emerald-700 rounded-xl font-black text-xs uppercase shadow-sm hover:bg-emerald-50 transition-all active:scale-95 disabled:opacity-50">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                Escanear
            </button>
            <button id="btn-fix-selected" disabled class="flex-1 md:flex-none flex items-center justify-center gap-3 px-6 py-2.5 metallic-green-gradient text-white rounded-xl font-black text-xs uppercase shadow-lg shadow-emerald-100 hover:scale-[1.02] transition-all active:scale-95 disabled:opacity-50 disabled:grayscale">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                Corregir Grupo
            </button>
            <button id="btn-delete-selected" disabled class="flex-1 md:flex-none flex items-center justify-center gap-3 px-6 py-2.5 metallic-red-gradient text-white rounded-xl font-black text-xs uppercase shadow-lg shadow-red-100 hover:scale-[1.02] transition-all active:scale-95 disabled:opacity-50 disabled:grayscale">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                Eliminar
            </button>
        </div>
    </div>

    <!-- Grupos de Auditoría (KPIs) -->
    <div class="flex-shrink-0 grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <!-- Inconsistencias -->
        <div onclick="setActiveGroup('logic')" id="tab-logic" class="kpi-tab active bg-white p-4 rounded-2xl flex flex-col justify-center">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Inconsistencias</span>
                <span id="stat-logic" class="count-circle bg-slate-100 text-slate-600 text-[10px] font-black px-2 py-0.5 rounded-full transition-all">0</span>
            </div>
            <p class="text-[8px] text-slate-400 font-bold uppercase leading-tight">Estatus vs Folio</p>
        </div>

        <!-- Menos de 5 dígitos -->
        <div onclick="setActiveGroup('short')" id="tab-short" class="kpi-tab bg-white p-4 rounded-2xl flex flex-col justify-center">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Menos de 5 Dígitos</span>
                <span id="stat-short" class="count-circle bg-slate-100 text-slate-600 text-[10px] font-black px-2 py-0.5 rounded-full transition-all">0</span>
            </div>
            <p class="text-[8px] text-slate-400 font-bold uppercase leading-tight">Corrección a Baja</p>
        </div>

        <!-- Más de 5 dígitos -->
        <div onclick="setActiveGroup('long')" id="tab-long" class="kpi-tab bg-white p-4 rounded-2xl flex flex-col justify-center">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Más de 5 Dígitos</span>
                <span id="stat-long" class="count-circle bg-slate-100 text-slate-600 text-[10px] font-black px-2 py-0.5 rounded-full transition-all">0</span>
            </div>
            <p class="text-[8px] text-slate-400 font-bold uppercase leading-tight">Revisión Manual</p>
        </div>

        <!-- Opción Incluir Bajas -->
        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-3">
            <input type="checkbox" id="check-include-baja" class="w-5 h-5 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer">
            <div>
                <label for="check-include-baja" class="block text-[10px] font-black text-slate-700 uppercase cursor-pointer">Incluir Bajas</label>
                <p class="text-[8px] text-slate-400 font-bold uppercase">Auditar registros inactivos</p>
            </div>
        </div>
    </div>

    <!-- Lista de Registros -->
    <div class="flex-1 bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden mb-6 flex flex-col">
        <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
            <h3 id="table-title" class="text-xs font-black text-emerald-900 uppercase tracking-widest">Lista: Inconsistencias</h3>
            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="checkbox" id="select-all" class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer">
                    <span class="text-[10px] font-bold text-slate-500 uppercase group-hover:text-emerald-600 transition-colors">Seleccionar Todo</span>
                </label>
            </div>
        </div>
        <div class="table-container overflow-y-auto custom-scroll">
            <table class="w-full text-left text-[11px]">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-100">
                        <th class="px-6 py-3 w-10"></th>
                        <th class="px-6 py-3 font-black text-slate-400 uppercase tracking-tighter">Socio / Nombre</th>
                        <th class="px-6 py-3 font-black text-slate-400 uppercase tracking-tighter">Folio Actual</th>
                        <th class="px-6 py-3 font-black text-slate-400 uppercase tracking-tighter">Estatus Actual</th>
                        <th class="px-6 py-3 font-black text-slate-400 uppercase tracking-tighter">Sugerencia</th>
                        <th class="px-6 py-3 font-black text-slate-400 uppercase tracking-tighter text-right">Acción</th>
                    </tr>
                </thead>
                <tbody id="error-list" class="divide-y divide-slate-50">
                    <tr>
                        <td colspan="6" class="px-6 py-20 text-center">
                            <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px]">Inicia el escaneo de auditoría</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Consola -->
    <div class="flex-shrink-0 bg-slate-900 rounded-3xl shadow-2xl overflow-hidden border border-slate-800">
        <div class="px-6 py-3 bg-slate-800 border-b border-slate-700 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-red-500"></div>
                <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                <span class="ml-2 text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Terminal de Lógica</span>
            </div>
            <button id="btn-clear" class="text-[9px] font-black text-slate-500 hover:text-white uppercase">Limpiar</button>
        </div>
        <div id="console" class="console-box p-6 overflow-y-auto custom-scroll text-[11px] text-emerald-400/90 leading-relaxed">
            <div class="console-line">Esperando instrucciones...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279"
        };

        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'cic.pp';

        const consoleEl = document.getElementById('console');
        const btnScan = document.getElementById('btn-scan');
        const btnFix = document.getElementById('btn-fix-selected');
        const btnDelete = document.getElementById('btn-delete-selected');
        const errorList = document.getElementById('error-list');
        const selectAll = document.getElementById('select-all');
        const includeBajaCheck = document.getElementById('check-include-baja');

        let groups = {
            logic: [],
            short: [],
            long: []
        };
        let activeGroupKey = 'logic';

        function log(msg, type = '') {
            const div = document.createElement('div');
            div.className = `console-line ${type ? 'console-' + type : ''}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        const normalize = (s) => String(s || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

        const hasRealFolio = (f) => {
            const val = normalize(f);
            return val !== "" && val !== "---" && val !== "0" && val !== "sin folio" && val !== "n/a" && val !== "null";
        };

        async function scanData() {
            log("Iniciando auditoría general de base de datos...", "info");
            btnScan.disabled = true;
            groups = { logic: [], short: [], long: [] };
            errorList.innerHTML = '<tr><td colspan="6" class="p-10 text-center"><div class="animate-spin w-6 h-6 border-2 border-emerald-500 border-t-transparent rounded-full mx-auto"></div></td></tr>';
            
            const includeBaja = includeBajaCheck.checked;

            try {
                const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Marbetes'));
                
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data.items && Array.isArray(data.items)) {
                        data.items.forEach((item, index) => {
                            const folioRaw = String(item.Folio || "").trim();
                            const estatusRaw = String(item.Estatus || item.Estado || "").trim();
                            const estatusNorm = normalize(estatusRaw);
                            const hasFolio = hasRealFolio(folioRaw);
                            const folioLen = hasFolio ? folioRaw.length : 0;
                            
                            const commonData = {
                                docId: docSnap.id,
                                itemIndex: index,
                                item: item,
                                selected: true,
                                folioDigits: folioLen
                            };

                            // Categorización por Longitud
                            if (hasFolio && folioLen < 5) {
                                groups.short.push({
                                    ...commonData,
                                    suggestedStatus: "Baja",
                                    suggestedFolio: folioRaw,
                                    reason: `Folio corto (${folioLen} dígs)`
                                });
                            } else if (hasFolio && folioLen > 5) {
                                groups.long.push({
                                    ...commonData,
                                    suggestedStatus: estatusRaw,
                                    suggestedFolio: folioRaw,
                                    reason: `Folio largo (${folioLen} dígs)`
                                });
                            }

                            // Categorización por Lógica (Si no está en Baja y no queremos incluir bajas, saltamos)
                            if (estatusNorm === "baja" && !includeBaja) return;

                            let logicError = false;
                            let sugStatus = estatusRaw;
                            let sugReason = "";

                            if (estatusNorm === "sin folio") {
                                logicError = true;
                                sugStatus = "Pendiente";
                                sugReason = "Estatus 'Sin Folio' -> Pendiente";
                            } else if (estatusNorm === "entregado" && !hasFolio) {
                                logicError = true;
                                sugStatus = "Pendiente";
                                sugReason = "Entregado pero NO tiene folio";
                            } else if (estatusNorm === "pendiente" && hasFolio) {
                                logicError = true;
                                sugStatus = "Entregado";
                                sugReason = "Pendiente pero TIENE folio";
                            } else if (estatusNorm !== "" && !["entregado", "pendiente", "baja"].includes(estatusNorm)) {
                                logicError = true;
                                sugStatus = "Pendiente";
                                sugReason = "Estatus inválido";
                            }

                            if (logicError) {
                                groups.logic.push({
                                    ...commonData,
                                    suggestedStatus: sugStatus,
                                    suggestedFolio: folioRaw,
                                    reason: sugReason
                                });
                            }
                        });
                    }
                });

                updateKPIs();
                renderErrors();
                log(`Escaneo finalizado. Inconsistencias: ${groups.logic.length}, Cortos: ${groups.short.length}, Largos: ${groups.long.length}`, "success");

            } catch (error) {
                log(`Error: ${error.message}`, "error");
            } finally {
                btnScan.disabled = false;
                updateSelectedCount();
            }
        }

        function updateKPIs() {
            document.getElementById('stat-logic').textContent = groups.logic.length;
            document.getElementById('stat-short').textContent = groups.short.length;
            document.getElementById('stat-long').textContent = groups.long.length;
        }

        window.setActiveGroup = (key) => {
            activeGroupKey = key;
            document.querySelectorAll('.kpi-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${key}`).classList.add('active');
            
            const titles = { logic: 'Lista: Inconsistencias', short: 'Lista: Menos de 5 Dígitos', long: 'Lista: Más de 5 Dígitos' };
            document.getElementById('table-title').textContent = titles[key];
            
            renderErrors();
            updateSelectedCount();
        };

        function renderErrors() {
            const list = groups[activeGroupKey];
            
            if (list.length === 0) {
                errorList.innerHTML = '<tr><td colspan="6" class="px-6 py-20 text-center"><p class="text-emerald-600 font-bold uppercase tracking-widest text-[10px]">No se encontraron registros en este grupo</p></td></tr>';
                return;
            }

            errorList.innerHTML = list.map((err, idx) => `
                <tr class="hover:bg-slate-50 transition-all group">
                    <td class="px-6 py-3">
                        <input type="checkbox" ${err.selected ? 'checked' : ''} onchange="toggleItem(${idx})" class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer">
                    </td>
                    <td class="px-6 py-3">
                        <div class="font-black text-slate-400 text-[9px] uppercase">${err.item["No de socio"] || 'N/A'}</div>
                        <div class="font-bold text-slate-700 uppercase">${err.item.Nombre || '---'}</div>
                    </td>
                    <td class="px-6 py-3">
                        <div class="font-mono font-bold text-emerald-800">${err.item.Folio || '---'}</div>
                        <div class="text-[8px] font-black ${err.folioDigits !== 5 && err.folioDigits > 0 ? 'text-rose-500' : 'text-slate-400'} uppercase">${err.folioDigits} DÍGITOS</div>
                    </td>
                    <td class="px-6 py-3">
                        <span class="px-2 py-0.5 bg-rose-100 text-rose-700 rounded text-[9px] font-black uppercase">${err.item.Estatus || err.item.Estado || '---'}</span>
                        <div class="text-[8px] text-rose-400 font-bold mt-1 uppercase">${err.reason}</div>
                    </td>
                    <td class="px-6 py-3">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-[9px] font-black uppercase">${err.suggestedStatus}</span>
                            <svg class="w-3 h-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M14 5l7 7m0 0l-7 7m7-7H3" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            <span class="font-mono font-bold text-emerald-600">${err.suggestedFolio}</span>
                        </div>
                    </td>
                    <td class="px-6 py-3 text-right">
                        <button onclick="viewDetail(${idx})" class="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg font-black text-[9px] uppercase hover:bg-emerald-600 hover:text-white transition-all">Detalle</button>
                    </td>
                </tr>
            `).join('');
        }

        window.toggleItem = (idx) => {
            groups[activeGroupKey][idx].selected = !groups[activeGroupKey][idx].selected;
            updateSelectedCount();
        };

        window.viewDetail = (idx) => {
            const data = groups[activeGroupKey][idx].item;
            window.parent.__CURRENT_MARBETE = data;
            if (typeof window.parent.Navegar_Marbetes === 'function') window.parent.Navegar_Marbetes('Detalle_Marbete');
            else window.parent.postMessage({ type: 'OPEN_MARBETE_DETAIL', data: data }, '*');
        };

        function updateSelectedCount() {
            const currentList = groups[activeGroupKey];
            const count = currentList.filter(e => e.selected).length;
            document.getElementById('stat-selected').textContent = count;
            
            const hasSelection = count > 0;
            btnFix.disabled = !hasSelection || activeGroupKey === 'long'; // No auto-fix para largos
            btnDelete.disabled = !hasSelection;
            selectAll.checked = count === currentList.length && count > 0;

            // Actualizar etiqueta del botón de corrección
            btnFix.innerHTML = activeGroupKey === 'logic' ? 
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Corregir Lógica' : 
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Mover a Baja';
        }

        selectAll.onchange = () => {
            const state = selectAll.checked;
            groups[activeGroupKey].forEach(e => e.selected = state);
            renderErrors();
            updateSelectedCount();
        };

        async function fixSelected() {
            const selected = groups[activeGroupKey].filter(e => e.selected);
            const msg = activeGroupKey === 'logic' ? 
                `¿Aplicar correcciones lógicas a ${selected.length} registros?` : 
                `¿Mover ${selected.length} registros con folios cortos a estatus 'Baja'?`;

            if (!confirm(msg)) return;

            log(`Procesando correcciones para grupo ${activeGroupKey}...`, "info");
            btnFix.disabled = true; btnDelete.disabled = true; btnScan.disabled = true;

            const updatesByDoc = {};
            selected.forEach(err => {
                if (!updatesByDoc[err.docId]) updatesByDoc[err.docId] = [];
                updatesByDoc[err.docId].push(err);
            });

            let successCount = 0;

            for (const docId in updatesByDoc) {
                try {
                    const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Marbetes'));
                    const docSnap = querySnapshot.docs.find(d => d.id === docId);
                    if (docSnap) {
                        const items = [...docSnap.data().items];
                        updatesByDoc[docId].forEach(err => {
                            items[err.itemIndex].Estatus = err.suggestedStatus;
                            items[err.itemIndex].Estado = err.suggestedStatus;
                            items[err.itemIndex].Folio = err.suggestedFolio;
                        });
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Marbetes', docId), { items: items });
                        successCount += updatesByDoc[docId].length;
                    }
                } catch (e) {
                    log(`Error en Doc ${docId}: ${e.message}`, "error");
                }
            }

            log(`Éxito: ${successCount} registros actualizados.`, "success");
            scanData();
        }

        async function deleteSelected() {
            const selected = groups[activeGroupKey].filter(e => e.selected);
            if (!confirm(`¿ELIMINAR ${selected.length} registros definitivamente del grupo actual?`)) return;

            log(`Borrando registros seleccionados...`, "error");
            btnFix.disabled = true; btnDelete.disabled = true; btnScan.disabled = true;

            const deletionsByDoc = {};
            selected.forEach(err => {
                if (!deletionsByDoc[err.docId]) deletionsByDoc[err.docId] = [];
                deletionsByDoc[err.docId].push(err.itemIndex);
            });

            let successCount = 0;

            for (const docId in deletionsByDoc) {
                try {
                    const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Marbetes'));
                    const docSnap = querySnapshot.docs.find(d => d.id === docId);
                    if (docSnap) {
                        const originalItems = docSnap.data().items;
                        const indicesToDelete = deletionsByDoc[docId];
                        const newItems = originalItems.filter((_, index) => !indicesToDelete.includes(index));
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'Marbetes', docId), { items: newItems });
                        successCount += indicesToDelete.length;
                    }
                } catch (e) {
                    log(`Error en Doc ${docId}: ${e.message}`, "error");
                }
            }

            log(`Borrados: ${successCount} registros.`, "info");
            scanData();
        }

        btnScan.onclick = scanData;
        btnFix.onclick = fixSelected;
        btnDelete.onclick = deleteSelected;
        document.getElementById('btn-clear').onclick = () => { consoleEl.innerHTML = '<div class="console-line">Consola limpia.</div>'; };

        onAuthStateChanged(auth, (user) => {
            if (user && !user.isAnonymous) log("Sistema de auditoría de lógica activo.", "success");
            else window.top.location.href = '../../../index.html';
        });
    </script>
</body>
</html>