<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería SheetJS para exportación real a Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        .metallic-green-gradient { background: linear-gradient(145deg, #10b981, #064e3b); }
        .table-container { height: calc(100vh - 240px); }
        th { cursor: pointer; user-select: none; position: sticky; top: 0; background: #f8fafc; z-index: 10; }
        th:hover { background-color: #f1f5f9; color: #059669; }
        
        /* Estilo de scroll esmeralda */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        
        .kpi-card { transition: all 0.2s ease; cursor: pointer; border: 2px solid transparent; }
        .kpi-card.active { border-color: #10b981; background-color: #f0fdf4; }
    </style>
</head>
<body class="p-6 bg-slate-50 antialiased font-sans">

    <!-- Header de Configuración -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h2 class="text-xl font-black text-emerald-900 uppercase leading-none">Exportador de Marbetes</h2>
            <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest mt-1">Reportes basados en Base de Datos CIC-6 v14.1</p>
        </div>
        
        <div class="flex gap-2 w-full md:w-auto">
            <button id="btn-refresh" class="p-2.5 bg-white border border-slate-200 text-slate-400 hover:text-emerald-600 rounded-xl transition-all shadow-sm" title="Sincronizar">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button id="btn-export" class="flex-1 md:flex-none flex items-center justify-center gap-3 px-8 py-2.5 metallic-green-gradient text-white rounded-xl font-black text-xs uppercase shadow-lg shadow-emerald-100 hover:scale-[1.02] transition-all active:scale-95 disabled:opacity-50">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Generar Reporte Completo
            </button>
        </div>
    </div>

    <!-- Filtros Inteligentes -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
        <!-- Buscador -->
        <div class="md:col-span-5 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
            <label class="block text-[9px] font-black text-slate-400 uppercase mb-2 tracking-widest">Buscador Global</label>
            <div class="relative">
                <input type="text" id="search-input" placeholder="Nombre, Socio, Folio o Placas..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-100 rounded-xl text-xs focus:ring-2 focus:ring-emerald-500 outline-none transition-all uppercase">
                <svg class="w-4 h-4 absolute left-3 top-2.5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
        </div>

        <!-- Filtro de Fecha -->
        <div class="md:col-span-4 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
            <label class="block text-[9px] font-black text-slate-400 uppercase mb-2 tracking-widest">Rango de Fechas</label>
            <div class="flex items-center gap-2">
                <select id="date-type" class="bg-slate-50 border border-slate-100 rounded-lg text-[10px] font-bold px-2 py-2 outline-none">
                    <option value="Fecha de solicitud">Solicitud</option>
                    <option value="Fecha de asignación">Asignación</option>
                </select>
                <input type="date" id="date-start" class="bg-slate-50 border border-slate-100 rounded-lg text-[10px] px-2 py-1.5 outline-none flex-1">
                <input type="date" id="date-end" class="bg-slate-50 border border-slate-100 rounded-lg text-[10px] px-2 py-1.5 outline-none flex-1">
            </div>
        </div>

        <!-- KPI Rápido -->
        <div class="md:col-span-3 bg-emerald-900 p-4 rounded-2xl shadow-inner flex flex-col justify-center text-center">
            <span id="record-count" class="text-xl font-black text-white leading-none">0</span>
            <span class="text-[8px] font-bold text-emerald-400 uppercase tracking-widest mt-1">Registros Filtrados</span>
        </div>
    </div>

    <!-- Filtros de Estatus -->
    <div class="flex gap-3 mb-6 overflow-x-auto no-scrollbar pb-2">
        <div onclick="setStatusFilter('Todos')" class="kpi-card active bg-white p-3 px-6 rounded-xl border-slate-200 shadow-sm min-w-[120px]" data-status="Todos">
            <span class="block text-[10px] font-black text-slate-400 uppercase">Todos</span>
            <span id="stat-all" class="text-lg font-black text-emerald-900">0</span>
        </div>
        <div onclick="setStatusFilter('Sin folio')" class="kpi-card bg-white p-3 px-6 rounded-xl border-slate-200 shadow-sm min-w-[120px]" data-status="Sin folio">
            <span class="block text-[10px] font-black text-slate-400 uppercase">Sin Folio</span>
            <span id="stat-nofolio" class="text-lg font-black text-slate-600">0</span>
        </div>
        <div onclick="setStatusFilter('Pendiente')" class="kpi-card bg-white p-3 px-6 rounded-xl border-slate-200 shadow-sm min-w-[120px]" data-status="Pendiente">
            <span class="block text-[10px] font-black text-slate-400 uppercase">Pendientes</span>
            <span id="stat-pending" class="text-lg font-black text-amber-600">0</span>
        </div>
        <div onclick="setStatusFilter('Entregado')" class="kpi-card bg-white p-3 px-6 rounded-xl border-slate-200 shadow-sm min-w-[120px]" data-status="Entregado">
            <span class="block text-[10px] font-black text-slate-400 uppercase">Entregados</span>
            <span id="stat-delivered" class="text-lg font-black text-emerald-600">0</span>
        </div>
        <div onclick="setStatusFilter('Baja')" class="kpi-card bg-white p-3 px-6 rounded-xl border-slate-200 shadow-sm min-w-[120px]" data-status="Baja">
            <span class="block text-[10px] font-black text-slate-400 uppercase">Bajas</span>
            <span id="stat-baja" class="text-lg font-black text-rose-600">0</span>
        </div>
    </div>

    <!-- Tabla de Previsualización -->
    <div class="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden relative">
        <div class="table-container overflow-auto custom-scroll">
            <table class="w-full text-left text-[11px]" id="preview-table">
                <thead>
                    <tr class="border-b border-slate-100">
                        <th onclick="sortTable('Folio')" class="px-6 py-4 font-black text-slate-400 uppercase tracking-tighter">Folio</th>
                        <th onclick="sortTable('No de socio')" class="px-6 py-4 font-black text-slate-400 uppercase tracking-tighter">Socio</th>
                        <th onclick="sortTable('Nombre')" class="px-6 py-4 font-black text-slate-400 uppercase tracking-tighter">Nombre</th>
                        <th onclick="sortTable('Marca')" class="px-6 py-4 font-black text-slate-400 uppercase tracking-tighter">Marca / Modelo</th>
                        <th onclick="sortTable('Negocio')" class="px-6 py-4 font-black text-slate-400 uppercase tracking-tighter">Negocio / Área</th>
                        <th onclick="sortTable('Fecha de solicitud')" class="px-6 py-4 font-black text-slate-400 uppercase tracking-tighter">Solicitud</th>
                        <th onclick="sortTable('Estatus')" class="px-6 py-4 font-black text-slate-400 uppercase tracking-tighter">Estatus</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-50">
                    <!-- Registros Inyectados -->
                </tbody>
            </table>
            
            <div id="loading-overlay" class="flex flex-col items-center justify-center p-20">
                <div class="w-10 h-10 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Procesando Base de Datos...</p>
            </div>
        </div>
        <!-- Aviso de Renderizado Limitado para optimización -->
        <div id="render-limit-warning" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-slate-900/80 text-white text-[9px] font-black rounded-full backdrop-blur-sm z-20 uppercase tracking-widest">
            Mostrando solo los primeros 100 resultados para mayor fluidez. El Excel incluirá todo.
        </div>
    </div>

    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279"
        };

        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'cic.pp';

        let allData = [];
        let displayData = [];
        let currentKpiFilter = "Todos";
        let sortState = { col: null, dir: 'asc' };
        let filterTimeout = null;

        function excelToDate(val) {
            if (!val || isNaN(val) || typeof val === 'string') return val;
            try {
                const date = new Date(Math.round((val - 25569) * 86400 * 1000));
                const adjusted = new Date(date.getTime() + (6 * 60 * 60 * 1000));
                const dd = String(adjusted.getDate()).padStart(2, '0');
                const mm = String(adjusted.getMonth() + 1).padStart(2, '0');
                return `${dd}/${mm}/${adjusted.getFullYear()}`;
            } catch (e) { return val; }
        }

        const normalize = (str) => String(str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

        async function fetchData() {
            const loader = document.getElementById('loading-overlay');
            const btnExport = document.getElementById('btn-export');
            loader.classList.remove('hidden');
            btnExport.disabled = true;

            try {
                const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'Marbetes'));
                allData = [];
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.items && Array.isArray(data.items)) {
                        data.items.forEach(item => {
                            allData.push({
                                "Fecha de solicitud": excelToDate(item["Fecha de solicitud"]),
                                "Fecha de asignación": excelToDate(item["Fecha de asignación"]),
                                "Folio": item.Folio || '---',
                                "Tipo": item.Tipo || '---',
                                "Estatus": item.Estatus || item.Estado || '---',
                                "Marca": item.Marca || '---',
                                "Modelo": item.Modelo || '---',
                                "Color": item.Color || '---',
                                "Placas": item.Placas || '---',
                                "No de socio": item["No de socio"] || item.Socio || '---',
                                "Nombre": item.Nombre || item.Titular || '---',
                                "Teléfono": item.Teléfono || '---',
                                "TelVerif": item.TelVerif || '---',
                                "Correo": item.Correo || '---',
                                "CorreoVerif": item.CorreoVerif || '---',
                                "Foto": item.Foto || '---',
                                "Puesto": item.Puesto || '---',
                                "Area": item.Area || '---',
                                "Negocio": item.Negocio || '---',
                                "Comentario": item.Comentario || '---',
                                "Tipo de motor": item["Tipo de motor"] || '---',
                                "IDFila": item.IDFila || item.__partId || '---'
                            });
                        });
                    }
                });

                updateStats();
                applyFilters();
            } catch (e) {
                console.error("Error Firestore:", e);
                if (e.code === 'permission-denied') window.top.location.href = '../../../index.html';
            } finally {
                loader.classList.add('hidden');
                btnExport.disabled = false;
            }
        }

        function updateStats() {
            const getLen = (s) => allData.filter(d => normalize(d.Estatus) === normalize(s)).length;
            document.getElementById('stat-all').innerText = allData.length;
            document.getElementById('stat-nofolio').innerText = getLen('Sin folio');
            document.getElementById('stat-pending').innerText = getLen('Pendiente');
            document.getElementById('stat-delivered').innerText = getLen('Entregado');
            document.getElementById('stat-baja').innerText = getLen('Baja');
        }

        window.setStatusFilter = (s) => {
            currentKpiFilter = s;
            document.querySelectorAll('.kpi-card').forEach(c => {
                c.classList.toggle('active', c.dataset.status === s);
            });
            applyFilters();
        };

        // Optimización: Debounce para evitar bloqueos mientras el usuario escribe
        window.applyFilters = () => {
            if (filterTimeout) clearTimeout(filterTimeout);
            filterTimeout = setTimeout(processFilters, 250);
        };

        function processFilters() {
            const query = normalize(document.getElementById('search-input').value);
            const dateType = document.getElementById('date-type').value;
            const startVal = document.getElementById('date-start').value;
            const endVal = document.getElementById('date-end').value;
            
            const startLimit = startVal ? new Date(startVal + "T00:00:00") : null;
            const endLimit = endVal ? new Date(endVal + "T23:59:59") : null;

            displayData = allData.filter(item => {
                // 1. Estatus
                if (currentKpiFilter !== "Todos" && normalize(item.Estatus) !== normalize(currentKpiFilter)) return false;

                // 2. Fecha
                if (startLimit || endLimit) {
                    const val = item[dateType];
                    if (val && typeof val === 'string' && val.includes('/')) {
                        const [d, m, y] = val.split('/').map(Number);
                        const itemDate = new Date(y, m - 1, d);
                        if (startLimit && itemDate < startLimit) return false;
                        if (endLimit && itemDate > endLimit) return false;
                    } else return false;
                }

                // 3. Búsqueda
                if (!query) return true;
                const haystack = normalize(`${item.Folio} ${item["No de socio"]} ${item.Nombre} ${item.Placas} ${item.Marca} ${item.Negocio}`);
                return haystack.includes(query);
            });

            render();
        }

        function render() {
            const tbody = document.getElementById('table-body');
            const warning = document.getElementById('render-limit-warning');
            tbody.innerHTML = '';
            document.getElementById('record-count').textContent = displayData.length;

            // Optimización Crítica: Solo renderizar los primeros 100 resultados en el DOM
            const sliceToRender = displayData.slice(0, 100);
            warning.classList.toggle('hidden', displayData.length <= 100);

            sliceToRender.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-all";
                
                const status = normalize(item.Estatus);
                const badgeClass = status === 'entregado' ? 'bg-emerald-100 text-emerald-700' : 
                                  status === 'pendiente' ? 'bg-amber-100 text-amber-700' : 
                                  status === 'baja' ? 'bg-rose-100 text-rose-700' : 'bg-slate-100 text-slate-500';

                tr.innerHTML = `
                    <td class="px-6 py-3 font-black text-emerald-800">${item.Folio}</td>
                    <td class="px-6 py-3 font-bold text-slate-400">${item["No de socio"]}</td>
                    <td class="px-6 py-3 font-bold text-slate-700 uppercase">${item.Nombre}</td>
                    <td class="px-6 py-3 text-slate-500">
                        <span class="font-bold">${item.Marca}</span><br>
                        <span class="text-[9px] opacity-60 italic">${item.Modelo} (${item.Color})</span>
                    </td>
                    <td class="px-6 py-3 text-[10px] text-slate-500 font-medium">
                        ${item.Negocio}<br><span class="text-[9px] opacity-60 font-black uppercase tracking-tighter">${item.Area}</span>
                    </td>
                    <td class="px-6 py-3 text-slate-400 font-mono">${item["Fecha de solicitud"]}</td>
                    <td class="px-6 py-3">
                        <span class="px-2 py-0.5 rounded-md text-[8px] font-black uppercase ${badgeClass}">${item.Estatus}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.sortTable = (key) => {
            const dir = (sortState.col === key && sortState.dir === 'asc') ? 'desc' : 'asc';
            sortState = { col: key, dir };

            displayData.sort((a, b) => {
                let valA = normalize(a[key]);
                let valB = normalize(b[key]);
                return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            });
            render();
        };

        document.getElementById('btn-export').onclick = () => {
            if (displayData.length === 0) return;

            // Mapeo exacto de los encabezados solicitados
            const excelRows = displayData.map(item => ({
                "Fecha de solicitud": item["Fecha de solicitud"],
                "Fecha de asignación": item["Fecha de asignación"],
                "Folio": item.Folio,
                "Tipo": item.Tipo,
                "Estatus": item.Estatus,
                "Marca": item.Marca,
                "Modelo": item.Modelo,
                "Color": item.Color,
                "Placas": item.Placas,
                "No de socio": item["No de socio"],
                "Nombre": item.Nombre,
                "Teléfono": item.Teléfono,
                "TelVerif": item.TelVerif,
                "Correo": item.Correo,
                "CorreoVerif": item.CorreoVerif,
                "Foto": item.Foto,
                "Puesto": item.Puesto,
                "Area": item.Area,
                "Negocio": item.Negocio,
                "Comentario": item.Comentario,
                "Tipo de motor": item["Tipo de motor"],
                "IDFila": item.IDFila
            }));

            const ws = XLSX.utils.json_to_sheet(excelRows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte_Completo");
            
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Reporte_Marbetes_CIC_${dateStr}.xlsx`);
        };

        document.getElementById('search-input').oninput = applyFilters;
        document.getElementById('date-start').onchange = applyFilters;
        document.getElementById('date-end').onchange = applyFilters;
        document.getElementById('date-type').onchange = applyFilters;
        document.getElementById('btn-refresh').onclick = fetchData;

        onAuthStateChanged(auth, (user) => { 
            if (user && !user.isAnonymous) fetchData(); 
            else window.top.location.href = '../../../index.html';
        });
    </script>
</body>
</html>