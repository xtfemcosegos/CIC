<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIC6 - RegAs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Paleta Fiusha Muy Oscuro Metálico */
            --metal-fuchsia-dark: #2d0630;
            --metal-fuchsia-mid: #4a044e;
            --metal-fuchsia-light: #701a75;
            
            --md-primary: #4a044e;
            --md-surface: #ffffff;
            --md-background: #e2e8f0;
            --md-outline: #cbd5e1;
            --ribbon-height: 44px;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--md-background);
            overflow: hidden;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #1f1a1a;
            display: flex;
            flex-direction: column;
            align-items: center; 
        }

        /* --- HEADER PEGADO ARRIBA Y AL 100% --- */
        .header-card {
            position: relative;
            width: 100%;
            height: 52px;
            margin-top: 0;
            background: linear-gradient(135deg, var(--metal-fuchsia-dark) 0%, var(--metal-fuchsia-mid) 50%, var(--metal-fuchsia-light) 100%);
            background-size: 100% 100%;
            border-radius: 0; 
            display: flex;
            align-items: center;
            padding: 0 24px;
            color: white;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 50;
        }

        .header-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(circle, rgba(255,255,255,0.03) 0.5px, transparent 0.5px),
                linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 4px 4px, 12px 12px;
            opacity: 0.5;
            pointer-events: none;
        }

        .header-tabs {
            display: flex;
            height: 100%;
            margin-left: 20px;
        }

        .header-tab {
            padding: 0 20px;
            display: flex;
            align-items: center;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255,255,255,0.4);
            transition: all 0.3s;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .header-tab:hover { color: white; background: rgba(255,255,255,0.05); }
        .header-tab.active {
            color: white;
            border-bottom-color: #f472b6;
            background: rgba(255,255,255,0.08);
        }

        /* --- TOOL RIBBON --- */
        .tool-ribbon {
            width: 100%;
            height: var(--ribbon-height);
            background: #ffffff;
            border-bottom: 1px solid var(--md-outline);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 12px;
            z-index: 40;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .ribbon-btn {
            height: 32px;
            padding: 0 14px;
            border-radius: 8px;
            font-size: 9.5px;
            font-weight: 800;
            text-transform: uppercase;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .ribbon-btn:hover { background: #fdf2f8; color: var(--metal-fuchsia-mid); }
        .ribbon-btn.active {
            background: var(--metal-fuchsia-mid);
            color: white;
            box-shadow: 0 4px 10px rgba(74, 4, 78, 0.2);
        }

        .btn-refresh-pro {
            width: 30px; height: 30px; border-radius: 50%;
            background: linear-gradient(135deg, var(--metal-fuchsia-light) 0%, var(--metal-fuchsia-dark) 100%);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s; border: none;
        }

        .ribbon-date-nav {
            display: flex; align-items: center; gap: 6px; background: white;
            border: 2px solid var(--md-outline); border-radius: 12px; padding: 2px 10px; height: 34px;
        }

        .ribbon-date-text { font-size: 11px; font-weight: 800; color: var(--metal-fuchsia-dark); cursor: pointer; padding: 0 6px; white-space: nowrap; }

        .content-container { width: 100%; flex: 1; display: flex; flex-direction: column; }
        iframe { flex: 1; width: 100%; border: none; background: white; }

        .header-date-tag {
            background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px; padding: 6px 14px; display: flex; align-items: center;
        }
        .header-date-tag span { font-size: 11px; font-weight: 700; color: white; }
    </style>
</head>
<body>

    <header class="header-card">
        <div class="relative z-10 flex items-center justify-between w-full h-full">
            <div class="flex items-center gap-4 h-full">
                <div class="flex items-center opacity-80 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <circle cx="18" cy="12" r="5"></circle>
                        <polyline points="18 10 18 12 19 13"></polyline>
                    </svg>
                </div>

                <h1 class="text-[10px] font-black uppercase tracking-tight">RegAs</h1>

                <nav class="header-tabs">
                    <div onclick="changeMainView('dia')" id="tab-dia" class="header-tab active">Vista Diaria</div>
                    <div onclick="changeMainView('planeacion')" id="tab-planeacion" class="header-tab">Planeación</div>
                    <div onclick="changeMainView('reportes')" id="tab-reportes" class="header-tab">Reportes</div>
                </nav>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="header-date-tag">
                    <span id="date-display">...</span>
                </div>
                <input type="hidden" id="main-date">
            </div>
        </div>
    </header>

    <div id="tool-ribbon" class="tool-ribbon"></div>

    <div class="content-container">
        <iframe id="main-frame" name="main-frame" src="about:blank"></iframe>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU", 
            authDomain: "cic6-pp-web.firebaseapp.com", 
            projectId: "cic6-pp-web", 
            appId: "1:248659087868:web:a277ef700d83c7f1d22279" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userContext = null;
        const viewsBase = "Componentes/RegAs/";
        
        window.setDaySubView = (sub) => {
            const frame = document.getElementById('main-frame');
            frame.src = `${viewsBase}${sub}.html`;
            localStorage.setItem('regas_lastSubView_dia', sub);
            updateRibbonActiveState(sub);
            
            frame.onload = () => {
                const date = document.getElementById('main-date').value;
                frame.contentWindow.postMessage({ type: 'INIT_SUBMODULE', user: userContext, date: date }, '*');
            };
        };

        window.setReportSubView = (sub) => {
            const frame = document.getElementById('main-frame');
            frame.src = `${viewsBase}${sub}.html`;
            localStorage.setItem('regas_lastSubView_reportes', sub);
            updateRibbonActiveState(sub);
            frame.onload = () => {
                const date = document.getElementById('main-date').value;
                frame.contentWindow.postMessage({ type: 'INIT_SUBMODULE', user: userContext, date: date }, '*');
            };
        };

        const ribbonTools = {
            dia: `
                <button class="btn-refresh-pro" onclick="document.getElementById('main-frame').contentWindow.location.reload()" title="Refrescar">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                </button>
                <div class="ribbon-date-nav">
                    <button onclick="window.adjustDate(-1)" class="p-1 hover:bg-slate-100 rounded-lg"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <div class="flex items-center">
                        <span id="ribbon-date-display" class="ribbon-date-text" onclick="document.getElementById('ribbon-picker').showPicker()">...</span>
                        <input type="date" id="ribbon-picker" class="absolute opacity-0 w-0 h-0" onchange="window.updateGlobalDate(this.value)">
                    </div>
                    <button onclick="window.adjustDate(1)" class="p-1 hover:bg-slate-100 rounded-lg"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
                </div>
                <button id="sub-Proximos" class="ribbon-btn" onclick="window.setDaySubView('Proximos')">Próximos</button>
                <button id="sub-Matutino" class="ribbon-btn" onclick="window.setDaySubView('Matutino')">Matutino</button>
                <button id="sub-Vespertino" class="ribbon-btn" onclick="window.setDaySubView('Vespertino')">Vespertino</button>
                <button id="sub-Nocturno" class="ribbon-btn" onclick="window.setDaySubView('Nocturno')">Nocturno</button>
                <button id="sub-Ausentismos" class="ribbon-btn text-red-600 border-red-50 hover:bg-red-50" onclick="window.setDaySubView('Ausentismos')">Ausentismos</button>
                <div class="flex-1"></div>
            `,
            reportes: `
                <button id="sub-Whatsapp" class="ribbon-btn" onclick="window.setReportSubView('Whatsapp')">WhatsApp</button>
                <button id="sub-Diario" class="ribbon-btn" onclick="window.setReportSubView('Diario')">Diario</button>
                <button id="sub-Excel" class="ribbon-btn" onclick="window.setReportSubView('Excel')">Excel</button>
            `
        };

        window.adjustDate = (days) => {
            const current = document.getElementById('main-date').value;
            const date = new Date(current + 'T12:00:00'); // Usar mediodía para evitar desfases locales
            date.setDate(date.getDate() + days);
            window.updateGlobalDate(date.toISOString().split('T')[0]);
        };

        function updateRibbonActiveState(activeId) {
            document.querySelectorAll('.ribbon-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`sub-${activeId}`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        window.changeMainView = (viewKey) => {
            const frame = document.getElementById('main-frame');
            document.querySelectorAll('.header-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${viewKey}`)?.classList.add('active');
            
            document.getElementById('tool-ribbon').innerHTML = ribbonTools[viewKey] || '';
            document.getElementById('tool-ribbon').classList.toggle('hidden', viewKey === 'planeacion');

            if (viewKey === 'dia') {
                window.setDaySubView(localStorage.getItem('regas_lastSubView_dia') || 'Proximos');
                window.syncRibbonDate();
            } else if (viewKey === 'planeacion') {
                frame.src = `${viewsBase}Tabla.html`;
                frame.onload = () => { 
                    frame.contentWindow.postMessage({ type: 'INIT_SUBMODULE', user: userContext, date: document.getElementById('main-date').value }, '*'); 
                };
            } else if (viewKey === 'reportes') {
                window.setReportSubView(localStorage.getItem('regas_lastSubView_reportes') || 'Whatsapp');
            }
            localStorage.setItem('regas_lastView', viewKey);
        };

        window.updateGlobalDate = (val) => {
            localStorage.setItem('regas_selectedDate', val);
            document.getElementById('main-date').value = val;
            
            const dateObj = new Date(val + 'T12:00:00');
            const headerText = dateObj.toLocaleDateString('es-MX', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            }).toUpperCase();
            document.getElementById('date-display').innerText = headerText;
            
            window.syncRibbonDate();
            const frame = document.getElementById('main-frame');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({ type: 'INIT_SUBMODULE', user: userContext, date: val }, '*');
            }
        };

        window.syncRibbonDate = () => {
            const val = document.getElementById('main-date').value;
            const rDate = document.getElementById('ribbon-date-display');
            if (rDate) {
                const dateObj = new Date(val + 'T12:00:00');
                rDate.innerText = dateObj.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric', month: 'short' }).toUpperCase();
            }
            const rPicker = document.getElementById('ribbon-picker');
            if (rPicker) rPicker.value = val;
        };

        window.addEventListener('message', (event) => {
            if (event.data.type === 'USER_CONTEXT_RESPONSE') {
                userContext = event.data.user;
            }
            if (event.data.type === 'navigateRight') {
                const finalUrl = `Apps/${viewsBase}${event.data.url}`;
                window.parent.postMessage({ type: 'OPEN_SIDE_PANEL', url: finalUrl, title: 'Perfil de Elemento' }, '*');
            }
            if (event.data.type === 'SIDE_PANEL_STATE_CHANGED') {
                const frame = document.getElementById('main-frame');
                if (frame && frame.contentWindow) {
                    frame.contentWindow.postMessage(event.data, '*');
                }
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.parent.postMessage({ type: 'REQUEST_USER_CONTEXT' }, '*');
                
                // FIX: Obtener fecha local YYYY-MM-DD sin desfase UTC
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const systemToday = `${year}-${month}-${day}`;
                
                window.updateGlobalDate(systemToday);
                window.changeMainView(localStorage.getItem('regas_lastView') || 'dia');
            } else { window.location.href = "../index.html"; }
        });
    </script>
</body>
</html>