<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asistencia - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Bloqueo total de scroll en el contenedor principal */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background-color: #f8fafc;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            display: flex; 
            flex-direction: column; 
        }

        /* Nivel 1: Cabecera Superior */
        .app-header-top {
            background: white;
            height: 65px;
            border-bottom: 1px solid #f1f5f9;
            display: grid;
            grid-template-columns: 1.2fr 1fr 1.2fr; 
            align-items: center;
            padding: 0 1.5rem;
            flex: none;
            z-index: 100;
        }

        .branding-section { display: flex; align-items: center; gap: 0.75rem; }
        .logo-container { width: 38px; height: 38px; }
        .logo-container img { width: 100%; height: 100%; object-fit: contain; }

        .apps-drawer-btn {
            width: 34px; height: 34px; border-radius: 9px; background: #f1f5f9;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 1px solid #e2e8f0; padding: 4px;
        }

        .gloss-nav {
            background: rgba(241, 245, 249, 0.8);
            backdrop-filter: blur(8px);
            padding: 4px;
            border-radius: 14px;
            display: flex;
            gap: 4px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            justify-self: center;
        }

        .main-tab-btn {
            padding: 0.5rem 1.4rem; border-radius: 10px; font-size: 11px; font-weight: 800;
            color: #64748b; text-transform: uppercase; cursor: pointer; transition: all 0.3s;
        }
        .main-tab-btn.active { color: white; background: #d946ef; box-shadow: 0 4px 12px rgba(217, 70, 239, 0.3); }

        .clock-container {
            justify-self: end; font-family: 'JetBrains Mono', monospace; background: #f8fafc;
            padding: 0.4rem 1rem; border-radius: 12px; font-size: 15px; font-weight: 600;
            border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 0.5rem;
        }
        .clock-dot { width: 6px; height: 6px; background: #d946ef; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }

        /* Nivel 2: Controles de Fecha/Turno */
        .app-header-sub {
            background: #fdf4ff;
            height: 60px;
            border-bottom: 1px solid #f0abfc;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            flex: none;
            z-index: 90;
        }
        .app-header-sub.hidden { display: none; }

        .nav-selector { display: flex; align-items: center; gap: 0.3rem; background: white; padding: 3px; border-radius: 10px; border: 1px solid #f0abfc; position: relative; }
        .nav-btn { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 7px; color: #d946ef; cursor: pointer; border: 1px solid #f5d0fe; }
        .nav-btn:hover { background: #d946ef; color: white; }

        .display-box { background: #fdf4ff; padding: 0 12px; height: 30px; border-radius: 7px; display: flex; align-items: center; justify-content: center; border: 1px solid #f5d0fe; min-width: 140px; cursor: pointer; }
        .display-text { font-size: 11px; font-weight: 900; color: #701a75; text-transform: uppercase; }

        #dateSelector { background: transparent; border: none; outline: none; font-size: 11px; font-weight: 900; color: #701a75; text-transform: uppercase; cursor: pointer; width: 100%; text-align: center; }

        .today-btn { background: #d946ef; color: white; font-size: 9px; font-weight: 900; text-transform: uppercase; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; }
        .today-btn.hidden { display: none; }

        .dropdown-shift-list { display: none; position: absolute; top: 115%; left: 0; right: 0; background: white; border: 1px solid #f0abfc; border-radius: 12px; box-shadow: 0 10px 25px rgba(112, 26, 117, 0.1); z-index: 500; padding: 5px; }
        .dropdown-shift-list.show { display: block; }
        .dropdown-item { padding: 10px 14px; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
        .dropdown-item:hover { background: #fdf4ff; color: #d946ef; }
        .dropdown-item.active { background: #d946ef; color: white; }

        /* Nivel 3: Ribbon */
        .app-ribbon {
            background: #1e293b; 
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 1.25rem;
            flex: none;
            z-index: 80;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .app-ribbon.hidden { display: none; }

        .ribbon-pill {
            padding: 0.5rem 1.2rem;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            color: #94a3b8;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.08);
            text-transform: uppercase;
            white-space: nowrap;
            margin-right: 0.5rem;
            transition: all 0.2s;
        }
        .ribbon-pill:hover { color: white; background: rgba(255, 255, 255, 0.12); transform: translateY(-1px); }
        .ribbon-pill.active { background: white; color: #1e293b; border-color: white; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Nivel 4: ÁREA DE PERSISTENCIA (Z-Stacking) */
        .main-content-area {
            flex: 1;
            position: relative;
            min-height: 0;
            background: #f8fafc;
        }

        .app-instance {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
        }

        .app-instance.active {
            z-index: 10;
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <!-- CABECERA PRINCIPAL -->
    <header class="app-header-top">
        <div class="branding-section">
            <div onclick="openApps()" class="apps-drawer-btn" title="Menú de Aplicaciones">
                <img src="../MM/Apps.png" alt="Apps">
            </div>
            <div class="logo-container">
                <img src="../MM/RegAs.png" alt="Logo">
            </div>
            <div class="hidden xs:block">
                <h1 class="text-[12px] font-black text-slate-900 uppercase tracking-widest leading-none">Registros de asistencia</h1>
                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter mt-1">CIC 7.1 · Gestión Operativa</p>
            </div>
        </div>

        <nav class="gloss-nav">
            <div onclick="setTab('diaria', this)" id="nav-diaria" class="main-tab-btn">Diaria</div>
            <div onclick="setTab('planeacion', this)" id="nav-planeacion" class="main-tab-btn">Planeación</div>
            <div onclick="setTab('reporte', this)" id="nav-reporte" class="main-tab-btn">Reporte</div>
        </nav>

        <div class="clock-container">
            <div class="clock-dot"></div>
            <span id="timeDisplay">00:00:00</span>
        </div>
    </header>

    <!-- CONTROLES DIARIOS -->
    <div id="diariaControls" class="app-header-sub hidden">
        <div class="flex items-center gap-4">
            <div class="w-1.5 h-8 bg-fuchsia-600 rounded-full"></div>
            <div class="flex flex-col">
                <h2 id="topDateLabel" class="text-[11px] font-black text-slate-800 uppercase tracking-tight leading-none">---</h2>
                <span id="viewStatus" class="text-[8px] font-bold text-emerald-500 uppercase mt-0.5">Jornada Actual</span>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="nav-selector">
                <button onclick="changeDate(-1)" class="nav-btn"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="display-box"><input type="date" id="dateSelector"></div>
                <button onclick="changeDate(1)" class="nav-btn"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <button id="todayBtn" onclick="goToToday()" class="today-btn">Hoy</button>

            <div class="nav-selector">
                <button onclick="changeShift(-1)" class="nav-btn"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="display-box" onclick="toggleShiftMenu(event)">
                    <span id="shiftLabel" class="display-text">MATUTINO</span>
                    <i class="fa-solid fa-caret-down ml-2 text-[10px] text-fuchsia-400"></i>
                </div>
                <button onclick="changeShift(1)" class="nav-btn"><i class="fa-solid fa-chevron-right"></i></button>
                <div id="shiftMenu" class="dropdown-shift-list"></div>
            </div>

            <label class="flex items-center gap-2 cursor-pointer select-none px-3 py-1.5 bg-white border border-fuchsia-200 rounded-xl">
                <input type="checkbox" id="hideAbsences" checked class="w-4 h-4 accent-fuchsia-600">
                <span class="text-[9px] font-black text-fuchsia-900 uppercase">Ocultar Ausentismos</span>
            </label>
        </div>
    </div>

    <!-- RIBBON DE BOTONES -->
    <nav id="appRibbon" class="app-ribbon">
        <div id="ribbonContent" class="flex items-center w-full overflow-x-auto no-scrollbar"></div>
    </nav>

    <!-- ÁREA DE PERSISTENCIA (Viewport para Iframes) -->
    <main class="main-content-area" id="viewport">
        <!-- Los iframes se inyectan dinámicamente -->
    </main>

    <script>
        let currentDate = new Date();
        const shifts = ['matutino', 'vespertino', 'nocturno', 'ausentismo'];
        let currentShiftIndex = 0;
        let currentActiveTab = 'diaria';

        const dom = {
            dateInput: document.getElementById('dateSelector'),
            shiftLabel: document.getElementById('shiftLabel'),
            topLabel: document.getElementById('topDateLabel'),
            viewport: document.getElementById('viewport'),
            diariaControls: document.getElementById('diariaControls'),
            ribbon: document.getElementById('appRibbon'),
            ribbonContent: document.getElementById('ribbonContent'),
            clockText: document.getElementById('timeDisplay'),
            hideAbsences: document.getElementById('hideAbsences'),
            shiftMenu: document.getElementById('shiftMenu'),
            todayBtn: document.getElementById('todayBtn'),
            viewStatus: document.getElementById('viewStatus')
        };

        const ribbonConfigs = {
            'diaria': [
                { label: 'Todos', type: 'todos', active: true },
                { label: 'Próximos', type: 'proximos' },
                { label: 'Matutino', type: 'matutino' },
                { label: 'Vespertino', type: 'vespertino' },
                { label: 'Nocturno', type: 'nocturno' },
                { label: 'Ausentismos', type: 'ausentismo' }
            ],
            'reporte': [
                { label: 'WhatsApp', action: 'whatsapp', id: 'wa' },
                { label: 'Diario', action: 'diario', id: 'diario', active: true }
            ]
        };

        const instances = {
            'diaria': '../Complementos/RegAs/Día.html',
            'planeacion': '../Complementos/RegAs/Planeación.html',
            'wa': '../Complementos/RegAs/Wa.html',
            'diario': '../Complementos/RegAs/Reporte_Diario.html'
        };

        function updateClock() { dom.clockText.textContent = new Date().toLocaleTimeString('es-MX', { hour12: false }); }
        setInterval(updateClock, 1000); updateClock();

        // Inicialización de Instancias (Pre-carga)
        function initInstances() {
            Object.entries(instances).forEach(([id, url]) => {
                const iframe = document.createElement('iframe');
                iframe.className = 'app-instance';
                iframe.id = `frame-${id}`;
                iframe.dataset.id = id;
                iframe.src = url;
                dom.viewport.appendChild(iframe);
            });
        }

        window.goToToday = () => {
            const now = new Date();
            const hour = now.getHours();
            currentDate = new Date(); currentDate.setHours(12, 0, 0, 0);
            if (hour < 7) { currentShiftIndex = 2; currentDate.setDate(currentDate.getDate() - 1); }
            else if (hour < 12) currentShiftIndex = 0;
            else if (hour < 18) currentShiftIndex = 1;
            else currentShiftIndex = 2;
            updateUI();
        };

        dom.hideAbsences.onchange = (e) => {
            if (e.target.checked && shifts[currentShiftIndex] === 'ausentismo') currentShiftIndex = 0;
            sendToIframe('diaria', { action: 'toggleAbsences', hide: e.target.checked });
            updateUI();
        };

        window.toggleShiftMenu = (e) => {
            e.stopPropagation();
            const show = !dom.shiftMenu.classList.contains('show');
            if (show) {
                const hide = dom.hideAbsences.checked;
                const valid = hide ? shifts.filter(s => s !== 'ausentismo') : shifts;
                dom.shiftMenu.innerHTML = valid.map(s => `
                    <div class="dropdown-item ${shifts[currentShiftIndex] === s ? 'active' : ''}" onclick="selectShift('${s}')">
                        <span>${s.toUpperCase()}</span>${shifts[currentShiftIndex] === s ? '<i class="fa-solid fa-check text-[8px]"></i>' : ''}
                    </div>
                `).join('');
                dom.shiftMenu.classList.add('show');
            } else dom.shiftMenu.classList.remove('show');
        };

        window.selectShift = (s) => { currentShiftIndex = shifts.indexOf(s); dom.shiftMenu.classList.remove('show'); updateUI(); };
        document.addEventListener('click', () => dom.shiftMenu.classList.remove('show'));

        function activateIframe(id) {
            document.querySelectorAll('.app-instance').forEach(i => {
                if(i.dataset.id === id) i.classList.add('active');
                else i.classList.remove('active');
            });
        }

        function renderRibbon(tab, forcedActionId = null) {
            dom.ribbonContent.innerHTML = '';
            if (tab === 'planeacion') { dom.ribbon.classList.add('hidden'); return; }
            dom.ribbon.classList.remove('hidden');
            const items = ribbonConfigs[tab] || [];
            
            items.forEach(item => {
                const btn = document.createElement('div');
                const isActive = forcedActionId ? (item.id === forcedActionId) : item.active;
                btn.className = `ribbon-pill ${isActive ? 'active' : ''}`;
                btn.textContent = item.label;
                btn.onclick = () => {
                    document.querySelectorAll('.ribbon-pill').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    if (tab === 'diaria') sendToIframe('diaria', { action: 'filter', type: item.type });
                    else activateIframe(item.id);
                };
                dom.ribbonContent.appendChild(btn);
                if(isActive && tab === 'reporte') activateIframe(item.id);
            });
        }

        window.setTab = (tab, el, forcedSubViewId = null) => {
            currentActiveTab = tab;
            localStorage.setItem('regas_last_view', tab);
            document.querySelectorAll('.main-tab-btn').forEach(t => t.classList.remove('active'));
            (el || document.getElementById(`nav-${tab}`)).classList.add('active');
            dom.diariaControls.classList.toggle('hidden', tab !== 'diaria');
            
            if (tab === 'diaria') {
                activateIframe('diaria');
                renderRibbon('diaria');
                updateUI();
            } else if (tab === 'planeacion') {
                activateIframe('planeacion');
                renderRibbon('planeacion');
            } else if (tab === 'reporte') {
                // Por defecto carga Reporte Diario (o el subview forzado)
                const target = forcedSubViewId || 'diario';
                renderRibbon('reporte', target);
                activateIframe(target);
            }
        };

        window.changeDate = (offset) => { currentDate.setDate(currentDate.getDate() + offset); updateUI(); };
        window.changeShift = (dir) => {
            const valid = dom.hideAbsences.checked ? shifts.filter(s => s !== 'ausentismo') : shifts;
            let idx = valid.indexOf(shifts[currentShiftIndex]);
            if (idx === -1) idx = 0;
            let nIdx = idx + dir;
            if (nIdx < 0) { currentDate.setDate(currentDate.getDate() - 1); nIdx = valid.length - 1; }
            else if (nIdx >= valid.length) { currentDate.setDate(currentDate.getDate() + 1); nIdx = 0; }
            currentShiftIndex = shifts.indexOf(valid[nIdx]);
            updateUI();
        };

        function sendToIframe(id, data) { 
            const iframe = document.getElementById(`frame-${id}`);
            if (iframe && iframe.contentWindow) iframe.contentWindow.postMessage(data, '*'); 
        }

        window.openApps = () => { window.parent.postMessage({ action: 'toggleMenu' }, '*'); };
        dom.dateInput.onchange = (e) => { currentDate = new Date(e.target.value + "T12:00:00"); updateUI(); };

        function updateUI() {
            const iso = currentDate.toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            dom.dateInput.value = iso;
            dom.topLabel.textContent = currentDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            dom.shiftLabel.textContent = shifts[currentShiftIndex].toUpperCase();
            dom.todayBtn.classList.toggle('hidden', iso === today);
            dom.viewStatus.textContent = iso === today ? "Jornada Actual" : "Vista Histórica";
            dom.viewStatus.className = `text-[8px] font-bold uppercase mt-0.5 ${iso === today ? 'text-emerald-500' : 'text-fuchsia-500'}`;
            if (currentActiveTab === 'diaria') sendToIframe('diaria', { action: 'syncDate', date: iso, shift: shifts[currentShiftIndex], hideAbsences: dom.hideAbsences.checked });
        }

        window.addEventListener('message', (e) => {
            if (e.data.action && (e.data.action.includes('Panel') || e.data.action.includes('Nav') || e.data.action === 'toggleMenu' || e.data.action === 'openApp')) window.parent.postMessage(e.data, '*');
            
            if (e.data.action === 'internalNav') {
                const subView = e.data.subview === 'diario' ? 'diario' : (e.data.subview === 'whatsapp' ? 'wa' : null);
                setTab(e.data.tab, null, subView);
            }

            if (e.data.action === 'reportShift') { currentShiftIndex = shifts.indexOf(e.data.shift); dom.shiftLabel.textContent = e.data.shift.toUpperCase(); }
            if (e.data.action === 'reportDate') {
                const newDate = new Date(e.data.date + "T12:00:00");
                if (newDate.getTime() !== currentDate.getTime()) { currentDate = newDate; updateUI(); }
            }
        });

        window.onload = () => { 
            initInstances();
            const last = localStorage.getItem('regas_last_view') || 'diaria';
            // Pequeño delay para asegurar que los iframes están en el DOM antes de activar el inicial
            setTimeout(() => setTab(last), 50);
        };
    </script>
</body>
</html>