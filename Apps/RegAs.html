<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia - CIC 7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow: hidden; height: 100vh; display: flex; flex-direction: column; margin: 0; }

        /* --- NIVEL 1: HEADER TOP --- */
        .app-header-top {
            background: white;
            height: 65px;
            border-bottom: 1px solid #f1f5f9;
            display: grid;
            grid-template-columns: 1.2fr 1fr 1.2fr; 
            align-items: center;
            padding: 0 1.5rem;
            flex-shrink: 0;
            z-index: 120;
        }

        .branding-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-container {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .logo-container:hover { transform: scale(1.05); }
        .logo-container img { width: 100%; height: 100%; object-fit: contain; }

        .apps-drawer-btn {
            width: 34px;
            height: 34px;
            border-radius: 9px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            padding: 4px;
        }
        .apps-drawer-btn:hover { background: #e2e8f0; border-color: #cbd5e1; transform: scale(1.05); }
        .apps-drawer-btn img { width: 100%; height: 100%; object-fit: contain; }

        .gloss-nav {
            background: rgba(241, 245, 249, 0.8);
            backdrop-filter: blur(8px);
            padding: 4px;
            border-radius: 14px;
            display: flex;
            gap: 4px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            justify-self: center;
        }

        .main-tab-btn {
            padding: 0.5rem 1.4rem;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            white-space: nowrap;
        }

        .main-tab-btn.active {
            color: white;
            background: #d946ef;
            box-shadow: 0 4px 12px rgba(217, 70, 239, 0.3);
        }

        .clock-container {
            justify-self: end;
            font-family: 'JetBrains Mono', monospace;
            background: #f8fafc;
            color: #1e293b;
            padding: 0.4rem 1rem;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .clock-dot {
            width: 6px;
            height: 6px;
            background: #d946ef;
            border-radius: 50%;
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- NIVEL 2: CONTROLES DIARIOS --- */
        .app-header-sub {
            background: #fdf4ff;
            height: 60px;
            border-bottom: 1px solid #f0abfc;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            flex-shrink: 0;
            z-index: 115;
            box-shadow: 0 2px 10px rgba(217, 70, 239, 0.05);
        }
        .app-header-sub.hidden { display: none; }

        .nav-selector {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: white;
            padding: 3px;
            border-radius: 10px;
            border: 1px solid #f0abfc;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 7px;
            background: white;
            color: #d946ef;
            cursor: pointer;
            border: 1px solid #f5d0fe;
            font-size: 11px;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: #d946ef; color: white; border-color: #d946ef; }

        .display-box {
            background: #fdf4ff;
            padding: 0 12px;
            height: 32px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #f5d0fe;
            min-width: 150px;
        }
        
        .display-text { font-size: 11px; font-weight: 900; color: #701a75; text-transform: uppercase; }

        #dateSelector {
            background: transparent;
            border: none;
            outline: none;
            font-size: 11px;
            font-weight: 900;
            color: #701a75;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            text-align: center;
        }

        /* --- NIVEL 3: RIBBON --- */
        .app-ribbon {
            background: linear-gradient(90deg, #1e293b 0%, #334155 50%, #1e293b 100%);
            height: 45px;
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 -2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
            z-index: 110;
        }
        .app-ribbon.hidden { display: none; }

        .app-ribbon::after {
            content: '';
            position: absolute;
            top: 0; left: -150%; width: 60%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.08) 45%, rgba(255,255,255,0.18) 50%, rgba(255,255,255,0.08) 55%, transparent);
            transform: skewX(-25deg);
            animation: shine-sweep 7s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes shine-sweep { 0% { left: -150%; } 15% { left: 150%; } 100% { left: 150%; } }

        .ribbon-pill {
            padding: 0.4rem 1.2rem;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            color: #94a3b8;
            background: rgba(255, 255, 255, 0.04);
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.06);
            text-transform: uppercase;
        }
        .ribbon-pill:hover { color: white; background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); }
        .ribbon-pill.active { background: white; color: #1e293b; border-color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        #mainIframe { flex: 1; border: none; width: 100%; background: #f8fafc; }
    </style>
</head>
<body>

    <!-- NIVEL 1 -->
    <header class="app-header-top">
        <div class="branding-section">
            <div onclick="openApps()" class="apps-drawer-btn" title="Aplicaciones">
                <img src="../MM/Apps.png" alt="Apps">
            </div>
            <div class="logo-container">
                <img src="../MM/RegAs.png" alt="Logo Asistencia" onerror="this.style.display='none'">
            </div>
            <div>
                <h1 class="text-[13px] font-black text-slate-900 uppercase tracking-widest leading-none">Registros de asistencia</h1>
                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-tighter mt-1">CIC 7.1 · Gestión Operativa</p>
            </div>
        </div>

        <nav class="gloss-nav">
            <div onclick="setTab('diaria', this)" id="nav-diaria" class="main-tab-btn">Diaria</div>
            <div onclick="setTab('planeacion', this)" id="nav-planeacion" class="main-tab-btn">Planeación</div>
            <div onclick="setTab('reporte', this)" id="nav-reporte" class="main-tab-btn">Reporte</div>
        </nav>

        <div id="clock" class="clock-container">
            <div class="clock-dot"></div>
            <span id="timeDisplay">00:00:00</span>
        </div>
    </header>

    <!-- NIVEL 2: Diaria -->
    <div id="diariaControls" class="app-header-sub hidden">
        <div class="flex items-center gap-4">
            <div class="w-1.5 h-8 bg-fuchsia-600 rounded-full"></div>
            <h2 id="topDateLabel" class="text-sm font-black text-slate-800 uppercase tracking-tight">---</h2>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="nav-selector">
                <button onclick="changeDate(-1)" class="nav-btn"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="display-box"><input type="date" id="dateSelector"></div>
                <button onclick="changeDate(1)" class="nav-btn"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <div class="nav-selector">
                <button onclick="changeShift(-1)" class="nav-btn"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="display-box"><span id="shiftLabel" class="display-text">MATUTINO</span></div>
                <button onclick="changeShift(1)" class="nav-btn"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <!-- NIVEL 3: Ribbon -->
    <nav id="appRibbon" class="app-ribbon">
        <div id="ribbonContent" class="flex items-center gap-3 w-full"></div>
    </nav>

    <iframe id="mainIframe" src=""></iframe>

    <script>
        let currentDate = new Date();
        currentDate.setHours(12, 0, 0, 0);
        const shifts = ['matutino', 'vespertino', 'nocturno', 'ausentismo'];
        let currentShiftIndex = 0;
        let currentActiveTab = 'diaria';

        const dom = {
            dateInput: document.getElementById('dateSelector'),
            shiftLabel: document.getElementById('shiftLabel'),
            topLabel: document.getElementById('topDateLabel'),
            iframe: document.getElementById('mainIframe'),
            diariaControls: document.getElementById('diariaControls'),
            ribbon: document.getElementById('appRibbon'),
            ribbonContent: document.getElementById('ribbonContent'),
            clockText: document.getElementById('timeDisplay')
        };

        const ribbonConfigs = {
            'diaria': [
                { label: 'Todos', type: 'todos', active: true },
                { label: 'Próximos', type: 'proximos' },
                { label: 'Matutino', type: 'matutino' },
                { label: 'Vespertino', type: 'vespertino' },
                { label: 'Nocturno', type: 'nocturno' },
                { label: 'Ausentismos', type: 'ausentismo' }
            ],
            'reporte': [
                { label: 'WhatsApp', action: 'whatsapp', icon: 'fa-brands fa-whatsapp', active: true },
                { label: 'Diario', action: 'diario', icon: 'fa-solid fa-file-invoice' }
            ]
        };

        function updateClock() {
            const now = new Date();
            dom.clockText.textContent = now.toLocaleTimeString('es-MX', { hour12: false });
        }
        setInterval(updateClock, 1000);
        updateClock();

        function renderRibbon(tab, forcedAction = null) {
            dom.ribbonContent.innerHTML = '';
            if (tab === 'planeacion') { dom.ribbon.classList.add('hidden'); return; }
            dom.ribbon.classList.remove('hidden');
            const items = ribbonConfigs[tab] || [];
            items.forEach(item => {
                const btn = document.createElement('div');
                // Si hay un action forzado (ej. 'diario'), marcarlo como activo
                const isActive = forcedAction ? (item.action === forcedAction) : item.active;
                btn.className = `ribbon-pill ${isActive ? 'active' : ''}`;
                
                if (tab === 'diaria') {
                    btn.textContent = item.label;
                    btn.onclick = () => {
                        document.querySelectorAll('.ribbon-pill').forEach(p => p.classList.remove('active'));
                        btn.classList.add('active');
                        sendToIframe({ action: 'filter', type: item.type });
                    };
                } else {
                    btn.innerHTML = `<i class="${item.icon} mr-2"></i>${item.label}`;
                    btn.onclick = () => {
                        document.querySelectorAll('.ribbon-pill').forEach(p => p.classList.remove('active'));
                        btn.classList.add('active');
                        const reportPaths = {
                            'whatsapp': '../Complementos/RegAs/Wa.html',
                            'diario': '../Complementos/RegAs/Reporte_Diario.html'
                        };
                        dom.iframe.src = reportPaths[item.action];
                    };
                }
                dom.ribbonContent.appendChild(btn);
            });
        }

        window.setTab = (tab, el, forcedSubView = null) => {
            currentActiveTab = tab;
            localStorage.setItem('regas_last_view', tab);

            document.querySelectorAll('.main-tab-btn').forEach(t => t.classList.remove('active'));
            const targetBtn = el || document.getElementById(`nav-${tab}`);
            if (targetBtn) targetBtn.classList.add('active');

            dom.diariaControls.classList.toggle('hidden', tab !== 'diaria');
            
            // Si venimos de un comando externo (ej. abrir reporte diario)
            if (forcedSubView) {
                renderRibbon(tab, forcedSubView);
                const forcedPaths = {
                    'diario': '../Complementos/RegAs/Reporte_Diario.html',
                    'whatsapp': '../Complementos/RegAs/Wa.html'
                };
                dom.iframe.src = forcedPaths[forcedSubView];
            } else {
                renderRibbon(tab);
                const paths = { 
                    'diaria': '../Complementos/RegAs/Día.html', 
                    'planeacion': '../Complementos/RegAs/Planeación.html', 
                    'reporte': '../Complementos/RegAs/Wa.html' 
                };
                dom.iframe.src = paths[tab];
            }
            
            if(tab === 'diaria') updateUI();
        };

        window.changeDate = (offset) => { currentDate.setDate(currentDate.getDate() + offset); updateUI(); };
        window.changeShift = (direction) => {
            currentShiftIndex += direction;
            if (currentShiftIndex < 0) { currentDate.setDate(currentDate.getDate() - 1); currentShiftIndex = shifts.length - 1; }
            else if (currentShiftIndex >= shifts.length) { currentDate.setDate(currentDate.getDate() + 1); currentShiftIndex = 0; }
            updateUI();
        };

        function sendToIframe(data) { if (dom.iframe.contentWindow) dom.iframe.contentWindow.postMessage(data, '*'); }
        
        window.openApps = () => {
            window.parent.postMessage({ action: 'toggleMenu' }, '*');
        };

        dom.dateInput.onchange = (e) => { currentDate = new Date(e.target.value + "T12:00:00"); updateUI(); };

        function updateUI() {
            const iso = currentDate.toISOString().split('T')[0];
            dom.dateInput.value = iso;
            dom.topLabel.textContent = currentDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            dom.shiftLabel.textContent = shifts[currentShiftIndex].toUpperCase();
            if (currentActiveTab === 'diaria') {
                sendToIframe({ action: 'syncDate', date: iso, shift: shifts[currentShiftIndex] });
            }
        }

        window.addEventListener('message', (e) => {
            if (e.data.action && (
                e.data.action.includes('Panel') || 
                e.data.action.includes('Nav') || 
                e.data.action === 'toggleMenu' || 
                e.data.action === 'openApp'
            )) {
                window.parent.postMessage(e.data, '*');
            }

            // COMANDO EXTERNO: Recibido desde Administración.html para cambiar de vista internamente
            if (e.data.action === 'internalNav') {
                setTab(e.data.tab, null, e.data.subview);
            }

            if (e.data.action === 'reportShift') {
                currentShiftIndex = shifts.indexOf(e.data.shift);
                dom.shiftLabel.textContent = e.data.shift.toUpperCase();
            }
            if (e.data.action === 'reportDate') {
                const newDate = new Date(e.data.date + "T12:00:00");
                if (newDate.getTime() !== currentDate.getTime()) {
                    currentDate = newDate;
                    dom.dateInput.value = e.data.date;
                    dom.topLabel.textContent = currentDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                }
            }
        });

        window.onload = () => { 
            const lastView = localStorage.getItem('regas_last_view') || 'diaria';
            setTab(lastView);
            updateUI(); 
        };
    </script>
</body>
</html>