    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Recorrido Virtual CCTV - CIC</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .fade-in { animation: fadeIn 0.3s ease-in; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .progress-transition { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
            .status-pill { display: none; position: fixed; top: 20px; right: 20px; z-index: 100; }
            .pro-shadow { box-shadow: 0 10px 25px -5px rgba(30, 64, 175, 0.1), 0 8px 10px -6px rgba(30, 64, 175, 0.1); }
            .results-scroll { max-height: 480px; overflow-y: auto; }
            ::-webkit-scrollbar { width: 6px; }
            ::-webkit-scrollbar-track { background: #f1f5f9; }
            ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        </style>
    </head>
    <body class="bg-slate-50 min-h-screen font-sans text-slate-900">

        <!-- Indicador de Estado -->
        <div id="status-pill" class="status-pill px-6 py-3 rounded-2xl shadow-2xl font-bold text-white transition-all transform scale-95 border border-white/20">
            <span id="status-text">Cargando...</span>
        </div>

        <!-- Header Profesional -->
        <nav class="bg-gradient-to-r from-blue-900 via-blue-800 to-indigo-900 text-white shadow-2xl sticky top-0 z-50">
            <div class="max-w-2xl mx-auto px-6 py-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-500/20 p-2 rounded-lg backdrop-blur-md">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-black tracking-tight uppercase">CIC Centro de Control</h1>
                            <p class="text-blue-300 text-[10px] font-bold tracking-[0.2em] uppercase">M√≥dulo de Inspecci√≥n</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleHistory(true)" class="text-[10px] font-black uppercase tracking-widest bg-white/10 px-3 py-1.5 rounded-lg border border-white/20 hover:bg-white/20 transition-all">Historial</button>
                        <span id="counter" class="text-xs font-mono font-bold bg-blue-950/50 px-3 py-1.5 rounded-lg border border-white/5">0 / 0</span>
                    </div>
                </div>
                <div id="progress-container" class="w-full bg-blue-950/50 rounded-full h-2 border border-white/5">
                    <div id="progress-bar" class="bg-gradient-to-r from-blue-400 to-indigo-400 h-2 rounded-full progress-transition" style="width: 0%"></div>
                </div>
            </div>
        </nav>

        <main class="max-w-2xl mx-auto px-4 py-8">
            
            <!-- Vista 1: Inspecci√≥n Paso a Paso -->
            <div id="wizard-container" class="space-y-6">
                <div id="camera-card" class="bg-white rounded-[2.5rem] p-8 text-center fade-in pro-shadow border border-slate-100">
                    <span id="cam-id" class="inline-block px-4 py-1.5 rounded-full bg-blue-50 text-blue-700 text-[10px] font-black mb-6 uppercase tracking-widest border border-blue-100">IDENTIFICADOR DE C√ÅMARA</span>
                    <h2 id="cam-name" class="text-2xl font-black text-slate-800 leading-tight mb-8 text-center text-balance italic">Cargando...</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-8 text-left">
                        <div class="md:col-span-1">
                            <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Hora Registro</label>
                            <input type="time" id="review-time" class="w-full p-4 border border-slate-100 rounded-2xl bg-slate-50 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none text-sm transition-all font-mono font-bold text-slate-700">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Notas de C√°mara</label>
                            <textarea id="individual-comment" class="w-full p-4 border border-slate-100 rounded-2xl bg-slate-50 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none text-sm transition-all font-medium text-slate-700" rows="1" placeholder="Reporte fallas o estado del lente..."></textarea>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button onclick="markCamera(true)" class="flex items-center justify-center gap-3 bg-emerald-500 hover:bg-emerald-600 active:scale-95 text-white py-6 rounded-[1.5rem] font-black text-lg transition-all shadow-xl shadow-emerald-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            VISUALIZACI√ìN OK
                        </button>
                        <button onclick="markCamera(false)" class="flex items-center justify-center gap-3 bg-rose-500 hover:bg-rose-600 active:scale-95 text-white py-6 rounded-[1.5rem] font-black text-lg transition-all shadow-xl shadow-rose-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                            FALLA DETECTADA
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-center px-4">
                    <button onclick="prevCamera()" id="btn-prev" class="text-slate-400 hover:text-blue-600 font-bold text-sm flex items-center gap-2 transition-colors disabled:opacity-0 group">
                        <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> Anterior
                    </button>
                    <button onclick="showSummary()" class="text-[10px] font-bold text-slate-400 uppercase hover:text-blue-600 transition-colors tracking-widest">Resumen Actual</button>
                </div>
            </div>

            <!-- Vista 2: Resumen Final -->
            <div id="summary-container" class="hidden space-y-6 fade-in">
                <div class="bg-white rounded-[2.5rem] p-8 pro-shadow border border-slate-100">
                    <h2 class="text-3xl font-black mb-6 text-blue-900 border-b border-slate-100 pb-4 tracking-tight">Recorrido virtual CCTV</h2>
                    
                    <div id="summary-stats-display" class="bg-slate-50 border border-slate-200 p-6 rounded-3xl mb-4 font-bold text-slate-700 leading-relaxed text-lg"></div>

                    <div class="mb-8">
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest text-blue-800">Comentarios Finales (Editable)</label>
                        <textarea id="final-general-comment" class="w-full p-4 border border-slate-200 rounded-2xl bg-white focus:ring-4 focus:ring-blue-500/10 outline-none text-sm transition-all font-medium text-slate-700 leading-relaxed resize-none shadow-sm" rows="4" placeholder="Escribe aqu√≠ las observaciones generales del recorrido..."></textarea>
                    </div>

                    <div id="results-list" class="results-scroll mb-8 border border-slate-200 rounded-3xl divide-y divide-slate-100 shadow-inner overflow-hidden"></div>

                    <div class="flex flex-col gap-4">
                        <button id="btn-send-api" onclick="exportAndSend()" class="w-full bg-blue-600 text-white py-5 rounded-[1.5rem] font-black hover:bg-blue-700 transition-all shadow-xl shadow-blue-200 flex items-center justify-center gap-3 active:scale-95 uppercase tracking-tighter">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                            Enviar al CIC y Guardar
                        </button>
                        <button onclick="backToWizard()" class="w-full text-slate-500 font-bold text-sm hover:text-slate-700 transition-colors text-center">Seguir revisando</button>
                        <button onclick="resetApp()" class="w-full text-rose-400 text-[10px] font-black mt-6 hover:text-rose-600 tracking-tighter uppercase transition-colors text-center">Borrar datos locales</button>
                    </div>
                </div>
            </div>

            <!-- Vista 3: Historial -->
            <div id="history-container" class="hidden space-y-6 fade-in">
                <div class="bg-white rounded-[2.5rem] p-8 pro-shadow border border-slate-100">
                    <div class="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
                        <h2 class="text-2xl font-black text-blue-900">Historial CIC</h2>
                        <button onclick="toggleHistory(false)" class="text-slate-400 font-bold text-sm hover:text-blue-600">Cerrar ‚úï</button>
                    </div>

                    <div class="mb-8">
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest text-blue-800">Seleccionar Fecha de Reporte</label>
                        <input type="date" id="history-date-picker" onchange="fetchHistoryByDate(this.value)" class="w-full p-4 border border-slate-200 rounded-2xl bg-white focus:ring-4 focus:ring-blue-500/10 outline-none text-sm transition-all font-bold text-slate-700 shadow-sm">
                    </div>

                    <div id="history-content" class="hidden space-y-6">
                        <div id="history-stats" class="bg-blue-50 border border-blue-100 p-6 rounded-3xl font-bold text-blue-900 leading-relaxed text-lg"></div>
                        <div id="history-comments" class="bg-slate-50 border border-slate-200 p-6 rounded-3xl text-slate-600 italic"></div>
                        <div id="history-list" class="results-scroll border border-slate-200 rounded-3xl divide-y divide-slate-100"></div>
                    </div>

                    <div id="history-empty" class="py-20 text-center text-slate-400 italic">
                        Seleccione una fecha para consultar reportes anteriores.
                    </div>
                </div>
            </div>

        </main>

        <!-- Firebase SDK -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // Globales del entorno
            const firebaseConfig = {
                                apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
                                authDomain: "cic6-pp-web.firebaseapp.com",
                                projectId: "cic6-pp-web",
                                storageBucket: "cic6-pp-web.firebasestorage.app",
                                messagingSenderId: "248659087868",
                                appId: "1:248659087868:web:a277ef700d83c7f1d22279",
                                measurementId: "G-ZMC7H7710Z"
                                };
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'cic.pp';

            // Variables de estado
            let user = null;
            const cameraData = [
                "01-OS-AZU-EXT-SN-ESTACIONAMIENTO", "02-OS-AZU-INT-PB-CONEXI√ìN", "03-OS-AZU-INT-PB-SITE",
                "04-OS-AZU-INT-PB-DIRECTORES", "05-OS-AZU-INT-PB-CENTRO", "06-OS-AZU-INT-PB-PRIVADO",
                "07-OS-AZU-INT-PB-ACCESO PRINCIPAL", "08-OS-AZU-INT-PB-PASILLO AZU/EXP", "09-OS-AZU-INT-PB-IDF-17",
                "10-OS-AZU-INT-PB-SITE FONDO", "11-OS-AZU-INT-PB-LIBRERO", "12-OS-AZU-INT-PA-OTE",
                "13-OS-AZU-INT-PA-PTE", "14-OS-AZU-INT-PA-PASILLO", "15-OS-AZU-INT-PA-SEOF",
                "16-OS-MOR-EXT-PB-ESTACIONAMIENTO", "20-OS-MOR-EXT-PB-PUERTA EMERGENCIA", "21-OS-MOR-INT-PB-PUERTA DE EMERGENCIA",
                "22-OS-MOR-INT-PB-AREA 03", "23-OS-MOR-EXT-PB-RAMPA", "24-OS-MOR-INT-PB-SALA DIGITAL",
                "25-OS-EXT-SN-ANDATTI GOURMENT", "26-OS-MOR-INT-PB- SITE IDF 20", "27-OS-MOR-EXT-PB-EST AREA DE MESAS",
                "31-OS-MOR-EXT-PB-COMEDOR", "32-OS-MOR-INT-PB-PASILLO", "33-OS-MOR-INT-PB-ENTRADA DIGITAL",
                "35-OS-MOR-INT-PB-SALIDA CARRANZA", "36-OS-MOR-INT-PB-AREA 02", "37-OS-MOR-INT-PB-AREA 06",
                "39-OS-MOR-EXT-PB-CONEXION EXPANSION", "40-OS-MOR-EXT-PB-ENTRADA", "41-OS-MOR-EXT-SN-PASILLO CARRANZA",
                "42-OS-MOR-EXT-PA-COMEDOR ORIENTE", "43-OS-MOR-INT-PA-ENTRADA CAR", "44-OS-MOR-INT-PA-AREA 08",
                "45-OS-MOR-INT-PA-PASILLO CAR", "46-OS-MOR-INT-PA-CAR", "47-OS-MOR-INT-PA-ANTIFRAUDES",
                "48-OS-MOR-INT-PA-CASILLERO CAR", "49-OS-MOR-INT-PA-AREA 05", "50-OS-MOR-INT-PA-AREA 21",
                "51-OS-MOR-INT-PA-AREA 14", "52-OS-MOR-INT-PA-AREA 15", "53-OS-MOR-INT-PA-AREA 17",
                "54-OS-MOR-EXT-PA-COMEDOR SUR", "55-OS-MOR-INT-PA-ACCESO CENTRO", "56-OS-MOR-INT-PA-SITE",
                "57-OS-MOR-INT-PA-FONDO CENTRAL", "58-OS-MOR-INT-PA-CONEXION EXPANSION", "59-OS-MOR-INT-PA-CAFETERA",
                "60-OS-MOR-INT-PA-AREA 04", "61-OS-MOR-INT-PA-AREA 03", "62-OS-MOR-INT-PA-AREA 06",
                "63-OS-MOR-INT-PA-AREA 12", "64-OS-MOR-INT-PA-AREA 16", "65-OS-MOR-INT-PA-AREA 07",
                "66-OS-MOR-INT-PA-AREA 18", "67-OS-ANE-INT-N1-MEZZANINE", "68-OS-ANE-INT-PA-CCO YZA",
                "69-OS-ANE-INT-N1-SALA", "70-OS-ANE-INT-N1-PASILLO", "71-OS-ANE-INT-N1-CAFETERIA",
                "72-OS-ANE-EXT-PORTERO ANEXO OS", "73-OS-ANE-INT-N1-RECEPCION ANEXO OS", "74-OS-ANE-INT-PB-COMEDOR 1",
                "75-OS-ANE-INT-PB-ACCESO COMEDOR", "76-OS-ATI-EXT-PB-MENSAJERIA", "77-OS-ANE-EXT-PA-IDF 7 ANEXO OS",
                "78-OS-ATI-INT-PA-CAFETERIA", "79-OS-ATI-INT-PA-CENTRO", "80-OS-ATI-INT-PA-IMPRESORA",
                "84-OS-TI-EXT-SN-PATIO IMPULSO", "85-OS-NAR-EXT-SN-CASETA IMPULSO", "86-OS-ATI-EXT-SN-PORTON TI",
                "87-OS-NAR-EXT-SN- ACCESO PEATONAL IMPULSO", "88-OS-EXP-EXT-PB-BALANCE", "89-OS-EXP-INT-PB-ACCESO PUERTA 20 NOV",
                "90-OS-EXP-INT-PB-SITE", "91-OS-AND-INT-SN- ANDATTI INTERIOR", "92-OS-EXP-EXT-SN-TIENDA OXXO",
                "93-OS-EXP-INT-PB-CENTRO", "94-OS-EXP-INT-PB-CAFE", "95-OS-EXP-INT-PB-DISE√ëO",
                "96-OS-AZU-EXT-SN-ACCESO 2", "97-OS-EXP-INT-PA-PROYECTOS", "98-OS-EXP-INT-PA-PASILLO MOR",
                "99-OS-EXP-INT-PA-PUENTE", "100-OS-EXP-INT-PA-PASILLO", "101-OS-EXP-INT-PA-CONEXI√ìN AZU",
                "102-OS-VER-INT-PB-SHOW ROOM", "103-OS-VER-INT-PB-ENTRADA", "104-OS-VER-EXT-SN-PATIO LOGISTICA",
                "106-OS-VER-INT-PB-SITE", "107-OS-VER-INT-PB ALMACEN", "108-OS-VER-EXT-SN-PALAPA",
                "109-OS-VER-INT-PA-PUERT EMERG", "110-OS-VER-INT-PA-NTE", "111-OS-VER-INT-PA-PASILLO",
                "112-OS-VER-INT-PA-SUR", "113-OS-EST-EXT-SN-ESTACIONAMIENTO DOMINGUEZ", "114-OS-VER-EXT-SN-EST-LOGISTICA",
                "116-OS-PER-EXT-SN-AREA RECICLAJE", "120-OS-GRI-INT-PB-ENTRADA", "121-OS-GRI-EXT-SN-PUERTA DE EMERGENCIA",
                "122-OS-GRI-INT-PB-CAFETERIA", "123-OS-GRI-INT-N1-PASILLO", "124-OS-GRI-INT-N1-BODEGA",
                "125-OS-GRI-INT-N1-CENTRO", "126-OS-GRI-INT-PB-AREA ACTIVACEL", "127-OS-GRI-INT-N2-PTE",
                "128-OS-GRI-INT-N2-CENTRO", "129-OS-GRI -INT-N1 -SITE IDF-12", "139-OS-NAR-EXT-SN- EST TECHADO PUERTA UN",
                "140-OS-TI-EXT-SN-EST TECHADO ESTE", "141-OS-TI-EXT-SN-EST TECHADO OESTE", "142-OS-ROJ-INT-SOT-SOTANO NORTE",
                "143-OS-ROJ-INT-SOT-SOTANO SUR", "144-OS-ROJ-EXT-SOT-ACCESO SOTANO", "145-OS-ROJ-INT-PB-CASETAS RECEPCION",
                "148-OS-ROJ-INT-PB-CENTRO", "149-OS-ROJ-INT-PB-RECEPCION OFICINA", "150-OS-ROJ-INT-PB-RAMPA RECEPCION",
                "151-OS-ROJ-INT-PB-RECEPCION PANORAMICA", "153-OS-ROJ-EXT-SN-PLUMA", "154-OS-ROJ-INT-SN-CASETA EDISON",
                "155-OS-ROJ-EXT-SN-EST EDISON", "156-OS-ROJ-EXT-SN-SALIDA VEHICULAR", "158-OS-ROJ-INT-PB-ELEVADOR",
                "159-OS-ROJ-EXT-SN-SALIDA EST 20 DE NOV", "160-OS-ROJ-EXT-SN-ESTACIONAMIENTO 20 DE NOV", "163-OS-ROJ-INT-PB-FIELD SERVICE",
                "165-OS-ROJ-INT-PB-MEZZANI", "166-OS-AMA-EXT-SN-ACCESO FIELD SERVICE", "167-OS-AMA-INT-PB- SHOW ROOM",
                "170-OS-AMA-INT-PB- SITE AMARILLO (RH)", "174-OS-ROJ-INT-PB-MEZZANINE SUR", "176-OS-AMA-INT-N1-ANDATTI",
                "177-OS-AMA-INT-N1-BODEGA", "178-OS-AMA-INT-N1-CENTRO DIR", "179-OS-AMA-INT-N1- CCO PROXYLOGIS",
                "180-OS-AMA-INT-N1-CONEXION PUENTE", "181-OS-AMA-INT-N1-DIRECCION 1", "182-OS-AMA-INT-N1-ENTRADA SILOS",
                "183-OS-AMA-INT-N1- CCO PROXYLOGIS (MONITOREO)", "190-OS-ROJ-INT-PB- SITE NACIONAL INTERIOR", "192-OS-AMA-INT-N3-O SABOR PONIENTE",
                "193-OS-AMA-INT-N3-O SABOR", "196-OS-SIL-INT-SN-ELEVADOR SILOS INTERIOR", "197-OS-AMA-INT-N4-O SABOR NORTE",
                "198-OS-AMA-INT-N4-O SABOR ORIENTE", "199 -OS-SIL-EXT-N5-ESCALERAS", "201-OS-AMA-INT-N5-BAR ORIENTE",
                "202-OS-AMA-INT-N5-BAR PONIENTE", "206-OS-ROJ-INT-N3-PASILLOS", "207-OS-ROJ-EXT-N3-TERRAZA",
                "208-OS-ROJ-INT-N3-AMENIDADES", "209-OS-ROJ-INT-N3-SITE", "210-OS-ROJ-INT-N3-ENTRADA AZO",
                "211-OS-AZU-INT-PB-SALA 3", "215-OS-PER-EXT-SN-COMEDOR 1 PONIENTE", "216-OS-PER-EXT-SN-COMEDOR 1",
                "217-OS-PER-EXT-SN-PTZ VIAS CRUCE", "218-OS-PER-EXT-SN-EST VISITAS", "220-OS-PER-EXT-SN-TORNIQUETE ENT EDISON",
                "221-OS-PER-EXT-SN-ACCESO RECEPCION", "222-OS-PER-EXT-SN-BANCAS SUR", "223-OS-PER-EXT-SN-BANCAS NTE",
                "224-OS-PER-EXT-SN-PUERTA DE EMERGENCIA", "225-OS-PER-EXT-SN-PANADERIA", "230-OS-PER-EXT-SN-CALLEJON 20 NOV",
                "231-OS-PER-EXT-SN-ENTRADA DOMINGUEZ", "232-OS-PER-EXT-SN-DOMINGUEZ OTE", "233-OS-PER-EXT-SN-CALLEJON",
                "234-OS-PER-EXT-SN-CALLEJON MIGUEL DOMINGUEZ/CARRANZA", "235-OS-PER-EXT-SN-ENTRADA 20 NOV", "236-OS-PER-EXT-ENTRADA IMPULSO",
                "237-OS-PER-EXT-SN-EST CARRANZA", "238-OS-PER-EXT-PORTERO UNIVERSIDAD", "239-OS-PER-EXT-SN-VIAS 3",
                "240-OS-PER-EXT-SN-PTZ VIAS 2", "241-OS-PER-EXT-SN-VIAS 1", "242-OS-PER-EXT-SN-VIAS 2",
                "243-OS-PER-EXT-SN-PTZ VIAS 1", "247-OS-MIC-PER-EXT-SN-CALLE MICHELENA", "258-OS-PER-EXT-PORTERO UNIVERSIDAD",
                "259-OS-SIM-INT-PB-RECEPCION", "260-OS-SIM-INT-N3-FRENTE", "261-OS-SIM-INT-N4-COMEDOR",
                "262-OS-MIC-INT-SN-ACCESO VEHICULAR", "263-OS-MIC-INT-SN-CASETA MICHELENA", "264-OS-MIC-EXT-SN-SALIDA VEHICULAR",
                "265-OS-MIC-EXT-SN-ACCESO PEATONAL", "273-OS-MIC-INT-PB-ENTRADA PRINCIPAL", "274-OS-MIC-INT-PB-RAMPA CAJERO",
                "275-OS-MIC-INT-PB-CAJERO", "276-OS-MIC-INT-PB-OXXO GAS", "277-OS-MIC-INT-PB-ELEVADORES",
                "285-OS-MIC-INT-N1-ELEVADOR", "288-OS-MIC-INT-N1-PASILLO NTE", "289-OS-MIC-INT-N1-PASILLO SUR",
                "291-OS-MIC-INT-N1-BODEGA IMMEX", "292-OS-MIC-INT-N2-ELEVADORES OXXOGAS", "293-OS-MIC-INT-N2-SALA DE JUNTAS",
                "294-OS-MIC-INT-N2-DIR OXXO GAS", "295-OS-MIC-INT-N2-PASILLO OXXO GAS PONIENTE", "296-OS-MIC-INT-N2-PASILLO OXXO GAS PONIENTE",
                "297-OS-MIC-INT-N2-PUERTA DE EMERGENCIA", "303-OS-MIC-INT-N3-PASILLO NTE", "304-OS-MIC-INT-N3-PASILLO SUR",
                "306-OS-MIC-INT-N4-ELEVADORES", "307-OS-MIC-INT-N4-PASILLO FARMACIA", "308-OS-MIC-INT-N4-FARMACIA PONIENTE",
                "309-OS-MIC-INT-N4-FARMACIA ORIENTE", "311-OS-MIC-INT-N4-RECEPCION YZA", "319-OS-COM-INT-SN-ACCESO COMEDOR 2",
                "320-OS-COM-INT-SN-COMEDOR 2", "321-OS-CCO-INT-CCO", "322-OS-ATI-EXT-SN- EST TI",
                "323-OS-PER-EXT-SN-CARRANZA", "324-OS-EX-SN-CASETA CARRANZA", "325-OS-MIC-INT-PB-CCO OXXO GAS",
                "326-OS-UN-INT-SN- TRAILAR EST UN", "327-OS-UN-EXT-SN-ESTACIONAMIENTO U.N FONDO", "328-OS-UN-EXT-SN-ESTACIONAMIENTO U.N ENTRADA",
                "329-OS-ROJ-EXT-N3-ESCALERAS", "330-OS-ROJ-INT-N3-COCINETA", "331-OS-AZU-EXT-SN-CUCHILLA",
                "332-OS-SIM-EXT-SN-CALLE", "333-OS-SIM-INT-PB-INTENDENCIA", "334-OS-SIM-INT-PASILLO ELAVADOR",
                "335-OS-SIM-INT-N1-FONDO", "336-OS-SIM-INT-N2-FRENTE", "337-OS-SIM-INT-N2-FONDO",
                "338-OS-SIM-INT-N3-FONDO", "339-OS-SIM-INT-N4-FONDO", "340-OS-PER-EXT-SN-EST VIAS",
                "341-OS-PER-INT-SN-ESTACIONAMIENTO VIAS EDI", "342-OS-PER-EXT-SN-PRIV EDI", "343-OS-PER-EXT-SN-VIAS4",
                "344-OS-SIL-INT-N4-SITE", "345-OS-SIL-EXT-N6-ESCALERAS", "346-OS-SIL-INT-N6-CCO IMMEX",
                "347-OS-CCO-INT-CCO FRONTAL", "348-OS-UN-EXT-SN-ESTACIONAMIENTO U.N CENTRO", "349-OS-UN-EXT-SN-ESTACIONAMIENTO U.N FONDO VIAS"
            ];

            let currentIndex = parseInt(localStorage.getItem('cctv_index')) || 0;
            let results = JSON.parse(localStorage.getItem('cctv_detailed_results')) || {};

            // INICIALIZACI√ìN FIREBASE (RESTRINGIDA)
            const initAuth = async () => {
                showStatus("Iniciando sesi√≥n segura...", "info");
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        // EL CIC NO ADMITE AN√ìNIMOS: Lanzamos error para notificar al usuario
                        throw new Error("Acceso Restringido: El CIC no admite usuarios an√≥nimos.");
                    }
                } catch (error) {
                    console.error("Auth error:", error);
                    showStatus("Error: Acceso restringido al Centro de Control.", "error");
                }
            };

            onAuthStateChanged(auth, (u) => {
                user = u;
                if (u) {
                    showStatus("Autenticaci√≥n verificada. Base de datos CIC activa.", "success");
                }
            });

            // FUNCIONES DE INTERFAZ
            window.showStatus = (msg, type = 'info') => {
                const pill = document.getElementById('status-pill');
                const text = document.getElementById('status-text');
                pill.style.display = 'block';
                text.innerText = msg;
                pill.className = "status-pill px-6 py-3 rounded-2xl shadow-2xl font-bold text-white transition-all transform scale-100 border border-white/20";
                if (type === 'success') pill.classList.add('bg-emerald-600');
                else if (type === 'error') pill.classList.add('bg-rose-600');
                else pill.classList.add('bg-blue-600');
                setTimeout(() => {
                    pill.classList.replace('scale-100', 'scale-95');
                    setTimeout(() => pill.style.display = 'none', 300);
                }, 4000);
            };

            window.updateUI = () => {
                if (currentIndex >= cameraData.length) {
                    window.showSummary();
                    return;
                }
                const camStr = cameraData[currentIndex];
                const [id, ...rest] = camStr.split('-');
                document.getElementById('cam-id').innerText = `ID: ${id}`;
                document.getElementById('cam-name').innerText = rest.join('-');
                const now = new Date();
                document.getElementById('review-time').value = results[camStr]?.time || `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                document.getElementById('individual-comment').value = results[camStr]?.comment || "";
                document.getElementById('counter').innerText = `${currentIndex + 1} / ${cameraData.length}`;
                document.getElementById('progress-bar').style.width = `${((currentIndex + 1) / cameraData.length) * 100}%`;
                document.getElementById('btn-prev').disabled = currentIndex === 0;
                localStorage.setItem('cctv_index', currentIndex);
            };

            window.markCamera = (status) => {
                const camStr = cameraData[currentIndex];
                results[camStr] = {
                    id_camara: camStr.split('-')[0],
                    ubicacion: camStr.split('-').slice(1).join('-'),
                    status: status ? "OK" : "FALLA",
                    comment: document.getElementById('individual-comment').value.trim(),
                    time: document.getElementById('review-time').value
                };
                localStorage.setItem('cctv_detailed_results', JSON.stringify(results));
                if (currentIndex < cameraData.length - 1) { currentIndex++; window.updateUI(); }
                else window.showSummary();
            };

            window.prevCamera = () => { if (currentIndex > 0) { currentIndex--; window.updateUI(); } };

            window.showSummary = () => {
                document.getElementById('wizard-container').classList.add('hidden');
                document.getElementById('history-container').classList.add('hidden');
                document.getElementById('summary-container').classList.remove('hidden');
                const reviewed = cameraData.map(cam => results[cam]).filter(Boolean);
                const okCount = reviewed.filter(r => r.status === "OK").length;
                const failCount = reviewed.length - okCount;
                
                document.getElementById('summary-stats-display').innerHTML = `
                    <p>C√°maras Correctas: ${okCount}</p>
                    <p>C√°maras con Falla: ${failCount}</p>
                    <p>Total Inspecciones: ${reviewed.length} de ${cameraData.length}</p>`;
                    
                const list = document.getElementById('results-list');
                list.innerHTML = reviewed.map(data => `
                    <div class="p-4 text-sm hover:bg-slate-50 transition-colors">
                        <div class="flex items-center justify-between font-bold ${data.status === 'OK' ? 'text-emerald-600' : 'text-rose-600'}">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <span class="text-[10px] bg-slate-100 px-1 rounded text-slate-500 font-mono border border-slate-200">${data.id_camara}</span>
                                <span class="truncate max-w-[150px] uppercase tracking-tight text-slate-700 font-black">${data.ubicacion}</span>
                                <span class="text-[10px] bg-blue-50 text-blue-500 px-1 rounded ml-1 font-mono">${data.time}</span>
                            </div>
                            <span>${data.status === 'OK' ? '‚úÖ' : '‚ùå'}</span>
                        </div>
                        ${data.comment ? `<div class="mt-1 text-xs text-slate-400 font-medium italic">Nota: ${data.comment}</div>` : ''}
                    </div>`).join('');
            };

            window.backToWizard = () => {
                document.getElementById('summary-container').classList.add('hidden');
                document.getElementById('history-container').classList.add('hidden');
                document.getElementById('wizard-container').classList.remove('hidden');
                window.updateUI();
            };

            window.toggleHistory = (show) => {
                if (show) {
                    document.getElementById('wizard-container').classList.add('hidden');
                    document.getElementById('summary-container').classList.add('hidden');
                    document.getElementById('history-container').classList.remove('hidden');
                } else {
                    window.backToWizard();
                }
            };

            // L√ìGICA DE FIREBASE Y ENV√çO API
            window.exportAndSend = async () => {
                const reviewed = cameraData.map(cam => results[cam]).filter(Boolean);
                if (reviewed.length === 0) { window.showStatus("Sin registros para enviar.", "error"); return; }

                const btn = document.getElementById('btn-send-api');
                btn.disabled = true;
                btn.innerText = "PROCESANDO REPORTE...";

                const okCount = reviewed.filter(r => r.status === "OK").length;
                const failCount = reviewed.length - okCount;
                const finalComment = document.getElementById('final-general-comment').value.trim();
                const dateStr = new Date().toISOString().split('T')[0];

                // 1. Guardar en Firebase (Bloqueado si no hay autenticaci√≥n real)
                if (user) {
                    try {
                        const reportData = {
                            fecha: dateStr,
                            timestamp: Date.now(),
                            stats: { ok: okCount, fail: failCount, total: reviewed.length, master: cameraData.length },
                            comentarios_finales: finalComment,
                            detalle: reviewed
                        };
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'RecorridoVirtual', dateStr);
                        await setDoc(docRef, reportData);
                        window.showStatus("Reporte guardado en la nube CIC.", "success");
                    } catch (e) {
                        console.error(e);
                        window.showStatus("Error al guardar en base de datos central.", "error");
                    }
                } else {
                    window.showStatus("Aviso: No se guard√≥ en nube por falta de credenciales.", "error");
                }

                // 2. Enviar a Power Automate (Documento HTML puro en el body)
                const docHtml = generateCompleteHTML(reviewed, okCount, failCount, cameraData.length, reviewed.length, finalComment);
                try {
                    const response = await fetch(API_URL, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ body: docHtml }) 
                    });
                    if (response.ok) {
                        window.showStatus("¬°Inspecci√≥n transmitida al Centro de Control!", "success");
                    } else {
                        throw new Error();
                    }
                } catch (err) { 
                    window.showStatus("Error de transmisi√≥n externa.", "error"); 
                }

                btn.disabled = false;
                btn.innerHTML = "<span>üöÄ</span> Enviar Reporte Final";
            };

            window.fetchHistoryByDate = async (date) => {
                if (!date || !user) {
                    if (!user) showStatus("Debe estar autenticado para ver el historial.", "error");
                    return;
                }
                const content = document.getElementById('history-content');
                const empty = document.getElementById('history-empty');
                
                showStatus("Consultando servidor...", "info");
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'RecorridoVirtual', date);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        empty.classList.add('hidden');
                        content.classList.remove('hidden');
                        
                        document.getElementById('history-stats').innerHTML = `
                            <p>C√°maras Correctas: ${data.stats.ok}</p>
                            <p>C√°maras con Falla: ${data.stats.fail}</p>
                            <p>Total Inspecciones: ${data.stats.total} de ${data.stats.master}</p>`;
                        
                        document.getElementById('history-comments').innerText = data.comentarios_finales || "Sin comentarios generales.";
                        
                        document.getElementById('history-list').innerHTML = data.detalle.map(d => `
                            <div class="p-4 border-b last:border-0">
                                <div class="flex justify-between items-center font-bold">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-mono bg-slate-100 px-1 rounded border border-slate-200">${d.id_camara}</span>
                                        <span class="text-sm uppercase text-slate-700 truncate max-w-[200px]">${d.ubicacion}</span>
                                    </div>
                                    <span class="${d.status === 'OK' ? 'text-emerald-600' : 'text-rose-600'}">${d.status === 'OK' ? '‚úÖ' : '‚ùå'}</span>
                                </div>
                                <div class="text-[10px] text-slate-400 font-bold">${d.time} hrs</div>
                                ${d.comment ? `<div class="text-xs mt-1 text-slate-500 italic">${d.comment}</div>` : ''}
                            </div>
                        `).join('');
                    } else {
                        content.classList.add('hidden');
                        empty.classList.remove('hidden');
                        empty.innerText = "No se encontr√≥ ning√∫n reporte para el d√≠a seleccionado.";
                    }
                } catch (e) {
                    showStatus("Error de conexi√≥n al historial.", "error");
                }
            };

            function generateCompleteHTML(reviewedData, ok, fail, total, reviewedCount, finalComment) {
                let tableRows = reviewedData.map((item, index) => `
                    <tr style="background-color: ${index % 2 === 0 ? "#ffffff" : "#f9fafb"};">
                        <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: bold; color: #1e3a8a; font-size: 12px; font-family: monospace;">${item.id_camara}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; color: #374151; text-transform: uppercase; font-size: 11px; font-weight: bold;">${item.ubicacion}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">
                            <span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: 900; color: ${item.status === 'OK' ? '#059669' : '#e11d48'}; border: 1px solid ${item.status === 'OK' ? '#059669' : '#e11d48'}; background-color: ${item.status === 'OK' ? '#f0fdf4' : '#fef2f2'}; font-size: 10px;">${item.status === 'OK' ? 'OK' : 'FALLA'}</span>
                        </td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; color: #3b82f6; font-family: monospace; font-weight: bold; font-size: 12px;">${item.time}</td>
                        <td style="padding: 10px; border: 1px solid #e5e7eb; color: #6b7280; font-style: italic; font-size: 11px;">${item.comment || '-'}</td>
                    </tr>`).join('');

                const formattedComment = (finalComment || 'Sin comentarios adicionales.')
                    .split('\n')
                    .map(l => `<p style="margin:0 0 5px 0; font-size:14px; color:#334155; font-weight:500;">${l}</p>`)
                    .join('');

                const fullHtml = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><style>
                    body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f3f4f6; margin: 0; padding: 20px; }
                    .card { max-width: 800px; margin: 0 auto; background: #ffffff; border-radius: 16px; border: 1px solid #e5e7eb; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
                    .header { background-color: #1e3a8a; padding: 30px; color: #ffffff; border-bottom: 4px solid #3b82f6; }
                    .stats-section { padding: 25px; background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; }
                    .stats-section p { margin: 0 0 8px 0; font-weight: bold; color: #1e293b; font-size: 17px; }
                    .comments-section { padding: 25px; background-color: #ffffff; border-bottom: 1px solid #f1f5f9; }
                    .comments-title { margin: 0 0 10px 0; font-size: 11px; text-transform: uppercase; color: #1e3a8a; font-weight: 900; letter-spacing: 1px; }
                    .comments-box { padding: 20px; background: #f0f7ff; border: 1px solid #cfe2f3; border-radius: 14px; }
                    .table-container { padding: 25px; }
                    table { width: 100%; border-collapse: collapse; border: 2px solid #1e3a8a; }
                    th { background-color: #1e40af; color: #ffffff; padding: 14px; text-transform: uppercase; font-size: 11px; border: 1px solid #1e3a8a; font-weight: 900; }
                    .footer-quote { margin-top: 40px; padding: 30px; text-align: right; border-top: 1px solid #f3f4f6; color: #64748b; font-style: italic; font-size: 17px; font-family: 'Times New Roman', serif; font-weight: 900; }
                </style></head><body><div class="card">
                    <div class="header"><h1 style="margin:0;font-size:26px;font-weight:900;letter-spacing:-0.5px;text-transform:uppercase;">Recorrido virtual CCTV</h1></div>
                    <div class="stats-section">
                        <p>C√°maras Correctas: ${ok}</p>
                        <p>C√°maras con Falla: ${fail}</p>
                        <p>Total Inspecciones: ${reviewedCount} de ${total}</p>
                    </div>
                    <div class="comments-section"><p class="comments-title">Comentarios Finales:</p><div class="comments-box">${formattedComment}</div></div>
                    <div class="table-container">
                        <h3 style="margin-top:0;color:#1e293b;font-size:15px;text-transform:uppercase;letter-spacing:0.5px;font-weight:900;margin-bottom:15px;">Bit√°cora de C√°maras Revisadas</h3>
                        <table><thead><tr><th>ID</th><th>Ubicaci√≥n</th><th>Estado</th><th>Hora</th><th>Notas</th></tr></thead><tbody>${tableRows}</tbody></table>
                    </div>
                    <div class="footer-quote">&ldquo;CIC - Centro de Control&rdquo;</div>
                </div></body></html>`;
                
                // Minificaci√≥n extrema del HTML para el env√≠o limpio
                return fullHtml.replace(/>\s+</g, '><').replace(/\s{2,}/g, ' ').trim();
            }

            window.resetApp = () => {
                if (confirm("¬øLimpiar todos los registros y reiniciar la inspecci√≥n CIC?")) {
                    localStorage.removeItem('cctv_index');
                    localStorage.removeItem('cctv_detailed_results');
                    currentIndex = 0;
                    results = {};
                    window.backToWizard();
                }
            };

            // Inicio seguro sin an√≥nimos
            initAuth();
            window.updateUI();
        </script>
    </body>
    </html>