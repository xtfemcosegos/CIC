<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist de C√°maras CCTV - CIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-transition {
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .status-pill {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .pro-shadow {
            box-shadow: 0 10px 25px -5px rgba(30, 64, 175, 0.1), 0 8px 10px -6px rgba(30, 64, 175, 0.1);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <!-- Indicador de Estado (Toast) -->
    <div id="status-pill" class="status-pill px-6 py-3 rounded-2xl shadow-2xl font-bold text-white transition-all transform scale-95">
        <span id="status-text">Enviando datos...</span>
    </div>

    <!-- Header Profesional / Progreso -->
    <nav class="bg-gradient-to-r from-blue-900 via-blue-800 to-indigo-900 text-white shadow-2xl sticky top-0 z-50">
        <div class="max-w-2xl mx-auto px-6 py-5">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-500/20 p-2 rounded-lg backdrop-blur-md">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight uppercase">CIC Centro de Control</h1>
                        <p class="text-blue-300 text-[10px] font-bold tracking-[0.2em] uppercase">M√≥dulo de Inspecci√≥n CCTV</p>
                    </div>
                </div>
                <span id="counter" class="text-xs font-mono font-bold bg-white/10 px-3 py-1.5 rounded-lg border border-white/20">0 / 0</span>
            </div>
            <div class="w-full bg-blue-950/50 rounded-full h-2 border border-white/5">
                <div id="progress-bar" class="bg-gradient-to-r from-blue-400 to-indigo-400 h-2 rounded-full progress-transition" style="width: 0%"></div>
            </div>
        </div>
    </nav>

    <main class="max-w-2xl mx-auto px-4 py-8">
        
        <!-- Interfaz de Paso a Paso -->
        <div id="wizard-container" class="space-y-6">
            <div id="camera-card" class="bg-white rounded-[2.5rem] p-8 text-center fade-in pro-shadow border border-slate-100">
                <span id="cam-id" class="inline-block px-4 py-1.5 rounded-full bg-blue-50 text-blue-700 text-[10px] font-black mb-6 uppercase tracking-widest border border-blue-100">C√ÅMARA DE SEGURIDAD</span>
                <h2 id="cam-name" class="text-2xl font-black text-slate-800 leading-tight mb-8">Cargando...</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-8 text-left">
                    <div class="md:col-span-1">
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Registro Hora</label>
                        <input type="time" id="review-time" 
                               class="w-full p-4 border border-slate-100 rounded-2xl bg-slate-50 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none text-sm transition-all font-mono font-bold">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Observaciones T√©cnicas</label>
                        <textarea id="individual-comment" 
                                  class="w-full p-4 border border-slate-100 rounded-2xl bg-slate-50 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none text-sm transition-all font-medium" 
                                  rows="1" 
                                  placeholder="Detalle de falla o estado del lente..."></textarea>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button onclick="markCamera(true)" class="flex items-center justify-center gap-3 bg-emerald-500 hover:bg-emerald-600 active:scale-95 text-white py-6 rounded-[1.5rem] font-black text-lg transition-all shadow-xl shadow-emerald-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                        VISUALIZACI√ìN OK
                    </button>
                    <button onclick="markCamera(false)" class="flex items-center justify-center gap-3 bg-rose-500 hover:bg-rose-600 active:scale-95 text-white py-6 rounded-[1.5rem] font-black text-lg transition-all shadow-xl shadow-rose-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                        DETECCI√ìN FALLA
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-center px-4">
                <button onclick="prevCamera()" id="btn-prev" class="text-slate-400 hover:text-blue-600 font-bold text-sm flex items-center gap-2 transition-colors disabled:opacity-0 group">
                    <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span> C√°mara Anterior
                </button>
                <button onclick="showSummary()" class="text-[10px] font-bold text-slate-400 uppercase hover:text-blue-600 transition-colors tracking-widest">Ver Reporte Final</button>
            </div>
        </div>

        <!-- Pantalla Final / Resumen -->
        <div id="summary-container" class="hidden space-y-6 fade-in">
            <div class="bg-white rounded-[2.5rem] p-8 pro-shadow border border-slate-100">
                <h2 class="text-2xl font-black mb-6 flex items-center gap-3 text-slate-800 border-b border-slate-100 pb-4">
                    <span class="p-2 bg-blue-50 rounded-xl text-blue-600">üìä</span> Reporte de Inspecci√≥n
                </h2>
                
                <div class="mb-6">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 tracking-widest">Estad√≠sticas y Comentarios (Editable)</label>
                    <textarea id="detailed-text-box" 
                              class="w-full h-48 p-4 border border-slate-200 rounded-2xl bg-slate-50 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none text-sm transition-all font-mono text-slate-700 leading-relaxed resize-none"></textarea>
                </div>

                <div id="results-list" class="max-h-64 overflow-y-auto mb-8 border border-slate-100 rounded-[1.5rem] divide-y divide-slate-50">
                    <!-- Se llena con JS -->
                </div>

                <div class="flex flex-col gap-4">
                    <button id="btn-send-api" onclick="exportAndSend()" class="w-full bg-blue-600 text-white py-5 rounded-[1.5rem] font-black hover:bg-blue-700 transition-all shadow-xl shadow-blue-200 flex items-center justify-center gap-3 active:scale-95">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                        FINALIZAR Y ENVIAR CIC
                    </button>
                    <button onclick="backToWizard()" class="w-full text-slate-500 font-bold text-sm hover:text-slate-700 transition-colors text-center">
                        Reanudar inspecci√≥n
                    </button>
                    <button onclick="resetApp()" class="w-full text-rose-400 text-[10px] font-black mt-6 hover:text-rose-600 tracking-tighter uppercase transition-colors">
                        Reiniciar base de datos local
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        const API_URL = "https://default3b2cbccb81bb44a2a19a2386bb3606.02.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/934f07eeecb44e11af5c0e90a8ebf039/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=3GXOIlSLKDmORGIQy7FbN3OMF1uFaVWngJvq7Q37_oU";

        const cameraData = [
            "01-OS-AZU-EXT-SN-ESTACIONAMIENTO", "02-OS-AZU-INT-PB-CONEXI√ìN", "03-OS-AZU-INT-PB-SITE",
            "04-OS-AZU-INT-PB-DIRECTORES", "05-OS-AZU-INT-PB-CENTRO", "06-OS-AZU-INT-PB-PRIVADO",
            "07-OS-AZU-INT-PB-ACCESO PRINCIPAL", "08-OS-AZU-INT-PB-PASILLO AZU/EXP", "09-OS-AZU-INT-PB-IDF-17",
            "10-OS-AZU-INT-PB-SITE FONDO", "11-OS-AZU-INT-PB-LIBRERO", "12-OS-AZU-INT-PA-OTE",
            "13-OS-AZU-INT-PA-PTE", "14-OS-AZU-INT-PA-PASILLO", "15-OS-AZU-INT-PA-SEOF",
            "16-OS-MOR-EXT-PB-ESTACIONAMIENTO", "20-OS-MOR-EXT-PB-PUERTA EMERGENCIA", "21-OS-MOR-INT-PB-PUERTA DE EMERGENCIA",
            "22-OS-MOR-INT-PB-AREA 03", "23-OS-MOR-EXT-PB-RAMPA", "24-OS-MOR-INT-PB-SALA DIGITAL",
            "25-OS-EXT-SN-ANDATTI GOURMENT", "26-OS-MOR-INT-PB- SITE IDF 20", "27-OS-MOR-EXT-PB-EST AREA DE MESAS",
            "31-OS-MOR-EXT-PB-COMEDOR", "32-OS-MOR-INT-PB-PASILLO", "33-OS-MOR-INT-PB-ENTRADA DIGITAL",
            "35-OS-MOR-INT-PB-SALIDA CARRANZA", "36-OS-MOR-INT-PB-AREA 02", "37-OS-MOR-INT-PB-AREA 06",
            "39-OS-MOR-EXT-PB-CONEXION EXPANSION", "40-OS-MOR-EXT-PB-ENTRADA", "41-OS-MOR-EXT-SN-PASILLO CARRANZA",
            "42-OS-MOR-EXT-PA-COMEDOR ORIENTE", "43-OS-MOR-INT-PA-ENTRADA CAR", "44-OS-MOR-INT-PA-AREA 08",
            "45-OS-MOR-INT-PA-PASILLO CAR", "46-OS-MOR-INT-PA-CAR", "47-OS-MOR-INT-PA-ANTIFRAUDES",
            "48-OS-MOR-INT-PA-CASILLERO CAR", "49-OS-MOR-INT-PA-AREA 05", "50-OS-MOR-INT-PA-AREA 21",
            "51-OS-MOR-INT-PA-AREA 14", "52-OS-MOR-INT-PA-AREA 15", "53-OS-MOR-INT-PA-AREA 17",
            "54-OS-MOR-EXT-PA-COMEDOR SUR", "55-OS-MOR-INT-PA-ACCESO CENTRO", "56-OS-MOR-INT-PA-SITE",
            "57-OS-MOR-INT-PA-FONDO CENTRAL", "58-OS-MOR-INT-PA-CONEXION EXPANSION", "59-OS-MOR-INT-PA-CAFETERA",
            "60-OS-MOR-INT-PA-AREA 04", "61-OS-MOR-INT-PA-AREA 03", "62-OS-MOR-INT-PA-AREA 06",
            "63-OS-MOR-INT-PA-AREA 12", "64-OS-MOR-INT-PA-AREA 16", "65-OS-MOR-INT-PA-AREA 07",
            "66-OS-MOR-INT-PA-AREA 18", "67-OS-ANE-INT-N1-MEZZANINE", "68-OS-ANE-INT-PA-CCO YZA",
            "69-OS-ANE-INT-N1-SALA", "70-OS-ANE-INT-N1-PASILLO", "71-OS-ANE-INT-N1-CAFETERIA",
            "72-OS-ANE-EXT-PORTERO ANEXO OS", "73-OS-ANE-INT-N1-RECEPCION ANEXO OS", "74-OS-ANE-INT-PB-COMEDOR 1",
            "75-OS-ANE-INT-PB-ACCESO COMEDOR", "76-OS-ATI-EXT-PB-MENSAJERIA", "77-OS-ANE-EXT-PA-IDF 7 ANEXO OS",
            "78-OS-ATI-INT-PA-CAFETERIA", "79-OS-ATI-INT-PA-CENTRO", "80-OS-ATI-INT-PA-IMPRESORA",
            "84-OS-TI-EXT-SN-PATIO IMPULSO", "85-OS-NAR-EXT-SN-CASETA IMPULSO", "86-OS-ATI-EXT-SN-PORTON TI",
            "87-OS-NAR-EXT-SN- ACCESO PEATONAL IMPULSO", "88-OS-EXP-EXT-PB-BALANCE", "89-OS-EXP-INT-PB-ACCESO PUERTA 20 NOV",
            "90-OS-EXP-INT-PB-SITE", "91-OS-AND-INT-SN- ANDATTI INTERIOR", "92-OS-EXP-EXT-SN-TIENDA OXXO",
            "93-OS-EXP-INT-PB-CENTRO", "94-OS-EXP-INT-PB-CAFE", "95-OS-EXP-INT-PB-DISE√ëO",
            "96-OS-AZU-EXT-SN-ACCESO 2", "97-OS-EXP-INT-PA-PROYECTOS", "98-OS-EXP-INT-PA-PASILLO MOR",
            "99-OS-EXP-INT-PA-PUENTE", "100-OS-EXP-INT-PA-PASILLO", "101-OS-EXP-INT-PA-CONEXI√ìN AZU",
            "102-OS-VER-INT-PB-SHOW ROOM", "103-OS-VER-INT-PB-ENTRADA", "104-OS-VER-EXT-SN-PATIO LOGISTICA",
            "106-OS-VER-INT-PB-SITE", "107-OS-VER-INT-PB ALMACEN", "108-OS-VER-EXT-SN-PALAPA",
            "109-OS-VER-INT-PA-PUERT EMERG", "110-OS-VER-INT-PA-NTE", "111-OS-VER-INT-PA-PASILLO",
            "112-OS-VER-INT-PA-SUR", "113-OS-EST-EXT-SN-ESTACIONAMIENTO DOMINGUEZ", "114-OS-VER-EXT-SN-EST-LOGISTICA",
            "116-OS-PER-EXT-SN-AREA RECICLAJE", "120-OS-GRI-INT-PB-ENTRADA", "121-OS-GRI-EXT-SN-PUERTA DE EMERGENCIA",
            "122-OS-GRI-INT-PB-CAFETERIA", "123-OS-GRI-INT-N1-PASILLO", "124-OS-GRI-INT-N1-BODEGA",
            "125-OS-GRI-INT-N1-CENTRO", "126-OS-GRI-INT-PB-AREA ACTIVACEL", "127-OS-GRI-INT-N2-PTE",
            "128-OS-GRI-INT-N2-CENTRO", "129-OS-GRI -INT-N1 -SITE IDF-12", "139-OS-NAR-EXT-SN- EST TECHADO PUERTA UN",
            "140-OS-TI-EXT-SN-EST TECHADO ESTE", "141-OS-TI-EXT-SN-EST TECHADO OESTE", "142-OS-ROJ-INT-SOT-SOTANO NORTE",
            "143-OS-ROJ-INT-SOT-SOTANO SUR", "144-OS-ROJ-EXT-SOT-ACCESO SOTANO", "145-OS-ROJ-INT-PB-CASETAS RECEPCION",
            "148-OS-ROJ-INT-PB-CENTRO", "149-OS-ROJ-INT-PB-RECEPCION OFICINA", "150-OS-ROJ-INT-PB-RAMPA RECEPCION",
            "151-OS-ROJ-INT-PB-RECEPCION PANORAMICA", "153-OS-ROJ-EXT-SN-PLUMA", "154-OS-ROJ-INT-SN-CASETA EDISON",
            "155-OS-ROJ-EXT-SN-EST EDISON", "156-OS-ROJ-EXT-SN-SALIDA VEHICULAR", "158-OS-ROJ-INT-PB-ELEVADOR",
            "159-OS-ROJ-EXT-SN-SALIDA EST 20 DE NOV", "160-OS-ROJ-EXT-SN-ESTACIONAMIENTO 20 DE NOV", "163-OS-ROJ-INT-PB-FIELD SERVICE",
            "165-OS-ROJ-INT-PB-MEZZANI", "166-OS-AMA-EXT-SN-ACCESO FIELD SERVICE", "167-OS-AMA-INT-PB- SHOW ROOM",
            "170-OS-AMA-INT-PB- SITE AMARILLO (RH)", "174-OS-ROJ-INT-PB-MEZZANINE SUR", "176-OS-AMA-INT-N1-ANDATTI",
            "177-OS-AMA-INT-N1-BODEGA", "178-OS-AMA-INT-N1-CENTRO DIR", "179-OS-AMA-INT-N1- CCO PROXYLOGIS",
            "180-OS-AMA-INT-N1-CONEXION PUENTE", "181-OS-AMA-INT-N1-DIRECCION 1", "182-OS-AMA-INT-N1-ENTRADA SILOS",
            "183-OS-AMA-INT-N1- CCO PROXYLOGIS (MONITOREO)", "190-OS-ROJ-INT-PB- SITE NACIONAL INTERIOR", "192-OS-AMA-INT-N3-O SABOR PONIENTE",
            "193-OS-AMA-INT-N3-O SABOR", "196-OS-SIL-INT-SN-ELEVADOR SILOS INTERIOR", "197-OS-AMA-INT-N4-O SABOR NORTE",
            "198-OS-AMA-INT-N4-O SABOR ORIENTE", "199 -OS-SIL-EXT-N5-ESCALERAS", "201-OS-AMA-INT-N5-BAR ORIENTE",
            "202-OS-AMA-INT-N5-BAR PONIENTE", "206-OS-ROJ-INT-N3-PASILLOS", "207-OS-ROJ-EXT-N3-TERRAZA",
            "208-OS-ROJ-INT-N3-AMENIDADES", "209-OS-ROJ-INT-N3-SITE", "210-OS-ROJ-INT-N3-ENTRADA AZO",
            "211-OS-AZU-INT-PB-SALA 3", "215-OS-PER-EXT-SN-COMEDOR 1 PONIENTE", "216-OS-PER-EXT-SN-COMEDOR 1",
            "217-OS-PER-EXT-SN-PTZ VIAS CRUCE", "218-OS-PER-EXT-SN-EST VISITAS", "220-OS-PER-EXT-SN-TORNIQUETE ENT EDISON",
            "221-OS-PER-EXT-SN-ACCESO RECEPCION", "222-OS-PER-EXT-SN-BANCAS SUR", "223-OS-PER-EXT-SN-BANCAS NTE",
            "224-OS-PER-EXT-SN-PUERTA DE EMERGENCIA", "225-OS-PER-EXT-SN-PANADERIA", "230-OS-PER-EXT-SN-CALLEJON 20 NOV",
            "231-OS-PER-EXT-SN-ENTRADA DOMINGUEZ", "232-OS-PER-EXT-SN-DOMINGUEZ OTE", "233-OS-PER-EXT-SN-CALLEJON",
            "234-OS-PER-EXT-SN-CALLEJON MIGUEL DOMINGUEZ/CARRANZA", "235-OS-PER-EXT-SN-ENTRADA 20 NOV", "236-OS-PER-EXT-ENTRADA IMPULSO",
            "237-OS-PER-EXT-SN-EST CARRANZA", "238-OS-PER-EXT-PORTERO UNIVERSIDAD", "239-OS-PER-EXT-SN-VIAS 3",
            "240-OS-PER-EXT-SN-PTZ VIAS 2", "241-OS-PER-EXT-SN-VIAS 1", "242-OS-PER-EXT-SN-VIAS 2",
            "243-OS-PER-EXT-SN-PTZ VIAS 1", "247-OS-MIC-PER-EXT-SN-CALLE MICHELENA", "258-OS-PER-EXT-PORTERO UNIVERSIDAD",
            "259-OS-SIM-INT-PB-RECEPCION", "260-OS-SIM-INT-N3-FRENTE", "261-OS-SIM-INT-N4-COMEDOR",
            "262-OS-MIC-INT-SN-ACCESO VEHICULAR", "263-OS-MIC-INT-SN-CASETA MICHELENA", "264-OS-MIC-EXT-SN-SALIDA VEHICULAR",
            "265-OS-MIC-EXT-SN-ACCESO PEATONAL", "273-OS-MIC-INT-PB-ENTRADA PRINCIPAL", "274-OS-MIC-INT-PB-RAMPA CAJERO",
            "275-OS-MIC-INT-PB-CAJERO", "276-OS-MIC-INT-PB-OXXO GAS", "277-OS-MIC-INT-PB-ELEVADORES",
            "285-OS-MIC-INT-N1-ELEVADOR", "288-OS-MIC-INT-N1-PASILLO NTE", "289-OS-MIC-INT-N1-PASILLO SUR",
            "291-OS-MIC-INT-N1-BODEGA IMMEX", "292-OS-MIC-INT-N2-ELEVADORES OXXOGAS", "293-OS-MIC-INT-N2-SALA DE JUNTAS",
            "294-OS-MIC-INT-N2-DIR OXXO GAS", "295-OS-MIC-INT-N2-PASILLO OXXO GAS PONIENTE", "296-OS-MIC-INT-N2-PASILLO OXXO GAS PONIENTE",
            "297-OS-MIC-INT-N2-PUERTA DE EMERGENCIA", "303-OS-MIC-INT-N3-PASILLO NTE", "304-OS-MIC-INT-N3-PASILLO SUR",
            "306-OS-MIC-INT-N4-ELEVADORES", "307-OS-MIC-INT-N4-PASILLO FARMACIA", "308-OS-MIC-INT-N4-FARMACIA PONIENTE",
            "309-OS-MIC-INT-N4-FARMACIA ORIENTE", "311-OS-MIC-INT-N4-RECEPCION YZA", "319-OS-COM-INT-SN-ACCESO COMEDOR 2",
            "320-OS-COM-INT-SN-COMEDOR 2", "321-OS-CCO-INT-CCO", "322-OS-ATI-EXT-SN- EST TI",
            "323-OS-PER-EXT-SN-CARRANZA", "324-OS-EX-SN-CASETA CARRANZA", "325-OS-MIC-INT-PB-CCO OXXO GAS",
            "326-OS-UN-INT-SN- TRAILAR EST UN", "327-OS-UN-EXT-SN-ESTACIONAMIENTO U.N FONDO", "328-OS-UN-EXT-SN-ESTACIONAMIENTO U.N ENTRADA",
            "329-OS-ROJ-EXT-N3-ESCALERAS", "330-OS-ROJ-INT-N3-COCINETA", "331-OS-AZU-EXT-SN-CUCHILLA",
            "332-OS-SIM-EXT-SN-CALLE", "333-OS-SIM-INT-PB-INTENDENCIA", "334-OS-SIM-INT-PASILLO ELAVADOR",
            "335-OS-SIM-INT-N1-FONDO", "336-OS-SIM-INT-N2-FRENTE", "337-OS-SIM-INT-N2-FONDO",
            "338-OS-SIM-INT-N3-FONDO", "339-OS-SIM-INT-N4-FONDO", "340-OS-PER-EXT-SN-EST VIAS",
            "341-OS-PER-INT-SN-ESTACIONAMIENTO VIAS EDI", "342-OS-PER-EXT-SN-PRIV EDI", "343-OS-PER-EXT-SN-VIAS4",
            "344-OS-SIL-INT-N4-SITE", "345-OS-SIL-EXT-N6-ESCALERAS", "346-OS-SIL-INT-N6-CCO IMMEX",
            "347-OS-CCO-INT-CCO FRONTAL", "348-OS-UN-EXT-SN-ESTACIONAMIENTO U.N CENTRO", "349-OS-UN-EXT-SN-ESTACIONAMIENTO U.N FONDO VIAS"
        ];

        let currentIndex = parseInt(localStorage.getItem('cctv_index')) || 0;
        let results = JSON.parse(localStorage.getItem('cctv_detailed_results')) || {};

        function showStatus(msg, type = 'info') {
            const pill = document.getElementById('status-pill');
            const text = document.getElementById('status-text');
            pill.style.display = 'block';
            text.innerText = msg;
            pill.classList.remove('bg-blue-600', 'bg-emerald-600', 'bg-rose-600', 'scale-95');
            pill.classList.add('scale-100');
            if (type === 'success') pill.classList.add('bg-emerald-600');
            else if (type === 'error') pill.classList.add('bg-rose-600');
            else pill.classList.add('bg-blue-600');
            if (type !== 'info') {
                setTimeout(() => {
                    pill.classList.remove('scale-100');
                    pill.classList.add('scale-95');
                    setTimeout(() => pill.style.display = 'none', 300);
                }, 4000);
            }
        }

        function updateUI() {
            if (currentIndex >= cameraData.length) {
                showSummary();
                return;
            }
            const camStr = cameraData[currentIndex];
            const [id, ...rest] = camStr.split('-');
            const name = rest.join('-');
            const card = document.getElementById('camera-card');
            card.classList.remove('fade-in');
            void card.offsetWidth; 
            card.classList.add('fade-in');
            document.getElementById('cam-id').innerText = `IDENTIFICADOR: ${id}`;
            document.getElementById('cam-name').innerText = name;
            const now = new Date();
            const currentTimeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            document.getElementById('review-time').value = results[camStr]?.time || currentTimeStr;
            document.getElementById('individual-comment').value = results[camStr]?.comment || "";
            const total = cameraData.length;
            document.getElementById('counter').innerText = `${currentIndex + 1} / ${total}`;
            document.getElementById('progress-bar').style.width = `${((currentIndex + 1) / total) * 100}%`;
            document.getElementById('btn-prev').disabled = currentIndex === 0;
            localStorage.setItem('cctv_index', currentIndex);
        }

        function markCamera(status) {
            const camStr = cameraData[currentIndex];
            const comment = document.getElementById('individual-comment').value.trim();
            const time = document.getElementById('review-time').value;
            results[camStr] = {
                id_camara: camStr.split('-')[0],
                ubicacion: camStr.split('-').slice(1).join('-'),
                nombre_completo: camStr,
                status: status ? "OK" : "FALLA",
                comment: comment,
                time: time,
                fecha_revision: new Date().toLocaleDateString()
            };
            localStorage.setItem('cctv_detailed_results', JSON.stringify(results));
            nextCamera();
        }

        function nextCamera() {
            if (currentIndex < cameraData.length - 1) {
                currentIndex++;
                updateUI();
            } else {
                showSummary();
            }
        }

        function prevCamera() {
            if (currentIndex > 0) {
                currentIndex--;
                updateUI();
            }
        }

        function showSummary() {
            document.getElementById('wizard-container').classList.add('hidden');
            const container = document.getElementById('summary-container');
            container.classList.remove('hidden');

            const reviewed = cameraData.map(cam => results[cam]).filter(Boolean);
            const okCount = reviewed.filter(r => r.status === "OK").length;
            const failCount = reviewed.length - okCount;
            const total = cameraData.length;

            // Generar texto estad√≠stico editable
            let statsText = `INFORME DETALLADO CIC\n`;
            statsText += `----------------------------------------\n`;
            statsText += `Resumen Operativo:\n`;
            statsText += `‚Ä¢ Total revisadas: ${reviewed.length} de ${total}\n`;
            statsText += `‚Ä¢ Correctas (OK): ${okCount}\n`;
            statsText += `‚Ä¢ Fallas (DET): ${failCount}\n`;
            statsText += `----------------------------------------\n`;
            statsText += `OBSERVACIONES ESPEC√çFICAS:\n`;
            
            const list = document.getElementById('results-list');
            list.innerHTML = '';

            cameraData.forEach(cam => {
                const data = results[cam];
                const item = document.createElement('div');
                item.className = 'p-4 text-sm hover:bg-slate-50 transition-colors';
                let icon = '‚è≥';
                let color = 'text-slate-300';
                if (data) {
                    icon = data.status === "OK" ? '‚úÖ' : '‚ùå';
                    color = data.status === "OK" ? 'text-emerald-600' : 'text-rose-600';
                    if (data.comment) {
                        statsText += `‚Ä¢ ${data.id_camara}: ${data.comment}\n`;
                    }
                }
                item.innerHTML = `
                    <div class="flex items-center justify-between font-bold ${color}">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="text-[10px] bg-slate-100 px-1 rounded text-slate-500 font-mono flex-shrink-0 border border-slate-200">${cam.split('-')[0]}</span>
                            <span class="truncate max-w-[150px] md:max-w-xs uppercase tracking-tight">${cam.split('-').slice(1).join('-')}</span>
                            ${data ? `<span class="text-[10px] bg-blue-50 text-blue-500 px-1.5 py-0.5 rounded font-black ml-1">${data.time}</span>` : ''}
                        </div>
                        <span class="ml-2">${icon}</span>
                    </div>
                    ${data && data.comment ? `<div class="mt-2 text-[11px] text-slate-600 bg-slate-50 p-2.5 rounded-xl border border-slate-100 italic">Observaci√≥n: ${data.comment}</div>` : ''}
                `;
                list.appendChild(item);
            });

            document.getElementById('detailed-text-box').value = statsText;
        }

        // Mejora significativa de estilos para la tabla enviada
        function generateHTMLTable(data, summaryText) {
            let html = `
            <div style="font-family: Arial, sans-serif; max-width: 800px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;">
                <div style="background-color: #1e3a8a; padding: 20px; border-radius: 6px 6px 0 0;">
                    <h2 style="color: #ffffff; margin: 0; font-size: 20px; text-transform: uppercase;">Informe T√©cnico CCTV</h2>
                    <p style="color: #bfdbfe; margin: 5px 0 0 0; font-size: 14px; font-weight: bold;">${summaryText}</p>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px; border: 2px solid #1e3a8a;">
                    <thead>
                        <tr style="background-color: #1e40af; color: #ffffff;">
                            <th style="padding: 12px; border: 1px solid #1e3a8a; text-align: left; font-size: 12px; text-transform: uppercase;">ID</th>
                            <th style="padding: 12px; border: 1px solid #1e3a8a; text-align: left; font-size: 12px; text-transform: uppercase;">Ubicaci√≥n</th>
                            <th style="padding: 12px; border: 1px solid #1e3a8a; text-align: center; font-size: 12px; text-transform: uppercase;">Estado</th>
                            <th style="padding: 12px; border: 1px solid #1e3a8a; text-align: center; font-size: 12px; text-transform: uppercase;">Hora</th>
                            <th style="padding: 12px; border: 1px solid #1e3a8a; text-align: left; font-size: 12px; text-transform: uppercase;">Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.forEach((item, index) => {
                const statusColor = item.status === "OK" ? "#059669" : "#dc2626";
                const rowBg = index % 2 === 0 ? "#ffffff" : "#f3f4f6";
                html += `
                    <tr style="background-color: ${rowBg};">
                        <td style="padding: 10px; border: 1px solid #d1d5db; font-weight: bold; color: #1e3a8a;">${item.id_camara}</td>
                        <td style="padding: 10px; border: 1px solid #d1d5db; color: #374151;">${item.ubicacion}</td>
                        <td style="padding: 10px; border: 1px solid #d1d5db; text-align: center; color: ${statusColor}; font-weight: 800;">${item.status}</td>
                        <td style="padding: 10px; border: 1px solid #d1d5db; text-align: center; color: #6b7280; font-family: monospace;">${item.time}</td>
                        <td style="padding: 10px; border: 1px solid #d1d5db; color: #4b5563; font-style: italic;">${item.comment || '-'}</td>
                    </tr>`;
            });

            html += `
                    </tbody>
                </table>
                <div style="margin-top: 25px; text-align: right; padding: 10px; border-top: 1px solid #e5e7eb;">
                    <p style="font-size: 14px; color: #6b7280; font-style: italic; margin: 0;">&ldquo;CIC - Centro de Control&rdquo;</p>
                </div>
            </div>`;
            
            // Eliminar cualquier resto de caracteres t√©cnicos molestos
            return html.replace(/\n/g, '').replace(/\s\s+/g, ' ');
        }

        async function exportAndSend() {
            const reviewed = cameraData.map(cam => results[cam]).filter(Boolean);
            if (reviewed.length === 0) {
                showStatus("No hay c√°maras revisadas.", "error");
                return;
            }
            
            const btn = document.getElementById('btn-send-api');
            btn.disabled = true;
            btn.innerText = "ENVIANDO REPORTE...";

            // Capturar el resumen editable del usuario
            const userSummary = document.getElementById('detailed-text-box').value;
            
            // Generar la tabla con estilos robustos
            const okCount = reviewed.filter(r => r.status === "OK").length;
            const failCount = reviewed.length - okCount;
            const cleanSummaryText = `C√°maras Operativas: ${okCount}. C√°maras con Falla: ${failCount}. Revisi√≥n: ${reviewed.length}/${cameraData.length}.`;
            
            const htmlTable = generateHTMLTable(reviewed, cleanSummaryText);

            // Respaldo manual (portapapeles)
            navigator.clipboard.writeText(userSummary + "\n\n" + cleanSummaryText);

            const success = await sendToPowerAutomate(cleanSummaryText, htmlTable);
            if (success) showStatus("¬°Datos enviados al Centro de Control!", "success");
            else showStatus("Error de red. Verifique conexi√≥n.", "error");

            btn.disabled = false;
            btn.innerHTML = "<span>üöÄ</span> ENVIAR REPORTE A TABLA";
        }

        async function sendToPowerAutomate(summary, htmlTable) {
            const payload = {
                body: {
                    resumen: summary, // Texto limpio
                    tabla_html: htmlTable // HTML con estilos inline reforzados
                }
            };
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) return true;
                } catch (err) { console.error(`Intento ${i + 1}`); }
                await new Promise(res => setTimeout(res, 2000));
            }
            return false;
        }

        function backToWizard() {
            document.getElementById('summary-container').classList.add('hidden');
            document.getElementById('wizard-container').classList.remove('hidden');
            updateUI();
        }

        function resetApp() {
            if (confirm("¬øDesea limpiar los datos y reiniciar?")) {
                localStorage.removeItem('cctv_index');
                localStorage.removeItem('cctv_detailed_results');
                currentIndex = 0;
                results = {};
                backToWizard();
            }
        }
        updateUI();
    </script>
</body>
</html>