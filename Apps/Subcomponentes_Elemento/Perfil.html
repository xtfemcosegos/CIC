<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Maps API con Librería Places -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDoGMql48pFyB9VFETw0c_dxFaC5yXRyVQ&libraries=places"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: transparent; padding: 20px; }
        .card-material { background: white; border-radius: 28px; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); padding: 24px; }
        .input-standard { width: 100%; background: #f8fafc; border: 2px solid #f1f5f9; border-radius: 16px; padding: 10px 14px; font-size: 13px; font-weight: 600; outline: none; transition: 0.2s; }
        .input-standard:focus { border-color: #450a0a; background: white; }
        .input-readonly { background: #f1f5f9; color: #64748b; cursor: not-allowed; }
        .section-label { font-size: 9px; font-weight: 800; color: #ffffff; background-color: #450a0a; padding: 4px 12px; border-radius: 99px; text-transform: uppercase; margin-bottom: 15px; display: inline-block; letter-spacing: 0.05em; }
        .info-label { font-size: 8px; font-weight: 800; color: #94a3b8; margin-bottom: 4px; display: block; text-transform: uppercase; margin-left: 4px; }
        
        #search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 16px; margin-top: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 50; overflow: hidden; display: none; border: 1px solid #f1f5f9; }
        .result-item { padding: 12px 20px; font-size: 11px; font-weight: 700; color: #1e293b; cursor: pointer; border-bottom: 1px solid #f8fafc; transition: all 0.2s; }
        .result-item:hover, .result-item.selected { background: #fdf8f8; color: #450a0a; border-left: 4px solid #450a0a; }

        .animate-fade { animation: fadeIn 0.3s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-my-profile { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #450a0a; display: flex; align-items: center; gap: 6px; padding: 10px 16px; border-radius: 12px; background: #fdf8f8; border: 1px solid #450a0a20; transition: all 0.2s; }
        .btn-my-profile:hover { background: #450a0a; color: white; }

        /* Estilos Cámara y Mapa */
        #camera-overlay { position: fixed; inset: 0; background: black; z-index: 100; display: none; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #map-container { width: 100%; height: 200px; border-radius: 16px; margin-top: 12px; border: 2px solid #f1f5f9; overflow: hidden; }
        
        /* Ajuste para el dropdown de Google Maps */
        .pac-container { border-radius: 16px; border: none; font-family: 'Plus Jakarta Sans', sans-serif; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 5px; z-index: 9999; }
        .pac-item { padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .pac-item:hover { background-color: #fdf8f8; }
        .pac-item-query { font-size: 12px; color: #1e293b; font-weight: 700; }
    </style>
</head>
<body>
    <div class="max-w-xl mx-auto space-y-6">
        
        <!-- CABECERA DE BÚSQUEDA Y ACCESO RÁPIDO -->
        <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between">
                <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Expediente Digital</p>
                <button id="btn-show-mine" class="btn-my-profile">
                    <i class="fa-solid fa-user-circle"></i>
                    Ver Mi Perfil
                </button>
            </div>
            
            <div class="relative">
                <div class="flex items-center bg-white rounded-[24px] shadow-sm border border-slate-100 px-4">
                    <i class="fa-solid fa-magnifying-glass text-slate-300 mr-3"></i>
                    <input type="text" id="search-input" autocomplete="off" class="w-full py-4 text-xs font-bold outline-none uppercase tracking-widest placeholder:text-slate-300" placeholder="Buscar otro elemento por nombre o nómina..." oninput="filterUsers(this.value)">
                </div>
                <div id="search-results"></div>
            </div>
        </div>

        <!-- VISTA DEL PERFIL -->
        <div id="profile-view" class="hidden animate-fade pb-10">
            <form id="profile-form" class="card-material space-y-8">
                
                <!-- IDENTIDAD -->
                <div class="flex flex-col items-center">
                    <div class="relative group">
                        <img id="profile-pic" src="https://ui-avatars.com/api/?background=450a0a&color=fff&name=P" class="w-28 h-28 rounded-[36px] object-cover border-4 border-slate-50 shadow-md">
                        <div class="absolute -bottom-2 -right-2 flex gap-1">
                            <label for="upload-photo" class="w-10 h-10 bg-red-900 text-white rounded-full flex items-center justify-center shadow-lg border-4 border-white cursor-pointer hover:scale-110 transition-transform">
                                <i class="fa-solid fa-upload text-[10px]"></i>
                            </label>
                            <button type="button" onclick="startCamera()" class="w-10 h-10 bg-red-900 text-white rounded-full flex items-center justify-center shadow-lg border-4 border-white hover:scale-110 transition-transform">
                                <i class="fa-solid fa-camera text-[10px]"></i>
                            </button>
                        </div>
                        <input type="file" id="upload-photo" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                    </div>
                    <div class="w-full mt-6">
                        <input type="text" name="nombre" class="text-center font-black uppercase text-slate-800 text-xl outline-none border-none bg-transparent w-full" placeholder="NOMBRE COMPLETO">
                        <p id="disp-puesto" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest text-center mt-1">PUESTO NO DEFINIDO</p>
                    </div>
                </div>

                <section>
                    <span class="section-label">Identidad y Estatus</span>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="info-label">Nómina</label>
                            <input type="number" name="id_empleado" class="input-standard">
                        </div>
                        <div>
                            <label class="info-label">Estatus</label>
                            <select name="status" class="input-standard">
                                <option value="Activo">Activo</option>
                                <option value="Baja">Baja</option>
                            </select>
                        </div>
                        <div>
                            <label class="info-label">Sexo</label>
                            <select name="sexo" class="input-standard">
                                <option value="Hombre">Hombre</option>
                                <option value="Mujer">Mujer</option>
                            </select>
                        </div>
                        <div>
                            <label class="info-label">Fecha Nacimiento</label>
                            <input type="date" name="fecha_nacimiento" id="input-nacimiento" class="input-standard">
                        </div>
                        <div class="col-span-2">
                            <label class="info-label">Edad Calculada (Solo Lectura)</label>
                            <input type="text" id="val-edad" class="input-standard input-readonly" readonly placeholder="--- años">
                        </div>
                    </div>
                </section>

                <section>
                    <span class="section-label">Legal y Salud</span>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="info-label">CURP</label>
                            <input type="text" name="curp" class="input-standard uppercase">
                        </div>
                        <div>
                            <label class="info-label">RFC</label>
                            <input type="text" name="rfc" class="input-standard uppercase">
                        </div>
                        <div class="col-span-2">
                            <label class="info-label">Número de Seguridad Social (NSS)</label>
                            <input type="text" name="nss" class="input-standard">
                        </div>
                        <div>
                            <label class="info-label">Tipo de Sangre</label>
                            <select name="tipo_sangre" class="input-standard">
                                <option value="O+">O+</option>
                                <option value="A+">A+</option>
                                <option value="B+">B+</option>
                                <option value="AB+">AB+</option>
                                <option value="O-">O-</option>
                                <option value="A-">A-</option>
                                <option value="B-">B-</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                        <div>
                            <label class="info-label">Talla Camisa</label>
                            <input type="text" name="talla_camisa" class="input-standard">
                        </div>
                        <div>
                            <label class="info-label">Talla Calzado</label>
                            <input type="number" name="talla_calzado" step="0.5" class="input-standard">
                        </div>
                        <div class="col-span-2">
                            <label class="info-label">Alergias o Restricciones Médicas</label>
                            <textarea name="alergias" class="input-standard h-20 py-2" placeholder="Describa alergias o condiciones..."></textarea>
                        </div>
                    </div>
                </section>

                <section>
                    <span class="section-label">Contacto y Domicilio</span>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="info-label">Teléfono Celular</label>
                                <input type="tel" name="celular" class="input-standard">
                            </div>
                            <div>
                                <label class="info-label">Correo Principal</label>
                                <input type="email" name="correo_principal" class="input-standard">
                            </div>
                        </div>
                        <div>
                            <label class="info-label">Domicilio (Autocompletado)</label>
                            <input type="text" name="domicilio" id="domicilio-search" class="input-standard" placeholder="Busca una dirección...">
                            <div id="map-container">
                                <div id="map" class="w-full h-full"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <div id="save-indicator" class="text-center opacity-0 transition-opacity">
                    <span class="text-[8px] font-black uppercase text-amber-600 tracking-[0.2em]"><i class="fa-solid fa-cloud-arrow-up mr-2"></i>Sincronizando cambios con CIC6 Cloud</span>
                </div>
            </form>
        </div>

        <div id="empty-state" class="py-20 text-center opacity-30">
            <i class="fa-solid fa-circle-notch animate-spin text-5xl mb-4 text-slate-300"></i>
            <p class="text-[10px] font-black uppercase tracking-widest text-slate-500">Sincronizando base de datos...</p>
        </div>
    </div>

    <!-- OVERLAY CÁMARA -->
    <div id="camera-overlay">
        <video id="video" autoplay playsinline muted></video>
        <div class="absolute bottom-10 left-0 w-full flex justify-center gap-4 px-10">
            <button onclick="stopCamera()" class="flex-1 bg-white/10 text-white p-5 rounded-3xl font-black uppercase text-[10px] backdrop-blur-md">Cancelar</button>
            <button onclick="takePicture()" class="flex-[2] bg-emerald-500 text-white p-5 rounded-3xl font-black uppercase text-[10px] shadow-xl flex items-center justify-center gap-2">
                <i class="fa-solid fa-camera"></i> Capturar Foto
            </button>
        </div>
    </div>
    <canvas id="canvas" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCd4p8USmJeFOie1cJj0Hi80-z8IbLAGqU",
            authDomain: "cic6-pp-web.firebaseapp.com",
            projectId: "cic6-pp-web",
            storageBucket: "cic6-pp-web.firebasestorage.app",
            messagingSenderId: "248659087868",
            appId: "1:248659087868:web:a277ef700d83c7f1d22279",
            measurementId: "G-ZMC7H7710Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let allUsers = [];
        let currentUid = null;
        let selectedIndex = -1;
        let filteredResults = [];
        let myUid = null;
        let stream = null;
        
        // Variables Mapa
        let map, marker, autocomplete;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                myUid = user.uid;
                await fetchUsers();
                initGoogleTools(); // Iniciar Google Maps y Autocomplete
                
                document.getElementById('btn-show-mine').onclick = () => loadProfile(myUid);

                const urlParams = new URLSearchParams(window.location.search);
                const targetUid = urlParams.get('uid');
                
                if (targetUid) loadProfile(targetUid);
                else loadProfile(myUid);
            }
        });

        function initGoogleTools() {
            const mapEl = document.getElementById('map');
            if(!mapEl) return;

            // Iniciar Mapa centrado en México por defecto
            map = new google.maps.Map(mapEl, {
                center: { lat: 23.6345, lng: -102.5528 },
                zoom: 5,
                disableDefaultUI: true,
                styles: [
                    { "featureType": "poi", "stylers": [{ "visibility": "off" }] }
                ]
            });
            marker = new google.maps.Marker({ map: map });

            // Iniciar Autocomplete
            const input = document.getElementById('domicilio-search');
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['address'],
                componentRestrictions: { country: 'mx' },
                fields: ['formatted_address', 'geometry']
            });

            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;

                // Centrar mapa
                map.setCenter(place.geometry.location);
                map.setZoom(17);
                marker.setPosition(place.geometry.location);
                
                // Guardar automáticamente
                autoSave({ domicilio: place.formatted_address });
            });
        }

        async function fetchUsers() {
            try {
                const snap = await getDocs(collection(db, 'artifacts', 'cic.pp', 'public', 'data', 'Usuarios'));
                allUsers = [];
                snap.forEach(d => allUsers.push({ uid: d.id, ...d.data() }));
            } catch (e) { console.error("Error catálogo:", e); }
        }

        window.filterUsers = (val) => {
            const res = document.getElementById('search-results');
            selectedIndex = -1;
            if(!val.trim()){ res.style.display = 'none'; return; }
            const q = val.toLowerCase();
            filteredResults = allUsers.filter(u => 
                u.nombre?.toLowerCase().includes(q) || 
                String(u.id_empleado).includes(q)
            ).slice(0, 5);
            renderResults();
        };

        function renderResults() {
            const res = document.getElementById('search-results');
            res.innerHTML = filteredResults.map((u, index) => `
                <div class="result-item ${index === selectedIndex ? 'selected' : ''}" onclick="loadProfile('${u.uid}', '${u.nombre}')">
                    ${u.nombre} <span class="opacity-30 text-[9px] ml-2">#${u.id_empleado || '---'}</span>
                </div>
            `).join('');
            res.style.display = filteredResults.length ? 'block' : 'none';
        }

        document.getElementById('search-input').addEventListener('keydown', (e) => {
            if (filteredResults.length === 0) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % filteredResults.length;
                renderResults();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + filteredResults.length) % filteredResults.length;
                renderResults();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0) {
                    const user = filteredResults[selectedIndex];
                    loadProfile(user.uid, user.nombre);
                }
            }
        });

        window.loadProfile = async (uid, nameHint = null) => {
            currentUid = uid;
            document.getElementById('search-input').value = "";
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('profile-view').classList.remove('hidden');

            try {
                const snap = await getDoc(doc(db, 'artifacts', 'cic.pp', 'public', 'data', 'Usuarios', uid));
                if(snap.exists()){
                    const d = snap.data();
                    const f = document.getElementById('profile-form');
                    
                    Object.keys(d).forEach(k => {
                        if(f.elements[k]) f.elements[k].value = d[k];
                    });

                    document.getElementById('disp-puesto').innerText = d.puesto || "OPERADOR OPERATIVO";
                    document.getElementById('profile-pic').src = d.foto || `https://ui-avatars.com/api/?background=450a0a&color=fff&name=${encodeURIComponent(d.nombre || 'U')}`;
                    
                    calculateAge(d.fecha_nacimiento);
                    
                    // Actualizar mapa si tiene domicilio
                    if(d.domicilio && map) {
                        const geocoder = new google.maps.Geocoder();
                        geocoder.geocode({ address: d.domicilio }, (results, status) => {
                            if (status === 'OK') {
                                map.setCenter(results[0].geometry.location);
                                map.setZoom(17);
                                marker.setPosition(results[0].geometry.location);
                            }
                        });
                    }

                    f.querySelectorAll('input, select, textarea').forEach(el => {
                        el.onchange = null; 
                        el.onchange = () => {
                            if(el.id === 'input-nacimiento') calculateAge(el.value);
                            autoSave();
                        };
                    });
                }
            } catch(e) { console.error("Error carga:", e); }
        };

        function calculateAge(birthDate) {
            const ageDisplay = document.getElementById('val-edad');
            if (!birthDate) { ageDisplay.value = "--- años"; return; }
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            ageDisplay.value = `${age} años`;
        }

        async function autoSave(additionalData = {}) {
            const ind = document.getElementById('save-indicator');
            ind.style.opacity = "1";
            const f = document.getElementById('profile-form');
            const formData = new FormData(f);
            const payload = { ...Object.fromEntries(formData.entries()), ...additionalData };
            
            if(payload.id_empleado) payload.id_empleado = Number(payload.id_empleado);
            if(payload.talla_calzado) payload.talla_calzado = Number(payload.talla_calzado);

            try {
                await updateDoc(doc(db, 'artifacts', 'cic.pp', 'public', 'data', 'Usuarios', currentUid), payload);
                setTimeout(() => ind.style.opacity = "0", 1500);
            } catch(e) { 
                console.error("Error guardado:", e);
                ind.innerHTML = '<span class="text-red-600 text-[8px] font-black uppercase">Fallo en la Nube</span>';
            }
        }

        /* LÓGICA DE FOTOGRAFÍA */
        window.handleFileUpload = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const b64 = event.target.result;
                document.getElementById('profile-pic').src = b64;
                await autoSave({ foto: b64 });
            };
            reader.readAsDataURL(file);
        };

        window.startCamera = async () => {
            document.getElementById('camera-overlay').style.display = 'flex';
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                alert("No se pudo acceder a la cámara.");
                stopCamera();
            }
        };

        window.stopCamera = () => {
            if(stream) stream.getTracks().forEach(track => track.stop());
            document.getElementById('camera-overlay').style.display = 'none';
        };

        window.takePicture = async () => {
            const canvas = document.getElementById('canvas');
            const video = document.getElementById('video');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const b64 = canvas.toDataURL('image/jpeg', 0.7);
            document.getElementById('profile-pic').src = b64;
            stopCamera();
            await autoSave({ foto: b64 });
        };
    </script>
</body>
</html>